== Boite √† outils

=== Python

Le langage https://www.python.org/[Python] est un https://docs.python.org/3/faq/general.html#what-is-python[langage de programmation] interpr√©t√©, interactif, orient√© objet (souvent), fonctionnel (parfois), open source, multi-plateformes, flexible, facile √† apprendre et difficile √† ma√Ætriser.

.https://xkcd.com/353/
image::images/xkcd-353-python.png[]

A premi√®re vue, certains concepts restent difficiles √† aborder: l'indentation d√©finit l'√©tendue d'un bloc (classe, fonction, m√©thode, boucle, condition, ...), il n'y a pas de typage fort des variables et le compilateur n'est pas l√† pour assurer le filet de s√©curit√© avant la mise en production (puisqu'il n'y a pas de compilateur üòõ).
Et malgr√© ces quelques points, Python reste un langage g√©n√©raliste accessible et "bon partout", et de pouvoir se reposer sur un √©cosyst√®me stable et fonctionnel.

Il fonctionne avec un syst√®me d'am√©liorations bas√©es sur des propositions: les PEP, ou "**Python Enhancement Proposal**".
Chacune d'entre elles doit √™tre approuv√©e par le http://fr.wikipedia.org/wiki/Benevolent_Dictator_for_Life[Benevolent Dictator For Life].

Si vous avez besoin d'un aide-m√©moire ou d'une liste exhaustive des types et structures de donn√©es du langage, r√©f√©rez-vous au lien suivant: https://gto76.github.io/python-cheatsheet/[Python Cheat Sheet].

NOTE: Le langage Python utilise un typage dynamique appel√© https://fr.wikipedia.org/wiki/Duck_typing[*duck typing*]: "_When I see a bird that quacks like a duck, walks like a duck, has feathers and webbed feet and associates with ducks ‚Äî I‚Äôm certainly going to assume that he is a duck_" (Source: http://en.wikipedia.org/wiki/Duck_test[Wikipedia (as usual)]).

==== PEP8 - Style Guide for Python Code

La premi√®re PEP qui va nous int√©resser est la https://www.python.org/dev/peps/pep-0008/[PEP 8 -- Style Guide for Python Code]. Elle sp√©cifie comment du code Python doit √™tre organis√© ou format√©, quelles sont les conventions pour l‚Äôindentation, le nommage des variables et des classes, ...
En bref, elle d√©crit comment √©crire du code proprement, afin que d‚Äôautres d√©veloppeurs puissent le reprendre facilement, ou simplement que votre base de code ne d√©rive lentement vers un seuil de non-maintenabilit√©.

Dans cet objectif, un outil existe et listera l'ensemble des conventions qui ne sont pas correctement suivies dans votre projet: pep8. Pour l'installer, passez par pip. Lancez ensuite la commande pep8 suivie du chemin √† analyser (`.`, le nom d'un r√©pertoire, le nom d'un fichier `.py`, ...). Si vous souhaitez uniquement avoir le nombre d'erreur de chaque type, saisissez les options `--statistics -qq`.


[source,bash]
----
$ pep8 . --statistics -qq

7       E101 indentation contains mixed spaces and tabs
6       E122 continuation line missing indentation or outdented
8       E127 continuation line over-indented for visual indent
23      E128 continuation line under-indented for visual indent
3       E131 continuation line unaligned for hanging indent
12      E201 whitespace after '{'
13      E202 whitespace before '}'
86      E203 whitespace before ':'
----

Si vous ne voulez pas √™tre d√©rang√© sur votre mani√®re de coder, et que vous voulez juste avoir un retour sur une analyse de votre code, essayez `pyflakes`: cette librairie analysera vos sources √† la recherche de sources d'erreurs possibles (imports inutilis√©s, m√©thodes inconnues, etc.).


==== PEP257 - Docstring Conventions

Python √©tant un langage interpr√©t√© fortement typ√©, il est plus que conseill√©, au m√™me titre que les tests unitaires que nous verrons plus bas, de documenter son code.
Cela impose une certaine rigueur, mais am√©liore √©norm√©ment la qualit√© (et la reprise) du code par une tierce personne.
Cela implique aussi de **tout** documenter: les modules, les paquets, les classes, les fonctions, m√©thodes, ...
Tout doit avoir un *docstring* associ√© :-).

WARNING: Documentation: be obsessed!

Il existe plusieurs types de conventions de documentation:

. PEP 257
. Numpy
. Google Style (parfois connue sous l'intitul√© `Napoleon`)
. ...

Les https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings[conventions propos√©es par Google] nous semblent  plus faciles √† lire que du RestructuredText, mais sont parfois moins bien int√©gr√©es que les docstrings officiellement support√©es (typiquement, par exemple par https://clize.readthedocs.io/en/stable/[clize] qui ne reconnait que du RestructuredText).
L'exemple donn√© dans les styleguide est celui-ci:

[source,python]
----
def fetch_smalltable_rows(table_handle: smalltable.Table,
                          keys: Sequence[Union[bytes, str]],
                          require_all_keys: bool = False,
) -> Mapping[bytes, Tuple[str]]:
    """Fetches rows from a Smalltable.

    Retrieves rows pertaining to the given keys from the Table instance
    represented by table_handle.  String keys will be UTF-8 encoded.

    Args:
        table_handle: An open smalltable.Table instance.
        keys: A sequence of strings representing the key of each table
          row to fetch.  String keys will be UTF-8 encoded.
        require_all_keys: Optional; If require_all_keys is True only
          rows with values set for all keys will be returned.

    Returns:
        A dict mapping keys to the corresponding table row data
        fetched. Each row is represented as a tuple of strings. For
        example:

        {b'Serak': ('Rigel VII', 'Preparer'),
         b'Zim': ('Irk', 'Invader'),
         b'Lrrr': ('Omicron Persei 8', 'Emperor')}

        Returned keys are always bytes.  If a key from the keys argument is
        missing from the dictionary, then that row was not found in the
        table (and require_all_keys must have been False).

    Raises:
        IOError: An error occurred accessing the smalltable.
    """
----

C'est-√†-dire:

. Une courte ligne d'introduction, descriptive, indiquant ce que la fonction ou la m√©thode r√©alise. Attention, la documentation ne doit pas indiquer _comment_ la fonction/m√©thode est impl√©ment√©e, mais ce qu'elle fait concr√®tement (et succintement).
. Une ligne vide
. Une description plus compl√®te et plus verbeuse
. Une ligne vide
. La description des arguments et param√®tres, des valeurs de retour (+ exemples) et les exceptions qui peuvent √™tre lev√©es.

Un exemple (encore) plus complet peut √™tre trouv√© https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html#example-google[dans le d√©p√¥t sphinxcontrib-napoleon].

Pour ceux que cela pourrait int√©resser, il existe https://marketplace.visualstudio.com/items?itemName=njpwerner.autodocstring[une extension pour Codium], comme nous le verrons juste apr√®s, qui permet de g√©n√©rer automatiquement le squelette de documentation d'un bloc de code:

.autodocstring
image::images/environment/python-docstring-vscode.png[]

NOTE: Nous le verrons plus loin, Django permet de rendre la documentation imm√©diatement accessible depuis son interface d'administration.

==== Linters

Il existe plusieurs niveaux de _linters_:

. Le premier niveau concerne https://pypi.org/project/pycodestyle/[pycodestyle] (anciennement, `pep8` justement...), qui analyse votre code √† la recherche d'erreurs de convention.
. Le deuxi√®me niveau concerne https://pypi.org/project/pyflakes/[pyflakes]. Pyflakes est un _simple_ footnote:[Ce n'est pas moi qui le dit, c'est la doc du projet] programme qui recherchera des erreurs parmi vos fichiers Python.
. Le troisi√®me niveau est https://pypi.org/project/flake8/[Flake8], qui regroupe les deux premiers niveaux, en plus d'y ajouter flexibilit√©, extensions et une analyse de complexit√© de McCabe.
. Le quatri√®me niveau footnote:[Oui, en Python, il n'y a que quatre cercles √† l'Enfer] est https://pylint.org/[PyLint].

PyLint est le meilleur ami de votre _moi_ futur, un peu comme quand vous prenez le temps de faire la vaisselle pour ne pas avoir √† la faire le lendemain: il rendra votre code soyeux et brillant, en posant des affirmations sp√©cifiques.
A vous de les traiter en corrigeant le code ou en apposant un _tag_ indiquant que vous avez pris connaissance de la remarque, que vous en avez tenu compte, et que vous choisissez malgr√© tout de faire autrement.

Pour vous donner une id√©e, voici ce que cela pourrait donner avec un code pas tr√®s propre et qui ne sert √† rien:

[source,python]
----
from datetime import datetime

"""On stocke la date du jour dans la variable ToD4y"""

ToD4y = datetime.today()

def print_today(ToD4y):
    today = ToD4y
    print(ToD4y)

def GetToday():
    return ToD4y


if __name__ == "__main__":
    t =   Get_Today()
    print(t)


----

Avec Flake8, nous obtiendrons ceci:

[source,bash]
----
test.py:7:1: E302 expected 2 blank lines, found 1
test.py:8:5: F841 local variable 'today' is assigned to but never used
test.py:11:1: E302 expected 2 blank lines, found 1
test.py:16:8: E222 multiple spaces after operator
test.py:16:11: F821 undefined name 'Get_Today'
test.py:18:1: W391 blank line at end of file
----

Nous trouvons des erreurs:

* de *conventions*: le nombre de lignes qui s√©parent deux fonctions, le nombre d'espace apr√®s un op√©rateur, une ligne vide √† la fin du fichier, ... Ces _erreurs_ n'en sont pas vraiment, elles indiquent juste de potentiels probl√®mes de communication si le code devait √™tre lu ou compris par une autre personne.
* de *d√©finition*: une variable assign√©e mais pas utilis√©e ou une lex√®me non trouv√©. Cette derni√®re information indique clairement un bug potentiel. Ne pas en tenir compte nuira sans doute √† la sant√© de votre code (et risque de vous r√©veiller √† cinq heures du mat', quand votre application se prendra m√©chamment les pieds dans le tapis).

L'√©tape d'apr√®s consiste √† invoquer pylint. Lui, il est directement moins conciliant:


[source,text]
----
$ pylint test.py
************* Module test
test.py:16:6: C0326: Exactly one space required after assignment
    t =   Get_Today()
      ^ (bad-whitespace)
test.py:18:0: C0305: Trailing newlines (trailing-newlines)
test.py:1:0: C0114: Missing module docstring (missing-module-docstring)
test.py:3:0: W0105: String statement has no effect (pointless-string-statement)
test.py:5:0: C0103: Constant name "ToD4y" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:7:16: W0621: Redefining name 'ToD4y' from outer scope (line 5) (redefined-outer-name)
test.py:7:0: C0103: Argument name "ToD4y" doesn't conform to snake_case naming style (invalid-name)
test.py:7:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:8:4: W0612: Unused variable 'today' (unused-variable)
test.py:11:0: C0103: Function name "GetToday" doesn't conform to snake_case naming style (invalid-name)
test.py:11:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:16:4: C0103: Constant name "t" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:16:10: E0602: Undefined variable 'Get_Today' (undefined-variable)

--------------------------------------------------------------------
Your code has been rated at -5.45/10
----

En gros, j'ai programm√© comme une grosse bouse an√©mique (et oui, le score d'√©valuation du code permet bien d'aller en n√©gatif). En vrac, on trouve des probl√®mes li√©s:

* au nommage (C0103) et √† la mise en forme (C0305, C0326, W0105)
* √† des variables non d√©finies (E0602)
* de la documentation manquante (C0114, C0116)
* de la red√©finition de variables (W0621).


Pour reprendre la http://pylint.pycqa.org/en/latest/user_guide/message-control.html[documentation], chaque code poss√®de sa signification (ouf!):

* C convention related checks
* R refactoring related checks
* W various warnings
* E errors, for probable bugs in the code
* F fatal, if an error occurred which prevented pylint from doing further* processing.

TODO: Expliquer comment faire pour tagger une explication.

==== Formatage de code

Nous avons parl√© ci-dessous de style de codage pour Python (PEP8), de style de r√©daction pour la documentation (PEP257), d'un _linter_ pour nous indiquer quels morceaux de code doivent absolument √™tre revus, ...
Reste que ces t√¢ches sont [line-through]#parfois# (tr√®s) souvent fastidieuses: √©crire un code propre et syst√©matiquement coh√©rent est une t√¢che ardue. Heureusement, il existe des outils pour nous aider (un peu).

A nouveau, il existe plusieurs possibilit√©s de formatage automatique du code.
M√™me si elle n'est pas parfaite, https://black.readthedocs.io/en/stable/[Black] arrive √† un compromis entre la clart√© du code, la facilit√© d'installation et d'int√©gration et un r√©sultat.

Est-ce que ce formatage est id√©al et accept√© par tout le monde ?
Non. M√™me Pylint arrivera parfois √† r√¢ler.
Mais ce formatage conviendra dans 97,83% des cas (au moins).

> By using Black, you agree to cede control over minutiae of hand-formatting. In return, Black gives you speed, determinism, and freedom from pycodestyle nagging about formatting. You will save time and mental energy for more important matters.
>
> Black makes code review faster by producing the smallest diffs possible. Blackened code looks the same regardless of the project you‚Äôre reading. Formatting becomes transparent after a while and you can focus on the content instead.

Traduit rapidement √† partir de la langue de Batman: "_En utilisant Black, vous c√©dez le contr√¥le sur le formatage de votre code. En retour, Black vous fera gagner un max de temps, diminuera votre charge mentale et fera revenir l'√™tre aim√©_". Mais la partie r√©ellement int√©ressante concerne le fait que "_Tout code qui sera pass√© par Black aura la m√™me forme, ind√©pendamment du project sur lequel vous serez en train de travailler. L'√©tape de formatage deviendra transparente, et vous pourrez vous concentrer sur le contenu_".


==== Complexit√© cyclomatique

A nouveau, un greffon pour `flake8` existe et donnera une estimation de la complexit√© de McCabe pour les fonctions trop complexes. Installez-le avec `pip install mccabe`, et activez-le avec le param√®tre `--max-complexity`. Toute fonction dans la complexit√© est sup√©rieure √† cette valeur sera consid√©r√©e comme trop complexe.


==== Typage statique - https://www.python.org/dev/peps/pep-0585/[PEP585]

Nous vous disions ci-dessus que Python √©tait un langage dynamique interpr√©t√©. 
Concr√®tement, cela signifie que des erreurs pouvant √™tre d√©tect√©es √† la compilation avec d'autres langages, ne le sont pas avec Python.

Il existe cependant une solution √† ce probl√®me, sous la forme de http://mypy-lang.org/[Mypy], qui peut (sous vous le souhaitez ;-)) v√©rifier une forme de typage statique de votre code source, gr√¢ce √† une expressivit√© du code, bas√©e sur des annotations (facultatives, elles aussi).

Ces v√©rifications se pr√©sentent de la mani√®re suivante:

[source,python]
----
from typing import List


def first_int_elem(l: List[int]) -> int:
    return l[0] if l else None


if __name__ == "__main__":
    print(first_int_elem([1, 2, 3]))
    print(first_int_elem(['a', 'b', 'c']))
----

Est-ce que le code ci-dessous fonctionne correctement ? 
*Oui*:

[source,bash]
----
Œª python mypy-test.py
1
a
----

Malgr√© que nos annotations d√©clarent une liste d'entiers, rien ne nous emp√™che de lui envoyer une liste de caract√®res, sans que cela ne lui pose de probl√®mes.

Est-ce que Mypy va r√¢ler ? *Oui, aussi*.
Non seulement nous retournons la valeur `None` si la liste est vide alors que nous lui annoncions un entier en sortie, mais en plus, nous l'appelons avec une liste de caract√®res, alors que nous nous attendions √† une liste d'entiers:

[source,bash]
----
Œª mypy mypy-test.py
mypy-test.py:7: error: Incompatible return value type (got "Optional[int]", expected "int")
mypy-test.py:12: error: List item 0 has incompatible type "str"; expected "int"
mypy-test.py:12: error: List item 1 has incompatible type "str"; expected "int"
mypy-test.py:12: error: List item 2 has incompatible type "str"; expected "int"
Found 4 errors in 1 file (checked 1 source file)
----

Pour corriger ceci, nous devons:

. Importer le type `Optional` et l'utiliser en sortie de notre fonction `first_int_elem`
. Eviter de lui donner de 
mauvais param√®tres ;-)

[source,python]
----
from typing import List, Optional


def first_int_elem(l: List[int]) -> Optional[int]:
    return l[0] if l else None


if __name__ == "__main__":
    print(first_int_elem([1, 2, 3]))
----

[source,bash]
----
Œª mypy mypy-test.py
Success: no issues found in 1 source file
----


==== Tests unitaires

*-> PyTest*

Comme tout bon *framework* qui se respecte, Django embarque tout un environnement facilitant le lancement de tests; chaque application est cr√©√©e par d√©faut avec un fichier **tests.py**, qui inclut la classe `TestCase` depuis le package `django.test`:

[source,python]
----
from django.test import TestCase

class TestModel(TestCase):
    def test_str(self):
        raise NotImplementedError('Not implemented yet')
----

Id√©alement, chaque fonction ou m√©thode doit √™tre test√©e afin de bien en valider le fonctionnement, ind√©pendamment du reste des composants. Cela permet d'isoler chaque bloc de mani√®re unitaire, et permet de ne pas rencontrer de r√©gression lors de l'ajout d'une nouvelle fonctionnalit√© ou de la modification d'une existante. Il existe plusieurs types de tests (int√©gration, comportement, ...); on ne parlera ici que des tests unitaires.

Avoir des tests, c'est bien. S'assurer que tout est test√©, c'est mieux. C'est l√† qu'il est utile d'avoir le pourcentage de code couvert par les diff√©rents tests, pour savoir ce qui peut √™tre am√©lior√©.

TODO: V√©rifier  comment les applications sont construites. Type DRF, Django Social Auth, tout √ßa.


==== Couverture de code

La couverture de code est une analyse qui donne un pourcentage li√© √† la quantit√© de code couvert par les tests. Attention qu'il ne s'agit pas de v√©rifier que le code est **bien** test√©, mais juste de v√©rifier **quelle partie** du code est test√©e. En Python, il existe le paquet https://pypi.python.org/pypi/coverage/[coverage], qui se charge d'√©valuer le pourcentage de code couvert par les tests. Ajoutez-le dans le fichier `requirements/base.txt`, et lancez une couverture de code gr√¢ce √† la commande `coverage`. La configuration peut se faire dans un fichier `.coveragerc` que vous placerez √† la racine de votre projet, et qui sera lu lors de l'ex√©cution.

[source,bash]
----
# requirements/base.text
[...]
coverage
django_coverage_plugin
----

[source,bash]
----
# .coveragerc to control coverage.py
[run]
branch = True
omit = ../*migrations*
plugins =
    django_coverage_plugin

[report]
ignore_errors = True

[html]
directory = coverage_html_report
----


[source,bash]
----
$ coverage run --source "." manage.py test
$ coverage report

    Name                      Stmts   Miss  Cover
    ---------------------------------------------
    gwift\gwift\__init__.py       0      0   100%
    gwift\gwift\settings.py      17      0   100%
    gwift\gwift\urls.py           5      5     0%
    gwift\gwift\wsgi.py           4      4     0%
    gwift\manage.py               6      0   100%
    gwift\wish\__init__.py        0      0   100%
    gwift\wish\admin.py           1      0   100%
    gwift\wish\models.py         49     16    67%
    gwift\wish\tests.py           1      1     0%
    gwift\wish\views.py           6      6     0%
    ---------------------------------------------
    TOTAL                        89     32    64%
    ----

$ coverage html
----

Ceci vous affichera non seulement la couverture de code estim√©e, et g√©n√©rera √©galement vos fichiers sources avec les branches non couvertes.


==== Matrice de compatibilit√©

L'int√©r√™t de la matrice de compatibilit√© consiste √† sp√©cifier un ensemble de plusieurs versions d'un m√™me interpr√©teur (ici, Python), afin de s'assurer que votre application continue √† fonctionner. Nous sommes donc un cran plus haut que la sp√©cification des versions des librairies, puisque nous nous situons directement au niveau de l'interpr√©teur.

L'outil le plus connu est https://tox.readthedocs.io/en/latest/[Tox], qui consiste en un outil bas√© sur virtualenv et qui permet:

. de v√©rifier que votre application s'installe correctement avec diff√©rentes versions de Python et d'interpr√©teurs
. de d√©marrer des tests parmi ces diff√©rents environnements

[source,ini]
----
# content of: tox.ini , put in same dir as setup.py
[tox]
envlist = py27,py36

[testenv]
deps =
    -r requirements/dev.txt
commands =
    pytest
----

D√©marrez ensuite la commande `tox`, pour d√©marrer la commande `pytest` sur les environnements Python 2.7 et 3.6, apr√®s avoir install√© nos d√©pendances pr√©sentes dans le fichier `requirements/dev.txt`.


==== Configuration globale

D√©crire le fichier setup.cfg

[source,bash]
----
$ touch setup.cfg
----


==== Dockerfile




==== Makefile

Pour gagner un peu de temps, n'h√©sitez pas √† cr√©er un fichier `Makefile` que vous placerez √† la racine du projet.
L'exemple ci-dessous permettra, gr√¢ce √† la commande `make coverage`, d'arriver au m√™me r√©sultat que ci-dessus:

[source,text]
----
# Makefile for gwift
#

# User-friendly check for coverage
ifeq ($(shell which coverage >/dev/null 2>&1; echo $$?), 1)
    $(error The 'coverage' command was not found. Make sure you have coverage installed)
endif

.PHONY: help coverage

help:
    @echo "  coverage to run coverage check of the source files."

coverage:
    coverage run --source='.' manage.py test; coverage report; coverage html;
    @echo "Testing of coverage in the sources finished."
----

Pour la petite histoire, `make` peu sembler un peu d√©suet, mais reste extr√™mement efficace.


==== The Zen of Python

[source,python]
----
>>> import this
----

[source,text]
----
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
----


=== Environnement de d√©veloppement

Concr√®tement, nous pourrions tout √† fait nous limiter √† Notepad ou Notepad++.
Mais √† moins d'aimer se fouetter avec un c√¢ble USB, nous appr√©cions la compl√©tion du code, la coloration syntaxique, l'int√©gration des tests unitaires et d'un debugger, ainsi que deux-trois sucreries qui feront plaisir √† n'importe quel d√©veloppeur.

Si vous manquez d'id√©es ou si vous ne savez pas par o√π commencer:

* https://vscodium.com/[VSCodium], avec les plugins https://marketplace.visualstudio.com/items?itemName=ms-python.python[Python]et https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens[GitLens]
* https://www.jetbrains.com/pycharm/[PyCharm]
* https://www.vim.org/[Vim] avec les plugins https://github.com/davidhalter/jedi-vim[Jedi-Vim] et https://github.com/preservim/nerdtree[nerdtree]

Si vous h√©sitez, et m√™me si Codium n'est pas le plus l√©ger (la faute √† https://www.electronjs.org/[Electron]...), il fera correctement son travail (√† savoir: faciliter le v√¥tre), en int√©grant suffisament de fonctionnalit√©s qui g√¢teront les papilles √©moustill√©es du d√©veloppeur impatient.

.Codium en action
image::images/environment/codium.png[]

=== Un terminal

_A priori_, les IDE footnote:[Integrated Development Environment] propos√©s ci-dessus fournissent par d√©faut ou _via_ des greffons un terminal int√©gr√©.
Ceci dit, disposer d'un terminal s√©par√© facilite parfois certaines t√¢ches.

A nouveau, si vous manquez d'id√©es:

. Si vous √™tes sous Windows, t√©l√©chargez une copie de https://cmder.net/[Cmder]. Il n'est pas le plus rapide, mais propose une int√©gration des outils Unix communs (`ls`, `pwd`, `grep`, `ssh`, `git`, ...) sans trop se fouler.
. Pour tout autre syst√®me, vous devriez disposer en natif de ce qu'il faut.

.Mise en ab√Æme
image::images/environment/terminal.png[]

=== Un gestionnaire de base de donn√©es

Django g√®re plusieurs moteurs de base de donn√©es.
Certains sont g√©r√©s nativement par Django (PostgreSQL, MariaDB, SQLite); _a priori_, ces trois-l√† sont disponibles pour tous les syst√®mes d'exploitation. D'autres moteurs n√©cessitent des librairies tierces (Oracle, Microsoft SQL Server).

Il n'est pas obligatoire de disposer d'une application de gestion pour ces moteurs: pour les cas d'utilisation simples, le shell Django pourra largement suffire (nous y reviendrons).
Mais pour faciliter la gestion des bases de donn√©es elles-m√™me, et si vous n'√™tes pas √† l'aise avec la ligne de commande, choisissez l'une des applications d'administration ci-dessous en fonction du moteur de base de donn√©es que vous souhaitez utiliser.

* Pour *PostgreSQL*, il existe https://www.pgadmin.org/[pgAdmin]
* Pour *MariaDB* ou *MySQL*, partez sur https://www.phpmyadmin.net/[PHPMyAdmin]
* Pour *SQLite*, il existe https://sqlitebrowser.org/[SQLiteBrowser]
PHPMyAdmin ou PgAdmin.


=== Un gestionnaire de mots de passe

Nous en auront besoin pour g√©(n√©)rer des phrases secr√®tes pour nos applications.
Si vous n'en utilisez pas d√©j√† un, partez sur https://keepassxc.org/[KeepassXC]: il est multi-plateformes, suivi et s'int√®gre correctement aux diff√©rents environnements, tout en restant accessible.

image::images/environment/keepass.png[]


=== Un syst√®me de gestion de versions

Il existe plusieurs syst√®mes de gestion de versions.
Le plus connu √† l'heure actuelle est https://git-scm.com/[Git], notamment pour sa (tr√®s) grande flexibilit√© et sa rapidit√© d'ex√©cution.
Il est une aide pr√©cieuse pour d√©velopper rapidement des preuves de concept, switcher vers une nouvelle fonctionnalit√©, un bogue √† r√©parer ou une nouvelle release √† proposer au t√©l√©chargement.
Ses deux plus gros d√©fauts concerneraient peut-√™tre sa courbe d'apprentissage pour les nouveaux venus et la complexit√© des actions qu'il permet de r√©aliser.

.https://xkcd.com/1597/
image::images/xkcd-1597-git.png[]

M√™me pour un d√©veloppeur solitaire, un syst√®me de gestion de versions (quel qu'il soit) reste indispensable.

Chaque "*branche*" correspond √† une t√¢che √† r√©aliser: un bogue √† corriger (_Hotfix A_), une nouvelle fonctionnalit√© √† ajouter ou un "_truc √† essayer_" footnote:[Oui, comme dans "Attends, j'essaie vite un truc, si √ßa marche, c'est beau."] (_Feature A_ et _Feature B_).
Chaque "*commit*" correspond √† une sauvegarde atomique d'un √©tat ou d'un ensemble de modifications coh√©rentes entre elles.footnote:[Il convient donc de s'abstenir de modifier le CSS d'une application et la couche d'acc√®s √† la base de donn√©es, sous peine de se faire huer par ses relecteurs au prochain stand-up.]
De cette mani√®re, il est beaucoup plus facile pour le d√©veloppeur de se concenter sur un sujet en particulier, dans la mesure o√π celui-ci ne doit pas obligatoirement √™tre cl√¥tur√© pour appliquer un changement de contexte.

.Git en action
image::images/diagrams/git-workflow.png[]

Cas pratique: vous d√©veloppez cette nouvelle fonctionnalit√© qui va r√©volutionner le monde de demain et d'apr√®s-demain, quand, tout √† coup (!), vous vous rendez compte que vous avez perdu votre conformit√© aux normes PCI parce les donn√©es des titulaires de cartes ne sont pas isol√©es correctement.
Il suffit alors de:

. sauver le travail en cours (`git add . && git commit -m [WIP]`)
. revenir sur la branche principale (`git checkout main`)
. cr√©er un "hotfix" (`git checkout -b hotfix/pci-compliance`)
. solutionner le probl√®me (sans doute un `;` en trop ?)
. sauver le correctif sur cette branche (`git add . && git commit -m "Did it!"`)
. r√©cup√©rer ce correctif sur la branche principal (`git checkout main && git merge hotfix/pci-compliance`)
. et revenir tranquillou sur votre branche de d√©veloppement pour fignoler ce g√©n√©rateur de noms de dinosaures rigolos que l'univers vous r√©clame √† cor et √† a cri (`git checkout features/dinolol`)

Finalement, sachez qu'il existe plusieurs mani√®res de g√©rer ces flux d'informations.
Les plus connus sont https://www.gitflow.com/[Gitflow] et https://www.reddit.com/r/programming/comments/7mfxo6/a_branching_strategy_simpler_than_gitflow/[Threeflow].

==== D√©crire ses changements

La description d'un changement se fait _via_ la commande `git commit`. 
Il est possible de lui passer directement le message associ√© √† ce changement gr√¢ce √† l'attribut `-m`, mais c'est une pratique relativement d√©conseill√©e: un _commit_ ne doit effectivement pas obligatoirement √™tre d√©crit sur une seule ligne. 
Une description plus compl√®te, accompagn√©e des √©ventuels tickets ou r√©f√©rences, sera plus compl√®te, plus agr√©able √† lire, et plus facile √† revoir pour vos √©ventuels relecteurs.

De plus, la plupart des plateformes de d√©p√¥ts pr√©senteront ces informations de mani√®re ergonomique. Par exemple:

.Un exemple de commit affich√© dans Gitea
image::images/environment/gitea-commit-message.png[]

La premi√®re ligne est reprise comme titre (normalement, sur 50 caract√®res maximum); le reste est repris comme de la description.

=== Un syst√®me de virtualisation

Par "_syst√®me de virtualisation_", nous entendons n'importe quel application, syst√®me d'exploitation, syst√®me de containeurisation, ... qui permette de cr√©er ou recr√©er un environnement de d√©veloppement aussi proche que celui en production.
Les solutions sont nombreuses:

* https://www.virtualbox.org/[VirtualBox]
* https://www.vagrantup.com/[Vagrant]
* https://www.docker.com/[Docker]
* https://linuxcontainers.org/lxc/[Linux Containers (LXC)]
* https://docs.microsoft.com/fr-fr/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v[Hyper-V]

Ces quelques propositions se situent un cran plus loin que la "simple" isolation d'un environnement, puisqu'elles vous permettront de construire un environnement complet.
Elles constituent donc une √©tape suppl√©mentaires dans la configuration de votre espace de travail, mais en am√©lioreront la qualit√©.

Dans la suite, nous d√©taillerons Vagrant et Docker, qui constituent deux solutions automatisables et multiplateformes, dont la configuration peut faire partie int√©grante de vos sources.

==== Vagrant

Vagrant consiste en un outil de cr√©ation et de gestion d'environnements virtualis√©s, en respectant toujours une m√™me mani√®re de travailler, ind√©pendamment des choix techniques et de l'infrastructure que vous pourriez s√©lectionner.

> Vagrant is a tool for building and managing virtual machine environments in a single workflow. With an easy-to-use workflow and focus on automation, Vagrant lowers development environment setup time, increases production parity, and makes the "works on my machine" excuse a relic of the past. footnote:[https://www.vagrantup.com/intro]

La partie la plus importante de la configuration de Vagrant pour votre projet consiste √† placer un fichier `Vagrantfile` - _a priori_ √† la racine de votre projet - et qui contiendra les information suivantes:

* Le choix du _fournisseur_ (*provider*) de virtualisation (Virtualbox, Hyper-V et Docker sont natifs; il est √©galement possible de passer par VMWare, AWS, etc.)
* Une _box_, qui consiste √† lui indiquer le type et la version attendue du syst√®me virtualis√© (Debian 10, Ubuntu 20.04, etc. - et https://app.vagrantup.com/boxes/search[il y a du choix]).
* La mani√®re dont la fourniture (*provisioning*) de l'environnement doit √™tre r√©alis√©e: scripts Shell, fichiers, Ansible, Puppet, Chef, ... Choisissez votre favori :-) m√™me s'il est toujours possible de passer par une installation et une maintenance manuelle, apr√®s s'√™tre connect√© sur la machine.
* Si un espace de stockage doit √™tre partag√© entre la machine virtuelle et l'h√¥te
* Les ports qui doivent √™tre transmis de la machine virtuelle vers l'h√¥te.

La syntaxe de ce fichier `Vagrantfile` est en https://www.ruby-lang.org/en/[Ruby]. Vous trouverez ci-dessous un exemple, g√©n√©r√© (et nettoy√©) apr√®s avoir ex√©cut√© la commande `vagrant init`:

[source,ruby]
----
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|

  config.vm.box = "ubuntu/bionic64"
  
  config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"

  config.vm.provider "virtualbox" do |vb|  
    vb.gui = true
    vb.memory = "1024"
  end
  
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y nginx
  SHELL
end
----

Dans le fichier ci-dessus, nous cr√©ons: 

* Une nouvelle machine virtuelle (ie. _invit√©e_) sous Ubuntu Bionic Beaver, en x64
* Avec une correspondance du port `80` de la machine vers le port `8080` de l'h√¥te, en limitant l'acc√®s √† celui-ci - acc√©dez √† `localhost:8080` et vous acc√©derez au port `80` de la machine virtuelle.
* En utilisant Virtualbox comme backend - la m√©moire vive allou√©e sera limit√©e √† 1Go de RAM et nous ne voulons pas voir l'interface graphique au d√©marrage
* Et pour finir, nous voulons appliquer un script de mise √† jour `apt-get update` et installer le paquet `nginx`

NOTE: Par d√©faut, le r√©pertoire courant (ie. le r√©pertoire dans lequel notre fichier `Vagrantfile` se trouve) sera synchronis√© dans le r√©pertoire `/vagrant` sur la machine invit√©e.


==== Docker


[source,dockerfile]
----
version: '3'

volumes:
  local_postgres_data: {}
  local_postgres_data_backups: {}

services:
  django: &django
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: khana_local_django
    container_name: django
    depends_on:
      - postgres
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
    ports:
      - "8000:8000"
    command: /start

  postgres:
    build:
      context: .
      dockerfile: ./compose/production/postgres/Dockerfile
    image: khana_production_postgres
    container_name: postgres
    volumes:
      - local_postgres_data:/var/lib/postgresql/data:Z
      - local_postgres_data_backups:/backups:z
    env_file:
      - ./.envs/.local/.postgres

  docs:
    image: khana_local_docs
    container_name: docs
    build:
      context: .
      dockerfile: ./compose/local/docs/Dockerfile
    env_file:
      - ./.envs/.local/.django
    volumes:
      - ./docs:/docs:z
      - ./config:/app/config:z
      - ./khana:/app/khana:z
    ports:
      - "7000:7000"
    command: /start-docs

  redis:
    image: redis:5.0
    container_name: redis

  celeryworker:
    <<: *django
    image: khana_local_celeryworker
    container_name: celeryworker
    depends_on:
      - redis
      - postgres
      
    ports: []
    command: /start-celeryworker

  celerybeat:
    <<: *django
    image: khana_local_celerybeat
    container_name: celerybeat
    depends_on:
      - redis
      - postgres
      
    ports: []
    command: /start-celerybeat

  flower:
    <<: *django
    image: khana_local_flower
    container_name: flower
    ports:
      - "5555:5555"
    command: /start-flower

----


[source,dockerfile]
----
FROM python:3.8-slim-buster

ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1

RUN apt-get update \
  # dependencies for building Python packages
  && apt-get install -y build-essential \
  # psycopg2 dependencies
  && apt-get install -y libpq-dev \
  # Translations dependencies
  && apt-get install -y gettext \
  # cleaning up unused files
  && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
  && rm -rf /var/lib/apt/lists/*

# Requirements are installed here to ensure they will be cached.
COPY ./requirements /requirements
RUN pip install -r /requirements/local.txt

COPY ./compose/production/django/entrypoint /entrypoint
RUN sed -i 's/\r$//g' /entrypoint
RUN chmod +x /entrypoint

COPY ./compose/local/django/start /start
RUN sed -i 's/\r$//g' /start
RUN chmod +x /start

COPY ./compose/local/django/celery/worker/start /start-celeryworker
RUN sed -i 's/\r$//g' /start-celeryworker
RUN chmod +x /start-celeryworker

COPY ./compose/local/django/celery/beat/start /start-celerybeat
RUN sed -i 's/\r$//g' /start-celerybeat
RUN chmod +x /start-celerybeat

COPY ./compose/local/django/celery/flower/start /start-flower
RUN sed -i 's/\r$//g' /start-flower
RUN chmod +x /start-flower

WORKDIR /app

ENTRYPOINT ["/entrypoint"]
----
