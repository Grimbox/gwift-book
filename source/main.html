<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="CÃ©dric Declerfayt, Fred Pauchet">
<title>Minor swing with Django</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Minor swing with Django</h1>
<div class="details">
<span id="author" class="author">CÃ©dric Declerfayt</span><br>
<span id="email" class="email"><a href="mailto:jaguarondi27@gmail.com">jaguarondi27@gmail.com</a></span><br>
<span id="author2" class="author">Fred Pauchet</span><br>
<span id="email2" class="email"><a href="mailto:fred@grimbox.be">fred@grimbox.be</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_environnement_de_travail">Environnement de travail</a>
<ul class="sectlevel1">
<li><a href="#_mÃ©thodologie_de_travail">1. MÃ©thodologie de travail</a></li>
<li><a href="#_environnements_virtuels">2. Environnements virtuels</a>
<ul class="sectlevel2">
<li><a href="#_crÃ©ation_de_lenvironnement_virtuel">2.1. CrÃ©ation de l&#8217;environnement virtuel</a></li>
<li><a href="#_installation_de_django_et_crÃ©ation_du_rÃ©pertoire_de_travail">2.2. Installation de Django et crÃ©ation du rÃ©pertoire de travail</a></li>
<li><a href="#_gestion_des_dÃ©pendances">2.3. Gestion des dÃ©pendances</a></li>
<li><a href="#_structure_finale_de_lenvironnement">2.4. Structure finale de l&#8217;environnement</a></li>
</ul>
</li>
<li><a href="#_django">3. Django</a>
<ul class="sectlevel2">
<li><a href="#_gestion">3.1. Gestion</a></li>
<li><a href="#_structure_dune_application">3.2. Structure d&#8217;une application</a></li>
<li><a href="#_tests_unitaires">3.3. Tests unitaires</a></li>
</ul>
</li>
<li><a href="#_construire_des_applications_maintenables">4. Construire des applications maintenables</a>
<ul class="sectlevel2">
<li><a href="#_au_niveau_des_mÃ©thodes_et_fonctions">4.1. Au niveau des mÃ©thodes et fonctions</a></li>
<li><a href="#_au_niveau_des_classes">4.2. Au niveau des classes</a></li>
<li><a href="#_au_niveau_des_composants">4.3. Au niveau des composants</a></li>
<li><a href="#_de_maniÃ¨re_plus_gÃ©nÃ©rale">4.4. De maniÃ¨re plus gÃ©nÃ©rale</a></li>
<li><a href="#_en_pratique">4.5. En pratique</a></li>
</ul>
</li>
<li><a href="#_chaÃ®ne_doutils">5. ChaÃ®ne d&#8217;outils</a>
<ul class="sectlevel2">
<li><a href="#_pep8">5.1. PEP8</a></li>
<li><a href="#_pep8_flake8_pylint">5.2. pep8, flake8, pylint</a></li>
<li><a href="#_black">5.3. Black</a></li>
<li><a href="#_pytest">5.4. pytest</a></li>
<li><a href="#_mypy">5.5. mypy</a></li>
</ul>
</li>
<li><a href="#_git">6. Git</a></li>
<li><a href="#_graphviz">7. graphviz</a></li>
<li><a href="#_en_rÃ©sumÃ©">8. En rÃ©sumÃ©</a></li>
</ul>
</li>
<li><a href="#_dÃ©ploiement">DÃ©ploiement</a>
<ul class="sectlevel1">
<li><a href="#_un_peu_de_thÃ©orie_les_principales_Ã©tapes">9. Un peu de thÃ©orie&#8230;&#8203; Les principales Ã©tapes</a>
<ul class="sectlevel2">
<li><a href="#_dÃ©finition_de_linfrastructure">9.1. DÃ©finition de l&#8217;infrastructure</a></li>
<li><a href="#_configuration_et_sÃ©curisation_de_la_machine_hÃ´te">9.2. Configuration et sÃ©curisation de la machine hÃ´te</a></li>
<li><a href="#_mise_Ã _jour">9.3. Mise Ã  jour</a></li>
<li><a href="#_supervision">9.4. Supervision</a></li>
</ul>
</li>
<li><a href="#_dÃ©ploiement_sur_centos">10. DÃ©ploiement sur CentOS</a>
<ul class="sectlevel2">
<li><a href="#_installation_des_dÃ©pendances_systÃ¨mes">10.1. Installation des dÃ©pendances systÃ¨mes</a></li>
<li><a href="#_prÃ©paration_de_lenvironnement_utilisateur">10.2. PrÃ©paration de l&#8217;environnement utilisateur</a></li>
<li><a href="#_configuration_de_lapplication">10.3. Configuration de l&#8217;application</a></li>
<li><a href="#_crÃ©ation_des_rÃ©pertoires_de_logs">10.4. CrÃ©ation des rÃ©pertoires de logs</a></li>
<li><a href="#_crÃ©ation_du_rÃ©pertoire_pour_le_socket">10.5. CrÃ©ation du rÃ©pertoire pour le socket</a></li>
<li><a href="#_gunicorn">10.6. Gunicorn</a></li>
<li><a href="#_supervision_2">10.7. Supervision</a></li>
<li><a href="#_ouverture_des_ports">10.8. Ouverture des ports</a></li>
<li><a href="#_installation_dnginx">10.9. Installation d&#8217;Nginx</a></li>
<li><a href="#_configuration_des_sauvegardes">10.10. Configuration des sauvegardes</a></li>
</ul>
</li>
<li><a href="#_postgresql">11. PostgreSQL</a></li>
<li><a href="#_mariadb">12. MariaDB</a></li>
</ul>
</li>
<li><a href="#_modÃ©lisation">ModÃ©lisation</a>
<ul class="sectlevel1">
<li><a href="#_modÃ©lisation_2">13. ModÃ©lisation</a></li>
<li><a href="#_queryset_managers">14. Queryset &amp; managers</a></li>
<li><a href="#_forms">15. Forms</a>
<ul class="sectlevel2">
<li><a href="#_dÃ©pendance_avec_le_modÃ¨le">15.1. DÃ©pendance avec le modÃ¨le</a></li>
<li><a href="#_rendu_et_affichage">15.2. Rendu et affichage</a></li>
<li><a href="#_squelette_par_dÃ©faut">15.3. Squelette par dÃ©faut</a></li>
<li><a href="#_crispy_forms">15.4. Crispy-forms</a></li>
</ul>
</li>
<li><a href="#_validation_des_donnÃ©es">16. Validation des donnÃ©es</a></li>
<li><a href="#_en_conclusion">17. En conclusion</a></li>
<li><a href="#_migrations">18. Migrations</a></li>
<li><a href="#_logging">19. Logging</a></li>
<li><a href="#_administration">20. Administration</a>
<ul class="sectlevel2">
<li><a href="#_quelques_conseils">20.1. Quelques conseils</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_go_live">Go Live !</a></li>
<li><a href="#_gestion_des_utilisateurs">Gestion des utilisateurs</a></li>
<li><a href="#_gestion_des_listes">Gestion des listes</a>
<ul class="sectlevel1">
<li><a href="#_modÃ¨lisation">21. ModÃ¨lisation</a></li>
<li><a href="#_fonctionnalitÃ©s">22. FonctionnalitÃ©s</a></li>
</ul>
</li>
<li><a href="#_gestion_des_souhaits">Gestion des souhaits</a>
<ul class="sectlevel1">
<li><a href="#_modÃ©lisation_3">23. ModÃ©lisation</a></li>
<li><a href="#_fonctionnalitÃ©s_2">24. FonctionnalitÃ©s</a></li>
</ul>
</li>
<li><a href="#_gestion_des_rÃ©alisations_de_souhaits">Gestion des rÃ©alisations de souhaits</a>
<ul class="sectlevel1">
<li><a href="#_modÃ©lisation_4">25. ModÃ©lisation</a></li>
<li><a href="#_fonctionnalitÃ©s_3">26. FonctionnalitÃ©s</a></li>
</ul>
</li>
<li><a href="#_gestion_des_personnes_rÃ©alisants_les_souhaits_et_qui_ne_sont_pas_connues">Gestion des personnes rÃ©alisants les souhaits et qui ne sont pas connues</a>
<ul class="sectlevel1">
<li><a href="#_modÃ©lisation_5">27. ModÃ©lisation</a></li>
<li><a href="#_fonctionnalitÃ©s_4">28. FonctionnalitÃ©s</a></li>
</ul>
</li>
<li><a href="#_pourquoi_sennuyer_Ã _Ã©crire_des_tests">Pourquoi s&#8217;ennuyer Ã  Ã©crire des tests?</a></li>
<li><a href="#_why_bother_with_test_discipline">Why Bother with Test Discipline?</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>On ne va pas se mentir: il existe enormÃ©ment de tutoriaux trÃ¨s bien rÃ©alisÃ©s sur "Comment rÃ©aliser une application Django" et autres "DÃ©ployer votre code en 2 minutes". On se disait juste que ces tutoriaux restaient relativement haut-niveau et se limitaient Ã  un contexte donnÃ©.</p>
</div>
<div class="paragraph">
<p>L&#8217;idÃ©e du texte ci-dessous est de jeter les bases d&#8217;un bon dÃ©veloppement, en survolant l&#8217;ensemble des outils permettant de suivre des lignes directrices reconnues, de maintenir une bonne qualitÃ© de code au travers des diffÃ©rentes Ã©tapes (du dÃ©veloppement au dÃ©ploiement) et de s&#8217;assurer du maintient correct de la base de code, en permettant Ã  n&#8217;importe qui de reprendre le dÃ©veloppement.</p>
</div>
<div class="paragraph">
<p>Ces idÃ©es ne s&#8217;appliquent pas uniquement Ã  Django et Ã  son cadre de travail, ni mÃªme au langage Python. Juste que ces deux bidules sont de bons candidats et que le cadre de travail est bien dÃ©fini et suffisamment flexible.</p>
</div>
<div class="paragraph">
<p>Django se prÃ©sente comme un `Framework Web pour perfectionnistes ayant des deadlines &lt;<a href="https://www.djangoproject.com/&gt;`_" class="bare">https://www.djangoproject.com/&gt;`_</a>.</p>
</div>
<div class="paragraph">
<p>Django suit quelques principes &lt;<a href="https://docs.djangoproject.com/en/dev/misc/design-philosophies/&gt;" class="bare">https://docs.djangoproject.com/en/dev/misc/design-philosophies/&gt;</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Faible couplage et forte cohÃ©sion, pour que chaque composant ait son indÃ©pendance.</p>
</li>
<li>
<p>Moins de code, plus de fonctionnalitÃ©s.</p>
</li>
<li>
<p>`Don&#8217;t repeat yourself &lt;<a href="https://fr.wikipedia.org/wiki/Sec&gt;`_" class="bare">https://fr.wikipedia.org/wiki/Sec&gt;`_</a>: ne pas se rÃ©pÃ©ter!</p>
</li>
<li>
<p>RapiditÃ© du dÃ©veloppement (aprÃ¨s une courbe d&#8217;apprentissage relativement ardue, malgrÃ© tout)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mis cÃ´tÃ© Ã  cÃ´tÃ©, l&#8217;application de ces principes permet une meilleure stabilitÃ© du projet. Dans la suite de ce chapitre, on verra comment configurer l&#8217;environnement, comment installer Django de maniÃ¨re isolÃ©e et comment dÃ©marrer un nouveau projet. On verra comment gÃ©rer correctement les dÃ©pendances, les versions et comment applique un score sur note code.</p>
</div>
<div class="paragraph">
<p>Finalement, on verra aussique la configuration proposÃ©e par dÃ©faut par le framework n&#8217;est pas idÃ©ale pour la majoritÃ© des cas.</p>
</div>
<div class="paragraph">
<p>Pour cela, on prÃ©sentera diffÃ©rents outils (mypy, flake8, black, &#8230;&#8203;), la rÃ©daction de tests unitaires et d&#8217;intÃ©gration pour limiter les rÃ©gressions, les rÃ¨gles de nomenclature et de contrÃ´le du contenu, ainsi que les bonnes Ã©tapes Ã  suivre pour arriver Ã  un dÃ©ploiement rapide et fonctionnel avec peu d&#8217;efforts.</p>
</div>
<div class="paragraph">
<p>Et tout Ã§a Ã  un seul et mÃªme endroit. Oui. :-)</p>
</div>
<div class="paragraph">
<p>Bonne lecture.</p>
</div>
</div>
</div>
<h1 id="_environnement_de_travail" class="sect0">Environnement de travail</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Avant de dÃ©marrer le dÃ©veloppement, il est nÃ©cessaire de passer un peu de temps sur la configuration de l&#8217;environnement.</p>
</div>
<div class="paragraph">
<p>Les morceaux de code seront dÃ©veloppÃ©s pour Python3.4+ et Django 1.8+. Ils nÃ©cessiteront peut-Ãªtre quelques adaptations pour fonctionner sur une version antÃ©rieure.</p>
</div>
<div class="paragraph">
<p><strong>Remarque</strong> : les commandes qui seront exÃ©cutÃ©s dans ce livre le seront depuis un shell sous GNU/Linux. Certaines devront donc Ãªtre adaptÃ©es si vous Ãªtes dans un autre environnemnet.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mÃ©thodologie_de_travail">1. MÃ©thodologie de travail</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour la mÃ©thode de travail et de dÃ©veloppement, on va se baser sur les <a href="https://12factor.net/fr/">The Twelve-factor App</a> - ou plus simplement les <strong>12 facteurs</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;idÃ©e derriÃ¨re cette mÃ©thode consiste Ã  pousser les concepts suivants (repris grossiÃ¨rement de la <a href="https://12factor.net/fr/">page d&#8217;introduction</a> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Faciliter la mise en place de phases d&#8217;automatisation; plus simplement, faciliter les mises Ã  jour applicatives, simplifier la gestion de l&#8217;hÃ´te, diminuer la divergence entre les diffÃ©rents environnements d&#8217;exÃ©cution et offrir la possibilitÃ© d&#8217;intÃ©grer le projet dans un processus d&#8217;<a href="https://en.wikipedia.org/wiki/Continuous_integration">intÃ©gration continue</a>/<a href="https://en.wikipedia.org/wiki/Continuous_deployment">dÃ©ploiement continu</a></p>
</li>
<li>
<p>Faciliter la mise Ã  pied de nouveaux dÃ©veloppeurs ou de personnes souhaitant rejoindre le projet.</p>
</li>
<li>
<p>Faciliter</p>
</li>
<li>
<p>Augmenter l&#8217;agilitÃ© gÃ©nÃ©rale du projet, en permettant une meilleure Ã©volutivitÃ© architecturale et une meilleure mise Ã  l&#8217;Ã©chelle - <em>Vous avez 5000 utilisateurs en plus? Ajoutez un serveur et on n&#8217;en parle plus ;-)</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En pratique, les idÃ©es planquÃ©es derriÃ¨re les quelques phrases ci-dessus permettront de monter facilement un nouvel environnement - qu&#8217;il soit sur la machine du petit nouveau ou sur un serveur Azure, Heroku, Digital Ocean ou votre nouveau Raspberry Pi ZÃ©ro cachÃ© Ã  la cave.</p>
</div>
<div class="paragraph">
<p>Pour reprendre de maniÃ¨re trÃ¨s brute les diffÃ©rentes idÃ©es derriÃ¨re cette mÃ©thode, on a:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
pensez Ã  retravailler la partie ci-dessous; la version anglophone semble plus comprÃ©hensible&#8230;&#8203; :-/
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Une base de code suivie avec un systÃ¨me de contrÃ´le de version, plusieurs dÃ©ploiements</p>
</li>
<li>
<p>DÃ©clarez explicitement et isolez les dÃ©pendances</p>
</li>
<li>
<p>Stockez la configuration dans lâenvironnement</p>
</li>
<li>
<p>Traitez les services externes comme des ressources attachÃ©es</p>
</li>
<li>
<p>SÃ©parez strictement les Ã©tapes dâassemblage et dâexÃ©cution</p>
</li>
<li>
<p>ExÃ©cutez lâapplication comme un ou plusieurs processus sans Ã©tat</p>
</li>
<li>
<p>Exportez les services via des associations de ports</p>
</li>
<li>
<p>Grossissez Ã  lâaide du modÃ¨le de processus</p>
</li>
<li>
<p>Maximisez la robustesse avec des dÃ©marrages rapides et des arrÃªts gracieux</p>
</li>
<li>
<p>Gardez le dÃ©veloppement, la validation et la production aussi proches que possible</p>
</li>
<li>
<p>Traitez les logs comme des flux dâÃ©vÃ¨nements</p>
</li>
<li>
<p>Lancez les processus dâadministration et de maintenance comme des one-off-processes</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. ConcrÃ¨tement</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concept</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base de code suivie avec un systÃ¨me de contrÃ´le de version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git, Mercurial, SVN, &#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chaque dÃ©ploiement dÃ©marre Ã  partir d&#8217;une base de code unique. Il n&#8217;y pas de dÃ©pÃ´t "Prod", "Staging" ou "Dev". Il n&#8217;y en a qu&#8217;un et un seul.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DÃ©claration explicite et isolation des dÃ©pendances</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pyenv, environnements virtuels, RVM, &#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Afin de ne pas perturber les dÃ©pendances systÃ¨mes, chaque application doit disposer d&#8217;un environnement sain par dÃ©faut.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration dans l&#8217;environnement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fichiers .ENV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Toute clÃ© de configuration (nom du serveur de base de donnÃ©es, adresse d&#8217;un service Web externe, clÃ© d&#8217;API pour l&#8217;interrogation d&#8217;une ressource, &#8230;&#8203;) sera dÃ©finie directement au niveau de l&#8217;hÃ´te - Ã  aucun moment, on ne doit trouver un mot de passe en clair dans le dÃ©pÃ´t source ou une valeur susceptible d&#8217;Ã©voluer, Ã©crite en dur dans le code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Services externes = ressources locales</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fichiers .ENV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chaque ressource doit pouvoir Ãªtre interchangeable avec une autre, sans modification du code source. La solution consiste Ã  passer toutes ces informations (nom du serveur et type de base de donnÃ©es, clÃ© d&#8217;authentification, &#8230;&#8203;) directement via des variables d&#8217;environnement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bien sÃ©parer les Ã©tapes de construction des Ã©tapes de mise Ã  disposition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capistrano, Gitea, un serveur d&#8217;artefacts, &#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L&#8217;idÃ©e est de pouvoir rÃ©cupÃ©rer une version spÃ©cifique du code, sans que celle-ci ne puisse avoir Ã©tÃ© modifiÃ©e. Git permet bien de gÃ©rer des versions (au travers des tags), mais ces Ã©lÃ©ments peuvent sans doute Ãªtre modifiÃ©s directement au travers de l&#8217;historique.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_environnements_virtuels">2. Environnements virtuels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On va commencer avec la partie la moins funky, mais la plus utile, dans la vie d&#8217;un dÃ©veloppeur: la gestion et l&#8217;isolation des dÃ©pendances.</p>
</div>
<div class="paragraph">
<p>Il est tout Ã  fait possible de s&#8217;en passer complÃ¨tement dans le cadre de "petits" projets ou d&#8217;applications dÃ©ployÃ©es sur des machines dÃ©diÃ©es, et de fonctionner Ã  grand renforts de "sudo" et d&#8217;installation globale des dÃ©pendances. Cette pratique est cependant fortement dÃ©conseillÃ©e pour plusieurs raisons:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pour la reproductibilitÃ© d&#8217;un environnement spÃ©cifique. Cela Ã©vite notamment les rÃ©ponses type "Ca juste marche chez moi", puisqu&#8217;on a la possibilitÃ© de construire un environnement sain et appliquer des dÃ©pendances identiques, quelle que soit la machine hÃ´te.</p>
</li>
<li>
<p>Il est tout Ã  fait envisagable que deux applications soient dÃ©ployÃ©es sur un mÃªme hÃ´te, et nÃ©cessitent chacune deux versions diffÃ©rentes d&#8217;une mÃªme dÃ©pendance.</p>
</li>
</ol>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>But it works on my machine! Then, we&#8217;ll ship your machine.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; A famous meme<br>
<cite>And this is how Docker was born.</cite>
</div>
</div>
<div class="paragraph">
<p>Nous allons utiliser le module <code>venv</code> afin de crÃ©er un `environnement virtuel &lt;<a href="http://sametmax.com/les-environnement-virtuels-python-virtualenv-et-virtualenvwrapper/&gt;`_" class="bare">http://sametmax.com/les-environnement-virtuels-python-virtualenv-et-virtualenvwrapper/&gt;`_</a> pour python.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
auparavant, on utilisait <code>virtualenvwrapper</code>. mais cela fait plusieurs annÃ©es que je ne l&#8217;utilise plus. On l&#8217;intÃ¨gre quand mÃªme ?
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_crÃ©ation_de_lenvironnement_virtuel">2.1. CrÃ©ation de l&#8217;environnement virtuel</h3>
<div class="paragraph">
<p>Commencons par crÃ©er un environnement virtuel, afin d&#8217;y stocker les dÃ©pendances. Lancez <code>python3 -m venv gwift-env</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nt">---</span>
IntÃ©grer les rÃ©sultats de la crÃ©ation de l<span class="s1">'environnement
---</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ceci crÃ©era l&#8217;arborescence de fichiers suivante, qui peut Ã  nouveau Ãªtre un peu diffÃ©rente en fonction du systÃ¨me d&#8217;exploitation:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ ls .virtualenvs/gwift-env
bin include lib</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous pouvons ensuite l&#8217;activer grÃ¢ce Ã  la commande <code>source gwift-env</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nt">---</span>
IntÃ©grer les rÃ©sultats de l<span class="s1">'accÃ¨s de l'</span>environnement
<span class="nt">---</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le <strong>shell</strong> signale que nous sommes bien dans l&#8217;environnement <code>gwift-env</code> en l&#8217;affichant avant le <code>$</code>. Par la suite, nous considÃ©rerons que l&#8217;environnement virtuel est toujours activÃ©, mÃªme si <code>gwift-env</code> n&#8217;est pas prÃ©sent devant chaque <code>$</code>.</p>
</div>
<div class="paragraph">
<p>A prÃ©sent, tous les binaires de cet environnement prendront le pas sur les binaires du systÃ¨me. De la mÃªme maniÃ¨re, une variable <code>PATH</code> propre est dÃ©finie et utilisÃ©e, afin que les librairies Python y soient stockÃ©es. C&#8217;est donc dans cet environnement virtuel que nous retrouverons le code source de Django, ainsi que des librairies externes pour Python une fois que nous les aurons installÃ©es.</p>
</div>
<div class="paragraph">
<p>Pour dÃ©sactiver l&#8217;environnement virtuel, il suffira d&#8217;utiliser la commande <code>deactivate</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_django_et_crÃ©ation_du_rÃ©pertoire_de_travail">2.2. Installation de Django et crÃ©ation du rÃ©pertoire de travail</h3>
<div class="paragraph">
<p>Comme l&#8217;environnement est activÃ©, on peut Ã  prÃ©sent y installer Django. La librairie restera indÃ©pendante du reste du systÃ¨me, et ne polluera pas les autres projets.</p>
</div>
<div class="paragraph">
<p>C&#8217;est parti: <code>pip install django</code>!</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ pip install django
Collecting django
  Downloading Django-X.Y.Z
100% |################################|
Installing collected packages: django
Successfully installed django-X.Y.Z</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les commandes de crÃ©ation d&#8217;un nouveau site sont Ã  prÃ©sent disponibles, la principale Ã©tant <code>django-admin startproject</code>. Par la suite, nous utiliserons <code>manage.py</code>, qui constitue un <strong>wrapper</strong> autour de <code>django-admin</code>.</p>
</div>
<div class="paragraph">
<p>Pour dÃ©marrer notre projet, nous lanÃ§ons donc <code>django-admin startproject gwift</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>django-admin startproject gwift</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette action a pour effet de crÃ©er un nouveau dossier <code>gwift</code>, dans lequel on trouve la structure suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>tree gwift
gwift
âââ gwift
âÂ Â  âââ __init__.py
âÂ Â  âââ settings.py
âÂ Â  âââ urls.py
âÂ Â  âââ wsgi.py
âââ manage.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est sans ce rÃ©pertoire que vont vivre tous les fichiers liÃ©s au projet. Le but est de faire en sorte que toutes les opÃ©rations (maintenance, dÃ©ploiement, Ã©criture, tests, &#8230;&#8203;) puissent se faire Ã  partir d&#8217;un seul point d&#8217;entrÃ©e. Tant qu&#8217;on y est, nous pouvons rajouter les rÃ©pertoires utiles Ã  la gestion de notre projet, Ã  savoir la documentation, les dÃ©pendances et le README:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>docs requirements
<span class="nv">$ </span><span class="nb">touch </span>docs/README.md</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>tree gwift
gwift
âââ gwift
âÂ Â  âââ __init__.py
âÂ Â  âââ settings.py
âÂ Â  âââ urls.py
âÂ Â  âââ wsgi.py
âââ manage.py
|-- docs/
|-- requirements/
|-- README</code></pre>
</div>
</div>
<div class="paragraph">
<p>Chacun de ces fichiers sert Ã :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>settings.py</code> contient tous les paramÃ¨tres globaux Ã  notre projet.</p>
</li>
<li>
<p><code>urls.py</code> contient les variables de routes, les adresses utilisÃ©es et les fonctions vers lesquelles elles pointent.</p>
</li>
<li>
<p><code>manage.py</code>, pour toutes les commandes de gestion.</p>
</li>
<li>
<p><code>wsgi.py</code> contient la dÃ©finition de l&#8217;interface `WSGI &lt;<a href="https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface&gt;`_" class="bare">https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface&gt;`_</a>, qui permettra Ã  votre serveur Web (Nginx, Apache, &#8230;&#8203;) de faire un pont vers votre projet.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
dÃ©placer la configuration dans un rÃ©pertoire <code>config</code> Ã  part.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_gestion_des_dÃ©pendances">2.3. Gestion des dÃ©pendances</h3>
<div class="paragraph">
<p>Comme nous venons d&#8217;ajouter une dÃ©pendance Ã  notre projet, nous allons crÃ©er un fichier reprenant tous les dÃ©pendances de notre projet. Celles-ci sont normalement placÃ©es dans un fichier <code>requirements.txt</code>. Dans un premier temps, ce fichier peut Ãªtre placÃ© directement Ã  la racine du projet, mais on prÃ©fÃ©rera rapidement le dÃ©placer dans un sous-rÃ©pertoire spÃ©cifique (<code>requirements</code>), afin de grouper les dÃ©pendances en fonction de leur utilitÃ©:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>base.txt</code></p>
</li>
<li>
<p><code>dev.txt</code></p>
</li>
<li>
<p><code>staging.txt</code></p>
</li>
<li>
<p><code>production.txt</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Au dÃ©but de chaque fichier, il suffira d&#8217;ajouter la ligne <code>-r base.txt</code>, puis de lancer l&#8217;installation grÃ¢ce Ã  un <code>pip install -r &lt;nom du fichier&gt;</code>. De cette maniÃ¨re, il est tout Ã  fait acceptable de n&#8217;installer <code>flake8</code> et <code>django-debug-toolbar</code> qu&#8217;en dÃ©veloppement par exemple.  Dans l&#8217;immÃ©diat, ajoutez simplement <code>django</code> dans le fichier <code>requirements/base.txt</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo </span>django <span class="o">&gt;&gt;</span> requirements/base.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Par la suite, il vous faudra <strong>absolument</strong> spÃ©cifier les versions Ã  utiliser: les librairies que vous utilisez comme dÃ©pendances Ã©voluent, de la mÃªme maniÃ¨re que vos projets. Des fonctions sont cassÃ©es, certaines signatures sont modifiÃ©es, des comportements sont altÃ©rÃ©s, etc. Si vous voulez Ãªtre sÃ»r et certain que le code que vous avez Ã©crit continue Ã  fonctionner, spÃ©cifiez la version de chaque librairie de dÃ©pendances. Avec les mÃ©canismes d&#8217;intÃ©gration continue et de tests unitaires, on verra plus loin comment se prÃ©munir d&#8217;un changement inattendu.</p>
</div>
</div>
<div class="sect2">
<h3 id="_structure_finale_de_lenvironnement">2.4. Structure finale de l&#8217;environnement</h3>
<div class="paragraph">
<p>Nous avons donc la strucutre finale pour notre environnement de travail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>tree ~/gwift-project
gwift
âââ docs
âÂ Â  âââ README.md
âââ gwift
âÂ Â  âââ __init__.py
âÂ Â  âââ settings.py
âÂ Â  âââ urls.py
âÂ Â  âââ wsgi.py
âÂ Â  manage.py
âââ requirements
    âââ base.txt</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_django">3. Django</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comme on l&#8217;a vu ci-dessus, <code>django-admin</code> permet de crÃ©er un nouveau projet. On fait ici une distinction entre un <strong>projet</strong> et une <strong>application</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Projet</strong>: ensemble des applications, paramÃ¨tres, pages HTML, middlwares, dÃ©pendances, etc., qui font que votre code fait ce qu&#8217;il est sensÃ© faire.</p>
</li>
<li>
<p><strong>Application</strong>: <strong>contexte</strong> Ã©ventuellement indÃ©pendant, permettant d&#8217;effectuer une partie isolÃ©e de ce que l&#8217;on veut faire.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour <code>gwift</code>, on va notamment avoir une application pour la gestion des listes de souhaits et des Ã©lÃ©ments, une deuxiÃ¨me application pour la gestion des utilisateurs, voire une troisiÃ¨me application qui gÃ©rera les partages entre utilisateurs et listes.</p>
</div>
<div class="paragraph">
<p>On voit bien ici le principe de <strong>contexte</strong>: l&#8217;application viendra avec son modÃ¨le, ses tests, ses vues et son paramÃ©trage. Elle pourra Ã©ventuellement Ãªtre rÃ©utilisÃ©e dans un autre projet. C&#8217;est en Ã§a que consistent les `paquets Django &lt;<a href="https://www.djangopackages.com/&gt;`_" class="bare">https://www.djangopackages.com/&gt;`_</a> dÃ©jÃ  disponibles: ce sont simplement de petites applications empaquetÃ©es pour Ãªtre rÃ©utilisÃ©es (eg. `Django-Rest-Framework &lt;<a href="https://github.com/tomchristie/django-rest-framework&gt;`" class="bare">https://github.com/tomchristie/django-rest-framework&gt;`</a><em>, `Django-Debug-Toolbar &lt;<a href="https://github.com/django-debug-toolbar/django-debug-toolbar&gt;`" class="bare">https://github.com/django-debug-toolbar/django-debug-toolbar&gt;`</a></em>, &#8230;&#8203;).</p>
</div>
<div class="sect2">
<h3 id="_gestion">3.1. Gestion</h3>
<div class="paragraph">
<p>Comme expliquÃ© un peu plus haut, le fichier <code>manage.py</code> est un <strong>wrapper</strong> sur les commandes <code>django-admin</code>. A partir de maintenant, nous n&#8217;utiliserons plus que celui-lÃ  pour tout ce qui touchera Ã  la gestion de notre projet:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>manage.py check</code> pour vÃ©rifier (en surface&#8230;&#8203;) que votre projet ne rencontre aucune erreur</p>
</li>
<li>
<p><code>manage.py runserver</code> pour lancer un serveur de dÃ©veloppement</p>
</li>
<li>
<p><code>manage.py test</code> pour dÃ©couvrir les tests unitaires disponibles et les lancer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La liste complÃ¨te peut Ãªtre affichÃ©e avec <code>manage.py help</code>. Vous remarquerez que ces commandes sont groupÃ©es selon diffÃ©rentes catÃ©gories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>auth</strong>: crÃ©ation d&#8217;un nouveau super-utilisateur, changer le mot de passe pour un utilisateur existant.</p>
</li>
<li>
<p><strong>django</strong>: vÃ©rifier la <strong>compliance</strong> du projet, lancer un <strong>shell</strong>, <strong>dumper</strong> les donnÃ©es de la base, effectuer une migration du schÃ©ma, &#8230;&#8203;</p>
</li>
<li>
<p><strong>sessions</strong>: suppressions des sessions en cours</p>
</li>
<li>
<p><strong>staticfiles</strong>: gestion des fichiers statiques et lancement du serveur de dÃ©veloppement.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous verrons plus tard comment ajouter de nouvelles commandes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_structure_dune_application">3.2. Structure d&#8217;une application</h3>
<div class="paragraph">
<p>Maintenant que l&#8217;on a vu Ã  quoi servait <code>manage.py</code>, on peut crÃ©er notre nouvelle application grÃ¢ce Ã  la commande <code>manage.py startapp &lt;label&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Cette application servira Ã  structurer les listes de souhaits, les Ã©lÃ©ments qui les composent et les parties que chaque utilisateur pourra offrir. Essayez de trouver un nom Ã©loquent, court et qui rÃ©sume bien ce que fait l&#8217;application. Pour nous, ce sera donc <code>wish</code>. C&#8217;est parti pour <code>manage.py startapp wish</code>!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>python manage.py startapp wish</code></pre>
</div>
</div>
<div class="paragraph">
<p>RÃ©sultat? Django nous a crÃ©Ã© un rÃ©pertoire <code>wish</code>, dans lequel on trouve les fichiers suivants:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> wish
admin.py  __init__.py  migrations  models.py  tests.py  views.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>En rÃ©sumÃ©, chaque fichier a la fonction suivante:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>admin.py</code> servira Ã  structurer l&#8217;administration de notre application. Chaque information peut en effet Ãªtre administrÃ©e facilement au travers d&#8217;une interface gÃ©nÃ©rÃ©e Ã  la volÃ©e par le framework. On y reviendra par la suite.</p>
</li>
<li>
<p><code><em>init</em>.py</code> pour que notre rÃ©pertoire <code>wish</code> soit converti en package Python.</p>
</li>
<li>
<p><code>migrations/</code>, dossier dans lequel seront stockÃ©es toutes les diffÃ©rentes migrations de notre application.</p>
</li>
<li>
<p><code>models.py</code> pour reprÃ©senter et structurer nos donnÃ©es.</p>
</li>
<li>
<p><code>tests.py</code> pour les tests unitaires.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tests_unitaires">3.3. Tests unitaires</h3>
<div class="paragraph">
<p>Plein de trucs Ã  complÃ©ter ici ;-) Est-ce qu&#8217;on passe par pytest ou par le framework intÃ©grÃ© ? Quels sont les avantages de l&#8217;un % Ã  l&#8217;autre ?
 * <code>views.py</code> pour dÃ©finir ce que nous pouvons faire avec nos donnÃ©es.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_construire_des_applications_maintenables">4. Construire des applications maintenables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour cette section, je me base d&#8217;un rÃ©sumÃ© de l&#8217;ebook <strong>Building Maintenable Software</strong> disponible chez `O&#8217;Reilly &lt;<a href="http://shop.oreilly.com/product/0636920049555.do`_" class="bare">http://shop.oreilly.com/product/0636920049555.do`_</a> qui vaut clairement le dÃ©tour pour poser les bases d&#8217;un projet.</p>
</div>
<div class="paragraph">
<p>Ce livre rÃ©partit un ensemble de conseils parmi quatre niveaux de composants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les mÃ©thodes et fonctions</p>
</li>
<li>
<p>Les classes</p>
</li>
<li>
<p>Les composants</p>
</li>
<li>
<p>Et de maniÃ¨re plus gÃ©nÃ©rale.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_au_niveau_des_mÃ©thodes_et_fonctions">4.1. Au niveau des mÃ©thodes et fonctions</h3>
<div class="ulist">
<ul>
<li>
<p>Gardez vos mÃ©thodes/fonctions courtes. Pas plus de 15 lignes, en comptant les commentaires. Des exceptions sont possibles, mais dans une certaine mesure uniquement (pas plus de 6.9% de plus de 60 lignes; pas plus de 22.3% de plus de 30 lignes, au plus 43.7% de plus de 15 lignes et au moins 56.3% en dessous de 15 lignes). Oui, c&#8217;est dur Ã  tenir, mais faisable.</p>
</li>
<li>
<p>Conserver une complexitÃ© de McCabe en dessous de 5, c&#8217;est-Ã -dire avec quatre branches au maximum. A nouveau, si on a une mÃ©thode avec une complexitÃ© cyclomatique de 15, la sÃ©parer en 3 fonctions avec une complexitÃ© de 5 conservera globalement le nombre 15, mais rendra le code de chacune de ces mÃ©thodes plus lisible, plus maintenable.</p>
</li>
<li>
<p>N&#8217;Ã©crivez votre code qu&#8217;une seule fois: Ã©vitez les duplications, copie, etc., c&#8217;est juste mal: imaginez qu&#8217;un bug soit dÃ©couvert dans une fonction; il devra alors Ãªtre corrigÃ© dans toutes les fonctions qui auront Ã©tÃ© copiÃ©es/collÃ©es. C&#8217;est aussi une forme de rÃ©gression.</p>
</li>
<li>
<p>Conservez de petites interfaces. Quatre paramÃ¨tres, pas plus. Au besoin, refactorisez certains paramÃ¨tres dans une classe, plus facile Ã  tester.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_au_niveau_des_classes">4.2. Au niveau des classes</h3>
<div class="ulist">
<ul>
<li>
<p>PrivilÃ©giez un couplage faible entre vos classes. Ceci n&#8217;est pas toujours possible, mais dans la mesure du possible, Ã©clatez vos classes en fonction de leur domaine de compÃ©tences. L&#8217;implÃ©mentation du service <code>UserNotificationsService</code> ne doit pas forcÃ©ment se trouver embarquÃ© dans une classe <code>UserService</code>. De mÃªme, pensez Ã  passer par une interface (commune Ã  plusieurs classes), afin d&#8217;ajouter une couche d&#8217;abstraction. La classe appellante n&#8217;aura alors que les mÃ©thodes offertes par l&#8217;interface comme points d&#8217;entrÃ©e.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_au_niveau_des_composants">4.3. Au niveau des composants</h3>
<div class="ulist">
<ul>
<li>
<p>Tout comme pour les classes, il faut conserver un couplage faible au niveau des composants Ã©galement. Une maniÃ¨re d&#8217;arriver Ã  ce rÃ©sultat est de conserver un nombre de points d&#8217;entrÃ©e restreint, et d&#8217;Ã©viter qu&#8217;on ne puisse contacter trop facilement des couches sÃ©parÃ©es de l&#8217;architecture. Pour une architecture n-tiers par exemple, la couche d&#8217;abstraction Ã  la base de donnÃ©es ne peut Ãªtre connue que des services; sans cela, au bout de quelques semaines, n&#8217;importe quelle couche de prÃ©sentation risque de contacter directement la base de donnÃ©es, "juste parce qu&#8217;elle en a la possibilitÃ©". Vous pourrez Ã©galement passer par des interfaces, afin de rÃ©duire le nombre de points d&#8217;entrÃ©e connus par un composant externe (qui ne connaÃ®tra par exemple que <code>IFileTransfer</code> avec ses mÃ©thodes <code>put</code> et <code>get</code>, et non pas les dÃ©tails d&#8217;implÃ©mentation complet d&#8217;une classe <code>FtpFileTransfer</code> ou <code>SshFileTransfer</code>).</p>
</li>
<li>
<p>Conserver un bon balancement au niveau des composants: Ã©vitez qu&#8217;un composant <strong>A</strong> ne soit un Ã©norme mastodonte, alors que le composant juste Ã  cÃ´tÃ© n&#8217;est capable que d&#8217;une action. De cette maniÃ¨re, les nouvelles fonctionnalitÃ©s seront mieux rÃ©parties parmi les diffÃ©rents systÃ¨mes, et les responsabilitÃ©s plus faciles Ã  gÃ©rer. Un conseil est d&#8217;avoir un nombre de composants compris entre 6 et 12 (idÃ©alement, 12), et que ces composants soit approximativement de mÃªme taille.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_de_maniÃ¨re_plus_gÃ©nÃ©rale">4.4. De maniÃ¨re plus gÃ©nÃ©rale</h3>
<div class="ulist">
<ul>
<li>
<p>Conserver une densitÃ© de code faible: il n&#8217;est Ã©videmment pas possible d&#8217;implÃ©menter n&#8217;importe quelle nouvelle fonctionnalitÃ© en moins de 20 lignes de code; l&#8217;idÃ©e ici est que la rÃ©Ã©criture du projet ne prenne pas plus de 20 hommes/mois. Pour cela, il faut (activement) passer du temps Ã  rÃ©duire la taille du code existant: soit en faisant du refactoring (intensif?), soit en utilisant des librairies existantes, soit en explosant un systÃ¨me existant en plusieurs sous-systÃ¨mes communiquant entre eux. Mais surtout en Ã©vitant de copier/coller bÃªtement du code existant.</p>
</li>
<li>
<p>Automatiser les tests, ajouter un environnement d&#8217;intÃ©gration continue dÃ¨s le dÃ©but du projet et vÃ©rifier par des outils les points ci-dessus.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_en_pratique">4.5. En pratique</h3>
<div class="paragraph">
<p>Par rapport aux points repris ci-dessus, l&#8217;environnement Python et le framework Django proposent un ensemble d&#8217;outils intÃ©grÃ©s qui permettent de rÃ©pondre Ã  chaque point. Avant d&#8217;aller plus loin, donc, un petit point sur les conventions, les tests (unitaires, orientÃ©s comportement, basÃ©s sur la documentation, &#8230;&#8203;), la gestion de version du code et sur la documentation. Plus que dans tout langage compilÃ©, ceux-ci sont pratiquement obligatoires. Vous pourrez les voir comme une perte de temps dans un premier temps, mais nous vous promettons qu&#8217;ils vous en feront gagner par la suite.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_chaÃ®ne_doutils">5. ChaÃ®ne d&#8217;outils</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le langage Python fonctionne avec un systÃ¨me dâamÃ©liorations basÃ©es sur des propositions: les PEP, ou âPython Enhancement Proposalâ.</p>
</div>
<div class="paragraph">
<p>Celle qui va nous intÃ©resser pour cette section est la <a href="https://www.python.org/dev/peps/pep-0008/">PEP 8&#8201;&#8212;&#8201;Style Guide for Python Code</a>. Elle spÃ©cifie comment du code Python doit Ãªtre organisÃ© ou formatÃ©, quelles sont les conventions pour lâindentation, le nommage des variables et des classes, â¦ En bref, elle dÃ©crit comment Ã©crire du code proprement pour que dâautres dÃ©veloppeurs puissent le reprendre facilement, ou simplement que votre base de code ne dÃ©rive lentement vers un seuil de non-maintenabilitÃ©.</p>
</div>
<div class="sect2">
<h3 id="_pep8">5.1. PEP8</h3>
<div class="paragraph">
<p>Le langage Python fonctionne avec un systÃ¨me d&#8217;amÃ©liorations basÃ©es sur des propositions: les PEP, ou "<strong>Python Enhancement Proposal</strong>". Chacune d&#8217;entre elles doit Ãªtre approuvÃ©e par le `Benevolent Dictator For Life &lt;<a href="http://fr.wikipedia.org/wiki/Benevolent_Dictator_for_Life&gt;`_" class="bare">http://fr.wikipedia.org/wiki/Benevolent_Dictator_for_Life&gt;`_</a>.</p>
</div>
<div class="paragraph">
<p>La PEP qui nous intÃ©resse plus particuliÃ¨rement pour la suite est la `PEP-8 &lt;<a href="https://www.python.org/dev/peps/pep-0008/&gt;`_" class="bare">https://www.python.org/dev/peps/pep-0008/&gt;`_</a>, ou "Style Guide for Python Code". Elle spÃ©cifie des conventions d&#8217;organisation et de formatage de code Python, quelles sont les conventions pour l&#8217;indentation, le nommage des variables et des classes, etc. En bref, elle dÃ©crit comment Ã©crire du code proprement pour que d&#8217;autres dÃ©veloppeurs puissent le reprendre facilement, ou simplement que votre base de code ne dÃ©rive lentement vers un seuil de non-maintenabilitÃ©.</p>
</div>
<div class="paragraph">
<p>Sur cette base, un outil existe et listera l&#8217;ensemble des conventions qui ne sont pas correctement suivies dans votre projet: pep8. Pour l&#8217;installer, passez par pip. Lancez ensuite la commande pep8 suivie du chemin Ã  analyser (<code>.</code>, le nom d&#8217;un rÃ©pertoire, le nom d&#8217;un fichier <code>.py</code>, &#8230;&#8203;). Si vous souhaitez uniquement avoir le nombre d&#8217;erreur de chaque type, saisissez les options <code>--statistics -qq</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ pep8 . --statistics -qq</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>7       E101 indentation contains mixed spaces and tabs
6       E122 continuation line missing indentation or outdented
8       E127 continuation line over-indented for visual indent
23      E128 continuation line under-indented for visual indent
3       E131 continuation line unaligned for hanging indent
12      E201 whitespace after '{'
13      E202 whitespace before '}'
86      E203 whitespace before ':'</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si vous ne voulez pas Ãªtre dÃ©rangÃ© sur votre maniÃ¨re de coder, et que vous voulez juste avoir un retour sur une analyse de votre code, essayez <code>pyflakes</code>: il analysera vos sources Ã  la recherche de sources d&#8217;erreurs possibles (imports inutilisÃ©s, mÃ©thodes inconnues, etc.).</p>
</div>
<div class="paragraph">
<p>Finalement, la solution qui couvre ces deux domaines existe et s&#8217;intitule `flake8 &lt;<a href="https://github.com/PyCQA/flake8&gt;`_" class="bare">https://github.com/PyCQA/flake8&gt;`_</a>. Sur base la mÃªme interface que <code>pep8</code>, vous aurez en plus tous les avantages liÃ©s Ã  <code>pyflakes</code> concernant votre code source.</p>
</div>
<div class="sect3">
<h4 id="_pep257">5.1.1. PEP257</h4>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>todo:: Ã  remplir avec <code>pydocstyle</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_tests">5.1.2. Tests</h4>
<div class="paragraph">
<p>Comme tout bon <strong>framework</strong> qui se respecte, Django embarque tout un environnement facilitant le lancement de tests; chaque application est crÃ©Ã©e par dÃ©faut avec un fichier <strong>tests.py</strong>, qui inclut la classe <code>TestCase</code> depuis le package <code>django.test</code>:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>from django.test import TestCase</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class TestModel(TestCase):
    def test_str(self):
        raise NotImplementedError('Not implemented yet')</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>IdÃ©alement, chaque fonction ou mÃ©thode doit Ãªtre testÃ©e afin de bien en valider le fonctionnement, indÃ©pendamment du reste des composants. Cela permet d&#8217;isoler chaque bloc de maniÃ¨re unitaire, et permet de ne pas rencontrer de rÃ©gression lors de l&#8217;ajout d&#8217;une nouvelle fonctionnalitÃ© ou de la modification d&#8217;une existante. Il existe plusieurs types de tests (intÃ©gration, comportement, &#8230;&#8203;); on ne parlera ici que des tests unitaires.</p>
</div>
<div class="paragraph">
<p>Avoir des tests, c&#8217;est bien. S&#8217;assurer que tout est testÃ©, c&#8217;est mieux. C&#8217;est lÃ  qu&#8217;il est utile d&#8217;avoir le pourcentage de code couvert par les diffÃ©rents tests, pour savoir ce qui peut Ãªtre amÃ©liorÃ©.</p>
</div>
</div>
<div class="sect3">
<h4 id="_couverture_de_code">5.1.3. Couverture de code</h4>
<div class="paragraph">
<p>La couverture de code est une analyse qui donne un pourcentage liÃ© Ã  la quantitÃ© de code couvert par les tests. Attention qu&#8217;il ne s&#8217;agit pas de vÃ©rifier que le code est <strong>bien</strong> testÃ©, mais juste de vÃ©rifier <strong>quelle partie</strong> du code est testÃ©e. En Python, il existe le paquet `coverage &lt;<a href="https://pypi.python.org/pypi/coverage/&gt;`_" class="bare">https://pypi.python.org/pypi/coverage/&gt;`_</a>, qui se charge d&#8217;Ã©valuer le pourcentage de code couvert par les tests. Ajoutez-le dans le fichier <code>requirements/base.txt</code>, et lancez une couverture de code grÃ¢ce Ã  la commande <code>coverage</code>. La configuration peut se faire dans un fichier <code>.coveragerc</code> que vous placerez Ã  la racine de votre projet, et qui sera lu lors de l&#8217;exÃ©cution.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre># requirements/base.text
[...]
coverage
django_coverage_plugin</pre>
</div>
</div>
</li>
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre># .coveragerc to control coverage.py
[run]
branch = True
omit = ../*migrations*
plugins =
    django_coverage_plugin</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>[report]
ignore_errors = True</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>[html]
directory = coverage_html_report</pre>
</div>
</div>
</li>
<li>
<p>todo:: le bloc ci-dessous est Ã  revoir pour isoler la configuration.</p>
</li>
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ coverage run --source "." manage.py test
$ coverage report</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Name                      Stmts   Miss  Cover
---------------------------------------------
gwift\gwift\__init__.py       0      0   100%
gwift\gwift\settings.py      17      0   100%
gwift\gwift\urls.py           5      5     0%
gwift\gwift\wsgi.py           4      4     0%
gwift\manage.py               6      0   100%
gwift\wish\__init__.py        0      0   100%
gwift\wish\admin.py           1      0   100%
gwift\wish\models.py         49     16    67%
gwift\wish\tests.py           1      1     0%
gwift\wish\views.py           6      6     0%
---------------------------------------------
TOTAL                        89     32    64%</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ coverage html</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ceci vous affichera non seulement la couverture de code estimÃ©e, et gÃ©nÃ©rera Ã©galement vos fichiers sources avec les branches non couvertes. Pour gagner un peu de temps, n&#8217;hÃ©sitez pas Ã  crÃ©er un fichier <code>Makefile</code> que vous placerez Ã  la racine du projet. L&#8217;exemple ci-dessous permettra, grÃ¢ce Ã  la commande <code>make coverage</code>, d&#8217;arriver au mÃªme rÃ©sultat que ci-dessus:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre># Makefile for gwift
#</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># User-friendly check for coverage
ifeq ($(shell which coverage &gt;/dev/null 2&gt;&amp;1; echo $$?), 1)
  $(error The 'coverage' command was not found. Make sure you have coverage installed)
endif</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>.PHONY: help coverage</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>help:
	@echo "  coverage to run coverage check of the source files."</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>coverage:
	coverage run --source='.' manage.py test; coverage report; coverage html;
	@echo "Testing of coverage in the sources finished."</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_complexitÃ©_de_mccabe">5.1.4. ComplexitÃ© de McCabe</h4>
<div class="paragraph">
<p>La `complexitÃ© cyclomatique &lt;<a href="https://fr.wikipedia.org/wiki/Nombre_cyclomatique&gt;`_" class="bare">https://fr.wikipedia.org/wiki/Nombre_cyclomatique&gt;`_</a> (ou complexitÃ© de McCabe) peut s&#8217;apparenter Ã  mesure de difficultÃ© de comprÃ©hension du code, en fonction du nombre d&#8217;embranchements trouvÃ©s dans une mÃªme section. Quand le cycle d&#8217;exÃ©cution du code rencontre une condition, il peut soit rentrer dedans, soit passer directement Ã  la suite. Par exemple:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>if True == True:
    pass # never happens</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># continue ...</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>La condition existe, mais on ne passera jamais dedans. A l&#8217;inverse, le code suivant aura une complexitÃ© pourrie Ã  cause du nombre de conditions imbriquÃ©es:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>def compare(a, b, c, d, e):
    if a == b:
        if b == c:
            if c == d:
                if d == e:
                    print('Yeah!')
                    return 1</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Potentiellement, les tests unitaires qui seront nÃ©cessaires Ã  couvrir tous les cas de figure seront au nombre de quatre: le cas par dÃ©faut (a est diffÃ©rent de b, rien ne se passe), puis les autres cas, jusqu&#8217;Ã  arriver Ã  l&#8217;impression Ã  l&#8217;Ã©cran et Ã  la valeur de retour. La complexitÃ© cyclomatique d&#8217;un bloc est Ã©valuÃ©e sur base du nombre d&#8217;embranchements possibles; par dÃ©faut, sa valeur est de 1. Si on rencontre une condition, elle passera Ã  2, etc.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;exemple ci-dessous, on va en fait devoir vÃ©rifier au moins chacun des cas pour s&#8217;assurer que la couverture est complÃ¨te. On devrait donc trouver:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Un test pour entrer (ou non) dans la condition <code>a == b</code></p>
</li>
<li>
<p>Un test pour entrer (ou non) dans la condition <code>b == c</code></p>
</li>
<li>
<p>Un test pour entrer (ou non) dans la condition <code>c == d</code></p>
</li>
<li>
<p>Un test pour entrer (ou non) dans la condition <code>d == e</code></p>
</li>
<li>
<p>Et s&#8217;assurer que n&#8217;importe quel autre cas retournera la valeur <code>None</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On a donc bien besoin de minimum cinq tests pour couvrir l&#8217;entiÃ¨retÃ© des cas prÃ©sentÃ©s.</p>
</div>
<div class="paragraph">
<p>Le nombre de tests unitaires nÃ©cessaires Ã  la couverture d&#8217;un bloc est au minimum Ã©gal Ã  la complexitÃ© cyclomatique de ce bloc. Une possibilitÃ© pour amÃ©liorer la maintenance du code est de faire baisser ce nombre, et de le conserver sous un certain seuil. Certains recommandent de le garder sous une complexitÃ© de 10; d&#8217;autres de 5.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>note::</p>
<div class="literalblock">
<div class="content">
<pre>Evidemment, si on refactorise un bloc pour en extraire une mÃ©thode, cela   n'amÃ©liorera pas sa complexitÃ© cyclomatique globale</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>A nouveau, un greffon pour <code>flake8</code> existe et donnera une estimation de la complexitÃ© de McCabe pour les fonctions trop complexes. Installez-le avec <code>pip install mccabe</code>, et activez-le avec le paramÃ¨tre <code>--max-complexity</code>. Toute fonction dans la complexitÃ© est supÃ©rieure Ã  cette valeur sera considÃ©rÃ©e comme trop complexe.</p>
</div>
</div>
<div class="sect3">
<h4 id="_documentation">5.1.5. Documentation</h4>
<div class="paragraph">
<p>Il existe plusieurs maniÃ¨res de gÃ©nÃ©rer la documentation d&#8217;un projet. Les plus connues sont `Sphinx &lt;<a href="http://sphinx-doc.org/&gt;`_" class="bare">http://sphinx-doc.org/&gt;`_</a> et `MkDocs &lt;<a href="http://www.mkdocs.org/&gt;`" class="bare">http://www.mkdocs.org/&gt;`</a><em>. Le premier a l&#8217;avantage d&#8217;Ãªtre plus reconnu dans la communautÃ© Python que l&#8217;autre, de pouvoir <strong>parser</strong> le code pour en extraire la documentation et de pouvoir lancer des `tests orientÃ©s documentation &lt;<a href="https://duckduckgo.com/?q=documentation+driven+development&amp;t=ffsb&gt;`" class="bare">https://duckduckgo.com/?q=documentation+driven+development&amp;t=ffsb&gt;`</a></em>. A contrario, votre syntaxe devra respecter `ReStructuredText &lt;<a href="https://en.wikipedia.org/wiki/ReStructuredText&gt;`_" class="bare">https://en.wikipedia.org/wiki/ReStructuredText&gt;`_</a>. Le second a l&#8217;avantage d&#8217;avoir une syntaxe plus simple Ã  apprendre et Ã  comprendre, mais est plus limitÃ© dans son rÃ©sultat.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;immÃ©diat, nous nous contenterons d&#8217;avoir des modules documentÃ©s (quelle que soit la mÃ©thode Sphinx/MkDocs/&#8230;&#8203;). Dans la continuiÃ© de <code>Flake8</code>, il existe un greffon qui vÃ©rifie la prÃ©sence de commentaires au niveau des mÃ©thodes et modules dÃ©veloppÃ©s.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>note::</p>
<div class="literalblock">
<div class="content">
<pre>voir si il ne faudrait pas mieux passer par pydocstyle.</pre>
</div>
</div>
</li>
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ pip install flake8_docstrings</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lancez ensuite <code>flake8</code> avec la commande <code>flake8 . --exclude="migrations"</code>. Sur notre projet (presque) vide, le rÃ©sultat sera le suivant:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ flake8 . --exclude="migrations"
.\src\manage.py:1:1: D100  Missing docstring in public module
.\src\gwift\__init__.py:1:1: D100  Missing docstring in public module
.\src\gwift\urls.py:1:1: D400  First line should end with a period (not 'n')
.\src\wish\__init__.py:1:1: D100  Missing docstring in public module
.\src\wish\admin.py:1:1: D100  Missing docstring in public module
.\src\wish\admin.py:1:1: F401 'admin' imported but unused
.\src\wish\models.py:1:1: D100  Missing docstring in public module
.\src\wish\models.py:1:1: F401 'models' imported but unused
.\src\wish\tests.py:1:1: D100  Missing docstring in public module
.\src\wish\tests.py:1:1: F401 'TestCase' imported but unused
.\src\wish\views.py:1:1: D100  Missing docstring in public module
.\src\wish\views.py:1:1: F401 'render' imported but unused</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bref, on le voit: nous n&#8217;avons que trÃ¨s peu de modules, et aucun d&#8217;eux n&#8217;est commentÃ©.</p>
</div>
<div class="paragraph">
<p>En plus de cette mÃ©thode, Django permet Ã©galement de rendre la documentation accessible depuis son interface d&#8217;administration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pep8_flake8_pylint">5.2. pep8, flake8, pylint</h3>
<div class="paragraph">
<p>Un outil existe et listera lâensemble des conventions qui ne sont pas correctement suivies dans votre projet: pep8. Pour lâinstaller, passez par pip. Lancez ensuite la commande pep8 suivie du chemin Ã  analyser (., le nom dâun rÃ©pertoire, le nom dâun fichier .py, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>Si vous ne voulez pas Ãªtre dÃ©rangÃ© sur votre maniÃ¨re de coder, et que vous voulez juste avoir un retour sur une analyse de votre code, essayez pyflakes: il analaysera vos sources Ã  la recherche dâerreurs (imports inutilsÃ©s, mÃ©thodes inconnues, etc.).</p>
</div>
<div class="paragraph">
<p>Et finalement, si vous voulez grouper les deux, il existe flake8. Sur base la mÃªme interface que pep8, vous aurez en plus des avertissements concernant le code source.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="s">"""On stocke la date du jour dans la variable ToD4y"""</span>

<span class="n">ToD4y</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">print_today</span><span class="p">(</span><span class="n">ToD4y</span><span class="p">):</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">ToD4y</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ToD4y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">GetToday</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ToD4y</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span>   <span class="n">Get_Today</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exÃ©cution de la commande flake8 . retourne ceci:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">test.py:7:1: E302 expected 2 blank lines, found 1
test.py:8:5: F841 <span class="nb">local </span>variable <span class="s1">'today'</span> is assigned to but never used
test.py:11:1: E302 expected 2 blank lines, found 1
test.py:16:8: E222 multiple spaces after operator
test.py:16:11: F821 undefined name <span class="s1">'Get_Today'</span>
test.py:18:1: W391 blank line at end of file</code></pre>
</div>
</div>
<div class="paragraph">
<p>On trouve des erreurs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>de <strong>conventions</strong>: le nombre de lignes qui sÃ©parent deux fonctions, le nombre d&#8217;espace aprÃ¨s un opÃ©rateur, une ligne vide Ã  la fin du fichier, &#8230;&#8203; Ces <em>erreurs</em> n&#8217;en sont pas vraiment, elles indiquent juste de potentiels problÃ¨mes de communication si le code devait Ãªtre lu ou compris par une autre personne.</p>
</li>
<li>
<p>de <strong>dÃ©finition</strong>: une variable assignÃ©e mais pas utilisÃ©e ou une lexÃ¨me non trouvÃ©. Cette derniÃ¨re information indique clairement un bug potentiel.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;Ã©tape d&#8217;aprÃ¨s consiste Ã  invoquer pylint. Lui, il est directement moins conciliant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">$ pylint test.py
************* Module test
test.py:16:6: C0326: Exactly one space required after assignment
    t =   Get_Today()
      ^ (bad-whitespace)
test.py:18:0: C0305: Trailing newlines (trailing-newlines)
test.py:1:0: C0114: Missing module docstring (missing-module-docstring)
test.py:3:0: W0105: String statement has no effect (pointless-string-statement)
test.py:5:0: C0103: Constant name "ToD4y" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:7:16: W0621: Redefining name 'ToD4y' from outer scope (line 5) (redefined-outer-name)
test.py:7:0: C0103: Argument name "ToD4y" doesn't conform to snake_case naming style (invalid-name)
test.py:7:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:8:4: W0612: Unused variable 'today' (unused-variable)
test.py:11:0: C0103: Function name "GetToday" doesn't conform to snake_case naming style (invalid-name)
test.py:11:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:16:4: C0103: Constant name "t" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:16:10: E0602: Undefined variable 'Get_Today' (undefined-variable)

--------------------------------------------------------------------
Your code has been rated at -5.45/10</code></pre>
</div>
</div>
<div class="paragraph">
<p>En gros, j&#8217;ai programmÃ© comme une grosse bouse anÃ©mique (et oui, le score d&#8217;Ã©valuation du code permet bien d&#8217;aller en nÃ©gatif). En vrac, on trouve des problÃ¨mes liÃ©s:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>au nommage (C0103) et Ã  la mise en forme (C0305, C0326, W0105)</p>
</li>
<li>
<p>Ã  des variables non dÃ©finies (E0602)</p>
</li>
<li>
<p>de la documentation manquante (C0114, C0116)</p>
</li>
<li>
<p>de la redÃ©finition de variables (W0621).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour reprendre la <a href="http://pylint.pycqa.org/en/latest/user_guide/message-control.html">documentation</a>, chaque code possÃ¨de sa signification (ouf!):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C convention related checks</p>
</li>
<li>
<p>R refactoring related checks</p>
</li>
<li>
<p>W various warnings</p>
</li>
<li>
<p>E errors, for probable bugs in the code</p>
</li>
<li>
<p>F fatal, if an error occurred which prevented pylint from doing further* processing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PyLint est la version <strong>++</strong>, pour ceux qui veulent un code propre et sans bavure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_black">5.3. Black</h3>

</div>
<div class="sect2">
<h3 id="_pytest">5.4. pytest</h3>

</div>
<div class="sect2">
<h3 id="_mypy">5.5. mypy</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_git">6. Git</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
insÃ©rer ici une description de Gitflow + quelques exemples types crÃ©ation, ajout, suppression, historique, branches, &#8230;&#8203; et quelques schÃ©mas qui-vont-bien.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il existe plusiseurs outils permettant de gÃ©rer les versions du code, dont les plus connus sont `git &lt;<a href="https://git-scm.com/&gt;`_" class="bare">https://git-scm.com/&gt;`_</a> et `mercurial &lt;<a href="https://www.mercurial-scm.org/&gt;`_" class="bare">https://www.mercurial-scm.org/&gt;`_</a>.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, nous utilisons git et hebergons le code et le livre directement sur le gitlab de `framasoft &lt;<a href="https://git.framasoft.org/&gt;`_" class="bare">https://git.framasoft.org/&gt;`_</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_graphviz">7. graphviz</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En utilisant django_extensions (! bien suivre les Ã©tapes d&#8217;installation !).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text"> C:\app\graphviz\bin\dot.exe graph.dot -Tpng -o graph.png</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_en_rÃ©sumÃ©">8. En rÃ©sumÃ©</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En rÃ©sumÃ©, la crÃ©ation d&#8217;un <strong>nouveau</strong> projet Django demande plus ou moins toujours les mÃªmes actions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configurer un environnement virtuel</p>
</li>
<li>
<p>Installer les dÃ©pendances et les ajouter dans le fichier <code>requirements.txt</code></p>
</li>
<li>
<p>Configurer le fichier <code>settings.py</code></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cookie-cutter</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>C&#8217;est ici que le projet `Cookie-Cutter &lt;<a href="http://cookiecutter.readthedocs.io/en/latest/readme.html&gt;`_" class="bare">http://cookiecutter.readthedocs.io/en/latest/readme.html&gt;`_</a> va Ãªtre intÃ©ressant: les X premiÃ¨res Ã©tapes peuvent Ãªtre <strong>bypassÃ©es</strong> par une simple commande.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>`Cookiecutter-Django &lt;<a href="http://cookiecutter-django.readthedocs.io/en/latest/project-generation-options.html&gt;`_" class="bare">http://cookiecutter-django.readthedocs.io/en/latest/project-generation-options.html&gt;`_</a></p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_dÃ©ploiement" class="sect0">DÃ©ploiement</h1>
<div class="openblock partintro">
<div class="content">
Et sÃ©curisation du serveur.
</div>
</div>
<div class="sect1">
<h2 id="_un_peu_de_thÃ©orie_les_principales_Ã©tapes">9. Un peu de thÃ©orie&#8230;&#8203; Les principales Ã©tapes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On va dÃ©jÃ  parler de dÃ©ploiement. Le serveur que django met Ã  notre disposition est prÃ©vu uniquement pour le dÃ©veloppement: inutile de passer par du code Python pour charger des fichiers statiques (feuilles de style, fichiers JavaScript, images, &#8230;&#8203;). De mÃªme, la base de donnÃ©e doit supporter plus qu&#8217;un seul utilisateur: SQLite fonctionne trÃ¨s bien dÃ¨s lors qu&#8217;on se limite Ã  un seul utilisateur&#8230;&#8203; Sur une application Web, il est plus que probable que vous rencontriez rapidement des erreurs de base de donnÃ©es verrouillÃ©e pour Ã©criture par un autre processus. Il est donc plus que bÃ©nÃ©fique de passer sur quelque chose de plus solide.</p>
</div>
<div class="paragraph">
<p>Si vous avez suivi les Ã©tapes jusqu&#8217;ici, vous devriez Ã  peine disposer d&#8217;un espace de travail proprement configurÃ©, d&#8217;un modÃ¨le relativement basique et d&#8217;une configuration avec une base de donnÃ©es simpliste. En bref, vous avez quelque chose qui fonctionne, mais qui ressemble de trÃ¨s loin Ã  ce que vous souhaitez au final.</p>
</div>
<div class="paragraph">
<p>Il y a une raison trÃ¨s simple Ã  aborder le dÃ©ploiement dÃ¨s maintenant: Ã  trop attendre et Ã  peaufiner son dÃ©veloppement en local, on en oublie que sa finalitÃ© sera de se retrouver exposÃ© sur un serveur. On risque d&#8217;avoir oubliÃ© une partie des dÃ©sidÃ©rata, d&#8217;avoir zappÃ© une fonctionnalitÃ© essentielle ou simplement de passer Ã©normÃ©ment de temps Ã  adapter les sources pour qu&#8217;elles fonctionnent sur un environnement en particulier.</p>
</div>
<div class="paragraph">
<p>Aborder le dÃ©ploiement maintenant permet Ã©galement de rÃ©diger dÃ¨s le dÃ©but les procÃ©dures d&#8217;installation, de mise Ã  jour et de sauvegardes. DÃ©ploier une nouvelle version sera aussi simple que de rÃ©cupÃ©rer la derniÃ¨re archive depuis le dÃ©pÃ´t, la placer dans le bon rÃ©pertoire, appliquer des actions spÃ©cifiques (et souvent identiques entre deux versions), puis redÃ©marrer les services adÃ©quats.</p>
</div>
<div class="paragraph">
<p>Dans cette partie, on abordera les points suivants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La dÃ©finition de l&#8217;infrastructure nÃ©cessaire Ã  notre application</p>
</li>
<li>
<p>La configuration de l&#8217;hÃ´te, qui hÃ©bergera l&#8217;application: dans une machine physique, virtuelle ou dans un container. On abordera aussi rapidement les dÃ©ploiements via Ansible, Chef, Puppet ou Salt.</p>
</li>
<li>
<p>Les diffÃ©rentes mÃ©thodes de supervision de l&#8217;application: comment analyser les fichiers de logs et comment intercepter correctement une erreur si elle se prÃ©sente et comment remonter l&#8217;information.</p>
</li>
<li>
<p>Une partie sur la sÃ©curitÃ© et la sÃ©curisation de l&#8217;hÃ´te.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_dÃ©finition_de_linfrastructure">9.1. DÃ©finition de l&#8217;infrastructure</h3>
<div class="paragraph">
<p>Comme on l&#8217;a vu dans la premiÃ¨re partie, Django est un framework complet, intÃ©grant tous les mÃ©canismes nÃ©cessaires Ã  la bonne Ã©volution d&#8217;une application. On peut ainsi commencer petit, et suivre l&#8217;Ã©volution des besoins en fonction de la charge estimÃ©e ou ressentie, ajouter un mÃ©canisme de mise en cache, des logiciels de suivi, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Pour une mise ne production, le standard <strong>de facto</strong> est le suivant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nginx comme serveur principal</p>
</li>
<li>
<p>Gunicorn comme serveur d&#8217;application</p>
</li>
<li>
<p>Supervisorctl pour le monitoring</p>
</li>
<li>
<p>PostgreSQL comme base de donnÃ©es.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est celle-ci que nous allons dÃ©crire ci-dessous.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_et_sÃ©curisation_de_la_machine_hÃ´te">9.2. Configuration et sÃ©curisation de la machine hÃ´te</h3>
<div class="paragraph">
<p>Supervisor, nginx, gunicorn, utilisateurs, groupes, &#8230;&#8203;</p>
</div>
<div class="openblock plantuml">
<div class="content">
<div class="paragraph">
<p>entity Nginx
entity "Gunicorn (sockets/HTTP)" as gunicorn
database PGSQL</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Aussi : Docker, Heroku, Digital Ocean, Scaleway, OVH, &#8230;&#8203; Bref, sur Debian et CentOS pour avoir un panel assez large. On oublie Windows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mise_Ã _jour">9.3. Mise Ã  jour</h3>
<div class="paragraph">
<p>Script de mise Ã  jour.</p>
</div>
</div>
<div class="sect2">
<h3 id="_supervision">9.4. Supervision</h3>
<div class="paragraph">
<p>Qu&#8217;est-ce qu&#8217;on fait des logs aprÃ¨s ? :-)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dÃ©ploiement_sur_centos">10. DÃ©ploiement sur CentOS</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">yum update
groupadd <span class="nt">--system</span> webapps
groupadd <span class="nt">--system</span> gunicorn_sockets
useradd <span class="nt">--system</span> <span class="nt">--gid</span> webapps <span class="nt">--shell</span> /bin/bash <span class="nt">--home</span> /home/medplan medplan
<span class="nb">mkdir</span> <span class="nt">-p</span> /home/medplan
<span class="nb">chown </span>medplan:webapps /home/medplan</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_installation_des_dÃ©pendances_systÃ¨mes">10.1. Installation des dÃ©pendances systÃ¨mes</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">yum <span class="nb">install </span>python36 git tree <span class="nt">-y</span>

<span class="c"># CentOS 7 ne dispose que de la version 3.7 d'SQLite. On a besoin d'une version 3.8 au minimum:</span>
wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm
wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm
<span class="nb">sudo </span>yum <span class="nb">install </span>sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm <span class="nt">-y</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prÃ©paration_de_lenvironnement_utilisateur">10.2. PrÃ©paration de l&#8217;environnement utilisateur</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">su - medplan
<span class="nb">cp</span> /etc/skel/.bashrc <span class="nb">.</span>
<span class="nb">cp</span> /etc/skel/.bash_profile <span class="nb">.</span>
ssh-keygen
<span class="nb">mkdir </span>bin
<span class="nb">mkdir</span> .venvs
<span class="nb">mkdir </span>webapps
python3.6 <span class="nt">-m</span> venv .venvs/medplan
<span class="nb">source</span> .venvs/medplan/bin/activate
<span class="nb">cd</span> /home/medplan/webapps
git clone git@vmwmedtools:institutionnel/medplan.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>La clÃ© SSH doit ensuite Ãªtre renseignÃ©e au niveau du dÃ©pÃ´t, afin de pouvoir y accÃ©der.</p>
</div>
<div class="paragraph">
<p>A ce stade, on devrait dÃ©jÃ  avoir quelque chose de fonctionnel en dÃ©marrant les commandes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># en tant qu'utilisateur 'medplan'</span>

<span class="nb">source</span> .venvs/medplan/bin/activate
pip <span class="nb">install</span> <span class="nt">-U</span> pip
pip <span class="nb">install</span> <span class="nt">-r</span> requirements/base.txt
pip <span class="nb">install </span>gunicorn
<span class="nb">cd </span>webapps/medplan
gunicorn config.wsgi:application <span class="nt">--bind</span> localhost:3000 <span class="nt">--settings</span><span class="o">=</span>config.settings_production</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_de_lapplication">10.3. Configuration de l&#8217;application</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">SECRET_KEY</span><span class="o">=</span>&lt;<span class="nb">set </span>your secret key here&gt;
<span class="nv">ALLOWED_HOSTS</span><span class="o">=</span><span class="k">*</span>
<span class="nv">STATIC_ROOT</span><span class="o">=</span>/var/www/medplan/static</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_crÃ©ation_des_rÃ©pertoires_de_logs">10.4. CrÃ©ation des rÃ©pertoires de logs</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">mkdir -p /var/www/medplan/static</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_crÃ©ation_du_rÃ©pertoire_pour_le_socket">10.5. CrÃ©ation du rÃ©pertoire pour le socket</h3>
<div class="paragraph">
<p>Dans le fichier <code>/etc/tmpfiles.d/medplan.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">D /var/run/webapps 0775 medplan gunicorn_sockets -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Suivi de la crÃ©ation par systemd :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">systemd-tmpfiles --create</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gunicorn">10.6. Gunicorn</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c"># defines settings for gunicorn</span>
<span class="nv">NAME</span><span class="o">=</span><span class="s2">"Medplan"</span>
<span class="nv">DJANGODIR</span><span class="o">=</span>/home/medplan/webapps/medplan
<span class="nv">SOCKFILE</span><span class="o">=</span>/var/run/webapps/gunicorn_medplan.sock
<span class="nv">USER</span><span class="o">=</span>medplan
<span class="nv">GROUP</span><span class="o">=</span>gunicorn_sockets
<span class="nv">NUM_WORKERS</span><span class="o">=</span>5
<span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>config.settings_production
<span class="nv">DJANGO_WSGI_MODULE</span><span class="o">=</span>config.wsgi

<span class="nb">echo</span> <span class="s2">"Starting </span><span class="nv">$NAME</span><span class="s2"> as </span><span class="sb">`</span><span class="nb">whoami</span><span class="sb">`</span><span class="s2">"</span>

<span class="nb">source</span> /home/medplan/.venvs/medplan/bin/activate
<span class="nb">cd</span> <span class="nv">$DJANGODIR</span>
<span class="nb">export </span><span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="nv">$DJANGO_SETTINGS_MODULE</span>
<span class="nb">export </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$DJANGODIR</span>:<span class="nv">$PYTHONPATH</span>

<span class="nb">exec </span>gunicorn <span class="k">${</span><span class="nv">DJANGO_WSGI_MODULE</span><span class="k">}</span>:application <span class="se">\</span>
<span class="nt">--name</span> <span class="nv">$NAME</span> <span class="se">\</span>
<span class="nt">--workers</span> <span class="nv">$NUM_WORKERS</span> <span class="se">\</span>
<span class="nt">--user</span> <span class="nv">$USER</span> <span class="se">\</span>
<span class="nt">--bind</span><span class="o">=</span>unix:<span class="nv">$SOCKFILE</span> <span class="se">\</span>
<span class="nt">--log-level</span><span class="o">=</span>debug <span class="se">\</span>
<span class="nt">--log-file</span><span class="o">=</span>-</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_supervision_2">10.7. Supervision</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">yum <span class="nb">install </span>supervisor <span class="nt">-y</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On crÃ©e ensuite le fichier <code>/etc/supervisord.d/medplan.ini</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">[</span>program:medplan]
<span class="nb">command</span><span class="o">=</span>/home/medplan/bin/start_gunicorn.sh
<span class="nv">user</span><span class="o">=</span>medplan
<span class="nv">stdout_logfile</span><span class="o">=</span>/var/log/medplan/medplan.log
<span class="nv">autostart</span><span class="o">=</span><span class="nb">true
</span><span class="nv">autorestart</span><span class="o">=</span>unexpected
<span class="nv">redirect_stdout</span><span class="o">=</span><span class="nb">true
</span><span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et on crÃ©e les rÃ©pertoires de logs, on dÃ©marre supervisord et on vÃ©rifie qu&#8217;il tourne correctement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">mkdir</span> /var/log/medplan
<span class="nb">chown </span>medplan:nagios /var/log/medplan

systemctl <span class="nb">enable </span>supervisord
systemctl start supervisord.service
systemctl status supervisord.service
â supervisord.service - Process Monitoring and Control Daemon
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/supervisord.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Tue 2019-12-24 10:08:09 CET<span class="p">;</span> 10s ago
  Process: 2304 <span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/supervisord <span class="nt">-c</span> /etc/supervisord.conf <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
 Main PID: 2310 <span class="o">(</span>supervisord<span class="o">)</span>
   CGroup: /system.slice/supervisord.service
           ââ2310 /usr/bin/python /usr/bin/supervisord <span class="nt">-c</span> /etc/supervisord.conf
           ââ2313 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
           ââ2317 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
           ââ2318 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
           ââ2321 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
           ââ2322 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
           ââ2323 /home/medplan/.venvs/medplan/bin/python3 /home/medplan/.venvs/medplan/bin/gunicorn config.wsgi:...
<span class="nb">ls</span> /var/run/webapps/</code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut aussi vÃ©rifier que l&#8217;application est en train de tourner, Ã  l&#8217;aide de la commande <code>supervisorctl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$$$ </span>supervisorctl status gwift
gwift                            RUNNING    pid 31983, <span class="nb">uptime </span>0:01:00</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et pour gÃ©rer le dÃ©marrage ou l&#8217;arrÃªt, on peut passer par les commandes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$$$ </span>supervisorctl stop gwift
gwift: stopped
root@ks3353535:/etc/supervisor/conf.d# supervisorctl start gwift
gwift: started
root@ks3353535:/etc/supervisor/conf.d# supervisorctl restart gwift
gwift: stopped
gwift: started</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ouverture_des_ports">10.8. Ouverture des ports</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-service=https
firewall-cmd --reload</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_dnginx">10.9. Installation d&#8217;Nginx</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>yum install nginx -y
usermod -a -G gunicorn_sockets nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>On configure ensuite le fichier <code>/etc/nginx/conf.d/medplan.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>upstream medplan_app {
        server unix:/var/run/webapps/gunicorn_medplan.sock fail_timeout=0;
}

server {
        listen 80;
        server_name &lt;server_name&gt;;
        root /var/www/medplan;
        error_log /var/log/nginx/medplan_error.log;
        access_log /var/log/nginx/medplan_access.log;

        client_max_body_size 4G;
        keepalive_timeout 5;

        gzip on;
        gzip_comp_level 7;
        gzip_proxied any;
        gzip_types gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;


        location /static/ {
                access_log off;
                expires 30d;
                add_header Pragma public;
                add_header Cache-Control "public";
                add_header Vary "Accept-Encoding";
                try_files $uri $uri/ =404;
        }

        location / {
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_redirect off;

                proxy_pass http://medplan_app;
        }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_des_sauvegardes">10.10. Configuration des sauvegardes</h3>
<div class="paragraph">
<p>Les sauvegardes ont Ã©tÃ© configurÃ©es avec borg: <code>yum install borgbackup</code>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est l&#8217;utilisateur medplan qui s&#8217;en occupe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mkdir -p /home/medplan/borg-backups/
cd /home/medplan/borg-backups/
borg init medplan.borg -e=none
borg create medplan.borg::{now} ~/bin ~/webapps</pre>
</div>
</div>
<div class="paragraph">
<p>Et dans le fichier crontab :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0 23 * * * /home/medplan/bin/backup.sh</pre>
</div>
</div>
<div class="paragraph">
<p>On l&#8217;a dÃ©jÃ  vu, Django se base sur un pattern type ActiveRecords pour l&#8217;ORM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Ã  vÃ©rifier ;-)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>et supporte les principaux moteurs de bases de donnÃ©es connus: MariaDB (en natif depuis Django 3.0), PostgreSQL au travers de psycopg2 (en natif aussi), Microsoft SQLServer grÃ¢ce aux drivers [&#8230;&#8203;Ã  complÃ©ter] ou Oracle via <a href="https://oracle.github.io/python-cx_Oracle/">cx_Oracle</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Chaque pilote doit Ãªtre utilisÃ© prÃ©cautionneusement ! Chaque version de Django n&#8217;est pas toujours compatible avec chacune des versions des pilotes, et chaque moteur de base de donnÃ©es nÃ©cessite parfois une version spÃ©cifique du pilote. De fait, vous serez parfois bloquÃ© sur une version de Django, simplement parce que votre serveur de base de donnÃ©es se trouvera dans une version spÃ©cifique (eg. Django 2.3 Ã  cause d&#8217;un Oracle 12.1).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ci-dessous, quelques procÃ©dures d&#8217;installation pour mettre un serveur Ã  disposition. Les deux plus simples seront MariaDB et PostgreSQL, qu&#8217;on couvrira ci-dessous. Oracle et Microsoft SQLServer se trouveront en annexes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgresql">11. PostgreSQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On commence par installer PostgreSQL.</p>
</div>
<div class="paragraph">
<p>Par exemple, dans le cas de debian, on exÃ©cute la commande suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$$$ </span>aptitude <span class="nb">install </span>postgresql postgresql-contrib</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, on crÃ©e un utilisateur pour la DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$$$ </span>su - postgres
postgres@gwift:~<span class="nv">$ </span>createuser <span class="nt">--interactive</span> <span class="nt">-P</span>
Enter name of role to add: gwift_user
Enter password <span class="k">for </span>new role:
Enter it again:
Shall the new role be a superuser? <span class="o">(</span>y/n<span class="o">)</span> n
Shall the new role be allowed to create databases? <span class="o">(</span>y/n<span class="o">)</span> n
Shall the new role be allowed to create more new roles? <span class="o">(</span>y/n<span class="o">)</span> n
postgres@gwift:~<span class="err">$</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalement, on peut crÃ©er la DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">postgres@gwift:~<span class="nv">$ </span>createdb <span class="nt">--owner</span> gwift_user gwift
postgres@gwift:~<span class="nv">$ </span><span class="nb">exit
logout</span>
<span class="nv">$$</span><span class="err">$</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
penser Ã  inclure un bidule pour les backups.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mariadb">12. MariaDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Idem, installation, configuration, backup, tout Ã§a.
A copier de grimboite, je suis sÃ»r d&#8217;avoir des notes lÃ -dessus.</p>
</div>
</div>
</div>
<h1 id="_modÃ©lisation" class="sect0">ModÃ©lisation</h1>
<div class="openblock partintro">
<div class="content">
Dans ce chapitre, on va parler de plusieurs concepts utiles au dÃ©veloppement rapide d&#8217;une application. On parlera de modÃ©lisation, de migrations, d&#8217;administration auto-gÃ©nÃ©rÃ©e.
</div>
</div>
<div class="sect1">
<h2 id="_modÃ©lisation_2">13. ModÃ©lisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On va aborder la modÃ©lisation des objets en elle-mÃªme, qui s&#8217;apparente Ã  la conception de la base de donnÃ©es.</p>
</div>
<div class="paragraph">
<p>Django utilise un modÃ¨le <a href="https://fr.wikipedia.org/wiki/Mapping_objet-relationnel">ORM</a> - c&#8217;est-Ã -dire que chaque objet peut s&#8217;apparenter Ã  une table SQL, mais en ajoutant une couche propre au paradigme orientÃ© objet. Il sera ainsi possible de dÃ©finir facilement des notions d&#8217;hÃ©ritage (tout en restant dans une forme d&#8217;hÃ©ritage simple), la possibilitÃ© d&#8217;utiliser des propriÃ©tÃ©s spÃ©cifiques, des classes intermÃ©diaires, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>L&#8217;avantage de tout ceci est que tout reste au niveau du code. Si l&#8217;on revient sur la mÃ©thodologie des douze facteurs, ce point concerne principalement la minimisation de la divergence entre les environnements d&#8217;exÃ©cution. DÃ©ployer une nouvelle instance de l&#8217;application pourra Ãªtre rÃ©alisÃ© directement Ã  partir d&#8217;une seule et mÃªme commande, dans la mesure oÃ¹ <strong>tout est embarquÃ© au niveau du code</strong>.</p>
</div>
<div class="paragraph">
<p>Assez de blabla, on dÃ©marre !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_queryset_managers">14. Queryset &amp; managers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;ORM de Django propose par dÃ©faut deux objets hyper importants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les managers, qui consistent en un point d&#8217;entrÃ©e pour accÃ©der aux objets persistants</p>
</li>
<li>
<p>Les querysets, qui permettent de filtrer des ensembles ou sous-ensemble d&#8217;objets. Les querysets peuvent s&#8217;imbriquer, pour ajouter
d&#8217;autres filtres Ã  des filtres existants.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En plus de cela, il faut bien tenir compte des propriÃ©tÃ©s <code>Meta</code> de la classe: si elle contient dÃ©jÃ  un ordre par dÃ©faut, celui-ci
sera pris en compte pour l&#8217;ensemble des requÃªtes effectuÃ©es sur cette classe.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forms">15. Forms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ou comment valider proprement des donnÃ©es entrantes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
intÃ©grer le dessin XKCD avec Little Bobby Table sur l&#8217;assainissement des donnÃ©es en entrÃ©e :-p
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quand on parle de <code>forms</code>, on ne parle pas uniquement de formulaires Web. On pourrait considÃ©rer qu&#8217;il s&#8217;agit de leur objectif principal, mais on peut Ã©galement voir un peu plus loin: on peut en fait voir les <code>forms</code> comme le point d&#8217;entrÃ©e pour chaque donnÃ©e arrivant dans notre application: il s&#8217;agit en quelque sorte d&#8217;un ensemble de rÃ¨gles complÃ©mentaires Ã  celles dÃ©jÃ  prÃ©sentes au niveau du modÃ¨le.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple le plus simple est un fichier <code>.csv</code>: la lecture de ce fichier pourrait se faire de maniÃ¨re trÃ¨s simple, en rÃ©cupÃ©rant les valeurs de chaque colonne et en l&#8217;introduisant dans une instance du modÃ¨le.</p>
</div>
<div class="paragraph">
<p>Mauvaise idÃ©e.</p>
</div>
<div class="paragraph">
<p>Les donnÃ©es fournies par un utilisateur <strong>doivent</strong> <strong>toujours</strong> Ãªtre validÃ©es avant introduction dans la base de donnÃ©es. Notre base de donnÃ©es Ã©tant accessible ici par l&#8217;ORM, la solution consiste Ã  introduire une couche supplÃ©mentaire de validation.</p>
</div>
<div class="paragraph">
<p>Le flux Ã  suivre est le suivant:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>CrÃ©ation d&#8217;une instance grÃ¢ce Ã  un dictionnaire</p>
</li>
<li>
<p>Validation des donnÃ©es et des informations reÃ§ues</p>
</li>
<li>
<p>Traitement, si la validation a rÃ©ussi.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ils jouent Ã©galement plusieurs rÃ´les:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Validation des donnÃ©es, en plus de celles dÃ©jÃ  dÃ©finies au niveau du modÃ¨le</p>
</li>
<li>
<p>ContrÃ´le sur le rendu Ã  appliquer aux champs</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ils agissent come une glue entre l&#8217;utilisateur et la modÃ©lisation de vos structures de donnÃ©es.</p>
</div>
<div class="sect2">
<h3 id="_dÃ©pendance_avec_le_modÃ¨le">15.1. DÃ©pendance avec le modÃ¨le</h3>
<div class="paragraph">
<p>Un <strong>form</strong> peut dÃ©pendre d&#8217;une autre classe Django. Pour cela, il suffit de fixer l&#8217;attribut <code>model</code> au niveau de la <code>class Meta</code> dans la dÃ©finition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="kn">from</span> <span class="nn">wish.models</span> <span class="kn">import</span> <span class="n">Wishlist</span>

<span class="k">class</span> <span class="nc">WishlistCreateForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Wishlist</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'description'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>De cette maniÃ¨re, notre form dÃ©pendra automatiquement des champs dÃ©jÃ  dÃ©clarÃ©s dans la classe <code>Wishlist</code>. Cela suit le principe de <code>DRY &lt;don&#8217;t repeat yourself&gt;`_, et Ã©vite qu&#8217;une modification ne pourrisse le code: en testant les deux champs prÃ©sent dans l&#8217;attribut `fields</code>, nous pourrons nous assurer de faire Ã©voluer le formulaire en fonction du modÃ¨le sur lequel il se base.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rendu_et_affichage">15.2. Rendu et affichage</h3>
<div class="paragraph">
<p>Le formulaire permet Ã©galement de contrÃ´ler le rendu qui sera appliquÃ© lors de la gÃ©nÃ©ration de la page. Si les champs dÃ©pendent du modÃ¨le sur lequel se base le formulaire, ces widgets doivent Ãªtre initialisÃ©s dans l&#8217;attribut <code>Meta</code>. Sinon, ils peuvent l&#8217;Ãªtre directement au niveau du champ.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Accident</span>

<span class="k">class</span> <span class="nc">AccidentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Accident</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'gymnast'</span><span class="p">,</span> <span class="s">'educative'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">,</span> <span class="s">'information'</span><span class="p">)</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'date'</span> <span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span>
                     <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s">'class'</span> <span class="p">:</span> <span class="s">'form-control'</span><span class="p">,</span>
                        <span class="s">'data-provide'</span> <span class="p">:</span> <span class="s">'datepicker'</span><span class="p">,</span>
                        <span class="s">'data-date-format'</span> <span class="p">:</span> <span class="s">'dd/mm/yyyy'</span><span class="p">,</span>
                        <span class="s">'placeholder'</span> <span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">d/</span><span class="si">%</span><span class="s">m/</span><span class="si">%</span><span class="s">Y"</span><span class="p">)</span>
                     <span class="p">}),</span>
            <span class="s">'information'</span> <span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
                            <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
                                <span class="s">'class'</span> <span class="p">:</span> <span class="s">'form-control'</span><span class="p">,</span>
                                <span class="s">'placeholder'</span> <span class="p">:</span> <span class="s">'Context (why, where, ...)'</span>
                            <span class="p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_squelette_par_dÃ©faut">15.3. Squelette par dÃ©faut</h3>
<div class="paragraph">
<p>On a d&#8217;un cÃ´tÃ© le {{ form.as_p }} ou {{ form.as_table }}, mais il y a beaucoup mieux que Ã§a ;-) Voir les templates de Vitor.</p>
</div>
</div>
<div class="sect2">
<h3 id="_crispy_forms">15.4. Crispy-forms</h3>
<div class="paragraph">
<p>Comme on l&#8217;a vu Ã  l&#8217;instant, les forms, en Django, c&#8217;est le bien. Cela permet de valider des donnÃ©es reÃ§ues en entrÃ©e et d&#8217;afficher (trÃ¨s) facilement des formulaires Ã  complÃ©ter par l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Par contre, c&#8217;est lourd. DÃ¨s qu&#8217;on souhaite peaufiner un peu l&#8217;affichage, contrÃ´ler parfaitement ce que l&#8217;utilisateur doit remplir, modifier les types de contrÃ´leurs, les placer au pixel prÃ¨s, &#8230;&#8203; Tout Ã§a demande Ã©normÃ©ment de temps. Et c&#8217;est lÃ  qu&#8217;intervient `Django-Crispy-Forms &lt;<a href="http://django-crispy-forms.readthedocs.io/en/latest/&gt;`_" class="bare">http://django-crispy-forms.readthedocs.io/en/latest/&gt;`_</a>. Cette librairie intÃ¨gre plusieurs frameworks CSS (Bootstrap, Foundation et uni-form) et permet de contrÃ´ler entiÃ¨rement le <strong>layout</strong> et la prÃ©sentation.</p>
</div>
<div class="paragraph">
<p>(c/c depuis le lien ci-dessous)</p>
</div>
<div class="paragraph">
<p>Pour chaque champ, crispy-forms va :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>utiliser le <code>verbose_name</code> comme label.</p>
</li>
<li>
<p>vÃ©rifier les paramÃ¨tres <code>blank</code> et <code>null</code> pour savoir si le champ est obligatoire.</p>
</li>
<li>
<p>utiliser le type de champ pour dÃ©finir le type de la balise <code>&lt;input&gt;</code>.</p>
</li>
<li>
<p>rÃ©cupÃ©rer les valeurs du paramÃ¨tre <code>choices</code> (si prÃ©sent) pour la balise <code>&lt;select&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="http://dotmobo.github.io/django-crispy-forms.html" class="bare">http://dotmobo.github.io/django-crispy-forms.html</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_des_donnÃ©es">16. Validation des donnÃ©es</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
parler ici des mÃ©thodes <code>clean</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_en_conclusion">17. En conclusion</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Toute donnÃ©e entrÃ©e par l&#8217;utilisateur <strong>doit</strong> passer par une instance de <code>form</code>.</p>
</li>
<li>
<p>euh ?</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_migrations">18. Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les migrations (comprendre les "migrations du schÃ©ma de base de donnÃ©es") sont intimement liÃ©es Ã  la reprÃ©sentation d&#8217;un contexte fonctionnel. L&#8217;ajout d&#8217;une nouvelle information, d&#8217;un nouveau champ ou d&#8217;une nouvelle fonction peut s&#8217;accompagner de tables de donnÃ©es Ã  mettre Ã  jour ou de champs Ã  Ã©tendre.</p>
</div>
<div class="paragraph">
<p>Toujours dans une optique de centralisation, les migrations sont directement embarquÃ©es au niveau du code. Le dÃ©veloppeur s&#8217;occupe de crÃ©er les migrations en fonction des actions Ã  entreprendre; ces migrations peuvent Ãªtre retravaillÃ©es, <em>squashÃ©es</em>, &#8230;&#8203; et feront partie intÃ©grante du processus de mise Ã  jour de l&#8217;application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logging">19. Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si on veut propager les logs entre applications, il faut bien spÃ©cifier l&#8217;attribut <code>propagate</code>, sans quoi on s&#8217;arrÃªtera au module sans prendre en considÃ©ration les sous-modules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'version'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'disable_existing_loggers'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">'handlers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'console'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
            <span class="s">'class'</span><span class="p">:</span> <span class="s">'logging.StreamHandler'</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">'file'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
            <span class="s">'class'</span><span class="p">:</span> <span class="s">'logging.FileHandler'</span><span class="p">,</span>
            <span class="s">'filename'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SRC_DIR</span><span class="p">,</span> <span class="s">'log'</span><span class="p">,</span> <span class="s">'log.txt'</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">'loggers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'mv'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s">'file'</span><span class="p">],</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
            <span class="s">'propagate'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Par exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="s">'loggers'</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">'mv'</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Parent
</span>        <span class="s">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s">'file'</span><span class="p">],</span>
        <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'mv.models'</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Enfant
</span>        <span class="s">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s">'console'</span><span class="p">],</span>
        <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
        <span class="s">'propagate'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">},</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et dans le fichier <code>mv/models.py</code>, on a ceci:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'helloworld'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le log sera Ã©crit dans la console <strong>ET</strong> dans le fichier.</p>
</div>
<div class="paragraph">
<p>Par contre, si on retire l&#8217;attribut <code>propagate: True</code> (ou qu&#8217;on le change en <code>propagate: False</code>), le mÃªme code ci-dessus n&#8217;Ã©crit que dans la console. Simplement parce que le log associÃ© Ã  un package considÃ¨re par dÃ©faut ses enfants, alors que le log associÃ© Ã  un module pas. [Par exemple](<a href="https://docs.djangoproject.com/en/2.1/topics/logging/#examples" class="bare">https://docs.djangoproject.com/en/2.1/topics/logging/#examples</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration">20. Administration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WokÃ©. On va commencer par la <strong>partie Ã  ne <em>surtout</em> (<em>surtout</em> !!) pas faire en premier dans un projet Django</strong>. Mais on va la faire quand mÃªme. La raison principale est que cette partie est tellement puissante et performante, qu&#8217;elle pourrait laisser penser qu&#8217;il est possible de rÃ©aliser une application complÃ¨te rien qu&#8217;en configurant l&#8217;administration.</p>
</div>
<div class="paragraph">
<p>C&#8217;est faux.</p>
</div>
<div class="paragraph">
<p>L&#8217;administration est une sorte de tour de contrÃ´le Ã©voluÃ©e; elle se base sur le modÃ¨le de donnÃ©es programmÃ© et construit dynamiquement les formulaires qui lui est associÃ©. Elle joue avec les clÃ©s primaires, Ã©trangÃ¨res, les champs et types de champs par <a href="https://fr.wikipedia.org/wiki/Introspection">introspection</a>.</p>
</div>
<div class="paragraph">
<p>Son problÃ¨me est qu&#8217;elle prÃ©sente une courbe d&#8217;apprentissage asymptotique. Il est <strong>trÃ¨s</strong> facile d&#8217;arriver rapidement Ã  un bon rÃ©sultat, au travers d&#8217;un pÃ©rimÃ¨tre de configuration  relativement restreint. Mais quoi que vous fassiez, il y a un moment oÃ¹ la courbe de paramÃ©trage sera tellement ardue que vous aurez plus facile Ã  dÃ©velopper ce que vous souhaitez ajouter en utilisant les autres concepts de Django.</p>
</div>
<div class="paragraph">
<p>Elle doit rester dans les mains d&#8217;administrateurs ou de gestionnaires, et dans leurs mains Ã  eux uniquement: il n&#8217;est pas question de donner des droits aux utilisateurs finaux (mÃªme si c&#8217;est extrÃªment tentant durant les premiers tours de roues). IndÃ©pendamment de la maniÃ¨re dont vous allez l&#8217;utiliser et la configurer, vous finirez par devoir dÃ©velopper une "vraie" application, destinÃ©e aux utilisateurs classiques, et rÃ©pondant Ã  leurs besoins uniquement.</p>
</div>
<div class="paragraph">
<p>Une bonne idÃ©e consiste Ã  dÃ©velopper l&#8217;administration dans un premier temps, en <strong>gardant en tÃªte qu&#8217;il sera nÃ©cessaire de dÃ©velopper des concepts spÃ©cifiques</strong>. Dans cet objectif, l&#8217;administration est un outil exceptionel, qui permet de valider un modÃ¨le, de crÃ©er des objets rapidement et de valider les liens qui existent entre eux. C&#8217;est un excellent outil de prototypage et de preuve de concept.</p>
</div>
<div class="sect2">
<h3 id="_quelques_conseils">20.1. Quelques conseils</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Surchargez la mÃ©thode <code><em>str</em>(self)</code> pour chaque classe que vous aurez dÃ©finie dans le modÃ¨le. Cela permettra de construire une reprÃ©sentation textuelle qui reprÃ©sentera l&#8217;instance de votre classe. Cette information sera utilisÃ©e un peu partout dans le code, et donnera une meilleure idÃ©e de ce que l&#8217;on manipule. En plus, cette mÃ©thode est Ã©galement appelÃ©e lorsque l&#8217;administration historisera une action (et comme cette Ã©tape sera inaltÃ©rable, autant qu&#8217;elle soit fixÃ©e dans le dÃ©but).</p>
</li>
<li>
<p>La mÃ©thode <code>get_absolute_url(self)</code> retourne l&#8217;URL Ã  laquelle on peut accÃ©der pour obtenir les dÃ©tails d&#8217;une instance. Par exemple:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'myapp.views.details'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="nb">id</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Les attributs <code>Meta</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
	<span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">'-field1'</span><span class="p">,</span> <span class="s">'field2'</span><span class="p">]</span>
	<span class="n">verbose_name</span> <span class="o">=</span> <span class="s">'my class in singular'</span>
	<span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">'my class when is in a list!'</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Le titre:</p>
<div class="ulist">
<ul>
<li>
<p>Soit en modifiant le template de l&#8217;administration</p>
</li>
<li>
<p>Soit en ajoutant l&#8217;assignation suivante dans le fichier <code>urls.py</code>: <code>admin.site.site_header = "SuperBook Secret Area</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Prefetch</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="https://hackernoon.com/all-you-need-to-know-about-prefetching-in-django-f9068ebe1e60?gi=7da7b9d3ad64" class="bare">https://hackernoon.com/all-you-need-to-know-about-prefetching-in-django-f9068ebe1e60?gi=7da7b9d3ad64</a></p>
</div>
<div class="paragraph">
<p><a href="https://medium.com/@hakibenita/things-you-must-know-about-django-admin-as-your-app-gets-bigger-6be0b0ee9614" class="bare">https://medium.com/@hakibenita/things-you-must-know-about-django-admin-as-your-app-gets-bigger-6be0b0ee9614</a></p>
</div>
<div class="paragraph">
<p>En gros, le problÃ¨me de l&#8217;admin est que si on fait des requÃªtes imbriquÃ©es, on va flinguer l&#8217;application et le chargement de la page.
La solution consiste Ã  utiliser la propriÃ©tÃ© <code>list_select_related</code> de la classe d&#8217;Admin, afin d&#8217;appliquer une jointure par dÃ©faut et
et gagner en performances.</p>
</div>
</div>
</div>
</div>
<h1 id="_go_live" class="sect0">Go Live !</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Pour commencer, nous allons nous concentrer sur la crÃ©ation d&#8217;un site ne contenant qu&#8217;une seule application, mÃªme si en pratique le site contiendra dÃ©jÃ  plusieurs applications fournies pas django, comme nous le verrons plus loin.</p>
</div>
<div class="paragraph">
<p>Pour prendre un exemple concret, nous allons crÃ©er un site permettant de gÃ©rer des listes de souhaits, que nous appellerons <code>gwift</code> (pour <code>GiFTs and WIshlisTs</code> :)).</p>
</div>
<div class="paragraph">
<p>La premiÃ¨re chose Ã  faire est de dÃ©finir nos besoins du point de vue de l&#8217;utilisateur, c&#8217;est-Ã -dire ce que nous souhaitons qu&#8217;un utilisateur puisse faire avec l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Ensuite, nous pourrons traduire ces besoins en fonctionnalitÃ©s et finalement effectuer le dÃ©veloppement</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Besoins utilisateurs</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Nous souhaitons dÃ©velopper un site oÃ¹ un utilisateur donnÃ© peut crÃ©er une liste contenant des souhaits et oÃ¹ d&#8217;autres utilisateurs, authentifiÃ©s ou non, peuvent choisir les souhaits Ã  la rÃ©alisation desquels ils souhaitent participer.</p>
</div>
<div class="paragraph">
<p>Il sera nÃ©cessaire de s&#8217;authentifier pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CrÃ©er une liste associÃ©e Ã  l&#8217;utilisateur en cours</p>
</li>
<li>
<p>Ajouter un nouvel Ã©lÃ©ment Ã  une liste</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il ne sera pas nÃ©cessaire de s&#8217;authentifier pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Faire une promesse d&#8217;offre pour un Ã©lÃ©ment appartenant Ã  une liste, associÃ©e Ã  un utilisateur.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;utilisateur ayant crÃ©Ã© une liste pourra envoyer un email directement depuis le site aux personnes avec qui il souhaite partager sa liste, cet email contenant un lien permettant d&#8217;accÃ©der Ã  cette liste.</p>
</div>
<div class="paragraph">
<p>A chaque souhait, on pourrait de maniÃ¨re facultative ajouter un prix. Dans ce cas, le souhait pourrait aussi Ãªtre subdivisÃ© en plusieurs parties, de maniÃ¨re Ã  ce que plusieurs personnes puissent participer Ã  sa rÃ©alisation.</p>
</div>
<div class="paragraph">
<p>Un souhait pourrait aussi Ãªtre rÃ©alisÃ© plusieurs fois. Ceci revient Ã  dupliquer le souhait en question.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Besoins fonctionnels</p>
</div>
</div>
</div>
</div>
</div>
<h1 id="_gestion_des_utilisateurs" class="sect0">Gestion des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Pour gÃ©rer les utilisateurs, nous allons faire en sorte de surcharger ce que Django propose: par dÃ©faut, on a une la possibilitÃ© de gÃ©rer des utilisateurs (identifiÃ©s par une adresse email, un nom, un prÃ©nom, &#8230;&#8203;) mais sans plus.</p>
</div>
<div class="paragraph">
<p>Ce qu&#8217;on peut souhaiter, c&#8217;est que l&#8217;utilisateur puisse s&#8217;authentifier grÃ¢ce Ã  une plateforme connue (Facebook, Twitter, Google, etc.), et qu&#8217;il puisse un minimum gÃ©rer son profil.</p>
</div>
</div>
</div>
<h1 id="_gestion_des_listes" class="sect0">Gestion des listes</h1>
<div class="sect1">
<h2 id="_modÃ¨lisation">21. ModÃ¨lisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les donnÃ©es suivantes doivent Ãªtre associÃ©es Ã  une liste:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>un identifiant externe (un GUID, par exemple)</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une description</p>
</li>
<li>
<p>le propriÃ©taire, associÃ© Ã  l&#8217;utilisateur qui l&#8217;aura crÃ©Ã©e</p>
</li>
<li>
<p>une date de crÃ©ation</p>
</li>
<li>
<p>une date de modification</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fonctionnalitÃ©s">22. FonctionnalitÃ©s</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Un utilisateur authentifiÃ© doit pouvoir crÃ©er, modifier, dÃ©sactiver et supprimer une liste dont il est le propriÃ©taire</p>
</li>
<li>
<p>Un utilisateur doit pouvoir associer ou retirer des souhaits Ã  une liste dont il est le propriÃ©taire</p>
</li>
<li>
<p>Il faut pouvoir accÃ©der Ã  une liste, avec un utilisateur authentifier ou non, <strong>via</strong> son identifiant externe</p>
</li>
<li>
<p>Il faut pouvoir envoyer un email avec le lien vers la liste, contenant son identifiant externe</p>
</li>
<li>
<p>L&#8217;utilisateur doit pouvoir voir toutes les listes qui lui appartiennent</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_gestion_des_souhaits" class="sect0">Gestion des souhaits</h1>
<div class="sect1">
<h2 id="_modÃ©lisation_3">23. ModÃ©lisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les donnÃ©es suivantes peuvent Ãªtre associÃ©es Ã  un souhait:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>identifiant de la liste</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une description</p>
</li>
<li>
<p>le propriÃ©taire</p>
</li>
<li>
<p>une date de crÃ©ation</p>
</li>
<li>
<p>une date de modification</p>
</li>
<li>
<p>une image, afin de reprÃ©senter l&#8217;objet ou l&#8217;idÃ©e</p>
</li>
<li>
<p>un nombre (1 par dÃ©faut)</p>
</li>
<li>
<p>un prix facultatif</p>
</li>
<li>
<p>un nombre de part, facultatif Ã©galement, si un prix est fourni.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fonctionnalitÃ©s_2">24. FonctionnalitÃ©s</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Un utilisateur authentifiÃ© doit pouvoir crÃ©er, modifier, dÃ©sactiver et supprimer un souhait dont il est le propriÃ©taire.</p>
</li>
<li>
<p>On ne peut crÃ©er un souhait sans liste associÃ©e</p>
</li>
<li>
<p>Il faut pouvoir fractionner un souhait uniquement si un prix est donnÃ©.</p>
</li>
<li>
<p>Il faut pouvoir accÃ©der Ã  un souhait, avec un utilisateur authentifiÃ© ou non.</p>
</li>
<li>
<p>Il faut pouvoir rÃ©aliser un souhait ou une partie seulement, avec un utilisateur authentifiÃ© ou non.</p>
</li>
<li>
<p>Un souhait en cours de rÃ©alisation et composÃ© de diffÃ©rentes parts ne peut plus Ãªtre modifiÃ©.</p>
</li>
<li>
<p>Un souhait en cours de rÃ©alisation ou rÃ©alisÃ© ne peut plus Ãªtre supprimÃ©.</p>
</li>
<li>
<p>On peut modifier le nombre de fois qu&#8217;un souhait doit Ãªtre rÃ©alisÃ© dans la limite des rÃ©alisations dÃ©jÃ  effectuÃ©es.</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_gestion_des_rÃ©alisations_de_souhaits" class="sect0">Gestion des rÃ©alisations de souhaits</h1>
<div class="sect1">
<h2 id="_modÃ©lisation_4">25. ModÃ©lisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les donnÃ©es suivantes peuvent Ãªtre associÃ©es Ã  une rÃ©alisation de souhait:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>identifiant du souhait</p>
</li>
<li>
<p>identifiant de l&#8217;utilisateur si connu</p>
</li>
<li>
<p>identifiant de la personne si utilisateur non connu</p>
</li>
<li>
<p>un commentaire</p>
</li>
<li>
<p>une date de rÃ©alisation</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fonctionnalitÃ©s_3">26. FonctionnalitÃ©s</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>L&#8217;utilisateur doit pouvoir voir si un souhait est rÃ©alisÃ©, en partie ou non. Il doit Ã©galement avoir un pourcentage de complÃ©tion sur la possibilitÃ© de rÃ©alisation de son souhait, entre 0% et 100%.</p>
</li>
<li>
<p>L&#8217;utilisateur doit pouvoir voir la ou les personnes ayant rÃ©alisÃ© un souhait.</p>
</li>
<li>
<p>Il y a autant de rÃ©alisation que de parts de souhait rÃ©alisÃ©es ou de nombre de fois que le souhait est rÃ©alisÃ©.</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_gestion_des_personnes_rÃ©alisants_les_souhaits_et_qui_ne_sont_pas_connues" class="sect0">Gestion des personnes rÃ©alisants les souhaits et qui ne sont pas connues</h1>
<div class="sect1">
<h2 id="_modÃ©lisation_5">27. ModÃ©lisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les donnÃ©es suivantes peuvent Ãªtre associÃ©es Ã  une personne rÃ©alisant un souhait:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une adresse email facultative</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fonctionnalitÃ©s_4">28. FonctionnalitÃ©s</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>ModÃ©lisation</p>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;ORM de Django permet de travailler uniquement avec une dÃ©finition de classes, et de faire en sorte que le lien avec la base de donnÃ©es soit gÃ©rÃ© uniquement de maniÃ¨re indirecte, par Django lui-mÃªme. On peut schÃ©matiser ce comportement par  une classe = une table.</p>
</div>
<div class="paragraph">
<p>Comme on l&#8217;a vu dans la description des fonctionnalitÃ©s, on va <strong>grosso modo</strong> avoir besoin des Ã©lÃ©ments suivants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Des listes de souhaits</p>
</li>
<li>
<p>Des Ã©lÃ©ments qui composent ces listes</p>
</li>
<li>
<p>Des parts pouvant composer chacun de ces Ã©lÃ©ments</p>
</li>
<li>
<p>Des utilisateurs pour gÃ©rer tout ceci.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous proposons dans un premier temps d&#8217;Ã©luder la gestion des utilisateurs, et de simplement se concentrer sur les fonctionnalitÃ©s principales.
Cela nous donne ceci:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre># wish/models.py</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>from django.db import models</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Wishlist(models.Model):
    pass</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Item(models.Model):
    pass</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Part(models.Model):
    pass</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les classes sont crÃ©Ã©es, mais vides. Entrons dans les dÃ©tails.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Listes de souhaits</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Comme dÃ©jÃ  dÃ©crit prÃ©cÃ©demment, les listes de souhaits peuvent s&#8217;apparenter simplement Ã  un objet ayant un nom et une description. Pour rappel, voici ce qui avait Ã©tÃ© dÃ©fini dans les spÃ©cifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>un identifiant externe</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une description</p>
</li>
<li>
<p>une date de crÃ©ation</p>
</li>
<li>
<p>une date de modification</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notre classe <code>Wishlist</code> peut Ãªtre dÃ©finie de la maniÃ¨re suivante:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre># wish/models.py</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Wishlist(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>name = models.CharField(max_length=255)
description = models.TextField()
created_at = models.DateTimeField(auto_now_add=True)
updated_at = models.DateTimeField(auto_now=True)
external_id = models.UUIDField(unique=True, default=uuid.uuid4, editable=False)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Que peut-on constater?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Que s&#8217;il n&#8217;est pas spÃ©cifiÃ©, un identifiant <code>id</code> sera automatiquement gÃ©nÃ©rÃ© et accessible dans le modÃ¨le. Si vous souhaitez malgrÃ© tout spÃ©cifier que ce soit un champ en particulier qui devienne la clÃ© primaire, il suffit de l&#8217;indiquer grÃ¢ce Ã  l&#8217;attribut <code>primary_key=True</code>.</p>
</li>
<li>
<p>Que chaque type de champs (<code>DateTimeField</code>, <code>CharField</code>, <code>UUIDField</code>, etc.) a ses propres paramÃ¨tres d&#8217;initialisation. Il est intÃ©ressant de les apprendre ou de se rÃ©fÃ©rer Ã  la documentation en cas de doute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Au niveau de notre modÃ©lisation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La propriÃ©tÃ© <code>created_at</code> est gÃ©rÃ©e automatiquement par Django grÃ¢ce Ã  l&#8217;attribut <code>auto_now_add</code>: de cette maniÃ¨re, lors d&#8217;un <strong>ajout</strong>, une valeur par dÃ©faut ("<strong>maintenant</strong>") sera attribuÃ©e Ã  cette propriÃ©tÃ©.</p>
</li>
<li>
<p>La propriÃ©tÃ© <code>updated_at</code> est Ã©galement gÃ©rÃ©e automatique, cette fois grÃ¢ce Ã  l&#8217;attribut <code>auto_now</code> initialisÃ© Ã  <code>True</code>: lors d&#8217;une <strong>mise Ã  jour</strong>, la propriÃ©tÃ© se verra automatiquement assigner la valeur du moment prÃ©sent. Cela ne permet Ã©videmment pas de gÃ©rer un historique complet et ne nous dira pas <strong>quels champs</strong> ont Ã©tÃ© modifiÃ©s, mais cela nous conviendra dans un premier temps.</p>
</li>
<li>
<p>La propriÃ©tÃ© <code>external_id</code> est de type <code>UUIDField</code>. Lorsqu&#8217;une nouvelle instance sera instanciÃ©e, cette propriÃ©tÃ© prendra la valeur gÃ©nÃ©rÃ©e par la fonction <code>uuid.uuid4()</code>. <strong>A priori</strong>, chacun des types de champs possÃ¨de une propriÃ©tÃ© <code>default</code>, qui permet d&#8217;initialiser une valeur sur une nouvelle instance.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Souhaits</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Nos souhaits ont besoin des propriÃ©tÃ©s suivantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>l&#8217;identifiant de la liste auquel le souhait est liÃ©</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une description</p>
</li>
<li>
<p>le propriÃ©taire</p>
</li>
<li>
<p>une date de crÃ©ation</p>
</li>
<li>
<p>une date de modification</p>
</li>
<li>
<p>une image permettant de le reprÃ©senter.</p>
</li>
<li>
<p>un nombre (1 par dÃ©faut)</p>
</li>
<li>
<p>un prix facultatif</p>
</li>
<li>
<p>un nombre de part facultatif, si un prix est fourni.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>AprÃ¨s implÃ©mentation, cela ressemble Ã  ceci:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre># wish/models.py</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Wish(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>wishlist = models.ForeignKey(Wishlist)
name = models.CharField(max_length=255)
description = models.TextField()
created_at = models.DateTimeField(auto_now_add=True)
updated_at = models.DateTimeField(auto_now=True)
picture = models.ImageField()
numbers_available = models.IntegerField(default=1)
number_of_parts = models.IntegerField(null=True)
estimated_price = models.DecimalField(max_digits=19, decimal_places=2,
                                        null=True)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>A nouveau, que peut-on constater ?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les clÃ©s Ã©trangÃ¨res sont gÃ©rÃ©es directement dans la dÃ©claration du modÃ¨le. Un champ de type `ForeignKey &lt;<a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/#django.db.models.ForeignKey&gt;`_" class="bare">https://docs.djangoproject.com/en/1.8/ref/models/fields/#django.db.models.ForeignKey&gt;`_</a> permet de dÃ©clarer une relation 1-N entre deux classes. Dans la mÃªme veine, une relation 1-1 sera reprÃ©sentÃ©e par un champ de type `OneToOneField &lt;<a href="https://docs.djangoproject.com/en/1.8/topics/db/examples/one_to_one/&gt;`" class="bare">https://docs.djangoproject.com/en/1.8/topics/db/examples/one_to_one/&gt;`</a><em>, alors qu&#8217;une relation N-N utilisera un `ManyToManyField &lt;<a href="https://docs.djangoproject.com/en/1.8/topics/db/examples/many_to_many/&gt;`" class="bare">https://docs.djangoproject.com/en/1.8/topics/db/examples/many_to_many/&gt;`</a></em>.</p>
</li>
<li>
<p>L&#8217;attribut <code>default</code> permet de spÃ©cifier une valeur initiale, utilisÃ©e lors de la construction de l&#8217;instance. Cet attribut peut Ã©galement Ãªtre une fonction.</p>
</li>
<li>
<p>Pour rendre un champ optionnel, il suffit de lui ajouter l&#8217;attribut <code>null=True</code>.</p>
</li>
<li>
<p>Comme citÃ© ci-dessus, chaque champ possÃ¨de des attributs spÃ©cifiques. Le champ <code>DecimalField</code> possÃ¨de par exemple les attributs <code>max_digits</code> et <code>decimal_places</code>, qui nous permettra de reprÃ©senter une valeur comprise entre 0 et plus d&#8217;un milliard (avec deux chiffres dÃ©cimaux).</p>
</li>
<li>
<p>L&#8217;ajout d&#8217;un champ de type <code>ImageField</code> nÃ©cessite l&#8217;installation de <code>pillow</code> pour la gestion des images. Nous l&#8217;ajoutons donc Ã  nos prÃ©-requis, dans le fichier <code>requirements/base.txt</code>.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Parts</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Les parts ont besoins des propriÃ©tÃ©s suivantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>identifiant du souhait</p>
</li>
<li>
<p>identifiant de l&#8217;utilisateur si connu</p>
</li>
<li>
<p>identifiant de la personne si utilisateur non connu</p>
</li>
<li>
<p>un commentaire</p>
</li>
<li>
<p>une date de rÃ©alisation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Elles constituent la derniÃ¨re Ã©tape de notre modÃ©lisation et reprÃ©sente la rÃ©alisation d&#8217;un souhait. Il y aura autant de part d&#8217;un souhait que le nombre de souhait Ã  rÃ©aliser fois le nombre de part.</p>
</div>
<div class="paragraph">
<p>Elles permettent Ã  un utilisateur de participer au souhait Ã©mis par un autre utilisateur. Pour les modÃ©liser, une part est liÃ©e d&#8217;un cÃ´tÃ© Ã  un souhait, et d&#8217;autre part Ã  un utilisateur. Cela nous donne ceci:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>from django.contrib.auth.models import User</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class WishPart(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>wish = models.ForeignKey(Wish)
user = models.ForeignKey(User, null=True)
unknown_user = models.ForeignKey(UnknownUser, null=True)
comment = models.TextField(null=True, blank=True)
done_at = models.DateTimeField(auto_now_add=True)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>La classe <code>User</code> rÃ©fÃ©rencÃ©e au dÃ©but du snippet correspond Ã  l&#8217;utilisateur qui sera connectÃ©. Ceci est gÃ©rÃ© par Django. Lorsqu&#8217;une requÃªte est effectuÃ©e et est transmise au serveur, cette information sera disponible grÃ¢ce Ã  l&#8217;objet <code>request.user</code>, transmis Ã  chaque fonction ou <strong>Class-based-view</strong>. C&#8217;est un des avantages d&#8217;un framework tout intÃ©grÃ©: il vient <strong>batteries-included</strong> et beaucoup de dÃ©tails ne doivent pas Ãªtre pris en compte. Pour le moment, nous nous limiterons Ã  ceci. Par la suite, nous verrons comment amÃ©liorer la gestion des profils utilisateurs, comment y ajouter des informations et comment gÃ©rer les cas particuliers.</p>
</div>
<div class="paragraph">
<p>La classe <code>UnknownUser</code> permet de reprÃ©senter un utilisateur non enregistrÃ© sur le site et est dÃ©finie au point suivant.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Utilisateurs inconnus</p>
</div>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>todo:: je supprimerais pour que tous les utilisateurs soient gÃ©rÃ©s au mÃªme endroit.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour chaque rÃ©alisation d&#8217;un souhait par quelqu&#8217;un, il est nÃ©cessaire de sauver les donnÃ©es suivantes, mÃªme si l&#8217;utilisateur n&#8217;est pas enregistrÃ© sur le site:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un identifiant</p>
</li>
<li>
<p>un nom</p>
</li>
<li>
<p>une adresse email. Cette adresse email sera unique dans notre base de donnÃ©es, pour ne pas crÃ©er une nouvelle occurence si un mÃªme utilisateur participe Ã  la rÃ©alisation de plusieurs souhaits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ceci nous donne aprÃ¨s implÃ©mentation:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>class UnkownUser(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>name = models.CharField(max_length=255)
email = models.CharField(email = models.CharField(max_length=255, unique=True)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Tests unitaires</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>MÃ©thodologies</p>
</div>
</div>
</div>
</div>
</div>
<h1 id="_pourquoi_sennuyer_Ã _Ã©crire_des_tests" class="sect0">Pourquoi s&#8217;ennuyer Ã  Ã©crire des tests?</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Traduit grossiÃ¨rement depuis un article sur `https://medium.com &lt;<a href="https://medium.com/javascript-scene/what-every-unit-test-needs-f6cd34d9836d#.kfyvxyb21&gt;`_" class="bare">https://medium.com/javascript-scene/what-every-unit-test-needs-f6cd34d9836d#.kfyvxyb21&gt;`_</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Vos tests sont la premiÃ¨re et la meilleure ligne de dÃ©fense contre les dÃ©fauts de programmation. Ils sont</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Les tests unitaires combinent de nombreuses fonctionnalitÃ©s, qui en fait une arme secrÃ¨te au service d'un dÃ©veloppement rÃ©ussi:</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Aide au design: Ã©crire des tests avant d&#8217;Ã©crire le code vous donnera une meilleure perspective sur le design Ã  appliquer aux API.</p>
</li>
<li>
<p>Documentation (pour les dÃ©veloppeurs): chaque description d&#8217;un test</p>
</li>
<li>
<p>Tester votre comprÃ©hension en tant que dÃ©veloppeur:</p>
</li>
<li>
<p>Assurance qualitÃ©: des tests,
5.</p>
</li>
</ol>
</div>
</div>
</div>
<h1 id="_why_bother_with_test_discipline" class="sect0">Why Bother with Test Discipline?</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Your tests are your first and best line of defense against software defects. Your tests are more important than linting &amp; static analysis (which can only find a subclass of errors, not problems with your actual program logic). Tests are as important as the implementation itself (all that matters is that the code meets the requirementâââhow itâs implemented doesnât matter at all unless itâs implemented poorly).</p>
</div>
<div class="paragraph">
<p>Unit tests combine many features that make them your secret weapon to application success:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Design aid: Writing tests first gives you a clearer perspective on the ideal API design.</p>
</li>
<li>
<p>Feature documentation (for developers): Test descriptions enshrine in code every implemented feature requirement.</p>
</li>
<li>
<p>Test your developer understanding: Does the developer understand the problem enough to articulate in code all critical component requirements?</p>
</li>
<li>
<p>Quality Assurance: Manual QA is error prone. In my experience, itâs impossible for a developer to remember all features that need testing after making a change to refactor, add new features, or remove features.</p>
</li>
<li>
<p>Continuous Delivery Aid: Automated QA affords the opportunity to automatically prevent broken builds from being deployed to production.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Unit tests donât need to be twisted or manipulated to serve all of those broad-ranging goals. Rather, it is in the essential nature of a unit test to satisfy all of those needs. These benefits are all side-effects of a well-written test suite with good coverage.</p>
</div>
<div class="paragraph">
<p>âWhat are you testing?â</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What component aspect are you testing?</p>
</li>
<li>
<p>What should the feature do? What specific behavior requirement are you testing?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Couverture de code</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>On a vu au chapitre 1 qu&#8217;il Ã©tait possible d&#8217;obtenir une couverture de code, c&#8217;est-Ã -dire un pourcentage.</p>
</div>
<div class="paragraph">
<p>Comment tester ?</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Il y a deux maniÃ¨res d&#8217;Ã©crire les tests: soit avant, soit aprÃ¨s l&#8217;implÃ©mentation. Oui, idÃ©alement, les tests doivent Ãªtre Ã©crits Ã  l&#8217;avance. Entre nous, on ne va pas rÃ¢ler si vous faites l&#8217;inverse, l&#8217;important Ã©tant que vous le fassiez. Une bonne mÃ©trique pour vÃ©rifier l&#8217;avancement des tests est la couverture de code.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;exemple, nous allons Ã©crire la fonction <code>percentage_of_completion</code> sur la classe <code>Wish</code>, et nous allons spÃ©cifier les rÃ©sultats attendus avant mÃªme d&#8217;implÃ©menter son contenu. Prenons le cas oÃ¹ nous Ã©crivons la mÃ©thode avant son test:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>class Wish(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>[...]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@property
def percentage_of_completion(self):
    """
    Calcule le pourcentage de complÃ©tion pour un Ã©lÃ©ment.
    """
    number_of_linked_parts = WishPart.objects.filter(wish=self).count()
    total = self.number_of_parts * self.numbers_available
    percentage = (number_of_linked_parts / total)
    return percentage * 100</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lancez maintenant la couverture de code. Vous obtiendrez ceci:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ coverage run --source "." src/manage.py test wish
$ coverage report</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Name                             Stmts   Miss Branch BrPart  Cover
------------------------------------------------------------------
src\gwift\__init__.py                0      0      0      0   100%
src\gwift\settings\__init__.py       4      0      0      0   100%
src\gwift\settings\base.py          14      0      0      0   100%
src\gwift\settings\dev.py            8      0      2      0   100%
src\manage.py                        6      0      2      1    88%
src\wish\__init__.py                 0      0      0      0   100%
src\wish\admin.py                    1      0      0      0   100%
src\wish\models.py                  36      5      0      0    88%
------------------------------------------------------------------
TOTAL                               69      5      4      1    93%</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si vous gÃ©nÃ©rez le rapport HTML avec la commande <code>coverage html</code> et que vous ouvrez le fichier <code>coverage_html_report/src_wish_models_py.html</code>, vous verrez que les mÃ©thodes en rouge ne sont pas testÃ©es.
<strong>A contrario</strong>, la couverture de code atteignait <strong>98%</strong> avant l&#8217;ajout de cette nouvelle mÃ©thode.</p>
</div>
<div class="paragraph">
<p>Pour cela, on va utiliser un fichier <code>tests.py</code> dans notre application <code>wish</code>. <strong>A priori</strong>, ce fichier est crÃ©Ã© automatiquement lorsque vous initialisez une nouvelle application.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>from django.test import TestCase</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class TestWishModel(TestCase):
    def test_percentage_of_completion(self):
        """
        VÃ©rifie que le pourcentage de complÃ©tion d'un souhait
        est correctement calculÃ©.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Sur base d'un souhait, on crÃ©e quatre parts et on vÃ©rifie
que les valeurs s'Ã©talent correctement sur 25%, 50%, 75% et 100%.
"""
wishlist = Wishlist(name='Fake WishList',
                    description='This is a faked wishlist')
wishlist.save()</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>wish = Wish(wishlist=wishlist,
            name='Fake Wish',
            description='This is a faked wish',
            number_of_parts=4)
wish.save()</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>part1 = WishPart(wish=wish, comment='part1')
part1.save()
self.assertEqual(25, wish.percentage_of_completion)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>part2 = WishPart(wish=wish, comment='part2')
part2.save()
self.assertEqual(50, wish.percentage_of_completion)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>part3 = WishPart(wish=wish, comment='part3')
part3.save()
self.assertEqual(75, wish.percentage_of_completion)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>part4 = WishPart(wish=wish, comment='part4')
part4.save()
self.assertEqual(100, wish.percentage_of_completion)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;attribut <code>@property</code> sur la mÃ©thode <code>percentage_of_completion()</code> va nous permettre d&#8217;appeler directement la mÃ©thode <code>percentage_of_completion()</code> comme s&#8217;il s&#8217;agissait d&#8217;une propriÃ©tÃ© de la classe, au mÃªme titre que les champs <code>number_of_parts</code> ou <code>numbers_available</code>. Attention que ce type de mÃ©thode contactera la base de donnÃ©es Ã  chaque fois qu&#8217;elle sera appelÃ©e. Il convient de ne pas surcharger ces mÃ©thodes de connexions Ã  la base: sur de petites applications, ce type de comportement a trÃ¨s peu d&#8217;impacts, mais ce n&#8217;est plus le cas sur de grosses applications ou sur des mÃ©thodes frÃ©quemment appelÃ©es. Il convient alors de passer par un mÃ©canisme de <strong>cache</strong>, que nous aborderons plus loin.</p>
</div>
<div class="paragraph">
<p>En relanÃ§ant la couverture de code, on voit Ã  prÃ©sent que nous arrivons Ã  99%:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: shell</p>
<div class="literalblock">
<div class="content">
<pre>$ coverage run --source='.' src/manage.py test wish; coverage report; coverage html;
.
----------------------------------------------------------------------
Ran 1 test in 0.006s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...
Name                             Stmts   Miss Branch BrPart  Cover
------------------------------------------------------------------
src\gwift\__init__.py                0      0      0      0   100%
src\gwift\settings\__init__.py       4      0      0      0   100%
src\gwift\settings\base.py          14      0      0      0   100%
src\gwift\settings\dev.py            8      0      2      0   100%
src\manage.py                        6      0      2      1    88%
src\wish\__init__.py                 0      0      0      0   100%
src\wish\admin.py                    1      0      0      0   100%
src\wish\models.py                  34      0      0      0   100%
src\wish\tests.py                   20      0      0      0   100%
------------------------------------------------------------------
TOTAL                               87      0      4      1    99%</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>En continuant de cette maniÃ¨re (ie. Ecriture du code et des tests, vÃ©rification de la couverture de code), on se fixe un objectif idÃ©al dÃ¨s le dÃ©but du projet. En prenant un dÃ©veloppement en cours de route, fixez-vous comme objectif de ne jamais faire baisser la couverture de code.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Quelques liens utiles</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>`Django factory boy &lt;<a href="https://github.com/rbarrois/django-factory_boy/tree/v1.0.0&gt;`_" class="bare">https://github.com/rbarrois/django-factory_boy/tree/v1.0.0&gt;`_</a></p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>A retenir</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Constructeurs</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Si vous dÃ©cidez de dÃ©finir un constructeur sur votre modÃ¨le, ne surchargez pas la mÃ©thode <code><em>init</em></code>: crÃ©ez plutÃ´t une mÃ©thode static de type <code>create()</code>, en y associant les paramÃ¨tres obligatoires ou souhaitÃ©s:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre>class Wishlist(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@staticmethod
def create(name, description):
    w = Wishlist()
    w.name = name
    w.description = description
    w.save()
    return w</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Item(models.Model):</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@staticmethod
def create(name, description, wishlist):
    i = Item()
    i.name = name
    i.description = description
    i.wishlist = wishlist
    i.save()
    return i</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Mieux encore: on pourrait passer par un <code>ModelManager</code> pour limiter le couplage; l''accÃ¨s Ã  une information stockÃ©e en base de donnÃ©es ne se ferait dÃ¨s lors qu&#8217;au travers de cette instance et pas directement au travers du modÃ¨le. De cette maniÃ¨re, on limite le couplage des classes et on centralise l&#8217;accÃ¨s.</p>
</div>
<div class="paragraph">
<p>Relations</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Types de relations</p>
</div>
<div class="listingblock">
<div class="content">
<pre> * ForeignKey
 * ManyToManyField
 * OneToOneField

Dans les examples ci-dessus, nous avons vu les relations multiples (1-N), reprÃ©sentÃ©es par des **ForeignKey** d'une classe A vers une classe B. Il existe Ã©galement les champs de type **ManyToManyField**, afin de reprÃ©senter une relation N-N. Les champs de type **OneToOneField**, pour reprÃ©senter une relation 1-1.
Dans notre modÃ¨le ci-dessus, nous n'avons jusqu'Ã  prÃ©sent eu besoin que des relations 1-N: la premiÃ¨re entre les listes de souhaits et les souhaits; la seconde entre les souhaits et les parts.

Mise en pratique
----------------

Dans le cas de nos listes et de leurs souhaits, on a la relation suivante:

.. code-block:: python

    # wish/models.py

    class Wishlist(models.Model):
        pass


    class Item(models.Model):
        wishlist = models.ForeignKey(Wishlist)

Depuis le code, Ã  partir de l'instance de la classe ``Item``, on peut donc accÃ©der Ã  la liste en appelant la propriÃ©tÃ© ``wishlist`` de notre instance. *A contrario*, depuis une instance de type ``Wishlist``, on peut accÃ©der Ã  tous les Ã©lÃ©ments liÃ©s grÃ¢ce Ã  ``&lt;nom de la propriÃ©tÃ©&gt;_set``; ici ``item_set``.

Lorsque vous dÃ©clarez une relation 1-1, 1-N ou N-N entre deux classes, vous pouvez ajouter l'attribut ``related_name`` afin de nommer la relation inverse.

.. code-block:: python

    # wish/models.py

    class Wishlist(models.Model):
        pass


    class Item(models.Model):
        wishlist = models.ForeignKey(Wishlist, related_name='items')

A partir de maintenant, on peut accÃ©der Ã  nos propriÃ©tÃ©s de la maniÃ¨re suivante:

.. code-block:: python

    # python manage.py shell

    &gt;&gt;&gt; from wish.models import Wishlist, Item
    &gt;&gt;&gt; w = Wishlist('Liste de test', 'description')
    &gt;&gt;&gt; w = Wishlist.create('Liste de test', 'description')
    &gt;&gt;&gt; i = Item.create('Element de test', 'description', w)
    &gt;&gt;&gt;
    &gt;&gt;&gt; i.wishlist
    &lt;Wishlist: Wishlist object&gt;
    &gt;&gt;&gt;
    &gt;&gt;&gt; w.items.all()
    [&lt;Item: Item object&gt;]

Remarque: si, dans une classe A, plusieurs relations sont liÃ©es Ã  une classe B, Django ne saura pas Ã  quoi correspondra la relation inverse. Pour palier Ã  ce problÃ¨me et pour gagner en cohÃ©rence, on fixe alors une valeur Ã  l'attribut ``related_name``.

Querysets &amp; managers
--------------------

 * http://stackoverflow.com/questions/12681653/when-to-use-or-not-use-iterator-in-the-django-orm
 * https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.iterator
 * http://blog.etianen.com/blog/2013/06/08/django-querysets/


***********
Refactoring
***********

On constate que plusieurs classes possÃ¨dent les mÃªmes propriÃ©tÃ©s ``created_at`` et ``updated_at``, initialisÃ©es aux mÃªmes valeurs. Pour gagner en cohÃ©rence, nous allons crÃ©er une classe dans laquelle nous dÃ©finirons ces deux champs, et nous ferons en sorte que les classes ``Wishlist``, ``Item`` et ``Part`` en hÃ©ritent. Django gÃ¨re trois sortes d'hÃ©ritage:

 * L'hÃ©ritage par classe abstraite
 * L'hÃ©ritage classique
 * L'hÃ©ritage par classe proxy.


Classe abstraite</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;hÃ©ritage par classe abstraite consiste Ã  dÃ©terminer une classe mÃ¨re qui ne sera jamais instanciÃ©e. C&#8217;est utile pour dÃ©finir des champs qui se rÃ©pÃ¨teront dans plusieurs autres classes et surtout pour respecter le principe de DRY. Comme la classe mÃ¨re ne sera jamais instanciÃ©e, ces champs seront en fait dupliquÃ©s physiquement, et traduits en SQL, dans chacune des classes filles.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre># wish/models.py</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class AbstractModel(models.Model):
    class Meta:
        abstract = True</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>created_at = models.DateTimeField(auto_now_add=True)
updated_at = models.DateTimeField(auto_now=True)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Wishlist(AbstractModel):
    pass</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Item(AbstractModel):
    pass</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Part(AbstractModel):
    pass</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>En traduisant ceci en SQL, on aura en fait trois tables, chacune reprenant les champs <code>created_at</code> et <code>updated_at</code>, ainsi que son propre identifiant:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: sql</p>
<div class="literalblock">
<div class="content">
<pre>--$ python manage.py sql wish
BEGIN;
CREATE TABLE "wish_wishlist" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_item" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_part" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>COMMIT;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>HÃ©ritage classique</p>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;hÃ©ritage classique est gÃ©nÃ©ralement dÃ©conseillÃ©, car il peut introduire trÃ¨s rapidement un problÃ¨me de performances: en reprenant l&#8217;exemple introduit avec l&#8217;hÃ©ritage par classe abstraite, et en omettant l&#8217;attribut <code>abstract = True</code>, on se retrouvera en fait avec quatre tables SQL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une table <code>AbstractModel</code>, qui reprend les deux champs <code>created_at</code> et <code>updated_at</code></p>
</li>
<li>
<p>Une table <code>Wishlist</code></p>
</li>
<li>
<p>Une table <code>Item</code></p>
</li>
<li>
<p>Une table <code>Part</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A nouveau, en analysant la sortie SQL de cette modÃ©lisation, on obtient ceci:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: sql</p>
<div class="literalblock">
<div class="content">
<pre>--$ python manage.py sql wish</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>BEGIN;
CREATE TABLE "wish_abstractmodel" (
   "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
   "created_at" datetime NOT NULL,
   "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_wishlist" (
   "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;
CREATE TABLE "wish_item" (
   "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;
CREATE TABLE "wish_part" (
   "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>COMMIT;</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le problÃ¨me est que les identifiants seront dÃ©finis et incrÃ©mentÃ©s au niveau de la table mÃ¨re. Pour obtenir les informations hÃ©ritÃ©es, nous seront obligÃ©s de faire une jointure. En gros, impossible d&#8217;obtenir les donnÃ©es complÃ¨tes pour l&#8217;une des classes de notre travail de base sans effectuer un <strong>join</strong> sur la classe mÃ¨re.</p>
</div>
<div class="paragraph">
<p>Dans ce sens, cela va encore&#8230;&#8203; Mais imaginez que vous dÃ©finissiez une classe <code>Wishlist</code>, de laquelle hÃ©ritent les classes <code>ChristmasWishlist</code> et <code>EasterWishlist</code>: pour obtenir la liste complÃ¨tes des listes de souhaits, il vous faudra faire une jointure <strong>externe</strong> sur chacune des tables possibles, avant mÃªme d&#8217;avoir commencÃ© Ã  remplir vos donnÃ©es. Il est parfois nÃ©cessaire de passer par cette modÃ©lisation, mais en Ã©tant conscient des risques inhÃ©rents.</p>
</div>
<div class="paragraph">
<p>Classe proxy</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Lorsqu&#8217;on dÃ©finit une classe de type <strong>proxy</strong>, on fait en sorte que cette nouvelle classe ne dÃ©finisse aucun nouveau champ sur la classe mÃ¨re. Cela ne change dÃ¨s lors rien Ã  la traduction du modÃ¨le de donnÃ©es en SQL, puisque la classe mÃ¨re sera traduite par une table, et la classe fille ira rÃ©cupÃ©rer les mÃªmes informations dans la mÃªme table: elle ne fera qu&#8217;ajouter ou modifier un comportement dynamiquement, sans ajouter d&#8217;emplacements de stockage supplÃ©mentaires.</p>
</div>
<div class="paragraph">
<p>Nous pourrions ainsi dÃ©finir les classes suivantes:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>code-block:: python</p>
<div class="literalblock">
<div class="content">
<pre># wish/models.py</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class Wishlist(models.Model):
    name = models.CharField(max_length=255)
    description = models.CharField(max_length=2000)
    expiration_date = models.DateField()</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@staticmethod
def create(self, name, description, expiration_date=None):
    wishlist = Wishlist()
    wishlist.name = name
    wishlist.description = description
    wishlist.expiration_date = expiration_date
    wishlist.save()
    return wishlist</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class ChristmasWishlist(Wishlist):
    class Meta:
        proxy = True</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@staticmethod
def create(self, name, description):
    christmas = datetime(current_year, 12, 31)
    w = Wishlist.create(name, description, christmas)
    w.save()</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>class EasterWishlist(Wishlist):
    class Meta:
        proxy = True</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@staticmethod
def create(self, name, description):
    expiration_date = datetime(current_year, 4, 1)
    w = Wishlist.create(name, description, expiration_date)
    w.save()</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Gestion des utilisateurs</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Dans les spÃ©cifications, nous souhaitions pouvoir associer un utilisateur Ã  une liste (<strong>le propriÃ©taire</strong>) et un utilisateur Ã  une part (<strong>le donateur</strong>). Par dÃ©faut, Django offre une gestion simplifiÃ©e des utilisateurs (pas de connexion LDAP, pas de double authentification, &#8230;&#8203;): juste un utilisateur et un mot de passe. Pour y accÃ©der, un paramÃ¨tre par dÃ©faut est dÃ©fini dans votre fichier de settings: <code>AUTH_USER_MODEL</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Jouons un peu avec la console</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>MÃ©tamodÃ¨le</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Sous ce titre franchement pompeux, on va un peu parler de la modÃ©lisation du modÃ¨le. Quand on prend une classe (par exemple, <code>Wishlist</code> que l&#8217;on a dÃ©fini ci-dessus), on voit qu&#8217;elle hÃ©rite par dÃ©faut de <code>models.Model</code>. On peut regarder les propriÃ©tÃ©s dÃ©finies dans cette classe en analysant le fichier <code>lib\site-packages\django\models\base.py</code>. On y voit notamment que <code>models.Model</code> hÃ©rite de <code>ModelBase</code> au travers de `six &lt;<a href="https://pypi.python.org/pypi/six&gt;`_" class="bare">https://pypi.python.org/pypi/six&gt;`_</a> pour la rÃ©trocompatibilitÃ© vers Python 2.7.</p>
</div>
<div class="paragraph">
<p>Cet hÃ©ritage apporte notamment les fonctions <code>save()</code>, <code>clean()</code>, <code>delete()</code>, &#8230;&#8203; Bref, toutes les mÃ©thodes qui font qu&#8217;une instance est sait <strong>comment</strong> interagir avec la base de donnÃ©es. La base d&#8217;un `ORM &lt;<a href="https://en.wikipedia.org/wiki/Object-relational_mapping&gt;`_" class="bare">https://en.wikipedia.org/wiki/Object-relational_mapping&gt;`_</a>, en fait.</p>
</div>
<div class="paragraph">
<p>D&#8217;autre part, chaque classe hÃ©ritant de <code>models.Model</code> possÃ¨de une propriÃ©tÃ© <code>objects</code>. Comme on l&#8217;a vu dans la section <strong>Jouons un peu avec la console</strong>, cette propriÃ©tÃ© permet d&#8217;accÃ©der aux objects persistants dans la base de donnÃ©es.</p>
</div>
<div class="paragraph">
<p>== Supervision des logs</p>
</div>
<div class="paragraph">
<p>== feedbacks utilisateurs</p>
</div>
<div class="paragraph">
<p>= En bonus</p>
</div>
<div class="paragraph">
<p>== Snippets utiles (et forcÃ©ment dispensables)</p>
</div>
<div class="paragraph">
<p>=== RÃ©cupÃ©ration du dernier tag Git en Python</p>
</div>
<div class="paragraph">
<p>L&#8217;idÃ©e ici est simplement de pouvoir afficher le numÃ©ro de version ou le hash d&#8217;exÃ©cution du code, sans avoir Ã  se connecter au dÃ©pÃ´t. Cela apporte une certaine transparence, <strong>sous rÃ©serve que le code soit gÃ©rÃ© par Git</strong>. Si vous suivez scrupuleusement les 12 facteurs, la version de l&#8217;application dÃ©ployÃ©e n&#8217;est plus sensÃ©e conserver un lien avec votre dÃ©pÃ´t d&#8217;origine&#8230;&#8203; Si vous dÃ©ployez votre code en utilisant un <code>git fetch</code> puis un <code>git checkout &lt;tag_name&gt;</code>, le morceau de code ci-dessous pourra vous intÃ©resser :-)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-02-16 21:01:55 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cm {
  color: #75715e;
  font-style: italic;
}
pre.rouge .c1 {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cp {
  color: #75715e;
  font-weight: bold;
}
pre.rouge .cs {
  color: #75715e;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .err {
  color: #960050;
  background-color: #1e0010;
}
pre.rouge .gi {
  color: #ffffff;
  background-color: #324932;
}
pre.rouge .gd {
  color: #ffffff;
  background-color: #493131;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .k, pre.rouge .kv {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kc {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kd {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kp {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kr {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kt {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kn {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .ow {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .o {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .mf {
  color: #ae81ff;
}
pre.rouge .mh {
  color: #ae81ff;
}
pre.rouge .il {
  color: #ae81ff;
}
pre.rouge .mi {
  color: #ae81ff;
}
pre.rouge .mo {
  color: #ae81ff;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #ae81ff;
}
pre.rouge .se {
  color: #ae81ff;
}
pre.rouge .sb {
  color: #e6db74;
}
pre.rouge .sc {
  color: #e6db74;
}
pre.rouge .sd {
  color: #e6db74;
}
pre.rouge .s2 {
  color: #e6db74;
}
pre.rouge .sh {
  color: #e6db74;
}
pre.rouge .si {
  color: #e6db74;
}
pre.rouge .sx {
  color: #e6db74;
}
pre.rouge .sr {
  color: #e6db74;
}
pre.rouge .s1 {
  color: #e6db74;
}
pre.rouge .ss {
  color: #e6db74;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #e6db74;
}
pre.rouge .na {
  color: #a6e22e;
}
pre.rouge .nc {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nd {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .ne {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .no {
  color: #66d9ef;
}
pre.rouge .bp {
  color: #f8f8f2;
}
pre.rouge .nb {
  color: #f8f8f2;
}
pre.rouge .ni {
  color: #f8f8f2;
}
pre.rouge .nn {
  color: #f8f8f2;
}
pre.rouge .vc {
  color: #f8f8f2;
}
pre.rouge .vg {
  color: #f8f8f2;
}
pre.rouge .vi {
  color: #f8f8f2;
}
pre.rouge .nv, pre.rouge .vm {
  color: #f8f8f2;
}
pre.rouge .w {
  color: #f8f8f2;
}
pre.rouge .nl {
  color: #f8f8f2;
  font-weight: bold;
}
pre.rouge .nt {
  color: #f92672;
}
pre.rouge {
  color: #f8f8f2;
  background-color: #49483e;
}
</style>
</body>
</html>