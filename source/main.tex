%% Preamble %%
%% A minimal LaTeX preamble
%% Some packates are needed to implement
%% Asciidoc features


\documentclass[11pt]{amsbook}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}               % ... or a4paper or a5paper or ...
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}       % Activate to begin paragraphs with an empty line rather than an indent

\usepackage{tcolorbox}
\usepackage{lipsum}

\usepackage{epstopdf}
\usepackage{color}
% \usepackage[usenames, dvipsnames]{color}
% \usepackage{alltt}


\usepackage{amssymb}
% \usepackage{amsmath}
\usepackage{amsthm}
\usepackage[version=3]{mhchem}


% Needed to properly typeset
% standard unicode characters:
%
\RequirePackage{fix-cm}
\usepackage{fontspec}
\usepackage[Latin,Greek]{ucharclasses}
%
% NOTE: you must also use xelatex
% as the typesetting engine


% \usepackage{fontspec}
% \usepackage{polyglossia}
% \setmainlanguage{en}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,
    urlcolor=cyan,
}

\usepackage{graphicx}
\usepackage{wrapfig}
\graphicspath{ {images/} }
\DeclareGraphicsExtensions{.png, .jpg, jpeg, .pdf}

%% \DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}
%% Asciidoc TeX Macros %%


% \pagecolor{black}
%%%%%%%%%%%%


% Needed for Asciidoc

\newcommand{\admonition}[2]{\textbf{#1}: {#2}}
\newcommand{\rolered}[1]{ \textcolor{red}{#1} }
\newcommand{\roleblue}[1]{ \textcolor{blue}{#1} }

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{problem}{Problem}
\newtheorem{exercise}{Exercise}
\newtheorem{example}{Example}
\newtheorem{note}{Note}
\newtheorem{joke}{Joke}
\newtheorem{objection}{Objection}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%  Extended quote environment with author

\renewenvironment{quotation}
{   \leftskip 4em \begin{em} }
{\end{em}\par }

\def\signed#1{{\leavevmode\unskip\nobreak\hfil\penalty50\hskip2em
  \hbox{}\nobreak\hfil\raise-3pt\hbox{(#1)}%
  \parfillskip=0pt \finalhyphendemerits=0 \endgraf}}


\newsavebox\mybox

\newenvironment{aquote}[1]
  {\savebox\mybox{#1}\begin{quotation}}
  {\signed{\usebox\mybox}\end{quotation}}

\newenvironment{tquote}[1]
  {  {\bf #1} \begin{quotation} \\ }
  { \end{quotation} }

%% BOXES: http://tex.stackexchange.com/questions/83930/what-are-the-different-kinds-of-boxes-in-latex
%% ENVIRONMENTS: https://www.sharelatex.com/learn/Environments

\newenvironment{asciidocbox}
  {\leftskip6em\rightskip6em\par}
  {\par}

\newenvironment{titledasciidocbox}[1]
  {\leftskip6em\rightskip6em\par{\bf #1}\vskip-0.6em\par}
  {\par}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% http://texblog.org/tag/rightskip/


\newenvironment{preamble}
  {}
  {}

%% http://tex.stackexchange.com/questions/99809/box-or-sidebar-for-additional-text
%%
\newenvironment{sidebar}[1][r]
  {\wrapfigure{#1}{0.5\textwidth}\tcolorbox}
  {\endtcolorbox\endwrapfigure}


%%%%%%%%%%

\newenvironment{comment*}
  {\leftskip6em\rightskip6em\par}
  {\par}

  \newenvironment{remark*}
  {\leftskip6em\rightskip6em\par}
  {\par}


%% Dummy environment for testing:

\newenvironment{foo}
  {\bf Foo.\ }
  {}


\newenvironment{foo*}
  {\bf Foo.\ }
  {}


\newenvironment{click}
  {\bf Click.\ }
  {}

\newenvironment{click*}
  {\bf Click.\ }
  {}


\newenvironment{remark}
  {\bf Remark.\ }
  {}

\newenvironment{capsule}
  {\leftskip10em\par}
  {\par}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Style

\parindent0pt
\parskip8pt
%% User Macros %%
%% Front Matter %%

\title{Minor swing with Django}
\author{C√©dric Declerfayt}
\date{}


%% Begin Document %%

\begin{document}
\maketitle
\tableofcontents
Nous n‚Äôallons pas vous mentir: il existe enorm√©ment de tutoriaux tr√®s bien r√©alis√©s sur "\emph{Comment r√©aliser une application Django}" et autres "\emph{D√©ployer votre code en 2 minutes}". Nous nous disions juste que ces tutoriaux restaient relativement haut-niveaux et se limitaient √† un contexte donn√©.


L‚Äôid√©e du texte ci-dessous est de jeter les bases d‚Äôun bon d√©veloppement, en survolant l‚Äôensemble des outils permettant de suivre des lignes directrices reconnues, de maintenir une bonne qualit√© de code au travers des diff√©rentes √©tapes (du d√©veloppement au d√©ploiement) et de s‚Äôassurer du maintient correct de la base de code, en permettant √† n‚Äôimporte qui de reprendre le d√©veloppement.


Ces id√©es ne s‚Äôappliquent pas uniquement √† Django et √† son cadre de travail, ni m√™me au langage Python. Juste que ces deux sujets sont de bons candidats et que le cadre de travail est bien d√©fini et suffisamment flexible.


Django se pr√©sente comme un "\href{https://www.djangoproject.com/}{Framework Web pour perfectionnistes ayant des deadlines}" et suit \href{https://docs.djangoproject.com/en/dev/misc/design-philosophies/}{ces quelques principes}:


\begin{itemize}

\item Faible couplage et forte coh√©sion, pour que chaque composant dispose de son ind√©pendance.

\item Moins de code, plus de fonctionnalit√©s.

\item \href{https://fr.wikipedia.org/wiki/Ne_vous_r%C3%A9p%C3%A9tez_pas}{Don‚Äôt repeat yourself}: on ne se r√©p√®te pas !

\item Rapidit√© du d√©veloppement (apr√®s une petite courbe d‚Äôapprentissage un peu ardue au d√©but ;-))

\end{itemize}


Mis c√¥te √† c√¥te, l‚Äôapplication de ces principes permet une meilleure stabilit√© du projet √† moyen et long terme. Tout pour plaire √† n‚Äôimporte quel directeur IT.


\textbf{Dans la premi√®re partie}, nous verrons comment partir d‚Äôun environnement sain, comment le configurer correctement, comment installer Django de mani√®re isol√©e et comment d√©marrer un nouveau projet.
Nous verrons rapidement comment g√©rer les d√©pendances, les versions et comment appliquer et suivre un score de qualit√© de notre code.
Nous verrons aussi que la configuration propos√©e par d√©faut par le framework n‚Äôest pas id√©ale dans la majorit√© des cas.


Pour cela, nous pr√©senterons diff√©rents outils, la r√©daction de tests unitaires et d‚Äôint√©gration pour limiter les r√©gressions, les r√®gles de nomenclature et de contr√¥le du contenu, comment partir d‚Äôun squelette plus complet, ainsi que les bonnes √©tapes √† suivre pour arriver √† un d√©ploiement rapide et fonctionnel avec peu d‚Äôefforts.


A la fin de cette partie, vous disposerez d‚Äôun code propre et d‚Äôun projet fonctionnel (mais encore inutile, parce qu‚Äôencore vide).


\textbf{Dans la deuxi√®me partie}, nous d√©taillerons pr√©cis√©ment les √©tapes de d√©ploiement, avec la description et la configuration de l‚Äôinfrastructure, des exemples concrets de mise √† disposition sur deux distributions principales (Debian et CentOS), sur une \emph{*Plateform as a Service*}, ainsi que l‚Äôutilisation de Docker et Docker-Compose.


Nous aborderons √©galement la supervision et la mise √† jour d‚Äôune application existante, en respectant les bonnes pratiques d‚Äôadministration syst√®me.


\textbf{Dans la troisi√®me partie}, nous aborderons les grands principes de mod√©lisation, en suivant les lignes de conduites du cadre de travail.
Nous aborderons les concepts cl√©s qui permettent √† une application de rester maintenable, les formulaires, leurs validations, comment g√©rer les donn√©es en entr√©e, les migrations de donn√©es et l‚Äôadministration.


\textbf{Dans la quatri√®me partie}, nous mettrons ces concepts en pratique en pr√©sentant le d√©veloppement de deux "vraies" applications: d√©finition des tables, gestion des utilisateurs, ‚Ä¶‚Äã et mise √† disposition!


Et tout √ßa √† un seul et m√™me endroit.\footnote{Avec un peu d‚Äô\href{https://www.xkcd.com}{XKCD} dedans} Oui. :-)


Bonne lecture.


\hypertarget{x-environnement-de-travail}{\part*{Environnement de travail}}
\begin{aquote}{Kent Beck}{}
Make it work, make it right, make it fast
\end{aquote}

Avant de d√©marrer le d√©veloppement, il est n√©cessaire de passer un peu de temps sur la configuration de l‚Äôenvironnement.


Les morceaux de code que vous trouverez ci-dessous seront d√©velopp√©s pour Python3.9+ et Django 3.2+.
Ils n√©cessiteront peut-√™tre quelques adaptations pour fonctionner sur une version ant√©rieure.


Django fonctionne sur un \href{https://docs.djangoproject.com/en/dev/internals/release-process/}{roulement de trois versions mineures pour une version majeure}, cl√¥tur√© par une version LTS (\emph{Long Term Support}).


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django-support-lts.png}


\end{figure}

La version utilis√©e sera une bonne indication √† prendre en consid√©ration pour nos d√©pendances, puisqu‚Äôen visant une version particuli√®re, nous ne devrons pratiquement pas nous soucier (bon, un peu quand m√™me, mais nous le verrons plus tard‚Ä¶‚Äã) des d√©pendances √† installer, pour peu que l‚Äôon reste sous un certain seuil.


Dans cette partie, nous allons parler de \textbf{m√©thodes de travail}, avec comme objectif d‚Äô√©viter que l‚Äôapplication ne tourne que sur notre machine et que chaque d√©ploiement ne soit une plaie √† g√©rer.
Chaque mise √† jour doit √™tre r√©alisable de la mani√®re la plus simple possible:


\begin{enumerate}

\item{d√©marrer un script,}

\item{pr√©voir un rollback si cela plante}

\item{se pr√©parer une tisane en regardant nos flux RSS (si cette technologie existe encore‚Ä¶‚Äã).}

\end{enumerate}


\admonition{NOTE}{La plupart des commandes qui seront pr√©sent√©es dans ce livre le seront depuis un shell sous GNU/Linux. Certaines d‚Äôentre elles pourraient devoir √™tre adapt√©es si vous utilisez un autre syst√®me d‚Äôexploitation (macOS) ou n‚Äôimporte quelle autre grosse bouse commerciale.}
\hypertarget{x-construire-des-applications-maintenables}{\chapter{Construire des applications maintenables}}
\hypertarget{x-12-facteurs}{\section{12 facteurs}}
Pour la m√©thode de travail et de d√©veloppement, nous allons nous baser sur les \href{https://12factor.net/fr/}{The Twelve-factor App} - ou plus simplement les \textbf{12 facteurs}.


L‚Äôid√©e derri√®re cette m√©thode, et ind√©pendamment des langages de d√©veloppement utilis√©s, consiste √† suivre un ensemble de douze concepts, afin de:


\begin{enumerate}

\item{\textbf{Faciliter la mise en place de phases d‚Äôautomatisation}; plus concr√®tement, de faciliter les mises √† jour applicatives, simplifier la gestion de l‚Äôh√¥te, diminuer la divergence entre les diff√©rents environnements d‚Äôex√©cution et offrir la possibilit√© d‚Äôint√©grer le projet dans un processus d‚Äô\href{https://en.wikipedia.org/wiki/Continuous_integration}{int√©gration continue} ou \href{https://en.wikipedia.org/wiki/Continuous_deployment}{d√©ploiement continu}}

\item{\textbf{Faciliter la mise √† pied de nouveaux d√©veloppeurs ou de personnes souhaitant rejoindre le projet}, dans la mesure o√π la mise √† disposition d‚Äôun environnement sera grandement facilit√©e.}

\item{\textbf{Minimiser les divergences entre les diff√©rents environnemens sur lesquels un projet pourrait √™tre d√©ploy√©}}

\item{\textbf{Augmenter l‚Äôagilit√© g√©n√©rale du projet}, en permettant une meilleure √©volutivit√© architecturale et une meilleure mise √† l‚Äô√©chelle - \emph{Vous avez 5000 utilisateurs en plus? Ajoutez un serveur et on n‚Äôen parle plus ;-)}.}

\end{enumerate}


En pratique, les points ci-dessus permettront de monter facilement un nouvel environnement - qu‚Äôil soit sur la machine du petit nouveau dans l‚Äô√©quipe, sur un serveur Azure, Heroku, Digital Ocean ou votre nouveau Raspberry Pi Z√©ro cach√© √† la cave - et vous feront gagner un temps pr√©cieux.


Pour reprendre de mani√®re tr√®s brute les diff√©rentes id√©es derri√®re cette m√©thode, nous avons:


\section{Une base de code unique, suivie par un syst√®me de contr√¥le de versions}


Chaque d√©ploiement de l‚Äôapplication se basera sur cette source, afin de minimiser les diff√©rences que l‚Äôon pourrait trouver entre deux environnements d‚Äôun m√™me projet. On utilisera un d√©p√¥t Git - Github, Gitlab, Gitea, ‚Ä¶‚Äã Au choix.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/diagrams/12-factors-1.png}

\centering
\end{figure}

\textbf{2 - D√©clarez explicitement les d√©pendances n√©cessaires au projet, et les isoler du reste du syst√®me lors de leur installation}


Chaque installation ou configuration doit toujours √™tre faite de la m√™me mani√®re, et doit pouvoir √™tre r√©p√©t√©e quel que soit l‚Äôenvironnement cible.


Cela permet d‚Äô√©viter que l‚Äôapplication n‚Äôutilise une d√©pendance qui soit d√©j√† install√©e sur un des syt√®mes de d√©veloppement, et qu‚Äôelle soit difficile, voire impossible, √† r√©percuter sur un autre environnement.
Dans notre cas, cela pourra √™tre fait au travers de \href{https://pypi.org/project/pip/}{PIP - Package Installer for Python} ou \href{https://python-poetry.org/}{Poetry}.


Mais dans tous les cas, chaque application doit disposer d‚Äôun environnement sain, qui lui est assign√©, et vu le peu de ressources que cela co√ªte, il ne faut pas s‚Äôen priver.


Chaque d√©pendance pouvant √™tre d√©clar√©e et √©pingl√©e dans un fichier, il suffira de cr√©er un nouvel environment vierge, puis d‚Äôutiliser ce fichier comme param√®tre pour installer les pr√©requis au bon fonctionnement de notre application et v√©rifier que cet environnement est bien reproductible.


\admonition{WARNING}{Il est important de bien "√©pingler" les versions li√©es aux d√©pendances de l‚Äôapplication. Cela peut √©viter des effets de bord comme une nouvelle version d‚Äôune librairie dans laquelle un bug aurait pu avoir √©t√© introduit.\footnote{Au conditionnel du futur plus-que-parfait ant√©rieur. Mais √ßa arrive. Et tout le temps au mauvais moment.}}
\textbf{3 - Sauver la configuration directement au niveau de l‚Äôenvironnement}


Nous voulons √©viter d‚Äôavoir √† recompiler/red√©ployer l‚Äôapplication parce que:


\begin{enumerate}

\item{l‚Äôadresse du serveur de messagerie a √©t√© modifi√©e,}

\item{un protocole a chang√© en cours de route}

\item{la base de donn√©es a √©t√© d√©plac√©e}

\item{‚Ä¶‚Äã}

\end{enumerate}


En pratique, toute information susceptible de modifier un lien applicatif doit se trouver dans un fichier ou dans une variable d‚Äôenvironnement, et doit √™tre facilement modifiable.
En allant un pas plus loin, cela permettra de param√©trer facilement un container, en modifiant une variable de configuration qui sp√©cifierait la base de donn√©es sur laquelle l‚Äôapplication devra se connecter.


Toute cl√© de configuration (nom du serveur de base de donn√©es, adresse d‚Äôun service Web externe, cl√© d‚ÄôAPI pour l‚Äôinterrogation d‚Äôune ressource, ‚Ä¶‚Äã) sera d√©finie directement au niveau de l‚Äôh√¥te - √† aucun moment, nous ne devons trouver un mot de passe en clair dans le d√©p√¥t source ou une valeur susceptible d‚Äô√©voluer, √©crite en dur dans le code.


\textbf{4 - Traiter les ressources externes comme des ressources attach√©es}


Nous parlons de bases de donn√©es, de services de mise en cache, d‚ÄôAPI externes, ‚Ä¶‚Äã
L‚Äôapplication doit √™tre capable d‚Äôeffectuer des changements au niveau de ces ressources sans que son code ne soit modifi√©. Nous parlons alors de \textbf{ressources attach√©es}, dont la pr√©sence est n√©cessaire au bon fonctionnement de l‚Äôapplication, mais pour lesquelles le \textbf{type} n‚Äôest pas obligatoirement d√©fini.


Nous voulons par exemple "une base de donn√©es" et "une m√©moire cache", et pas "une base MariaDB et une instance Memcached". De cette mani√®re, les ressources peuvent √™tre attach√©es et d√©tach√©es d‚Äôun d√©ploiement √† la vol√©e.


Si une base de donn√©es ne fonctionne pas correctement (probl√®me mat√©riel?), l‚Äôadministrateur pourrait simplement restaurer un nouveau serveur √† partir d‚Äôune pr√©c√©dente sauvegarde, et l‚Äôattacher √† l‚Äôapplication sans que le code source ne soit modifi√©. une solution consiste √† passer toutes ces informations (nom du serveur et type de base de donn√©es, cl√© d‚Äôauthentification, ‚Ä¶‚Äã) directement via des variables d‚Äôenvironnement.


\textbf{5 - S√©parer proprement les phases de construction, de mise √† disposition et d‚Äôex√©cution}


\begin{enumerate}

\item{La \textbf{construction} (\emph{build}) convertit un code source en un ensemble de fichiers ex√©cutables, associ√© √† une version et √† une transaction dans le syst√®me de gestion de sources.}

\item{La \textbf{mise √† disposition} (\emph{release}) associe cet ensemble √† une configuration pr√™te √† √™tre ex√©cut√©e,}

\item{tandis que la phase d'\textbf{ex√©cution} (\emph{run}) d√©marre les processus n√©cessaires au bon fonctionnement de l‚Äôapplication.}

\end{enumerate}


Parmi les solutions possibles, nous pourrions nous pourrions nous baser sur les \emph{releases} de Gitea, sur un serveur d‚Äôartefacts ou sur \href{https://fr.wikipedia.org/wiki/Capistrano_(logiciel)}{Capistrano}.


\textbf{6 - Les processus d‚Äôex√©cution ne doivent rien conna√Ætre ou conserver de l‚Äô√©tat de l‚Äôapplication}


Toute information stock√©e en m√©moire ou sur disque ne doit pas alt√©rer le comportement futur de l‚Äôapplication, par exemple apr√®s un red√©marrage non souhait√©.


Pratiquement, si l‚Äôapplication devait rencontrer un probl√®me, nous pourrions la red√©marrer sur un autre serveur. Toute information qui aurait √©t√© stock√©e durant l‚Äôex√©cution de l‚Äôapplication sur le premier h√¥te serait donc perdue.
Si une r√©initialisation devait √™tre n√©cessaire, l‚Äôapplication ne devra pas compter sur la pr√©sence d‚Äôune information au niveau du nouveau syst√®me.


Il serait √©galement difficile d‚Äôappliquer une mise √† l‚Äô√©chelle de l‚Äôapplication si une donn√©e indispensable √† son fonctionnement devait se trouver sur une seule machine o√π elle est ex√©cut√©e.


\textbf{7 - Autoriser la liaison d‚Äôun port de l‚Äôapplication √† un port du syst√®me h√¥te}


Les applications 12-factors sont auto-contenues et peuvent fonctionner en autonomie totale.
L‚Äôid√©e est qu‚Äôelles puissent √™tre joignables gr√¢ce √† un m√©canisme de ponts, o√π l‚Äôh√¥te effectue la redirection vers l‚Äôun des ports ouverts par l‚Äôapplication, typiquement, en HTTP ou via un autre protocole.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/diagrams/12-factors-7.png}

\centering
\end{figure}

\textbf{8 - Faites confiance aux processus syst√®mes pour l‚Äôex√©cution de l‚Äôapplication}


Comme d√©crit plus haut, l‚Äôapplication doit utiliser des processus \emph{stateless} (sans √©tat).
Nous pouvons cr√©er et utiliser des processus suppl√©mentaires pour tenir plus facilement une lourde charge, ou d√©dier des processus particuliers pour certaines t√¢ches: requ√™tes HTTP \emph{via} des processus Web; \emph{long-running} jobs pour des processus asynchrones, ‚Ä¶‚Äã
Si cela existe au niveau du syst√®me, ne vous fatiguez pas: utilisez le.


\textbf{9 - Am√©liorer la robustesse de l‚Äôapplication gr√¢ce √† des arr√™ts √©l√©gants et √† des d√©marrages rapides}


Par "arr√™t √©l√©gant", nous voulons surtout √©viter le \texttt{kill -9 <pid>} ou tout autre arr√™t brutal d‚Äôun processus qui n√©cessiterait une intervention urgente du superviseur.
De cette mani√®re, les requ√™tes en cours pourront se terminer au mieux, tandis que le d√©marrage rapide de nouveaux processus am√©liorera la balance d‚Äôun processus en cours d‚Äôextinction vers des processus tout frais.


L‚Äôint√©gration de ces m√©canismes d√®s les premi√®res √©tapes de d√©veloppement limitera les perturbations et facilitera la prise en compte d‚Äôarr√™ts inopin√©s (probl√®me mat√©riel, red√©marrage du syst√®me h√¥te, etc.).


\textbf{10 - Conserver les diff√©rents environnements aussi similaires que possible, et limiter les divergences entre un environnement de d√©veloppement et de production}


L‚Äôexemple donn√© est un d√©veloppeur qui utilise macOS, NGinx et SQLite, tandis que l‚Äôenvironnement de production tourne sur une CentOS avec Apache2 et PostgreSQL.
L‚Äôid√©e derri√®re ce concept limite les divergences entre environnements, facilite les d√©ploiements et limite la casse et la d√©couverte de modules non compatibles d√®s les premi√®res phases de d√©veloppement.


Pour vous donner un exemple tout b√™te, SQLite utilise un \href{https://www.sqlite.org/datatype3.html}{m√©canisme de stockage dynamique}, associ√©e √† la valeur plut√¥t qu‚Äôau sch√©ma, \emph{via} un syst√®me d‚Äôaffinit√©s. Un autre moteur de base de donn√©es d√©finira un sch√©ma statique et rigide, o√π la valeur sera d√©termin√©e par son contenant.
Un champ \texttt{URLField} propos√© par Django a une longeur maximale par d√©faut de \href{https://docs.djangoproject.com/en/3.1/ref/forms/fields/#django.forms.URLField}{200 caract√®res}.
Si vous faites vos d√©veloppements sous SQLite et que vous rencontrez une URL de plus de 200 caract√®res, votre d√©veloppement sera passera parfaitement bien, mais plantera en production (ou en \emph{staging}, si vous faites les choses un peu mieux) parce que les donn√©es seront tronqu√©es‚Ä¶‚Äã


Conserver des environements similaires limite ce genre de d√©sagr√©ments.


\textbf{11 - G√©rer les journeaux d‚Äô√©v√®nements comme des flux}


Une application ne doit jamais se soucier de l‚Äôendroit o√π ses √©v√®nements seront √©crits, mais simplement de les envoyer sur la sortie \texttt{stdout}.
De cette mani√®re, que nous soyons en d√©veloppement sur le poste d‚Äôun d√©veloppeur avec une sortie console ou sur une machine de production avec un envoi vers une instance \href{https://www.graylog.org/}{Greylog} ou \href{https://sentry.io/welcome/}{Sentry}, le routage des journaux sera r√©alis√© en fonction de sa n√©cessit√© et de sa criticit√©, et non pas parce que le d√©veloppeur l‚Äôa sp√©cifi√© en dur dans son code.


\textbf{12 - Isoler les t√¢ches administratives du reste de l‚Äôapplication}


Evitez qu‚Äôune migration ne puisse √™tre d√©marr√©e depuis une URL de l‚Äôapplication, ou qu‚Äôun envoi massif de notifications ne soit accessible pour n‚Äôimporte quel utilisateur: les t√¢ches administratives ne doivent √™tre accessibles qu‚Äô√† un administrateur.
Les applications 12facteurs favorisent les langages qui mettent un environnement REPL (pour \emph{Read}, \emph{Eval}, \emph{Print} et \emph{Loop}) √† disposition (au hasard: \href{https://pythonprogramminglanguage.com/repl/}{Python} ou \href{https://kotlinlang.org/}{Kotlin}), ce qui facilite les √©tapes de maintenance.


\hypertarget{x-bonnes-pratiques}{\section{Bonnes pratiques}}
Pour cette section, nous nous basons sur un r√©sum√© de l‚Äôebook \textbf{Building Maintenable Software} disponible chez \href{http://shop.oreilly.com/product/0636920049555.do}{O‚ÄôReilly}.


Ce livre r√©partit un ensemble de conseils parmi quatre niveaux de composants:


\begin{itemize}

\item Les m√©thodes et fonctions

\item Les classes

\item Les composants

\item Et des conseils plus g√©n√©raux.

\end{itemize}


Ces conseils sont valables pour n‚Äôimporte quel langage.


\hypertarget{x-au-niveau-des-m√©thodes-et-fonctions}{\subsection{Au niveau des m√©thodes et fonctions}}
\begin{itemize}

\item \textbf{Gardez vos m√©thodes/fonctions courtes}. Pas plus de 15 lignes, en comptant les commentaires. Des exceptions sont possibles, mais dans une certaine mesure uniquement (pas plus de 6.9% de plus de 60 lignes; pas plus de 22.3% de plus de 30 lignes, au plus 43.7% de plus de 15 lignes et au moins 56.3% en dessous de 15 lignes). Oui, c‚Äôest dur √† tenir, mais faisable.

\item \textbf{Conserver une complexit√© de McCabe en dessous de 5}, c‚Äôest-√†-dire avec quatre branches au maximum. A nouveau, si une m√©thode pr√©sente une complexit√© cyclomatique de 15, la s√©parer en 3 fonctions avec une complexit√© de 5 conservera globalement le nombre 15, mais rendra le code de chacune de ces m√©thodes plus lisible, plus maintenable.

\item \textbf{N‚Äô√©crivez votre code qu‚Äôune seule fois: √©vitez les duplications, copie, etc.}, c‚Äôest juste mal: imaginez qu‚Äôun bug soit d√©couvert dans une fonction; il devra alors √™tre corrig√© dans toutes les fonctions qui auront √©t√© copi√©es/coll√©es. C‚Äôest aussi une forme de r√©gression.

\item \textbf{Conservez de petites interfaces}. Quatre param√®tres, pas plus. Au besoin, refactorisez certains param√®tres dans une classe, qui sera plus facile √† tester.

\end{itemize}


\hypertarget{x-au-niveau-des-classes}{\subsection{Au niveau des classes}}
\begin{itemize}

\item \textbf{Privil√©giez un couplage faible entre vos classes}. Ceci n‚Äôest pas toujours possible, mais dans la mesure du possible, √©clatez vos classes en fonction de leur domaine de comp√©tences respectif. L‚Äôimpl√©mentation du service \texttt{UserNotificationsService} ne doit pas forc√©ment se trouver embarqu√© dans une classe \texttt{UserService}. De m√™me, pensez √† passer par une interface (commune √† plusieurs classes), afin d‚Äôajouter une couche d‚Äôabstraction. La classe appellante n‚Äôaura alors que les m√©thodes offertes par l‚Äôinterface comme points d‚Äôentr√©e.

\end{itemize}


\hypertarget{x-au-niveau-des-composants}{\subsection{Au niveau des composants}}
\begin{itemize}

\item \textbf{Tout comme pour les classes, il faut conserver un couplage faible au niveau des composants} √©galement. Une mani√®re d‚Äôarriver √† ce r√©sultat est de conserver un nombre de points d‚Äôentr√©e restreint, et d‚Äô√©viter qu‚Äôil ne soit possible de contacter trop facilement des couches s√©par√©es de l‚Äôarchitecture. Pour une architecture n-tiers par exemple, la couche d‚Äôabstraction √† la base de donn√©es ne peut √™tre connue que des services; sans cela, au bout de quelques semaines, n‚Äôimporte quelle couche de pr√©sentation risque de contacter directement la base de donn√©es, "\emph{juste parce qu‚Äôelle en a la possibilit√©}". Vous pourriez √©galement passer par des interfaces, afin de r√©duire le nombre de points d‚Äôentr√©e connus par un composant externe (qui ne conna√Ætra par exemple que \texttt{IFileTransfer} avec ses m√©thodes \texttt{put} et \texttt{get}, et non pas les d√©tails d‚Äôimpl√©mentation complet d‚Äôune classe \texttt{FtpFileTransfer} ou \texttt{SshFileTransfer}).

\item \textbf{Conserver un bon balancement au niveau des composants}: √©vitez qu‚Äôun composant \textbf{A} ne soit un √©norme mastodonte, alors que le composant juste √† c√¥t√© ne soit capable que d‚Äôune action. De cette mani√®re, les nouvelles fonctionnalit√©s seront mieux r√©parties parmi les diff√©rents syst√®mes, et les responsabilit√©s seront plus faciles √† g√©rer. Un conseil est d‚Äôavoir un nombre de composants compris entre 6 et 12 (id√©alement, 12), et que chacun de ces composants soit approximativement de m√™me taille.

\end{itemize}


\hypertarget{x-de-mani√®re-plus-g√©n√©rale}{\subsection{De mani√®re plus g√©n√©rale}}
\begin{itemize}

\item \textbf{Conserver une densit√© de code faible}: il n‚Äôest √©videmment pas possible d‚Äôimpl√©menter n‚Äôimporte quelle nouvelle fonctionnalit√© en moins de 20 lignes de code; l‚Äôid√©e ici est que la r√©√©criture du projet ne prenne pas plus de 20 hommes/mois. Pour cela, il faut (activement) passer du temps √† r√©duire la taille du code existant: soit en faisant du refactoring (intensif?), soit en utilisant des librairies existantes, soit en explosant un syst√®me existant en plusieurs sous-syst√®mes communiquant entre eux. Mais surtout, en √©vitant de copier/coller b√™tement du code existant.

\item \textbf{Automatiser les tests}, \textbf{ajouter un environnement d‚Äôint√©gration continue d√®s le d√©but du projet} et \textbf{v√©rifier par des outils les points ci-dessus}.

\end{itemize}


\hypertarget{x-solid}{\section{SOLID}}
\begin{enumerate}

\item{S : SRP (Single Responsibility}

\item{O : Open closed}

\item{L : LSP (Liskov Substitution)}

\item{I : Interface Segregation}

\item{D : Dependency Inversion}

\end{enumerate}


\hypertarget{x-single-responsibility-principle}{\subsection{Single Responsibility Principle}}
Le principe de responsabilit√© unique d√©finit que chaque concept ou domaine d‚Äôactivit√© ne s‚Äôoccupe que d‚Äôune et d‚Äôune seule chose.
En prenant l‚Äôexemple d‚Äôune m√©thode qui communique avec une base de donn√©es, ce ne sera pas √† cette m√©thode √† g√©rer l‚Äôinscription d‚Äôune exception √† un emplacement quelconque.
Cette action doit √™tre prise en compte par une autre classe (ou un autre concept), qui s‚Äôoccupera elle de d√©finir l‚Äôemplacement o√π l‚Äô√©v√®nement sera enregistr√© (dans une base de donn√©es, une instance Graylog, un fichier, ‚Ä¶‚Äã).


Cette mani√®re d‚Äôorganiser le code ajoute une couche de flemmardise (ie. Une fonction ou une m√©thode doit pouvoir se dire "\emph{I don‚Äôt care}" et s‚Äôoccuper uniquement de ses propres oignons) sur certains concepts. Ceci permet de centraliser la configuration d‚Äôun type d‚Äô√©v√®nement √† un seul endroit, ce augmente la testabilit√© du code.


\hypertarget{x-open-closed}{\subsection{Open Closed}}
Un des principes essentiels en programmation orient√©e objets concerne l‚Äôh√©ritage de classes et la surcharge de m√©thodes: plut√¥t que de partir sur une s√©rie de comparaisons pour d√©finir le comportement d‚Äôune instance, il est parfois pr√©f√©rable de d√©finir une nouvelle sous-classe, qui surcharge une m√©thode bien pr√©cise.
Pour l‚Äôexemple, on pourrait ainsi d√©finir trois classes:


\begin{itemize}

\item Une classe \texttt{Customer}, pour laquelle la m√©thode \texttt{GetDiscount} ne renvoit rien;

\item Une classe \texttt{SilverCustomer}, pour laquelle la m√©thode revoit une r√©duction de 10%;

\item Une classe \texttt{GoldCustomer}, pour laquelle la m√™me m√©thode renvoit une r√©duction de 20%.

\end{itemize}


Si nous rencontrons un nouveau type de client, il suffit de cr√©er une nouvelle sous-classe.
Cela √©vite d‚Äôavoir √† g√©rer un ensemble cons√©quent de conditions dans la m√©thode initiale, en fonction d‚Äôune autre variable (ici, le type de client).


Nous passerions ainsi de:


\begin{verbatim}
class Customer():
    def __init__(self, customer_type: str):
        self.customer_type = customer_type


def get_discount(customer: Customer) -> int:
    if customer.customer_type == "Silver":
        return 10
    elif customer.customer_type == "Gold":
        return 20
    return 0


>>> jack = Customer("Silver")
>>> jack.get_discount()
10
\end{verbatim}

A ceci:


\begin{verbatim}
class Customer():
    def get_discount(self) -> int:
        return 0


class SilverCustomer(Customer):
    def get_discount(self) -> int:
        return 10


class GoldCustomer(Customer):
    def get_discount(self) -> int:
        return 20


>>> jack = SilverCustomer()
>>> jack.get_discount()
10
\end{verbatim}

En anglais, dans le texte : "Putting in simple words, the ‚ÄúCustomer‚Äù class is now closed for any new modification but it‚Äôs open for extensions when new customer types are added to the project.". En r√©sum√©: nous fermons la classe \texttt{Customer} √† toute modification, mais nous ouvrons la possibilit√© de cr√©er de nouvelles extensions en ajoutant de nouveaux types [h√©ritant de \texttt{Customer}].


De cette mani√®re, nous simplifions √©galement la maintenance de la m√©thode \texttt{get\_discount}, dans la mesure o√π elle d√©pend directement du type dans lequel elle est impl√©ment√©e.


Ce point sera tr√®s utile lorsque nous aborderons les \href{https://docs.djangoproject.com/en/3.1/topics/db/models/#proxy-models}{mod√®les proxy}.


\hypertarget{x-liskov-substitution}{\subsection{Liskov Substitution}}
Le principe de substitution fait qu‚Äôune classe h√©ritant d‚Äôune autre classe doit se comporter de la m√™me mani√®re que cette derni√®re.
Il n‚Äôest pas question que la sous-classe n‚Äôimpl√©mente pas certaines m√©thodes, alors que celles-ci sont disponibles sa classe parente.


\begin{quotation}
[‚Ä¶‚Äã] if S is a subtype of T, then objects of type T in a computer program may be replaced with objects of type S (i.e., objects of type S may be substituted for objects of type T), without altering any of the desirable properties of that program (correctness, task performed, etc.). (Source: \href{http://en.wikipedia.org/wiki/Liskov_substitution_principle}{Wikip√©dia}).
\end{quotation}

\begin{quotation}
Let q(x) be a property provable about objects x of type T. Then q(y) should be provable for objects y of type S, where S is a subtype of T. (Source: \href{http://en.wikipedia.org/wiki/Liskov_substitution_principle}{Wikip√©dia aussi})
\end{quotation}

Ce n‚Äôest donc pas parce qu‚Äôune classe \textbf{a besoin d‚Äôune m√©thode d√©finie dans une autre classe} qu‚Äôelle doit forc√©ment en h√©riter.
Cela bousillerait le principe de substitution, dans la mesure o√π une instance de cette classe pourra toujours √™tre consid√©r√©e comme √©tant du type de son parent.


Petit exemple pratique: si nous d√©finissons une m√©thode \texttt{walk} et une m√©thode \texttt{eat} sur une classe \texttt{Duck}, et qu‚Äôune r√©flexion avanc√©e (et sans doute un peu alcoolis√©e) nous dit que "Puisqu‚Äôun \texttt{Lion} marche aussi, faisons le h√©riter de notre classe `Canard`":


\begin{verbatim}
class Duck():
    def walk(self):
        print("Kwak")

    def eat(self, thing):
        if thing in ("plant", "insect", "seed", "seaweed", "fish"):
            return "Yummy!"

        raise IndigestionError("Arrrh")

class Lion(Duck):
    def walk(self):
        print("Roaaar!")
\end{verbatim}

UnNous vous laissons tester la structure ci-dessus en glissant une antilope dans la boite √† go√ªter du lion, ce qui nous donnera quelques trucs bizarres (et un lion atteint de botulisme).


\hypertarget{x-interface-segregation}{\subsection{Interface Segregation}}
Ce principe stipule qu‚Äôun client ne peut en aucun cas d√©pendre d‚Äôune m√©thode dont il n‚Äôa pas besoin.
Plus simplement, plut√¥t que de d√©pendre d‚Äôune seule et m√™me (grosse) interface pr√©sentant un ensemble cons√©quent de m√©thodes, il est propos√© d‚Äôexploser cette interface en plusieurs (plus petites) interfaces.
Ceci permet aux diff√©rents consommateurs de n‚Äôutiliser qu‚Äôun sous-ensemble pr√©cis d‚Äôinterfaces, r√©pondant chacune √† un besoin pr√©cis.


Un exemple est d‚Äôavoir une interface permettant d‚Äôacc√©der √† des √©l√©ments.
Modifier cette interface pour permettre l‚Äô√©criture impliquerait que toutes les applications ayant d√©j√† acc√®s √† la premi√®re, obtiendraient (par d√©faut) un acc√®s en √©criture, ce qui n‚Äôest pas souhait√©/souhaitable.


Pour contrer ceci, on aurait alors une premi√®re interface permettant la lecture, tandis qu‚Äôune deuxi√®me (h√©ritant de la premi√®re) permettrait l‚Äô√©criture. On aurait alors le sch√©ma suivant :


\begin{itemize}

\item A : lecture

\item B (h√©ritant de A) : lecture (par A) et √©criture.

\end{itemize}


\hypertarget{x-dependency-inversion}{\subsection{Dependency inversion}}
Dans une architecture conventionnelle, les composants de haut-niveau d√©pendent directement des composants de bas-niveau.
L‚Äôinversion de d√©pendances stipule que c‚Äôest le composant de haut-niveau qui poss√®de la d√©finition de l‚Äôinterface dont il a besoin, et le composant de bas-niveau qui l‚Äôimpl√©mente.


Le composant de haut-niveau peut d√©finir qu‚Äôil s‚Äôattend √† avoir un \texttt{Publisher}, afin de publier du contenu vers un emplacement particulier.
Plusieurs impl√©mentation de cette interface peuvent alors √™tre mise en place:


\begin{itemize}

\item Une publication par SSH

\item Une publication par FTP

\item Une publication

\item ‚Ä¶‚Äã

\end{itemize}


L‚Äôinjection de d√©pendances est un patron de programmation qui suit le principe d‚Äôinversion de d√©pendances.


\hypertarget{x-sources}{\subsection{Sources}}
\begin{itemize}

\item \href{http://www.codeproject.com/Articles/703634/SOLID-architecture-principles-using-simple-Csharp}{Understanding SOLID principles on CodeProject}

\item \href{http://en.wikipedia.org/wiki/Software_craftsmanship}{Software Craftmanship}

\item \href{http://lostechies.com/derickbailey/2011/09/22/dependency-injection-is-not-the-same-as-the-dependency-inversion-principle/}{Dependency Injection is NOT the same as dependency inversion}

\item \href{http://en.wikipedia.org/wiki/Dependency_injection}{Injection de d√©pendances}

\end{itemize}


\hypertarget{x-complexit√©-de-mccabe}{\section{Complexit√© de McCabe}}
La \href{https://fr.wikipedia.org/wiki/Nombre_cyclomatique}{complexit√© cyclomatique} (ou complexit√© de McCabe) peut s‚Äôapparenter √† mesure de difficult√© de compr√©hension du code, en fonction du nombre d‚Äôembranchements trouv√©s dans une m√™me section.
Quand le cycle d‚Äôex√©cution du code rencontre une condition, il peut soit rentrer dedans, soit passer directement √† la suite.


Par exemple:


\begin{verbatim}
if True == False:
    pass # never happens

# continue ...
\end{verbatim}

TODO: faut vraiment reprendre un cas un peu plus lisible. L√†, c‚Äôest naze.


La condition existe, mais nous ne passerons jamais dedans.
A l‚Äôinverse, le code suivant aura une complexit√© moisie √† cause du nombre de conditions imbriqu√©es:


\begin{verbatim}
def compare(a, b, c, d, e):
    if a == b:
        if b == c:
            if c == d:
                if d == e:
                    print('Yeah!')
                    return 1
\end{verbatim}

Potentiellement, les tests unitaires qui seront n√©cessaires √† couvrir tous les cas de figure seront au nombre de cinq:


\begin{enumerate}

\item{le cas par d√©faut (a est diff√©rent de b, rien ne se passe),}

\item{le cas o√π \texttt{a} est √©gal √† \texttt{b}, mais o√π \texttt{b} est diff√©rent de \texttt{c}}

\item{le cas o√π \texttt{a} est √©gal √† \texttt{b}, \texttt{b} est √©gal √† \texttt{c}, mais \texttt{c} est diff√©rent de \texttt{d}}

\item{le cas o√π \texttt{a} est √©gal √† \texttt{b}, \texttt{b} est √©gal √† \texttt{c}, \texttt{c} est √©gal √† \texttt{d}, mais \texttt{d} est diff√©rent de \texttt{e}}

\item{le cas o√π \texttt{a} est √©gal √† \texttt{b}, \texttt{b} est √©gal √† \texttt{c}, \texttt{c} est √©gal √† \texttt{d} et \texttt{d} est √©gal √† \texttt{e}}

\end{enumerate}


La complexit√© cyclomatique d‚Äôun bloc est √©valu√©e sur base du nombre d‚Äôembranchements possibles; par d√©faut, sa valeur est de 1.
Si nous rencontrons une condition, elle passera √† 2, etc.


Pour l‚Äôexemple ci-dessous, nous allons devoir v√©rifier au moins chacun des cas pour nous assurer que la couverture est compl√®te.
Nous devrions donc trouver:


\begin{enumerate}

\item{Un test o√π rien de se passe (\texttt{a != b})}

\item{Un test pour entrer dans la condition \texttt{a == b}}

\item{Un test pour entrer dans la condition \texttt{b == c}}

\item{Un test pour entrer dans la condition \texttt{c == d}}

\item{Un test pour entrer dans la condition \texttt{d == e}}

\end{enumerate}


Nous avons donc bien besoin de minimum cinq tests pour couvrir l‚Äôenti√®ret√© des cas pr√©sent√©s.


Le nombre de tests unitaires n√©cessaires √† la couverture d‚Äôun bloc fonctionnel est au minimum √©gal √† la complexit√© cyclomatique de ce bloc.
Une possibilit√© pour am√©liorer la maintenance du code est de faire baisser ce nombre, et de le conserver sous un certain seuil.
Certains recommandent de le garder sous une complexit√© de 10; d‚Äôautres de 5.


\admonition{NOTE}{A noter que refactoriser un bloc pour en extraire une m√©thode n‚Äôam√©liorera pas la complexit√© cyclomatique globale de l‚Äôapplication. Mais nous visons ici une am√©lioration \textbf{locale}.}
\hypertarget{x-boite-√†-outils}{\chapter{Boite √† outils}}
\hypertarget{x-python}{\section{Python}}
Le langage \href{https://www.python.org/}{Python} est un \href{https://docs.python.org/3/faq/general.html#what-is-python}{langage de programmation} interpr√©t√©, interactif, orient√© objet (souvent), fonctionnel (parfois), open source, multi-plateformes, flexible, facile √† apprendre et difficile √† ma√Ætriser.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/xkcd-353-python.png}
\caption{}

\end{figure}

A premi√®re vue, certains concepts restent difficiles √† aborder: l‚Äôindentation d√©finit l‚Äô√©tendue d‚Äôun bloc (classe, fonction, m√©thode, boucle, condition, ‚Ä¶‚Äã), il n‚Äôy a pas de typage fort des variables et le compilateur n‚Äôest pas l√† pour assurer le filet de s√©curit√© avant la mise en production (puisqu‚Äôil n‚Äôy a pas de compilateur üòõ).
Et malgr√© ces quelques points, Python reste un langage g√©n√©raliste accessible et "bon partout", et de pouvoir se reposer sur un √©cosyst√®me stable et fonctionnel.


Il fonctionne avec un syst√®me d‚Äôam√©liorations bas√©es sur des propositions: les PEP, ou "\textbf{Python Enhancement Proposal}".
Chacune d‚Äôentre elles doit √™tre approuv√©e par le \href{http://fr.wikipedia.org/wiki/Benevolent_Dictator_for_Life}{Benevolent Dictator For Life}.


Si vous avez besoin d‚Äôun aide-m√©moire ou d‚Äôune liste exhaustive des types et structures de donn√©es du langage, r√©f√©rez-vous au lien suivant: \href{https://gto76.github.io/python-cheatsheet/}{Python Cheat Sheet}.


\admonition{NOTE}{Le langage Python utilise un typage dynamique appel√© \href{https://fr.wikipedia.org/wiki/Duck_typing}{\textbf{duck typing}}: "\emph{When I see a bird that quacks like a duck, walks like a duck, has feathers and webbed feet and associates with ducks ‚Äî I‚Äôm certainly going to assume that he is a duck}"
Source: \href{http://en.wikipedia.org/wiki/Duck_test}{Wikipedia}.}
\hypertarget{x-the-zen-of-python}{\subsection{The Zen of Python}}
\begin{verbatim}
>>> import this
\end{verbatim}

\begin{verbatim}
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
\end{verbatim}

\hypertarget{x-pep8---style-guide-for-python-code}{\subsection{PEP8 - Style Guide for Python Code}}
La premi√®re PEP qui va nous int√©resser est la \href{https://www.python.org/dev/peps/pep-0008/}{PEP 8‚Äâ‚Äî‚ÄâStyle Guide for Python Code}. Elle sp√©cifie comment du code Python doit √™tre organis√© ou format√©, quelles sont les conventions pour l‚Äôindentation, le nommage des variables et des classes, ‚Ä¶‚Äã
En bref, elle d√©crit comment √©crire du code proprement, afin que d‚Äôautres d√©veloppeurs puissent le reprendre facilement, ou simplement que votre base de code ne d√©rive lentement vers un seuil de non-maintenabilit√©.


Dans cet objectif, un outil existe et listera l‚Äôensemble des conventions qui ne sont pas correctement suivies dans votre projet: pep8.
Pour l‚Äôinstaller, passez par pip. Lancez ensuite la commande pep8 suivie du chemin √† analyser (\texttt{.}, le nom d‚Äôun r√©pertoire, le nom d‚Äôun fichier \texttt{.py}, ‚Ä¶‚Äã).
Si vous souhaitez uniquement avoir le nombre d‚Äôerreur de chaque type, saisissez les options \texttt{--statistics -qq}.


\begin{verbatim}
$ pep8 . --statistics -qq

7       E101 indentation contains mixed spaces and tabs
6       E122 continuation line missing indentation or outdented
8       E127 continuation line over-indented for visual indent
23      E128 continuation line under-indented for visual indent
3       E131 continuation line unaligned for hanging indent
12      E201 whitespace after '{'
13      E202 whitespace before '}'
86      E203 whitespace before ':'
\end{verbatim}

Si vous ne voulez pas √™tre d√©rang√© sur votre mani√®re de coder, et que vous voulez juste avoir un retour sur une analyse de votre code, essayez \texttt{pyflakes}: cette librairie analysera vos sources √† la recherche de sources d‚Äôerreurs possibles (imports inutilis√©s, m√©thodes inconnues, etc.).


\hypertarget{x-pep257---docstring-conventions}{\subsection{PEP257 - Docstring Conventions}}
Python √©tant un langage interpr√©t√© fortement typ√©, il est plus que conseill√©, au m√™me titre que les tests unitaires que nous verrons plus bas, de documenter son code.
Cela impose une certaine rigueur, mais am√©liore √©norm√©ment la qualit√© (et la reprise) du code par une tierce personne.
Cela implique aussi de \textbf{tout} documenter: les modules, les paquets, les classes, les fonctions, m√©thodes, ‚Ä¶‚Äã
Tout doit avoir un \textbf{docstring} associ√© :-).


\admonition{WARNING}{Documentation: be obsessed!}
Il existe plusieurs types de conventions de documentation:


\begin{enumerate}

\item{PEP 257}

\item{Numpy}

\item{Google Style (parfois connue sous l‚Äôintitul√© \texttt{Napoleon})}

\item{‚Ä¶‚Äã}

\end{enumerate}


Les \href{https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings}{conventions propos√©es par Google} nous semblent  plus faciles √† lire que du RestructuredText, mais sont parfois moins bien int√©gr√©es que les docstrings officiellement support√©es (typiquement, par exemple par \href{https://clize.readthedocs.io/en/stable/}{clize} qui ne reconnait que du RestructuredText).
L‚Äôexemple donn√© dans les styleguide est celui-ci:


\begin{verbatim}
def fetch_smalltable_rows(table_handle: smalltable.Table,
                          keys: Sequence[Union[bytes, str]],
                          require_all_keys: bool = False,
) -> Mapping[bytes, Tuple[str]]:
    """Fetches rows from a Smalltable.

    Retrieves rows pertaining to the given keys from the Table instance
    represented by table_handle.  String keys will be UTF-8 encoded.

    Args:
        table_handle: An open smalltable.Table instance.
        keys: A sequence of strings representing the key of each table
          row to fetch.  String keys will be UTF-8 encoded.
        require_all_keys: Optional; If require_all_keys is True only
          rows with values set for all keys will be returned.

    Returns:
        A dict mapping keys to the corresponding table row data
        fetched. Each row is represented as a tuple of strings. For
        example:

        {b'Serak': ('Rigel VII', 'Preparer'),
         b'Zim': ('Irk', 'Invader'),
         b'Lrrr': ('Omicron Persei 8', 'Emperor')}

        Returned keys are always bytes.  If a key from the keys argument is
        missing from the dictionary, then that row was not found in the
        table (and require_all_keys must have been False).

    Raises:
        IOError: An error occurred accessing the smalltable.
    """
\end{verbatim}

C‚Äôest-√†-dire:


\begin{enumerate}

\item{Une courte ligne d‚Äôintroduction, descriptive, indiquant ce que la fonction ou la m√©thode r√©alise. Attention, la documentation ne doit pas indiquer \emph{comment} la fonction/m√©thode est impl√©ment√©e, mais ce qu‚Äôelle fait concr√®tement (et succintement).}

\item{Une ligne vide}

\item{Une description plus compl√®te et plus verbeuse}

\item{Une ligne vide}

\item{La description des arguments et param√®tres, des valeurs de retour (+ exemples) et les exceptions qui peuvent √™tre lev√©es.}

\end{enumerate}


Un exemple (encore) plus complet peut √™tre trouv√© \href{https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html#example-google}{dans le d√©p√¥t sphinxcontrib-napoleon}.


Pour ceux que cela pourrait int√©resser, il existe \href{https://marketplace.visualstudio.com/items?itemName=njpwerner.autodocstring}{une extension pour Codium}, comme nous le verrons juste apr√®s, qui permet de g√©n√©rer automatiquement le squelette de documentation d‚Äôun bloc de code:


\begin{figure}[h]{}
\centering\includegraphics{images/environment/python-docstring-vscode.png}
\caption{}

\end{figure}

\admonition{NOTE}{Nous le verrons plus loin, Django permet de rendre la documentation imm√©diatement accessible depuis son interface d‚Äôadministration.}
\hypertarget{x-linters}{\subsection{Linters}}
Il existe plusieurs niveaux de \emph{linters}:


\begin{enumerate}

\item{Le premier niveau concerne \href{https://pypi.org/project/pycodestyle/}{pycodestyle} (anciennement, \texttt{pep8} justement‚Ä¶‚Äã), qui analyse votre code √† la recherche d‚Äôerreurs de convention.}

\item{Le deuxi√®me niveau concerne \href{https://pypi.org/project/pyflakes/}{pyflakes}. Pyflakes est un \emph{simple} \footnote{Ce n‚Äôest pas moi qui le dit, c‚Äôest la doc du projet} programme qui recherchera des erreurs parmi vos fichiers Python.}

\item{Le troisi√®me niveau est \href{https://pypi.org/project/flake8/}{Flake8}, qui regroupe les deux premiers niveaux, en plus d‚Äôy ajouter flexibilit√©, extensions et une analyse de complexit√© de McCabe.}

\item{Le quatri√®me niveau \footnote{Oui, en Python, il n‚Äôy a que quatre cercles √† l‚ÄôEnfer} est \href{https://pylint.org/}{PyLint}.}

\end{enumerate}


PyLint est le meilleur ami de votre \emph{moi} futur, un peu comme quand vous prenez le temps de faire la vaisselle pour ne pas avoir √† la faire le lendemain: il rendra votre code soyeux et brillant, en posant des affirmations sp√©cifiques.
A vous de les traiter en corrigeant le code ou en apposant un \emph{tag} indiquant que vous avez pris connaissance de la remarque, que vous en avez tenu compte, et que vous choisissez malgr√© tout de faire autrement.


Pour vous donner une id√©e, voici ce que cela pourrait donner avec un code pas tr√®s propre et qui ne sert √† rien:


\begin{verbatim}
from datetime import datetime

"""On stocke la date du jour dans la variable ToD4y"""

ToD4y = datetime.today()

def print_today(ToD4y):
    today = ToD4y
    print(ToD4y)

def GetToday():
    return ToD4y


if __name__ == "__main__":
    t =   Get_Today()
    print(t)
\end{verbatim}

Avec Flake8, nous obtiendrons ceci:


\begin{verbatim}
test.py:7:1: E302 expected 2 blank lines, found 1
test.py:8:5: F841 local variable 'today' is assigned to but never used
test.py:11:1: E302 expected 2 blank lines, found 1
test.py:16:8: E222 multiple spaces after operator
test.py:16:11: F821 undefined name 'Get_Today'
test.py:18:1: W391 blank line at end of file
\end{verbatim}

Nous trouvons des erreurs:


\begin{itemize}

\item de \textbf{conventions}: le nombre de lignes qui s√©parent deux fonctions, le nombre d‚Äôespace apr√®s un op√©rateur, une ligne vide √† la fin du fichier, ‚Ä¶‚Äã Ces \emph{erreurs} n‚Äôen sont pas vraiment, elles indiquent juste de potentiels probl√®mes de communication si le code devait √™tre lu ou compris par une autre personne.

\item de \textbf{d√©finition}: une variable assign√©e mais pas utilis√©e ou une lex√®me non trouv√©. Cette derni√®re information indique clairement un bug potentiel. Ne pas en tenir compte nuira sans doute √† la sant√© de votre code (et risque de vous r√©veiller √† cinq heures du mat', quand votre application se prendra m√©chamment les pieds dans le tapis).

\end{itemize}


L‚Äô√©tape d‚Äôapr√®s consiste √† invoquer pylint.
Lui, il est directement moins conciliant:


\begin{verbatim}
$ pylint test.py
************* Module test
test.py:16:6: C0326: Exactly one space required after assignment
    t =   Get_Today()
      ^ (bad-whitespace)
test.py:18:0: C0305: Trailing newlines (trailing-newlines)
test.py:1:0: C0114: Missing module docstring (missing-module-docstring)
test.py:3:0: W0105: String statement has no effect (pointless-string-statement)
test.py:5:0: C0103: Constant name "ToD4y" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:7:16: W0621: Redefining name 'ToD4y' from outer scope (line 5) (redefined-outer-name)
test.py:7:0: C0103: Argument name "ToD4y" doesn't conform to snake_case naming style (invalid-name)
test.py:7:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:8:4: W0612: Unused variable 'today' (unused-variable)
test.py:11:0: C0103: Function name "GetToday" doesn't conform to snake_case naming style (invalid-name)
test.py:11:0: C0116: Missing function or method docstring (missing-function-docstring)
test.py:16:4: C0103: Constant name "t" doesn't conform to UPPER_CASE naming style (invalid-name)
test.py:16:10: E0602: Undefined variable 'Get_Today' (undefined-variable)

--------------------------------------------------------------------
Your code has been rated at -5.45/10
\end{verbatim}

En gros, j‚Äôai programm√© comme une grosse bouse an√©mique (et oui: le score d‚Äô√©valuation du code permet bien d‚Äôaller en n√©gatif).
En vrac, nous trouvons des probl√®mes li√©s:


\begin{itemize}

\item au nommage (C0103) et √† la mise en forme (C0305, C0326, W0105)

\item √† des variables non d√©finies (E0602)

\item de la documentation manquante (C0114, C0116)

\item de la red√©finition de variables (W0621).

\end{itemize}


Pour reprendre la \href{http://pylint.pycqa.org/en/latest/user_guide/message-control.html}{documentation}, chaque code poss√®de sa signification (ouf!):


\begin{itemize}

\item C convention related checks

\item R refactoring related checks

\item W various warnings

\item E errors, for probable bugs in the code

\item F fatal, if an error occurred which prevented pylint from doing further* processing.

\end{itemize}


TODO: Expliquer comment faire pour tagger une explication.


TODO: Voir si la sortie de pylint est obligatoirement 0 s‚Äôil y a un warning


TODO: parler de \texttt{pylint --errors-only}


\hypertarget{x-formatage-de-code}{\subsection{Formatage de code}}
Nous avons parl√© ci-dessous de style de codage pour Python (PEP8), de style de r√©daction pour la documentation (PEP257), d‚Äôun \emph{linter} pour nous indiquer quels morceaux de code doivent absolument √™tre revus, ‚Ä¶‚Äã
Reste que ces t√¢ches sont  (tr√®s) souvent fastidieuses: √©crire un code propre et syst√©matiquement coh√©rent est une t√¢che ardue.
Heureusement, il existe des outils pour nous aider (un peu).


A nouveau, il existe plusieurs possibilit√©s de formatage automatique du code.
M√™me si elle n‚Äôest pas parfaite, \href{https://black.readthedocs.io/en/stable/}{Black} arrive √† un compromis entre clart√© du code, facilit√© d‚Äôinstallation et d‚Äôint√©gration et r√©sultat.


Est-ce que ce formatage est id√©al et accept√© par tout le monde ?
\textbf{Non}. M√™me Pylint arrivera parfois √† r√¢ler.
Mais ce formatage conviendra dans 97,83% des cas (au moins).


\begin{quotation}
By using Black, you agree to cede control over minutiae of hand-formatting. In return, Black gives you speed, determinism, and freedom from pycodestyle nagging about formatting. You will save time and mental energy for more important matters.


Black makes code review faster by producing the smallest diffs possible. Blackened code looks the same regardless of the project you‚Äôre reading. Formatting becomes transparent after a while and you can focus on the content instead.
\end{quotation}

Traduit rapidement √† partir de la langue de Batman: "\emph{En utilisant Black, vous c√©dez le contr√¥le sur le formatage de votre code. En retour, Black vous fera gagner un max de temps, diminuera votre charge mentale et fera revenir l‚Äô√™tre aim√©}".
Mais la partie r√©ellement int√©ressante concerne le fait que "\emph{Tout code qui sera pass√© par Black aura la m√™me forme, ind√©pendamment du project sur lequel vous serez en train de travailler. L‚Äô√©tape de formatage deviendra transparente, et vous pourrez vous concentrer sur le contenu}".


\hypertarget{x-complexit√©-cyclomatique}{\subsection{Complexit√© cyclomatique}}
A nouveau, un greffon pour \texttt{flake8} existe et donnera une estimation de la complexit√© de McCabe pour les fonctions trop complexes. Installez-le avec \texttt{pip install mccabe}, et activez-le avec le param√®tre \texttt{--max-complexity}. Toute fonction dans la complexit√© est sup√©rieure √† cette valeur sera consid√©r√©e comme trop complexe.


\hypertarget{x-typage-statique---\href{https://www.python.org/dev/peps/pep-0585/}{pep585}}{\subsection{Typage statique - \href{https://www.python.org/dev/peps/pep-0585/}{PEP585}}}
Nous vous disions ci-dessus que Python √©tait un langage dynamique interpr√©t√©.
Concr√®tement, cela signifie que des erreurs pouvant √™tre d√©tect√©es √† la compilation avec d‚Äôautres langages, ne le sont pas avec Python.


Il existe cependant une solution √† ce probl√®me, sous la forme de \href{http://mypy-lang.org/}{Mypy}, qui peut (sous vous le souhaitez ;-)) v√©rifier une forme de typage statique de votre code source, gr√¢ce √† une expressivit√© du code, bas√©e sur des annotations (facultatives, elles aussi).


Ces v√©rifications se pr√©sentent de la mani√®re suivante:


\begin{verbatim}
from typing import List


def first_int_elem(l: List[int]) -> int:
    return l[0] if l else None


if __name__ == "__main__":
    print(first_int_elem([1, 2, 3]))
    print(first_int_elem(['a', 'b', 'c']))
\end{verbatim}

Est-ce que le code ci-dessous fonctionne correctement ?
\textbf{Oui}:


\begin{verbatim}
Œª python mypy-test.py
1
a
\end{verbatim}

Malgr√© que nos annotations d√©clarent une liste d‚Äôentiers, rien ne nous emp√™che de lui envoyer une liste de caract√®res, sans que cela ne lui pose de probl√®mes.


Est-ce que Mypy va r√¢ler ? \textbf{Oui, aussi}.
Non seulement nous retournons la valeur \texttt{None} si la liste est vide alors que nous lui annoncions un entier en sortie, mais en plus, nous l‚Äôappelons avec une liste de caract√®res, alors que nous nous attendions √† une liste d‚Äôentiers:


\begin{verbatim}
Œª mypy mypy-test.py
mypy-test.py:7: error: Incompatible return value type (got "Optional[int]", expected "int")
mypy-test.py:12: error: List item 0 has incompatible type "str"; expected "int"
mypy-test.py:12: error: List item 1 has incompatible type "str"; expected "int"
mypy-test.py:12: error: List item 2 has incompatible type "str"; expected "int"
Found 4 errors in 1 file (checked 1 source file)
\end{verbatim}

Pour corriger ceci, nous devons:


\begin{enumerate}

\item{Importer le type \texttt{Optional} et l‚Äôutiliser en sortie de notre fonction \texttt{first\_int\_elem}}

\item{Eviter de lui donner de
mauvais param√®tres ;-)}

\end{enumerate}


\begin{verbatim}
from typing import List, Optional


def first_int_elem(l: List[int]) -> Optional[int]:
    return l[0] if l else None


if __name__ == "__main__":
    print(first_int_elem([1, 2, 3]))
\end{verbatim}

\begin{verbatim}
Œª mypy mypy-test.py
Success: no issues found in 1 source file
\end{verbatim}

\hypertarget{x-tests-unitaires}{\subsection{Tests unitaires}}
\textbf{-> PyTest}


Comme tout bon \textbf{framework} qui se respecte, Django embarque tout un environnement facilitant le lancement de tests; chaque application est cr√©√©e par d√©faut avec un fichier \textbf{tests.py}, qui inclut la classe \texttt{TestCase} depuis le package \texttt{django.test}:


\begin{verbatim}
from django.test import TestCase


class TestModel(TestCase):
    def test_str(self):
        raise NotImplementedError('Not implemented yet')
\end{verbatim}

Id√©alement, chaque fonction ou m√©thode doit √™tre test√©e afin de bien en valider le fonctionnement, ind√©pendamment du reste des composants. Cela permet d‚Äôisoler chaque bloc de mani√®re unitaire, et permet de ne pas rencontrer de r√©gression lors de l‚Äôajout d‚Äôune nouvelle fonctionnalit√© ou de la modification d‚Äôune existante.
Il existe plusieurs types de tests (int√©gration, comportement, ‚Ä¶‚Äã); on ne parlera ici que des tests unitaires.


Avoir des tests, c‚Äôest bien.
S‚Äôassurer que tout est test√©, c‚Äôest mieux.
C‚Äôest l√† qu‚Äôil est utile d‚Äôavoir le pourcentage de code couvert par les diff√©rents tests, pour savoir ce qui peut √™tre am√©lior√©.


Comme indiqu√© ci-dessus, Django propose son propre cadre de tests, au travers du package \texttt{django.tests}.
Une bonne pratique (parfois discut√©e) consiste cependant √† switcher vers \texttt{pytest}, qui pr√©sente quelques avantages:


\begin{itemize}

\item Une syntaxe plus concise (au prix de \href{https://docs.pytest.org/en/reorganize-docs/new-docs/user/naming_conventions.html}{quelques conventions}, m√™me si elles restent configurables): un test est une fonction, et ne doit pas obligatoirement faire partie d‚Äôune classe h√©ritant de \texttt{TestCase} - la seule n√©cessit√© √©tant que cette fonction fasse partie d‚Äôun module commen√ßant ou finissant par "test" (\texttt{test\_example.py} ou \texttt{example\_test.py}).

\item Une compatibilit√© avec du code Python "classique" - vous ne devrez donc retenir qu‚Äôun seul ensemble de commandes ;-)

\item Des \emph{fixtures} faciles √† r√©utiliser entre vos diff√©rents composants

\item Une compatibilit√© avec le reste de l‚Äô√©cosyst√®me, dont la couverture de code pr√©sent√©e ci-dessous.

\end{itemize}


Ainsi, apr√®s installation, il nous suffit de cr√©er notre module \texttt{test\_models.py}, dans lequel nous allons simplement tester l‚Äôaddition d‚Äôun nombre et d‚Äôune cha√Æne de caract√®res (oui, c‚Äôest compl√®tement biesse; on est sur la partie th√©orique ici):


\begin{verbatim}
def test_add():
    assert 1 + 1 == "argh"
\end{verbatim}

Forc√©ment, cela va planter.
Pour nous en assurer (d√®s fois que quelqu‚Äôun en doute), il nous suffit de d√©marrer la commande \texttt{pytest}:


\begin{verbatim}
Œª pytest
============================= test session starts ====================================
platform ...
rootdir: ...
plugins: django-4.1.0
collected 1 item

gwift\test_models.py F                                                          [100%]

================================== FAILURES ==========================================
_______________________________ test_basic_add _______________________________________

    def test_basic_add():
>       assert 1 + 1 == "argh"
E       AssertionError: assert (1 + 1) == 'argh'

gwift\test_models.py:2: AssertionError

=========================== short test summary info ==================================
FAILED gwift/test_models.py::test_basic_add - AssertionError: assert (1 + 1) == 'argh'
============================== 1 failed in 0.10s =====================================
\end{verbatim}

\hypertarget{x-couverture-de-code}{\subsection{Couverture de code}}
La couverture de code est une analyse qui donne un pourcentage li√© √† la quantit√© de code couvert par les tests.
Attention qu‚Äôil ne s‚Äôagit pas de v√©rifier que le code est \textbf{bien} test√©, mais juste de v√©rifier \textbf{quelle partie} du code est test√©e.
Le paquet \texttt{coverage} se charge d‚Äô√©valuer le pourcentage de code couvert par les tests.


Avec \texttt{pytest}, il convient d‚Äôutiliser le paquet \href{https://pypi.org/project/pytest-cov/}{\texttt{pytest-cov}}, suivi de la commande \texttt{pytest --cov=gwift tests/}.


Si vous pr√©f√©rez rester avec le cadre de tests de Django, vous pouvez passer par le paquet \href{https://pypi.org/project/django-coverage-plugin/}{django-coverage-plugin} Ajoutez-le dans le fichier \texttt{requirements/base.txt}, et lancez une couverture de code gr√¢ce √† la commande \texttt{coverage}.
La configuration peut se faire dans un fichier \texttt{.coveragerc} que vous placerez √† la racine de votre projet, et qui sera lu lors de l‚Äôex√©cution.


\begin{verbatim}
# requirements/base.text
[...]
django_coverage_plugin
\end{verbatim}

\begin{verbatim}
# .coveragerc to control coverage.py
[run]
branch = True
omit = ../*migrations*
plugins =
    django_coverage_plugin

[report]
ignore_errors = True

[html]
directory = coverage_html_report
\end{verbatim}

\begin{verbatim}
$ coverage run --source "." manage.py test
$ coverage report

    Name                      Stmts   Miss  Cover
    ---------------------------------------------
    gwift\gwift\__init__.py       0      0   100%
    gwift\gwift\settings.py      17      0   100%
    gwift\gwift\urls.py           5      5     0%
    gwift\gwift\wsgi.py           4      4     0%
    gwift\manage.py               6      0   100%
    gwift\wish\__init__.py        0      0   100%
    gwift\wish\admin.py           1      0   100%
    gwift\wish\models.py         49     16    67%
    gwift\wish\tests.py           1      1     0%
    gwift\wish\views.py           6      6     0%
    ---------------------------------------------
    TOTAL                        89     32    64%
    ----

$ coverage html
\end{verbatim}

<--- / partie obsol√®te --->


Ceci vous affichera non seulement la couverture de code estim√©e, et g√©n√©rera √©galement vos fichiers sources avec les branches non couvertes.


\hypertarget{x-matrice-de-compatibilit√©}{\subsection{Matrice de compatibilit√©}}
L‚Äôint√©r√™t de la matrice de compatibilit√© consiste √† sp√©cifier un ensemble de plusieurs versions d‚Äôun m√™me interpr√©teur (ici, Python), afin de s‚Äôassurer que votre application continue √† fonctionner. Nous sommes donc un cran plus haut que la sp√©cification des versions des librairies, puisque nous nous situons directement au niveau de l‚Äôinterpr√©teur.


L‚Äôoutil le plus connu est \href{https://tox.readthedocs.io/en/latest/}{Tox}, qui consiste en un outil bas√© sur virtualenv et qui permet:


\begin{enumerate}

\item{de v√©rifier que votre application s‚Äôinstalle correctement avec diff√©rentes versions de Python et d‚Äôinterpr√©teurs}

\item{de d√©marrer des tests parmi ces diff√©rents environnements}

\end{enumerate}


\begin{verbatim}
# content of: tox.ini , put in same dir as setup.py
[tox]
envlist = py36,py37,py38,py39
skipsdist = true

[testenv]
deps =
    -r requirements/dev.txt
commands =
    pytest
\end{verbatim}

D√©marrez ensuite la commande \texttt{tox}, pour d√©marrer la commande \texttt{pytest} sur les environnements Python 3.6, 3.7, 3.8 et 3.9, apr√®s avoir install√© nos d√©pendances pr√©sentes dans le fichier \texttt{requirements/dev.txt}.


\admonition{WARNING}{pour que la commande ci-dessus fonctionne correctement, il sera n√©cessaire que vous ayez les diff√©rentes versions d‚Äôinterpr√©teurs install√©es.
Ci-dessus, la commande retournera une erreur pour chaque version non trouv√©e, avec une erreur type \texttt{ERROR:   pyXX: InterpreterNotFound: pythonX.X}.}
\hypertarget{x-configuration-globale}{\subsection{Configuration globale}}
D√©crire le fichier setup.cfg


\begin{verbatim}
$ touch setup.cfg
\end{verbatim}

\hypertarget{x-dockerfile}{\subsection{Dockerfile}}
\begin{verbatim}
# Dockerfile

# Pull base image
#FROM python:3.8
FROM python:3.8-slim-buster

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV DEBIAN_FRONTEND noninteractive
ENV ACCEPT_EULA=Y

# install Microsoft SQL Server requirements.
ENV ACCEPT_EULA=Y
RUN apt-get update -y && apt-get update \
  && apt-get install -y --no-install-recommends curl gcc g++ gnupg


# Add SQL Server ODBC Driver 17
RUN curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
RUN curl https://packages.microsoft.com/config/debian/10/prod.list > /etc/apt/sources.list.d/mssql-release.list
RUN apt-get update \
  && apt-get install -y msodbcsql17 unixodbc-dev

# clean the install.
RUN apt-get -y clean

# Set work directory
WORKDIR /code

# Install dependencies
COPY ./requirements/base.txt /code/requirements/
RUN pip install --upgrade pip
RUN pip install -r ./requirements/base.txt

# Copy project
COPY . /code/
\end{verbatim}

\hypertarget{x-makefile}{\subsection{Makefile}}
Pour gagner un peu de temps, n‚Äôh√©sitez pas √† cr√©er un fichier \texttt{Makefile} que vous placerez √† la racine du projet.
L‚Äôexemple ci-dessous permettra, gr√¢ce √† la commande \texttt{make coverage}, d‚Äôarriver au m√™me r√©sultat que ci-dessus:


\begin{verbatim}
# Makefile for gwift
#

# User-friendly check for coverage
ifeq (pass:[$(shell which coverage >/dev/null 2>&1; echo $]$?), 1)
    $(error The 'coverage' command was not found. Make sure you have coverage installed)
endif

.PHONY: help coverage

help:
    @echo "  coverage to run coverage check of the source files."

coverage:
    coverage run --source='.' manage.py test; coverage report; coverage html;
    @echo "Testing of coverage in the sources finished."
\end{verbatim}

Pour la petite histoire, \texttt{make} peu sembler un peu d√©suet, mais reste extr√™mement efficace.


\hypertarget{x-environnement-de-d√©veloppement}{\section{Environnement de d√©veloppement}}
Concr√®tement, nous pourrions tout √† fait nous limiter √† Notepad ou Notepad++.
Mais √† moins d‚Äôaimer se fouetter avec un c√¢ble USB, nous appr√©cions la compl√©tion du code, la coloration syntaxique, l‚Äôint√©gration des tests unitaires et d‚Äôun debugger, ainsi que deux-trois sucreries qui feront plaisir √† n‚Äôimporte quel d√©veloppeur.


Si vous manquez d‚Äôid√©es ou si vous ne savez pas par o√π commencer:


\begin{itemize}

\item \href{https://vscodium.com/}{VSCodium}, avec les plugins \href{https://marketplace.visualstudio.com/items?itemName=ms-python.python}{Python}et \href{https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens}{GitLens}

\item \href{https://www.jetbrains.com/pycharm/}{PyCharm}

\item \href{https://www.vim.org/}{Vim} avec les plugins \href{https://github.com/davidhalter/jedi-vim}{Jedi-Vim} et \href{https://github.com/preservim/nerdtree}{nerdtree}

\end{itemize}


Si vous h√©sitez, et m√™me si Codium n‚Äôest pas le plus l√©ger (la faute √† \href{https://www.electronjs.org/}{Electron}‚Ä¶‚Äã), il fera correctement son travail (√† savoir: faciliter le v√¥tre), en int√©grant suffisament de fonctionnalit√©s qui g√¢teront les papilles √©moustill√©es du d√©veloppeur impatient.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/environment/codium.png}
\caption{}

\end{figure}

\hypertarget{x-un-terminal}{\section{Un terminal}}
\emph{A priori}, les IDE \footnote{Integrated Development Environment} propos√©s ci-dessus fournissent par d√©faut ou \emph{via} des greffons un terminal int√©gr√©.
Ceci dit, disposer d‚Äôun terminal s√©par√© facilite parfois certaines t√¢ches.


A nouveau, si vous manquez d‚Äôid√©es:


\begin{enumerate}

\item{Si vous √™tes sous Windows, t√©l√©chargez une copie de \href{https://cmder.net/}{Cmder}. Il n‚Äôest pas le plus rapide, mais propose une int√©gration des outils Unix communs (\texttt{ls}, \texttt{pwd}, \texttt{grep}, \texttt{ssh}, \texttt{git}, ‚Ä¶‚Äã) sans trop se fouler.}

\item{Pour tout autre syst√®me, vous devriez disposer en natif de ce qu‚Äôil faut.}

\end{enumerate}


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/environment/terminal.png}
\caption{}

\end{figure}

\hypertarget{x-un-gestionnaire-de-base-de-donn√©es}{\section{Un gestionnaire de base de donn√©es}}
Django g√®re plusieurs moteurs de base de donn√©es.
Certains sont g√©r√©s nativement par Django (PostgreSQL, MariaDB, SQLite); \emph{a priori}, ces trois-l√† sont disponibles pour tous les syst√®mes d‚Äôexploitation. D‚Äôautres moteurs n√©cessitent des librairies tierces (Oracle, Microsoft SQL Server).


Il n‚Äôest pas obligatoire de disposer d‚Äôune application de gestion pour ces moteurs: pour les cas d‚Äôutilisation simples, le shell Django pourra largement suffire (nous y reviendrons).
Mais pour faciliter la gestion des bases de donn√©es elles-m√™me, et si vous n‚Äô√™tes pas √† l‚Äôaise avec la ligne de commande, choisissez l‚Äôune des applications d‚Äôadministration ci-dessous en fonction du moteur de base de donn√©es que vous souhaitez utiliser.


\begin{itemize}

\item Pour \textbf{PostgreSQL}, il existe \href{https://www.pgadmin.org/}{pgAdmin}

\item Pour \textbf{MariaDB} ou \textbf{MySQL}, partez sur \href{https://www.phpmyadmin.net/}{PHPMyAdmin}

\item Pour \textbf{SQLite}, il existe \href{https://sqlitebrowser.org/}{SQLiteBrowser}
PHPMyAdmin ou PgAdmin.

\end{itemize}


\hypertarget{x-un-gestionnaire-de-mots-de-passe}{\section{Un gestionnaire de mots de passe}}
Nous en auront besoin pour g√©(n√©)rer des phrases secr√®tes pour nos applications.
Si vous n‚Äôen utilisez pas d√©j√† un, partez sur \href{https://keepassxc.org/}{KeepassXC}: il est multi-plateformes, suivi et s‚Äôint√®gre correctement aux diff√©rents environnements, tout en restant accessible.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/environment/keepass.png}


\end{figure}

\hypertarget{x-un-syst√®me-de-gestion-de-versions}{\section{Un syst√®me de gestion de versions}}
Il existe plusieurs syst√®mes de gestion de versions.
Le plus connu √† l‚Äôheure actuelle est \href{https://git-scm.com/}{Git}, notamment pour sa (tr√®s) grande flexibilit√© et sa rapidit√© d‚Äôex√©cution.
Il est une aide pr√©cieuse pour d√©velopper rapidement des preuves de concept, switcher vers une nouvelle fonctionnalit√©, un bogue √† r√©parer ou une nouvelle release √† proposer au t√©l√©chargement.
Ses deux plus gros d√©fauts concerneraient peut-√™tre sa courbe d‚Äôapprentissage pour les nouveaux venus et la complexit√© des actions qu‚Äôil permet de r√©aliser.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/xkcd-1597-git.png}
\caption{}

\end{figure}

M√™me pour un d√©veloppeur solitaire, un syst√®me de gestion de versions (quel qu‚Äôil soit) reste indispensable.


Chaque "\textbf{branche}" correspond √† une t√¢che √† r√©aliser: un bogue √† corriger (\emph{Hotfix A}), une nouvelle fonctionnalit√© √† ajouter ou un "\emph{truc √† essayer}" \footnote{Oui, comme dans "Attends, j‚Äôessaie vite un truc, si √ßa marche, c‚Äôest beau."} (\emph{Feature A} et \emph{Feature B}).


Chaque "\textbf{commit}" correspond √† une sauvegarde atomique d‚Äôun √©tat ou d‚Äôun ensemble de modifications coh√©rentes entre elles.\footnote{Il convient donc de s‚Äôabstenir de modifier le CSS d‚Äôune application et la couche d‚Äôacc√®s √† la base de donn√©es, sous peine de se faire huer par ses relecteurs au prochain stand-up.}
De cette mani√®re, il est beaucoup plus facile pour le d√©veloppeur de se concenter sur un sujet en particulier, dans la mesure o√π celui-ci ne doit pas obligatoirement √™tre cl√¥tur√© pour appliquer un changement de contexte.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/diagrams/git-workflow.png}
\caption{}

\end{figure}

Cas pratique: vous d√©veloppez cette nouvelle fonctionnalit√© qui va r√©volutionner le monde de demain et d‚Äôapr√®s-demain, quand, tout √† coup (!), vous vous rendez compte que vous avez perdu votre conformit√© aux normes PCI parce les donn√©es des titulaires de cartes ne sont pas isol√©es correctement.
Il suffit alors de:


\begin{enumerate}

\item{sauver le travail en cours (\texttt{git add \. \&\& git commit -m \[WIP\]})}

\item{revenir sur la branche principale (\texttt{git checkout main})}

\item{cr√©er un "hotfix" (\texttt{git checkout -b hotfix/pci-compliance})}

\item{solutionner le probl√®me (sans doute un \texttt{;} en trop ?)}

\item{sauver le correctif sur cette branche (\texttt{git add \. \&\& git commit -m \"Did it\!\"})}

\item{r√©cup√©rer ce correctif sur la branche principal (\texttt{git checkout main \&\& git merge hotfix/pci-compliance})}

\item{et revenir tranquillou sur votre branche de d√©veloppement pour fignoler ce g√©n√©rateur de noms de dinosaures rigolos que l‚Äôunivers vous r√©clame √† cor et √† a cri (\texttt{git checkout features/dinolol})}

\end{enumerate}


Finalement, sachez qu‚Äôil existe plusieurs mani√®res de g√©rer ces flux d‚Äôinformations.
Les plus connus sont \href{https://www.gitflow.com/}{Gitflow} et \href{https://www.reddit.com/r/programming/comments/7mfxo6/a_branching_strategy_simpler_than_gitflow/}{Threeflow}.


\hypertarget{x-d√©crire-ses-changements}{\subsection{D√©crire ses changements}}
La description d‚Äôun changement se fait \emph{via} la commande \texttt{git commit}.
Il est possible de lui passer directement le message associ√© √† ce changement gr√¢ce √† l‚Äôattribut \texttt{-m}, mais c‚Äôest une pratique relativement d√©conseill√©e: un \emph{commit} ne doit effectivement pas obligatoirement √™tre d√©crit sur une seule ligne.
Une description plus compl√®te, accompagn√©e des √©ventuels tickets ou r√©f√©rences, sera plus compl√®te, plus agr√©able √† lire, et plus facile √† revoir pour vos √©ventuels relecteurs.


De plus, la plupart des plateformes de d√©p√¥ts pr√©senteront ces informations de mani√®re ergonomique. Par exemple:


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/environment/gitea-commit-message.png}
\caption{}

\end{figure}

La premi√®re ligne est reprise comme titre (normalement, sur 50 caract√®res maximum); le reste est repris comme de la description.


\hypertarget{x-un-syst√®me-de-virtualisation}{\section{Un syst√®me de virtualisation}}
Par "\emph{syst√®me de virtualisation}", nous entendons n‚Äôimporte quel application, syst√®me d‚Äôexploitation, syst√®me de containeurisation, ‚Ä¶‚Äã qui permette de cr√©er ou recr√©er un environnement de d√©veloppement aussi proche que celui en production.
Les solutions sont nombreuses:


\begin{itemize}

\item \href{https://www.virtualbox.org/}{VirtualBox}

\item \href{https://www.vagrantup.com/}{Vagrant}

\item \href{https://www.docker.com/}{Docker}

\item \href{https://linuxcontainers.org/lxc/}{Linux Containers (LXC)}

\item \href{https://docs.microsoft.com/fr-fr/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v}{Hyper-V}

\end{itemize}


Ces quelques propositions se situent un cran plus loin que la "simple" isolation d‚Äôun environnement, puisqu‚Äôelles vous permettront de construire un environnement complet.
Elles constituent donc une √©tape suppl√©mentaires dans la configuration de votre espace de travail, mais en am√©lioreront la qualit√©.


Dans la suite, nous d√©taillerons Vagrant et Docker, qui constituent deux solutions automatisables et multiplateformes, dont la configuration peut faire partie int√©grante de vos sources.


\hypertarget{x-vagrant}{\subsection{Vagrant}}
Vagrant consiste en un outil de cr√©ation et de gestion d‚Äôenvironnements virtualis√©s, en respectant toujours une m√™me mani√®re de travailler, ind√©pendamment des choix techniques et de l‚Äôinfrastructure que vous pourriez s√©lectionner.


\begin{quotation}
Vagrant is a tool for building and managing virtual machine environments in a single workflow. With an easy-to-use workflow and focus on automation, Vagrant lowers development environment setup time, increases production parity, and makes the "works on my machine" excuse a relic of the past. \footnote{\href{https://www.vagrantup.com/intro}{https://www.vagrantup.com/intro}}
\end{quotation}

La partie la plus importante de la configuration de Vagrant pour votre projet consiste √† placer un fichier \texttt{Vagrantfile} - \emph{a priori} √† la racine de votre projet - et qui contiendra les information suivantes:


\begin{itemize}

\item Le choix du \emph{fournisseur} (\textbf{provider}) de virtualisation (Virtualbox, Hyper-V et Docker sont natifs; il est √©galement possible de passer par VMWare, AWS, etc.)

\item Une \emph{box}, qui consiste √† lui indiquer le type et la version attendue du syst√®me virtualis√© (Debian 10, Ubuntu 20.04, etc. - et \href{https://app.vagrantup.com/boxes/search}{il y a du choix}).

\item La mani√®re dont la fourniture (\textbf{provisioning}) de l‚Äôenvironnement doit √™tre r√©alis√©e: scripts Shell, fichiers, Ansible, Puppet, Chef, ‚Ä¶‚Äã Choisissez votre favori :-) m√™me s‚Äôil est toujours possible de passer par une installation et une maintenance manuelle, apr√®s s‚Äô√™tre connect√© sur la machine.

\item Si un espace de stockage doit √™tre partag√© entre la machine virtuelle et l‚Äôh√¥te

\item Les ports qui doivent √™tre transmis de la machine virtuelle vers l‚Äôh√¥te.

\end{itemize}


La syntaxe de ce fichier \texttt{Vagrantfile} est en \href{https://www.ruby-lang.org/en/}{Ruby}. Vous trouverez ci-dessous un exemple, g√©n√©r√© (et nettoy√©) apr√®s avoir ex√©cut√© la commande \texttt{vagrant init}:


\begin{verbatim}
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|

  config.vm.box = "ubuntu/bionic64"

  config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"

  config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = "1024"
  end

  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y nginx
  SHELL
end
\end{verbatim}

Dans le fichier ci-dessus, nous cr√©ons:


\begin{itemize}

\item Une nouvelle machine virtuelle (ie. \emph{invit√©e}) sous Ubuntu Bionic Beaver, en x64

\item Avec une correspondance du port \texttt{80} de la machine vers le port \texttt{8080} de l‚Äôh√¥te, en limitant l‚Äôacc√®s √† celui-ci - acc√©dez √† \texttt{localhost:8080} et vous acc√©derez au port \texttt{80} de la machine virtuelle.

\item En utilisant Virtualbox comme backend - la m√©moire vive allou√©e sera limit√©e √† 1Go de RAM et nous ne voulons pas voir l‚Äôinterface graphique au d√©marrage

\item Et pour finir, nous voulons appliquer un script de mise √† jour \texttt{apt-get update} et installer le paquet \texttt{nginx}

\end{itemize}


\admonition{NOTE}{Par d√©faut, le r√©pertoire courant (ie. le r√©pertoire dans lequel notre fichier \texttt{Vagrantfile} se trouve) sera synchronis√© dans le r√©pertoire \texttt{/vagrant} sur la machine invit√©e.}
\hypertarget{x-docker}{\subsection{Docker}}
(copi√©/coll√© de cookie-cutter-django)


\begin{verbatim}
version: '3'

volumes:
  local_postgres_data: {}
  local_postgres_data_backups: {}

services:
  django: &django
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: khana_local_django
    container_name: django
    depends_on:
      - postgres
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
    ports:
      - "8000:8000"
    command: /start

  postgres:
    build:
      context: .
      dockerfile: ./compose/production/postgres/Dockerfile
    image: khana_production_postgres
    container_name: postgres
    volumes:
      - local_postgres_data:/var/lib/postgresql/data:Z
      - local_postgres_data_backups:/backups:z
    env_file:
      - ./.envs/.local/.postgres

  docs:
    image: khana_local_docs
    container_name: docs
    build:
      context: .
      dockerfile: ./compose/local/docs/Dockerfile
    env_file:
      - ./.envs/.local/.django
    volumes:
      - ./docs:/docs:z
      - ./config:/app/config:z
      - ./khana:/app/khana:z
    ports:
      - "7000:7000"
    command: /start-docs

  redis:
    image: redis:5.0
    container_name: redis

  celeryworker:
    <<: *django
    image: khana_local_celeryworker
    container_name: celeryworker
    depends_on:
      - redis
      - postgres

    ports: []
    command: /start-celeryworker

  celerybeat:
    <<: *django
    image: khana_local_celerybeat
    container_name: celerybeat
    depends_on:
      - redis
      - postgres

    ports: []
    command: /start-celerybeat

  flower:
    <<: *django
    image: khana_local_flower
    container_name: flower
    ports:
      - "5555:5555"
    command: /start-flower
\end{verbatim}

\begin{verbatim}
# docker-compose.yml
version: '3.8'

services:
  web:
    build: .
    command: python /code/manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/code
    ports:
      - 8000:8000
    depends_on:
      - slqserver
  slqserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - "ACCEPT_EULA=Y"
      - "SA_PASSWORD=sqklgjqihagrtdgqk12¬ß!"
    ports:
      - 1433:1433
    volumes:
      - ../sqlserver/data:/var/opt/mssql/data
      - ../sqlserver/log:/var/opt/mssql/log
      - ../sqlserver/secrets:/var/opt/mssql/secrets
\end{verbatim}

\begin{verbatim}
FROM python:3.8-slim-buster

ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1

RUN apt-get update \
  # dependencies for building Python packages
  && apt-get install -y build-essential \
  # psycopg2 dependencies
  && apt-get install -y libpq-dev \
  # Translations dependencies
  && apt-get install -y gettext \
  # cleaning up unused files
  && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
  && rm -rf /var/lib/apt/lists/*

# Requirements are installed here to ensure they will be cached.
COPY ./requirements /requirements
RUN pip install -r /requirements/local.txt

COPY ./compose/production/django/entrypoint /entrypoint
RUN sed -i 's/\r$//g' /entrypoint
RUN chmod +x /entrypoint

COPY ./compose/local/django/start /start
RUN sed -i 's/\r$//g' /start
RUN chmod +x /start

COPY ./compose/local/django/celery/worker/start /start-celeryworker
RUN sed -i 's/\r$//g' /start-celeryworker
RUN chmod +x /start-celeryworker

COPY ./compose/local/django/celery/beat/start /start-celerybeat
RUN sed -i 's/\r$//g' /start-celerybeat
RUN chmod +x /start-celerybeat

COPY ./compose/local/django/celery/flower/start /start-flower
RUN sed -i 's/\r$//g' /start-flower
RUN chmod +x /start-flower

WORKDIR /app

ENTRYPOINT ["/entrypoint"]
\end{verbatim}

\admonition{NOTE}{Voir comment nous pouvons int√©grer toutes ces commandes au niveau de la CI et au niveau du d√©ploiement (Docker-compose ?)}
\hypertarget{x-un-projet-django}{\chapter{Un projet Django}}
\hypertarget{x-travailler-en-isolation}{\section{Travailler en isolation}}
Nous allons aborder la gestion et l‚Äôisolation des d√©pendances.
Cette section est aussi utile pour une personne travaillant seule, que pour transmettre les connaissances √† un nouveau membre de l‚Äô√©quipe ou pour d√©ployer l‚Äôapplication elle-m√™me.


Il en √©tait d√©j√† question au deuxi√®me point des 12 facteurs: m√™me dans le cas de petits projets, il est d√©conseill√© de s‚Äôen passer.
Cela √©vite les d√©ploiements effectu√©s √† l‚Äôarrache √† grand renfort de \texttt{sudo} et d‚Äôinstallation globale de d√©pendances, pouvant potentiellement occasioner des conflits entre les applications d√©ploy√©es:


\begin{enumerate}

\item{Il est tout √† fait envisagable que deux applications diff√©rentes soient d√©ploy√©es sur un m√™me h√¥te, et n√©cessitent chacune deux versions diff√©rentes d‚Äôune m√™me d√©pendance.}

\item{Pour la reproductibilit√© d‚Äôun environnement sp√©cifique, cela √©vite notamment les r√©ponses type "Ca juste marche chez moi", puisque la construction d‚Äôun nouvel environnement fait partie int√©grante du processus de construction et de la documentation du projet; gr√¢ce √† elle, nous avons la possibilit√© de construire un environnement sain et d‚Äôappliquer des d√©pendances identiques, quelle que soit la machine h√¥te.}

\end{enumerate}


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/it-works-on-my-machine.jpg}


\end{figure}

Dans la suite de ce chapitre, nous allons consid√©rer deux projets diff√©rents:


\begin{enumerate}

\item{Gwift, une application permettant de g√©rer des listes de souhaits}

\item{Khana, une application de suivi d‚Äôapprentissage pour des √©l√®ves ou √©tudiants.}

\end{enumerate}


\hypertarget{x-environnement-virtuel}{\subsection{Environnement virtuel}}
Depuis la version 3.5 de Python, le module \texttt{venv} est \href{https://docs.python.org/3/library/venv.html}{la mani√®re recommand√©e} pour cr√©er un environnement virtuel.


\admonition{NOTE}{Il existe plusieurs autres modules permettant d‚Äôarriver au m√™me r√©sultat, avec quelques avantages et inconv√©nients pour chacun d‚Äôentre eux. Le plus prometteur d‚Äôentre eux est \href{https://python-poetry.org/}{Poetry}, qui dispose d‚Äôune interface en ligne de commande plus propre et plus moderne que ce que PIP propose.}
Pour cr√©er un nouvel environnement, vous aurez donc besoin:


\begin{enumerate}

\item{D‚Äôune installation de Python - \href{https://www.python.org/}{https://www.python.org/}}

\item{D‚Äôun terminal - voir le point \hyperlink{../environment/-index#un-terminal}{}}

\end{enumerate}


\admonition{NOTE}{J‚Äôai pour habitude de conserver mes projets dans un r√©pertoire \texttt{~/Sources/} et mes environnements virtuels dans un r√©pertoire \texttt{~/.venvs/}.
Cette s√©paration √©vite que l‚Äôenvironnement virtuel ne se trouve dans le m√™me r√©pertoire que les sources, ou ne soit accidentellement envoy√© vers le syst√®me de gestion de versions.
Dans la suite de ce chapitre, je consid√©rerai ces m√™mes r√©pertoires, mais n‚Äôh√©sitez pas √† les modifier.}
Pur cr√©er notre r√©pertoire de travail et notre environnement virtuel, ex√©cutez les commandes suivantes:


\begin{verbatim}
mkdir ~/.venvs/
python -m venv ~/.venvs/gwift-venv
\end{verbatim}

Ceci aura pour effet de cr√©er un nouveau r√©pertoire (\texttt{~/.venvs/gwift-env/}), dans lequel vous trouverez une installation compl√®te de l‚Äôinterpr√©teur Python.
Votre environnement virtuel est pr√™t, il n‚Äôy a plus qu‚Äô√† indiquer que nous souhaitons l‚Äôutiliser, gr√¢ce √† l‚Äôune des commandes suivantes:


\begin{verbatim}
# GNU/Linux, macOS
source ~/.venvs/gwift-venv/bin/activate

# MS Windows, avec Cmder
~/.venvs/gwift-venv/Scripts/activate.bat

# Pour les deux
(gwift-env) fred@aerys:~/Sources/.venvs/gwift-env$ 
\end{verbatim}


A pr√©sent que l‚Äôenvironnement est activ√©, tous les binaires de cet environnement prendront le pas sur les binaires du syst√®me.
De la m√™me mani√®re, une variable \texttt{PATH} propre est d√©finie et utilis√©e, afin que les librairies Python y soient stock√©es.
C‚Äôest donc dans cet environnement virtuel que nous retrouverons le code source de Django, ainsi que des librairies externes pour Python une fois que nous les aurons install√©es.


\admonition{NOTE}{Pour les curieux, un environnement virtuel n‚Äôest jamais qu‚Äôun r√©pertoire dans lequel se trouve une installation fra√Æche de l‚Äôinterpr√©teur, vers laquelle pointe les liens symboliques des binaires. Si vous recherchez l‚Äôemplacement de l‚Äôinterpr√©teur avec la commande \texttt{which python}, vous recevrez comme r√©ponse \texttt{/home/fred/.venvs/gwift-env/bin/python}.}
Pour sortir de l‚Äôenvironnement virtuel, ex√©cutez la commande \texttt{deactivate}.
Si vous pensez ne plus en avoir besoin, supprimer le dossier.
Si n√©cessaire, il suffira d‚Äôen cr√©er un nouveau.


Pour g√©rer des versions diff√©rentes d‚Äôune m√™me librairie, il nous suffit de jongler avec autant d‚Äôenvironnements que n√©cessaires. Une application n√©cessite une version de Django inf√©rieure √† la 2.0 ? On cr√©e un environnement, on l‚Äôactive et on installe ce qu‚Äôil faut.


Cette technique fonctionnera autant pour un poste de d√©veloppement que sur les serveurs destin√©s √† recevoir notre application.


\admonition{NOTE}{Par la suite, nous consid√©rerons que l‚Äôenvironnement virtuel est toujours activ√©, m√™me si \texttt{gwift-env} n‚Äôest pas indiqu√©.}
\hypertarget{x-gestion-des-d√©pendances,-installation-de-django-et-cr√©ation-d‚Äôun-nouveau-projet}{\subsection{Gestion des d√©pendances, installation de Django et cr√©ation d‚Äôun nouveau projet}}
Comme nous en avons d√©j√† discut√©, PIP est la solution que nous avons choisie pour la gestion de nos d√©pendances.
Pour installer une nouvelle librairie, vous pouvez simplement passer par la commande \texttt{pip install <my\_awesome\_library>}.
Dans le cas de Django, et apr√®s avoir activ√© l‚Äôenvironnement, nous pouvons √† pr√©sent y installer Django.
Comme expliqu√© ci-dessus, la librairie restera ind√©pendante du reste du syst√®me, et ne polluera aucun autre projet. nous ex√©cuterons donc la commande suivante:


\begin{verbatim}
$ source ~/.venvs/gwift-env/bin/activate # ou ~/.venvs/gwift-env/Scrips/activate.bat pour Windows.
$ pip install django
Collecting django
    Downloading Django-3.1.4
100% |################################|
Installing collected packages: django
Successfully installed django-3.1.4
\end{verbatim}

\admonition{IMPORTANT}{Ici, la commande \texttt{pip install django} r√©cup√®re la \textbf{derni√®re version connue disponible dans les d√©p√¥ts \href{https://pypi.org/}}{https://pypi.org/}} (sauf si vous en avez d√©finis d‚Äôautres. Mais c‚Äôest hors sujet).
Nous en avons d√©j√† discut√©: il est important de bien sp√©cifier la version que vous souhaitez utiliser, sans quoi vous risquez de rencontrer des effets de bord.)
L‚Äôinstallation de Django a ajout√© un nouvel ex√©cutable: \texttt{django-admin}, que l‚Äôon peut utiliser pour cr√©er notre nouvel espace de travail.
Par la suite, nous utiliserons \texttt{manage.py}, qui constitue un \textbf{wrapper} autour de \texttt{django-admin}.


Pour d√©marrer notre projet, nous lan√ßons \texttt{django-admin startproject gwift}:


\begin{verbatim}
$ django-admin startproject gwift
\end{verbatim}

Cette action a pour effet de cr√©er un nouveau dossier \texttt{gwift}, dans lequel nous trouvons la structure suivante:


\begin{verbatim}
$ tree gwift
gwift
‚îú‚îÄ‚îÄ gwift
|   |‚îÄ‚îÄ asgi.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ settings.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ urls.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ wsgi.py
‚îî‚îÄ‚îÄ manage.py
\end{verbatim}

C‚Äôest dans ce r√©pertoire que vont vivre tous les fichiers li√©s au projet. Le but est de faire en sorte que toutes les op√©rations (maintenance, d√©ploiement, √©criture, tests, ‚Ä¶‚Äã) puissent se faire √† partir d‚Äôun seul point d‚Äôentr√©e.


L‚Äôutilit√© de ces fichiers est d√©finie ci-dessous:


\begin{itemize}

\item \texttt{settings.py} contient tous les param√®tres globaux √† notre projet.

\item \texttt{urls.py} contient les variables de routes, les adresses utilis√©es et les fonctions vers lesquelles elles pointent.

\item \texttt{manage.py}, pour toutes les commandes de gestion.

\item \texttt{asgi.py} contient la d√©finition de l‚Äôinterface \href{https://en.wikipedia.org/wiki/Asynchronous_Server_Gateway_Interface}{ASGI}, le protocole pour la passerelle asynchrone entre votre application et le serveur Web.

\item \texttt{wsgi.py} contient la d√©finition de l‚Äôinterface \href{https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface}{WSGI}, qui permettra √† votre serveur Web (Nginx, Apache, ‚Ä¶‚Äã) de faire un pont vers votre projet.

\end{itemize}


\admonition{NOTE}{Indiquer qu‚Äôil est possible d‚Äôavoir plusieurs structures de dossiers et qu‚Äôil n‚Äôy a pas de "magie" derri√®re toutes ces commandes.}
Tant que nous y sommes, nous pouvons ajouter un r√©pertoire dans lequel nous stockerons les d√©pendances et un fichier README:


\begin{verbatim}
(gwift) $ mkdir requirements
(gwift) $ touch README.md
(gwift) $ tree gwift
gwift
‚îú‚îÄ‚îÄ gwift
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ asgi.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ settings.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ urls.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ wsgi.py
‚îú‚îÄ‚îÄ requirements 
‚îú‚îÄ‚îÄ README.md 
‚îî‚îÄ‚îÄ manage.py
\end{verbatim}


Comme nous venons d‚Äôajouter une d√©pendance √† notre projet, profitons-en pour cr√©er un fichier reprenant tous les d√©pendances de notre projet.
Celles-ci sont normalement plac√©es dans un fichier \texttt{requirements.txt}.
Dans un premier temps, ce fichier peut √™tre plac√© directement √† la racine du projet, mais on pr√©f√©rera rapidement le d√©placer dans un sous-r√©pertoire sp√©cifique (\texttt{requirements}), afin de grouper les d√©pendances en fonction de leur environnement de destination:


\begin{itemize}

\item \texttt{base.txt}

\item \texttt{dev.txt}

\item \texttt{production.txt}

\end{itemize}


Au d√©but de chaque fichier, il suffit d‚Äôajouter la ligne \texttt{-r base.txt}, puis de lancer l‚Äôinstallation gr√¢ce √† un \texttt{pip install -r <nom du fichier>}.
De cette mani√®re, il est tout √† fait acceptable de n‚Äôinstaller \texttt{flake8} et \texttt{django-debug-toolbar} qu‚Äôen d√©veloppement par exemple.
Dans l‚Äôimm√©diat, nous allons ajouter \texttt{django} dans une version strictement inf√©rieure √† la version 3.2 dans le fichier \texttt{requirements/base.txt}.


\begin{verbatim}
$ echo 'django==3.2' > requirements/base.txt
$ echo '-r base.txt' > requirements/prod.txt
$ echo '-r base.txt' > requirements/dev.txt
\end{verbatim}

\admonition{IMPORTANT}{Prenez directement l‚Äôhabitude de sp√©cifier la version ou les versions compatibles: les librairies que vous utilisez comme d√©pendances √©voluent, de la m√™me mani√®re que vos projets.
Pour √™tre s√ªr et certain le code que vous avez √©crit continue √† fonctionner, sp√©cifiez la version de chaque librairie de d√©pendances.
Entre deux versions d‚Äôune m√™me librairie, des fonctions sont cass√©es, certaines signatures sont modifi√©es, des comportements sont alt√©r√©s, etc. Il suffit de parcourir les pages de \emph{Changements incompatibles avec les anciennes versions dans Django} \href{https://docs.djangoproject.com/fr/3.1/releases/3.0/}{(par exemple ici pour le passage de la 3.0 √† la 3.1)} pour r√©aliser que certaines op√©rations ne sont pas anodines, et que sans filet de s√©curit√©, c‚Äôest le mur assur√©.
Avec les m√©canismes d‚Äôint√©gration continue et de tests unitaires, nous verrons plus loin comment se pr√©munir d‚Äôun changement inattendu.}
\hypertarget{x-django}{\section{Django}}
Comme nous l‚Äôavons vu ci-dessus, \texttt{django-admin} permet de cr√©er un nouveau projet.
Nous faisons ici une distinction entre un \textbf{projet} et une \textbf{application}:


\begin{itemize}

\item \textbf{Un projet} repr√©sente l‚Äôensemble des applications, param√®tres, pages HTML, middlewares, d√©pendances, etc., qui font que votre code fait ce qu‚Äôil est sens√© faire.

\item \textbf{Une application} est un contexte d‚Äôex√©cution, id√©alement autonome, d‚Äôune partie du projet.

\end{itemize}


Pour \texttt{gwift}, nous aurons:


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-project-vs-apps-gwift.png}
\caption{}

\end{figure}

\begin{enumerate}

\item{une premi√®re application pour la gestion des listes de souhaits et des √©l√©ments,}

\item{une deuxi√®me application pour la gestion des utilisateurs,}

\item{voire une troisi√®me application qui g√©rera les partages entre utilisateurs et listes.}

\end{enumerate}


Nous voyons √©galement que la gestion des listes de souhaits et √©l√©ments aura besoin de la gestion des utilisateurs - elle n‚Äôest pas autonome -, tandis que la gestion des utilisateurs n‚Äôa aucune autre d√©pendance qu‚Äôelle-m√™me.


Pour \texttt{khana}, nous pourrions avoir quelque chose comme ceci:


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-project-vs-apps-khana.png}
\caption{}

\end{figure}

En rouge, vous pouvez voir quelque chose que nous avons d√©j√† vu: la gestion des utilisateurs et la possibilit√© qu‚Äôils auront de communiquer entre eux.
Ceci pourrait √™tre commun aux deux applications.
Nous pouvons clairement visualiser le principe de \textbf{contexte} pour une application: celle-ci viendra avec son mod√®le, ses tests, ses vues et son param√©trage et pourrait ainsi √™tre r√©utilis√©e dans un autre projet.
C‚Äôest en √ßa que consistent les \href{https://www.djangopackages.com/}{paquets Django} d√©j√† disponibles: ce sont "\emph{simplement}" de petites applications empaquet√©es et pouvant √™tre r√©utilis√©es dans diff√©rents contextes (eg. \href{https://github.com/tomchristie/django-rest-framework}{Django-Rest-Framework}, \href{https://github.com/django-debug-toolbar/django-debug-toolbar}{Django-Debug-Toolbar}, ‚Ä¶‚Äã).


\hypertarget{x-manage.py}{\subsection{manage.py}}
Le fichier \texttt{manage.py} que vous trouvez √† la racine de votre projet est un \textbf{wrapper} sur les commandes \texttt{django-admin}.
A partir de maintenant, nous n‚Äôutiliserons plus que celui-l√† pour tout ce qui touchera √† la gestion de notre projet:


\begin{itemize}

\item \texttt{manage.py check} pour v√©rifier (en surface‚Ä¶‚Äã) que votre projet ne rencontre aucune erreur √©vidente

\item \texttt{manage.py check --deploy}, pour v√©rifier (en surface aussi) que l‚Äôapplication est pr√™te pour un d√©ploiement

\item \texttt{manage.py runserver} pour lancer un serveur de d√©veloppement

\item \texttt{manage.py test} pour d√©couvrir les tests unitaires disponibles et les lancer.

\end{itemize}


La liste compl√®te peut √™tre affich√©e avec \texttt{manage.py help}.
Vous remarquerez que ces commandes sont group√©es selon diff√©rentes cat√©gories:


\begin{itemize}

\item \textbf{auth}: cr√©ation d‚Äôun nouveau super-utilisateur, changer le mot de passe pour un utilisateur existant.

\item \textbf{django}: v√©rifier la \textbf{compliance} du projet, lancer un \textbf{shell}, \textbf{dumper} les donn√©es de la base, effectuer une migration du sch√©ma, ‚Ä¶‚Äã

\item \textbf{sessions}: suppressions des sessions en cours

\item \textbf{staticfiles}: gestion des fichiers statiques et lancement du serveur de d√©veloppement.

\end{itemize}


Nous verrons plus tard comment ajouter de nouvelles commandes.


Si nous d√©marrons la commande \texttt{python manage.py runserver}, nous verrons la sortie console suivante:


\begin{verbatim}
$ python manage.py runserver
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).

[...]

December 15, 2020 - 20:45:07
Django version 3.1.4, using settings 'gwift.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
\end{verbatim}

Si nous nous rendons sur la page \href{http://127.0.0.1:8000}{http://127.0.0.1:8000} (ou \href{http://localhost:8000}{http://localhost:8000}) comme le propose si gentiment notre (nouveau) meilleur ami, nous verrons ceci:


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/manage-runserver.png}
\caption{}

\end{figure}

\admonition{IMPORTANT}{Nous avons mis un morceau de la sortie console entre crochet \texttt{[‚Ä¶‚Äã]} ci-dessus, car elle concerne les migrations.
Si vous avez suivi les √©tapes jusqu‚Äôici, vous avez √©galement d√ª voir un message type \texttt{You have 18 unapplied migration(s). [‚Ä¶‚Äã] Run 'python manage.py migrate' to apply them.}
Cela concerne les migrations, et c‚Äôest un point que nous verrons un peu plus tard.}
\hypertarget{x-cr√©ation-d‚Äôune-nouvelle-application}{\subsection{Cr√©ation d‚Äôune nouvelle application}}
Maintenant que nous avons a vu √† quoi servait \texttt{manage.py}, nous pouvons cr√©er notre nouvelle application gr√¢ce √† la commande \texttt{manage.py startapp <label>}.


Notre premi√®re application servira √† structurer les listes de souhaits, les √©l√©ments qui les composent et les parties que chaque utilisateur pourra offrir.
De mani√®re g√©n√©rale, essayez de trouver un nom √©loquent, court et qui r√©sume bien ce que fait l‚Äôapplication.
Pour nous, ce sera donc \texttt{wish}.


C‚Äôest parti pour \texttt{manage.py startapp wish}!


\begin{verbatim}
$ python manage.py startapp wish
\end{verbatim}

R√©sultat? Django nous a cr√©√© un r√©pertoire \texttt{wish}, dans lequel nous trouvons les fichiers et dossiers suivants:


\begin{itemize}

\item \texttt{wish/\emph{init}.py} pour que notre r√©pertoire \texttt{wish} soit converti en package Python.

\item \texttt{wish/admin.py} servira √† structurer l‚Äôadministration de notre application. Chaque information peut √™tre administr√©e facilement au travers d‚Äôune interface g√©n√©r√©e √† la vol√©e par le framework. Nous y reviendrons par la suite.

\item \texttt{wish/migrations/} est le dossier dans lequel seront stock√©es toutes les diff√©rentes migrations de notre application (= toutes les modifications que nous apporterons aux donn√©es que nous souhaiterons manipuler)

\item \texttt{wish/models.py} repr√©sentera et structurera nos donn√©es, et est intimement li√© aux migrations.

\item \texttt{wish/tests.py} pour les tests unitaires.

\end{itemize}


\admonition{NOTE}{Par soucis de clart√©, vous pouvez d√©placer ce nouveau r√©pertoire \texttt{wish} dans votre r√©pertoire \texttt{gwift} existant.
C‚Äôest une forme de convention.}
La structure de vos r√©pertoires devient celle-ci:


\begin{verbatim}
(gwift-env) fred@aerys:~/Sources/gwift$ tree .
.
‚îú‚îÄ‚îÄ gwift
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ asgi.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ settings.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ urls.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ wish 
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ admin.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ apps.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ migrations
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ views.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ wsgi.py
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ base.txt
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ dev.txt
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ prod.txt
‚îú‚îÄ‚îÄ setup.cfg
‚îî‚îÄ‚îÄ tox.ini

5 directories, 22 files
\end{verbatim}


\hypertarget{x-fonctionement-g√©n√©ral}{\subsection{Fonctionement g√©n√©ral}}
Le m√©tier de programmeur est devenu de plus en plus complexe. Il y a 20 ans, nous pouvions nous contenter d‚Äôune simple page PHP dans laquelle nous mixions l‚Äôensemble des actios √† r√©aliser: requ√™tes en bases de donn√©es, construction de la page, ‚Ä¶‚Äã
La recherche d‚Äôune solution a un probl√®me n‚Äô√©tait pas sp√©cialement plus complexe - dans la mesure o√π le rendu des enregistrements en direct n‚Äô√©tait finalement qu‚Äôune forme un chouia plus √©volu√©e du \texttt{print()} ou des \texttt{System.out.println()} - mais c‚Äô√©tait l‚Äô√©volutivit√© des applications qui en prenait un coup: une grosse partie des t√¢ches √©taient dupliqu√©es entre les diff√©rentes pages, et l‚Äôajout d‚Äôune nouvelle fonctionnalit√© √©tait relativement ardue.


Django (et d‚Äôautres cadriciels) r√©solvent ce probl√®me en se basant ouvertement sur le principe de \texttt{Don‚Äôt repeat yourself} \footnote{DRY}.
Chaque morceau de code ne doit apparaitre qu‚Äôune seule fois, afin de limiter au maximum la redite (et donc, l‚Äôapplication d‚Äôun m√™me correctif √† diff√©rents endroits).


Le chemin parcouru par une requ√™te est expliqu√© en (petits) d√©tails ci-dessous.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/diagrams/django-how-it-works.png}
\caption{}

\end{figure}

\textbf{1. Un utilisateur ou un visiteur souhaite acc√©der √† une URL h√©berg√©e et servie par notre application}.
Ici, nous prenons l‚Äôexemple de l‚ÄôURL fictive \texttt{https://gwift/wishes/91827}.
Lorsque cette URL "arrive" dans notre application, son point d‚Äôentr√©e se trouvera au niveau des fichiers \texttt{asgi.py} ou \texttt{wsgi.py}. Nous verrons cette partie plus tard, et nous pouvons nous concentrer sur le chemin interne qu‚Äôelle va parcourir.


\textbf{Etape 0} - La premi√®re √©tape consiste √† v√©rifier que cette URL r√©pond √† un sch√©ma que nous avons d√©fini dans le fichier \texttt{gwift/urls.py}.


\textbf{Etape 1} - Si ce n‚Äôest pas le cas, l‚Äôapplication n‚Äôira pas plus loin et retournera une erreur √† l‚Äôutilisateur.


\textbf{Etape 2} - Django va parcourir l‚Äôensemble des \emph{patterns} pr√©sents dans le fichier \texttt{urls.py} et s‚Äôarr√™tera sur le premier qui correspondra √† la requ√™te qu‚Äôil a re√ßue.
Ce cas est relativement trivial: la requ√™te \texttt{/wishes/91827} a une correspondance au niveau de la ligne \texttt{path("wishes/<int:wish\_id>} dans l‚Äôexemple ci-dessous.
Django va alors appeler la fonction \footnote{Qui ne sera pas toujours une fonction. Django s‚Äôattend √† trouver un \emph{callable}, c‚Äôest-√†-dire n‚Äôimporte quel √©l√©ment qu‚Äôil peut appeler comme une fonction.} associ√©e √† ce \emph{pattern}, c‚Äôest-√†-dire \texttt{wish\_details} du module \texttt{gwift.views}.


\begin{verbatim}
from django.contrib import admin
from django.urls import path

from gwift.views import wish_details 

urlpatterns = [
    path('admin/', admin.site.urls),
    path("wishes/<int:wish_id>", wish_details), 
]
\end{verbatim}


TODO: En fait, il faudrait quand m√™me s‚Äôoccuper du mod√®le ici.
TODO: et de la mise en place de l‚Äôadministration, parce que nous en aurons besoin pour les √©tapes de d√©ploiement.





Le module \texttt{gwift.views} qui se trouve dans le fichier \texttt{gwift/views.py} peut ressembler √† ceci:


\begin{verbatim}
[...]

from datetime import datetime


def wishes_details(request: HttpRequest, wish_id: int) -> HttpResponse:
    context = {
        "user_name": "Bond,"
        "user_first_name": "James",
        "now": datetime.now()
    }

    return render(
        request,
        "wish_details.html",
        context
    )
\end{verbatim}

Pour r√©sumer, cette fonction permet:


\begin{enumerate}

\item{De construire un \emph{contexte}, qui est repr√©sent√© sous la forme d‚Äôun dictionnaire associant des cl√©s √† des valeurs. Les cl√©s sont respectivement \texttt{user\_name}, \texttt{user\_first\_name} et \texttt{now}, tandis que leurs valeurs respectives sont \texttt{Bond}, \texttt{James} et le \texttt{moment pr√©sent} \footnote{Non, pas celui d‚ÄôEckhart Tolle}.}

\item{Nous passons ensuite ce dictionnaire √† un canevas, \texttt{wish\_details.html}}

\item{L‚Äôapplication du contexte sur le canevas nous donne un r√©sultat.}

\end{enumerate}


\begin{verbatim}
<!-- fichier wish_details.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Page title</title>
</head>
<body>
  <h1>üë§ Hi!</h1>
  <p>My name is glossterm::[ user_name ]. glossterm::[ user_first_name ] glossterm::[ user_name ].</p>
  <p>This page was generated at glossterm::[ now ]</p>
</body>
</html>
\end{verbatim}

Apr√®s application de notre contexte sur ce template, nous obtiendrons ce document, qui sera renvoy√© au navigateur de l‚Äôutilisateur qui aura fait la requ√™te initiale:


\begin{verbatim}
<!DOCTYPE html>
<html>
<head>
  <title>Page title</title>
</head>
<body>
  <h1>üë§ Hi!</h1>
  <p>My name is Bond. James Bond.</p>
  <p>This page was generated at 2027-03-19 19:47:38</p>
</body>
</html>
\end{verbatim}

\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-first-template.png}
\caption{}

\end{figure}

\hypertarget{x-12-facteurs-et-configuration-globale}{\subsection{12 facteurs et configuration globale}}
-> Faire le lien avec les settings
-> Faire le lien avec les douze facteurs
-> Construction du fichier setup.cfg


\hypertarget{x-setup.cfg}{\subsection{setup.cfg}}
(Repris de cookie-cutter-django)


\begin{verbatim}
[flake8]
max-line-length = 120
exclude = .tox,.git,*/migrations/*,*/static/CACHE/*,docs,node_modules,venv

[pycodestyle]
max-line-length = 120
exclude = .tox,.git,*/migrations/*,*/static/CACHE/*,docs,node_modules,venv

[mypy]
python_version = 3.8
check_untyped_defs = True
ignore_missing_imports = True
warn_unused_ignores = True
warn_redundant_casts = True
warn_unused_configs = True
plugins = mypy_django_plugin.main

[mypy.plugins.django-stubs]
django_settings_module = config.settings.test

[mypy-*.migrations.*]
# Django migrations should not produce any errors:
ignore_errors = True

[coverage:run]
include = khana/*
omit = *migrations*, *tests*
plugins =
    django_coverage_plugin
\end{verbatim}

\hypertarget{x-structure-finale-de-notre-environnement}{\section{Structure finale de notre environnement}}
Nous avons donc la structure finale pour notre environnement de travail:


\begin{verbatim}
(gwift-env) fred@aerys:~/Sources/gwift$ tree .
.
‚îú‚îÄ‚îÄ gwift
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ asgi.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ settings.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ urls.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ wish 
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ admin.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ apps.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ migrations
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tests.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ views.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ wsgi.py
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ base.txt
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ dev.txt
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ prod.txt
‚îú‚îÄ‚îÄ setup.cfg
‚îî‚îÄ‚îÄ tox.ini
\end{verbatim}

\hypertarget{x-cookie-cutter}{\section{Cookie cutter}}
Pfiou! Ca en fait des commandes et du boulot pour "juste" d√©marrer un nouveau projet, non? Sachant qu‚Äôen plus, nous avons d√ª modifier des fichiers, d√©placer des dossiers, ajouter des d√©pendances, configurer une base de donn√©es, ‚Ä¶‚Äã


Bonne nouvelle! Il existe des g√©n√©rateurs, permettant de d√©marrer rapidement un nouveau projet sans (trop) se prendre la t√™te. Le plus connu (et le plus personnalisable) est \href{https://cookiecutter.readthedocs.io/}{Cookie-Cutter}, qui se base sur des canevas \emph{type \href{https://pypi.org/project/Jinja2/}{Jinja2}}, pour cr√©er une arborescence de dossiers et fichiers conformes √† votre mani√®re de travailler. Et si vous avez la flemme de cr√©er votre propre canevas, vous pouvez utiliser \href{https://cookiecutter-django.readthedocs.io}{ceux qui existent d√©j√†}.


Pour d√©marrer, cr√©ez un environnement virtuel (comme d‚Äôhabitude):


\begin{verbatim}
Œª python -m venv .venvs\cookie-cutter-khana
Œª .venvs\cookie-cutter-khana\Scripts\activate.bat
(cookie-cutter-khana) Œª pip install cookiecutter

  Collecting cookiecutter
  [...]
  Successfully installed Jinja2-2.11.2 MarkupSafe-1.1.1 arrow-0.17.0 binaryornot-0.4.4 certifi-2020.12.5 chardet-4.0.0 click-7.1.2 cookiecutter-1.7.2 idna-2.10 jinja2-time-0.2.0 poyo-0.5.0 python-dateutil-2.8.1 python-slugify-4.0.1 requests-2.25.1 six-1.15.0 text-unidecode-1.3 urllib3-1.26.2

(cookie-cutter-khana) Œª cookiecutter https://github.com/pydanny/cookiecutter-django

  [...]

 [SUCCESS]: Project initialized, keep up the good work!
\end{verbatim}

Si vous explorez les diff√©rents fichiers, vous trouverez beaucoup de similitudes avec la configuration que nous vous proposions ci-dessus.
En fonction de votre exp√©rience, vous serez tent√© de modifier certains param√®tres, pour faire correspondre ces sources avec votre utilisation ou vos habitudes.


Il est aussi possible d‚Äôutiliser l‚Äôargument \texttt{--template}, suivie d‚Äôun argument reprenant le nom de votre projet (\texttt{<my\_project>}), lors de l‚Äôinitialisation d‚Äôun projet avec la commande \texttt{startproject} de \texttt{django-admin}, afin de calquer votre arborescence sur un projet existant.
La \href{https://docs.djangoproject.com/en/stable/ref/django-admin/#startproject}{documentation} √† ce sujet est assez compl√®te.

\begin{verbatim}
django-admin.py startproject --template=https://[...].zip <my_project>
\end{verbatim}

\hypertarget{x-d√©ploiement}{\part*{D√©ploiement}}
Il y a une raison tr√®s simple √† aborder le d√©ploiement d√®s maintenant: √† trop attendre et √† peaufiner son d√©veloppement en local, on en oublie que sa finalit√© sera de se retrouver expos√© sur un serveur.
Il est du coup probable d‚Äôoublier une partie des d√©sid√©rata, de zapper une fonctionnalit√© essentielle ou simplement de passer √©norm√©ment de temps √† adapter les sources pour qu‚Äôelles fonctionnent sur un environnement en particulier.


Aborder le d√©ploiement d√®s le d√©but permet √©galement de r√©diger d√®s le d√©but les proc√©dures d‚Äôinstallation, de mises √† jour et de sauvegardes.
D√©ploier une nouvelle version sera aussi simple que de r√©cup√©rer la derni√®re archive depuis le d√©p√¥t, la placer dans le bon r√©pertoire, appliquer des actions sp√©cifiques (et souvent identiques entre deux versions), puis red√©marrer les services ad√©quats, et la proc√©dure compl√®te se r√©sumera √† quelques lignes d‚Äôun script bash.


Le serveur que django met √† notre disposition \emph{via} la commande \texttt{runserver} est extr√™mement pratique, mais il est uniquement pr√©vu pour la phase  d√©veloppement: en production, il est inutile de passer par du code Python pour charger des fichiers statiques (feuilles de style, fichiers JavaScript, images, ‚Ä¶‚Äã).
De m√™me, Django propose par d√©faut une base de donn√©es SQLite, qui fonctionne parfaitement d√®s lors que l‚Äôon connait ses limites et que l‚Äôon se limite √† un utilisateur √† la fois. En production, il est l√©gitime que la base de donn√©e soit capable de supporter plusieurs utilisateurs et connexions simultan√©ment‚Ä¶‚Äã
En restant avec les param√®tres par d√©faut, il est plus que probable que vous rencontriez rapidement des erreurs de verrou parce qu‚Äôun autre processus a d√©j√† pris la main pour √©crire ses donn√©es.
En bref, vous avez quelque chose qui fonctionne, mais qui ressemble de tr√®s loin √† ce dont vous aurez besoin au final.


Dans cette partie, nous aborderons les points suivants:


\begin{itemize}

\item D√©finir l‚Äôinfrastructure n√©cessaire √† notre application et configurer l‚Äôh√¥te qui h√©bergera l‚Äôapplication: dans une machine physique, virtuelle ou dans un container. Nous aborderons aussi les d√©ploiements via Ansible et Salt.

\item D√©ployer notre code source

\item Configurer les outils n√©cessaires √† la bonne ex√©cution de ce code et de ses fonctionnalit√©s: les diff√©rentes m√©thodes de supervision de l‚Äôapplication, comment analyser les fichiers de logs, comment intercepter correctement une erreur si elle se pr√©sente et comment remonter l‚Äôinformation.

\item Rendre notre application accessible depuis l‚Äôext√©rieur.

\end{itemize}


\hypertarget{x-infrastructure-&-composants}{\chapter{Infrastructure \& composants}}
Pour une mise ne production, le standard \emph{de facto} est le suivant:


\begin{itemize}

\item Nginx comme reverse proxy

\item HAProxy pour la distribution de charge

\item Gunicorn ou Uvicorn comme serveur d‚Äôapplication

\item Supervisor pour le monitoring

\item PostgreSQL ou MariaDB comme base de donn√©es.

\item Celery et RabbitMQ pour l‚Äôex√©cution de t√¢ches asynchrones

\item Redis / Memcache pour la mise √† en cache (et pour les sessions ? A v√©rifier).

\end{itemize}


Si nous sch√©matisons l‚Äôinfrastructure et le chemin parcouru par une requ√™te, nous pourrions arriver √† la synth√®se suivante:


\begin{enumerate}

\item{L‚Äôutilisateur fait une requ√™te via son navigateur (Firefox ou Chrome)}

\item{Le navigateur envoie une requ√™te http, sa version, un verbe (GET, POST, ‚Ä¶‚Äã), un port et √©ventuellement du contenu}

\item{Le firewall du serveur (Debian GNU/Linux, CentOS, ‚Ä¶‚Äã) v√©rifie si la requ√™te peut √™tre prise en compte}

\item{La requ√™te est transmise √† l‚Äôapplication qui √©coute sur le port (probablement 80 ou 443; et \emph{a priori} Nginx)}

\item{Elle est ensuite transmise par socket et est prise en compte par un des \emph{workers} (= un processus Python) instanci√© par Gunicorn. Si l‚Äôun de ces travailleurs venait √† planter, il serait automatiquement r√©instanci√© par Supervisord.}

\item{Qui la transmet ensuite √† l‚Äôun de ses \emph{workers} (= un processus Python).}

\item{Apr√®s ex√©cution, une r√©ponse est renvoy√©e √† l‚Äôutilisateur.}

\end{enumerate}


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/diagrams/architecture.png}


\end{figure}

\hypertarget{x-reverse-proxy}{\section{Reverse proxy}}
Le principe du \textbf{proxy inverse} est de pouvoir rediriger du trafic entrant vers une application h√©berg√©e sur le syst√®me.
Il serait tout √† fait possible de rendre notre application directement accessible depuis l‚Äôext√©rieur, mais le proxy a aussi l‚Äôint√©r√™t de pouvoir √©lever la s√©curit√© du serveur (SSL) et d√©charger le serveur applicatif gr√¢ce √† un m√©canisme de cache ou en compressant certains r√©sultats \footnote{\href{https://fr.wikipedia.org/wiki/Proxy_inverse}{https://fr.wikipedia.org/wiki/Proxy\_inverse}}


\hypertarget{x-load-balancer}{\section{Load balancer}}

\hypertarget{x-workers}{\section{Workers}}

\hypertarget{x-supervision-des-processus}{\section{Supervision des processus}}

\hypertarget{x-base-de-donn√©es}{\section{Base de donn√©es}}

\hypertarget{x-t√¢ches-asynchrones}{\section{T√¢ches asynchrones}}

\hypertarget{x-mise-en-cache}{\section{Mise en cache}}

\hypertarget{x-code-source}{\chapter{Code source}}
Au niveau logiciel (la partie mise en subrillance ci-dessus), la requ√™te arrive dans les mains du processus Python, qui doit encore


\begin{enumerate}

\item{effectuer le routage des donn√©es,}

\item{trouver la bonne fonction √† ex√©cuter,}

\item{r√©cup√©rer les donn√©es depuis la base de donn√©es,}

\item{effectuer le rendu ou la conversion des donn√©es,}

\item{et renvoyer une r√©ponse √† l‚Äôutilisateur.}

\end{enumerate}


Comme nous l‚Äôavons vu dans la premi√®re partie, Django est un framework complet, int√©grant tous les m√©canismes n√©cessaires √† la bonne √©volution d‚Äôune application.
Il est possible de d√©marrer petit, et de suivre l‚Äô√©volution des besoins en fonction de la charge estim√©e ou ressentie, d‚Äôajouter un m√©canisme de mise en cache, des logiciels de suivi, ‚Ä¶‚Äã


\hypertarget{x-outils-de-supervision-et-de-mise-√†-disposition}{\chapter{Outils de supervision et de mise √† disposition}}

\hypertarget{x-m√©thode-de-d√©ploiement}{\chapter{M√©thode de d√©ploiement}}
Nous allons d√©tailler ci-dessous trois m√©thodes de d√©ploiement:


\begin{itemize}

\item Sur une machine h√¥te, en embarquant tous les composants sur un m√™me serveur. Ce ne sera pas id√©al, puisqu‚Äôil ne sera pas possible de configurer un \emph{load balancer}, de routeur plusieurs bas√©es de donn√©es, mais ce sera le premier cas de figure.

\item Dans des containers, avec Docker-Compose.

\item Sur une \textbf{Plateforme en tant que Service} (ou plus simplement, \textbf{PaaS}), pour faire abstraction de toute la couche de configuration du serveur.

\end{itemize}


\hypertarget{x-sur-une-machine-h√¥te}{\section{Sur une machine h√¥te}}
La premi√®re √©tape pour la configuration de notre h√¥te consiste √† d√©finir les utilisateurs et groupes de droits. Il est faut absolument √©viter de faire tourner une application en tant qu‚Äôutilisateur \textbf{root}, car la moindre faille pourrait avoir des cons√©quences catastrophiques.


Une fois que ces utilisateurs seront configur√©s, nous pourrons passer √† l‚Äô√©tape de configuration, qui consistera √†:


\begin{enumerate}

\item{D√©ployer les sources}

\item{D√©marrer un serveur impl√©mentant une interface WSGI (\textbf{Web Server Gateway Interface}), qui sera charg√© de cr√©er autant de  travailleurs que nous le d√©sirerons.}

\item{D√©marrer un superviseur, qui se chargera de veiller √† la bonne sant√© de nos petits travailleurs, et en cr√©er de nouveaux s‚Äôil le juge n√©cessaire}

\item{Configurer un proxy inverse, qui s‚Äôoccupera d‚Äôenvoyer les requ√™tes d‚Äôun utilisateur externe √† la machine h√¥te vers notre serveur applicatif, qui la communiquera √† l‚Äôun des travailleurs.}

\end{enumerate}


La machine h√¥te peut √™tre lou√©e chez Digital Ocean, Scaleway, OVH, Vultr, ‚Ä¶‚Äã Il existe des dizaines d‚Äôh√©bergements typ√©s VPS (\textbf{Virtual Private Server}). A vous de choisir celui qui vous convient \footnote{Personnellement, j‚Äôai un petit faible pour Hetzner Cloud}.


\hypertarget{x-d√©ploiement-sur-debian}{\section{D√©ploiement sur Debian}}
\begin{verbatim}
apt update
groupadd --system webapps 
groupadd --system gunicorn_sockets 
useradd --system --gid webapps --shell /bin/bash --home /home/gwift gwift 
mkdir -p /home/gwift 
chown gwift:webapps /home/gwift 
\end{verbatim}


\hypertarget{x-installation-des-d√©pendances-syst√®mes}{\subsection{Installation des d√©pendances syst√®mes}}
La version 3.6 de Python se trouve dans les d√©p√¥ts officiels de CentOS.
Si vous souhaitez utiliser une version ult√©rieure, il suffit de l‚Äôinstaller en parall√®le de la version officiellement support√©e par votre distribution.


Pour CentOS, vous avez donc deux possibilit√©s :


\begin{verbatim}
yum install python36 -y
\end{verbatim}

Ou passer par une installation alternative:


\begin{verbatim}
sudo yum -y groupinstall "Development Tools"
sudo yum -y install openssl-devel bzip2-devel libffi-devel

wget https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tgz
cd Python-3.8*/
./configure --enable-optimizations
sudo make altinstall 
\end{verbatim}


\hypertarget{x-installation-de-la-base-de-donn√©es}{\subsection{Installation de la base de donn√©es}}
On l‚Äôa d√©j√† vu, Django se base sur un pattern type \href{https://www.martinfowler.com/eaaCatalog/activeRecord.html}{ActiveRecords} pour la gestion de la persistance des donn√©es et supporte les principaux moteurs de bases de donn√©es connus:


\begin{itemize}

\item SQLite (en natif, mais Django 3.0 exige une version du moteur sup√©rieure ou √©gale √† la 3.8)

\item MariaDB (en natif depuis Django 3.0),

\item PostgreSQL au travers de psycopg2 (en natif aussi),

\item Microsoft SQLServer gr√¢ce aux drivers [‚Ä¶‚Äã√† compl√©ter]

\item Oracle via \href{https://oracle.github.io/python-cx_Oracle/}{cx\_Oracle}.

\end{itemize}


\admonition{CAUTION}{Chaque pilote doit √™tre utilis√© pr√©cautionneusement ! Chaque version de Django n‚Äôest pas toujours compatible avec chacune des versions des pilotes, et chaque moteur de base de donn√©es n√©cessite parfois une version sp√©cifique du pilote. Par ce fait, vous serez parfois bloqu√© sur une version de Django, simplement parce que votre serveur de base de donn√©es se trouvera dans une version sp√©cifique (eg. Django 2.3 √† cause d‚Äôun Oracle 12.1).}
Ci-dessous, quelques proc√©dures d‚Äôinstallation pour mettre un serveur √† disposition. Les deux plus simples seront MariaDB et PostgreSQL, qu‚Äôon couvrira ci-dessous. Oracle et Microsoft SQLServer se trouveront en annexes.


\hypertarget{x-postgresql}{\subsubsection{PostgreSQL}}
On commence par installer PostgreSQL.


Par exemple, dans le cas de debian, on ex√©cute la commande suivante:


\begin{verbatim}
pass:[$$]$ aptitude install postgresql postgresql-contrib
\end{verbatim}

Ensuite, on cr√©e un utilisateur pour la DB:


\begin{verbatim}
pass:[$$]$ su - postgres
postgres@gwift:~$ createuser --interactive -P
Enter name of role to add: gwift_user
Enter password for new role:
Enter it again:
Shall the new role be a superuser? (y/n) n
Shall the new role be allowed to create databases? (y/n) n
Shall the new role be allowed to create more new roles? (y/n) n
postgres@gwift:~$
\end{verbatim}

Finalement, on peut cr√©er la DB:


\begin{verbatim}
postgres@gwift:~$ createdb --owner gwift_user gwift
postgres@gwift:~$ exit
logout
pass:[$$]$
\end{verbatim}

\admonition{NOTE}{penser √† inclure un bidule pour les backups.}
\hypertarget{x-mariadb}{\subsubsection{MariaDB}}
Idem, installation, configuration, backup, tout √ßa.
A copier de grimboite, je suis s√ªr d‚Äôavoir des notes l√†-dessus.


\hypertarget{x-microsoft-sql-server}{\subsubsection{Microsoft SQL Server}}

\hypertarget{x-oracle}{\subsubsection{Oracle}}

\hypertarget{x-pr√©paration-de-l‚Äôenvironnement-utilisateur}{\subsection{Pr√©paration de l‚Äôenvironnement utilisateur}}
\begin{verbatim}
su - gwift
cp /etc/skel/.bashrc .
cp /etc/skel/.bash_profile .
ssh-keygen
mkdir bin
mkdir .venvs
mkdir webapps
python3.6 -m venv .venvs/gwift
source .venvs/gwift/bin/activate
cd /home/gwift/webapps
git clone ...
\end{verbatim}

La cl√© SSH doit ensuite √™tre renseign√©e au niveau du d√©p√¥t, afin de pouvoir y acc√©der.


A ce stade, on devrait d√©j√† avoir quelque chose de fonctionnel en d√©marrant les commandes suivantes:


\begin{verbatim}
# en tant qu'utilisateur 'gwift'

source .venvs/gwift/bin/activate
pip install -U pip
pip install -r requirements/base.txt
pip install gunicorn
cd webapps/gwift
gunicorn config.wsgi:application --bind localhost:3000 --settings=config.settings_production
\end{verbatim}

\hypertarget{x-configuration-de-l‚Äôapplication}{\subsection{Configuration de l‚Äôapplication}}
\begin{verbatim}
SECRET_KEY=<set your secret key here> 
ALLOWED_HOSTS=*
STATIC_ROOT=/var/www/gwift/static
DATABASE= 
\end{verbatim}


\hypertarget{x-cr√©ation-des-r√©pertoires-de-logs}{\subsection{Cr√©ation des r√©pertoires de logs}}
\begin{verbatim}
mkdir -p /var/www/gwift/static
\end{verbatim}

\hypertarget{x-cr√©ation-du-r√©pertoire-pour-le-socket}{\subsection{Cr√©ation du r√©pertoire pour le socket}}
Dans le fichier \texttt{/etc/tmpfiles.d/gwift.conf}:


\begin{verbatim}
D /var/run/webapps 0775 gwift gunicorn_sockets -
\end{verbatim}

Suivi de la cr√©ation par systemd :


\begin{verbatim}
systemd-tmpfiles --create
\end{verbatim}

\hypertarget{x-gunicorn}{\subsection{Gunicorn}}
\begin{verbatim}
#!/bin/bash

# defines settings for gunicorn
NAME="gwift"
DJANGODIR=/home/gwift/webapps/gwift
SOCKFILE=/var/run/webapps/gunicorn_gwift.sock
USER=gwift
GROUP=gunicorn_sockets
NUM_WORKERS=5
DJANGO_SETTINGS_MODULE=config.settings_production
DJANGO_WSGI_MODULE=config.wsgi

echo "Starting $NAME as `whoami`"

source /home/gwift/.venvs/gwift/bin/activate
cd $DJANGODIR
export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
export PYTHONPATH=pass:[$DJANGODIR:$]PYTHONPATH

exec gunicorn ${DJANGO_WSGI_MODULE}:application \
--name $NAME \
--workers $NUM_WORKERS \
--user $USER \
--bind=unix:$SOCKFILE \
--log-level=debug \
--log-file=-
\end{verbatim}

\hypertarget{x-supervision,-keep-alive-et-autoreload}{\subsection{Supervision, keep-alive et autoreload}}
Pour la supervision, on passe par Supervisor. Il existe d‚Äôautres superviseurs,


\begin{verbatim}
yum install supervisor -y
\end{verbatim}

On cr√©e ensuite le fichier \texttt{/etc/supervisord.d/gwift.ini}:


\begin{verbatim}
[program:gwift]
command=/home/gwift/bin/start_gunicorn.sh
user=gwift
stdout_logfile=/var/log/gwift/gwift.log
autostart=true
autorestart=unexpected
redirect_stdout=true
redirect_stderr=true
\end{verbatim}

Et on cr√©e les r√©pertoires de logs, on d√©marre supervisord et on v√©rifie qu‚Äôil tourne correctement:


\begin{verbatim}
mkdir /var/log/gwift
chown gwift:nagios /var/log/gwift

systemctl enable supervisord
systemctl start supervisord.service
systemctl status supervisord.service
‚óè supervisord.service - Process Monitoring and Control Daemon
   Loaded: loaded (/usr/lib/systemd/system/supervisord.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2019-12-24 10:08:09 CET; 10s ago
  Process: 2304 ExecStart=/usr/bin/supervisord -c /etc/supervisord.conf (code=exited, status=0/SUCCESS)
 Main PID: 2310 (supervisord)
   CGroup: /system.slice/supervisord.service
           ‚îú‚îÄ2310 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf
           ‚îú‚îÄ2313 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
           ‚îú‚îÄ2317 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
           ‚îú‚îÄ2318 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
           ‚îú‚îÄ2321 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
           ‚îú‚îÄ2322 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
           ‚îî‚îÄ2323 /home/gwift/.venvs/gwift/bin/python3 /home/gwift/.venvs/gwift/bin/gunicorn config.wsgi:...
ls /var/run/webapps/
\end{verbatim}

On peut aussi v√©rifier que l‚Äôapplication est en train de tourner, √† l‚Äôaide de la commande \texttt{supervisorctl}:


\begin{verbatim}
pass:[$$]$ supervisorctl status gwift
gwift                            RUNNING    pid 31983, uptime 0:01:00
\end{verbatim}

Et pour g√©rer le d√©marrage ou l‚Äôarr√™t, on peut passer par les commandes suivantes:


\begin{verbatim}
pass:[$$]$ supervisorctl stop gwift
gwift: stopped
root@ks3353535:/etc/supervisor/conf.d# supervisorctl start gwift
gwift: started
root@ks3353535:/etc/supervisor/conf.d# supervisorctl restart gwift
gwift: stopped
gwift: started
\end{verbatim}

\hypertarget{x-ouverture-des-ports}{\subsection{Ouverture des ports}}
\begin{verbatim}
et 443 (HTTPS).
\end{verbatim}

\begin{verbatim}
firewall-cmd --permanent --zone=public --add-service=http 
firewall-cmd --permanent --zone=public --add-service=https 
firewall-cmd --reload
\end{verbatim}


\hypertarget{x-installation-d‚Äônginx}{\subsection{Installation d‚ÄôNginx}}
\begin{verbatim}
yum install nginx -y
usermod -a -G gunicorn_sockets nginx
\end{verbatim}

On configure ensuite le fichier \texttt{/etc/nginx/conf.d/gwift.conf}:


\begin{verbatim}
upstream gwift_app {
        server unix:/var/run/webapps/gunicorn_gwift.sock fail_timeout=0;
}

server {
        listen 80;
        server_name <server_name>;
        root /var/www/gwift;
        error_log /var/log/nginx/gwift_error.log;
        access_log /var/log/nginx/gwift_access.log;

        client_max_body_size 4G;
        keepalive_timeout 5;

        gzip on;
        gzip_comp_level 7;
        gzip_proxied any;
        gzip_types gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;


        location /static/ { 
                access_log off;
                expires 30d;
                add_header Pragma public;
                add_header Cache-Control "public";
                add_header Vary "Accept-Encoding";
                try_files pass:[$uri $]uri/ =404;
        }

        location / {
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
                proxy_set_header Host $http_host;
                proxy_redirect off;

                proxy_pass http://gwift_app;
        }
}
\end{verbatim}


\hypertarget{x-mise-√†-jour}{\subsection{Mise √† jour}}
Script de mise √† jour.


\begin{verbatim}
su - <user>
source ~/.venvs/<app>/bin/activate
cd ~/webapps/<app>
git fetch
git checkout vX.Y.Z
pip install -U requirements/prod.txt
python manage.py migrate
python manage.py collectstatic
kill -HUP `ps -C gunicorn fch -o pid | head -n 1` 
\end{verbatim}


\hypertarget{x-configuration-des-sauvegardes}{\subsection{Configuration des sauvegardes}}
Les sauvegardes ont √©t√© configur√©es avec borg: \texttt{yum install borgbackup}.


C‚Äôest l‚Äôutilisateur gwift qui s‚Äôen occupe.


\begin{verbatim}
mkdir -p /home/gwift/borg-backups/
cd /home/gwift/borg-backups/
borg init gwift.borg -e=none
borg create gwift.borg::{now} ~/bin ~/webapps
\end{verbatim}

Et dans le fichier crontab :


\begin{verbatim}
0 23 * * * /home/gwift/bin/backup.sh
\end{verbatim}

\hypertarget{x-rotation-des-jounaux}{\subsection{Rotation des jounaux}}
\begin{verbatim}
/var/log/gwift/* {
        weekly
        rotate 3
        size 10M
        compress
        delaycompress
}
\end{verbatim}

Puis on d√©marre logrotate avec \# logrotate -d /etc/logrotate.d/gwift pour v√©rifier que cela fonctionne correctement.


\hypertarget{x-ansible}{\subsection{Ansible}}
TODO


\hypertarget{x-heroku}{\section{Heroku}}
\href{https://www.heroku.com}{Heroku} est une \emph{Plateform As A Service} \footnote{Aussi abr√©g√© "PaaS" pour les conaisseurs}, o√π vous choisissez le \emph{service} dont vous avez besoin (une base de donn√©es, un service de cache, un service applicatif, ‚Ä¶‚Äã), vous lui envoyer les param√®tres n√©cessaires et le tout d√©marre gentiment sans que vous ne deviez superviser l‚Äôh√¥te.
Ce mode d√©marrage ressemble √©norm√©ment aux 12 facteurs dont nous avons d√©j√† parl√© plus t√¥t - raison de plus pour que notre application soit directement pr√™te √† y √™tre d√©ploy√©e, d‚Äôautant plus qu‚Äôil ne sera pas possible de modifier un fichier une fois qu‚Äôelle aura d√©marr√©: si vous souhaitez modifier un param√®tre, cela reviendra √† couper l‚Äôactuelle et envoyer de nouveaux param√®tres et recommencer le d√©ploiement depuis le d√©but.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/deployment/heroku.png}
\caption{}

\end{figure}

Pour un projet de type "hobby" et pour l‚Äôexemple de d√©ploiement ci-dessous, il est tout √† fait possible de s‚Äôen sortir sans d√©penser un kopek, afin de tester nos quelques id√©es ou mettre rapidement un \emph{Most Valuable Product} en place. La seule contrainte consistera √† pouvoir h√©berger des fichiers envoy√©s par vos utilisateurs - ceci pourra √™tre fait en configurant un \emph{bucket S3} chez Amazon (beurk), Scaleway ou OVH \footnote{Entre autres.}


Le fonctionnement est relativement simple: pour chaque application, Heroku cr√©e un d√©p√¥t Git qui lui est associ√©. Au travers de la commande \texttt{heroku create}, vous associez en fait une nouvelle r√©f√©rence √† votre code source:


\begin{verbatim}
$ heroku create
Creating app... done, ‚¨¢ young-temple-86098
https://young-temple-86098.herokuapp.com/ | https://git.heroku.com/young-temple-86098.git

$ cat .git/config
[core]
        repositoryformatversion = 0
        filemode = false
        bare = false
        logallrefupdates = true
        symlinks = false
        ignorecase = true
[remote "heroku"]
        url = https://git.heroku.com/still-thicket-66406.git
        fetch = +refs/heads/*:refs/remotes/heroku/*
\end{verbatim}

Pour envoyer une nouvelle version, il suffit d√®s lors (apr√®s l‚Äôavoir param√©tr√©e), de pousser la r√©f√©rence gr√¢ce √† la commande \texttt{git push heroku master}.


Pr√™t √† vous lancer ? Commencez par cr√©er un compte: \href{https://signup.heroku.com/python}{https://signup.heroku.com/python}.


\hypertarget{x-configuration-du-compte-heroku}{\subsection{Configuration du compte Heroku}}
+ R√©cup√©ration des valeurs d‚Äôenvironnement pour les r√©utiliser ci-dessous.


Vous aurez peut-√™tre besoin d‚Äôun coup de pouce pour d√©marrer votre premi√®re application; heureusement, la documentation est super bien faite:


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/deployment/heroku-new-app.png}
\caption{}

\end{figure}

Installez ensuite la CLI (\emph{Command Line Interface}) en suivant \href{https://devcenter.heroku.com/articles/heroku-cli}{la documentation suivante}.


Au besoin, cette CLI existe pour:


\begin{enumerate}

\item{macOS, \emph{via} `brew `}

\item{Windows, gr√¢ce √† un \href{https://cli-assets.heroku.com/heroku-x64.exe}{binaire x64} (la version 32 bits existe aussi, mais il est peu probable que vous en ayez besoin)}

\item{GNU/Linux, via un script Shell \texttt{curl \href{https://cli-assets.heroku.com/install.sh}{https://cli-assets.heroku.com/install.sh} | sh} ou sur \href{https://snapcraft.io/heroku}{SnapCraft}.}

\end{enumerate}


Une fois install√©e, connectez-vous:


\begin{verbatim}
$ heroku login
\end{verbatim}

Et cr√©er votre application:


\begin{verbatim}
$ heroku create
Creating app... done, ‚¨¢ young-temple-86098
https://young-temple-86098.herokuapp.com/ | https://git.heroku.com/young-temple-86098.git
\end{verbatim}

\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/deployment/heroku-app-created.png}
\caption{}

\end{figure}

Ajoutons lui une base de donn√©es, que nous sauvegarderons √† intervalle r√©gulier:


\begin{verbatim}
$ heroku addons:create heroku-postgresql:hobby-dev
Creating heroku-postgresql:hobby-dev on ‚¨¢ still-thicket-66406... free
Database has been created and is available
 ! This database is empty. If upgrading, you can transfer
 ! data from another database with pg:copy
Created postgresql-clear-39693 as DATABASE_URL
Use heroku addons:docs heroku-postgresql to view documentation

$ heroku pg:backups schedule --at '14:00 Europe/Brussels' DATABASE_URL
Scheduling automatic daily backups of postgresql-clear-39693 at 14:00 Europe/Brussels... done
\end{verbatim}

TODO: voir comment r√©cup√©rer le backup de la db :-p


\begin{verbatim}
# Copi√©/coll√© de https://cookiecutter-django.readthedocs.io/en/latest/deployment-on-heroku.html
heroku create --buildpack https://github.com/heroku/heroku-buildpack-python

heroku addons:create heroku-redis:hobby-dev

heroku addons:create mailgun:starter

heroku config:set PYTHONHASHSEED=random

heroku config:set WEB_CONCURRENCY=4

heroku config:set DJANGO_DEBUG=False
heroku config:set DJANGO_SETTINGS_MODULE=config.settings.production
heroku config:set DJANGO_SECRET_KEY="$(openssl rand -base64 64)"

# Generating a 32 character-long random string without any of the visually similar characters "IOl01":
heroku config:set DJANGO_ADMIN_URL="$(openssl rand -base64 4096 | tr -dc 'A-HJ-NP-Za-km-z2-9' | head -c 32)/"

# Set this to your Heroku app url, e.g. 'bionic-beaver-28392.herokuapp.com'
heroku config:set DJANGO_ALLOWED_HOSTS=

# Assign with AWS_ACCESS_KEY_ID
heroku config:set DJANGO_AWS_ACCESS_KEY_ID=

# Assign with AWS_SECRET_ACCESS_KEY
heroku config:set DJANGO_AWS_SECRET_ACCESS_KEY=

# Assign with AWS_STORAGE_BUCKET_NAME
heroku config:set DJANGO_AWS_STORAGE_BUCKET_NAME=

git push heroku master

heroku run python manage.py createsuperuser

heroku run python manage.py check --deploy

heroku open
\end{verbatim}

\hypertarget{x-docker-compose}{\section{Docker-Compose}}
(c/c Ced' - 2020-01-24)


√áa y est, j‚Äôai fait un test sur mon portable avec docker et cookiecutter pour django.


D‚Äôabords, apr√®s avoir installer docker-compose et les d√©pendances sous debian, tu dois t‚Äôajouter dans le groupe docker, sinon il faut √™tre root pour utiliser docker.
Ensuite, j‚Äôai relanc√© mon pc car juste relanc√© un shell n‚Äôa pas suffit pour que je puisse utiliser docker avec mon compte.


Bon apr√®s c‚Äôest facile, un petit virtualenv pour cookiecutter, suivit d‚Äôune installation du template django.
Et puis j‚Äôai suivi sans t \href{https://cookiecutter-django.readthedocs.io/en/latest/developing-locally-docker.html}{https://cookiecutter-django.readthedocs.io/en/latest/developing-locally-docker.html}


Alors, il t√©l√©charge les images, fait un petit update, installe les d√©pendances de dev, install les requirement pip ‚Ä¶‚Äã


Du coup, √ßa prend vite de la place:
image.png


L‚Äôimage de base python passe de 179 √† 740 MB. Et l√† j‚Äôen ai pour presque 1,5 GB d‚Äôun coup.


Mais par contre, j‚Äôai un python 3.7 direct et postgres 10 sans rien faire ou presque.


La partie ci-dessous a √©t√© reprise telle quelle de \href{https://cookiecutter-django.readthedocs.io/en/latest/deployment-with-docker.html}{la documentation de cookie-cutter-django}.


\admonition{WARNING}{le serveur de d√©ploiement ne doit avoir qu‚Äôun acc√®s en lecture au d√©p√¥t source.}
On peut aussi passer par fabric, ansible, chef ou puppet.


\hypertarget{x-supervision}{\chapter{Supervision}}
Qu‚Äôest-ce qu‚Äôon fait des logs apr√®s ? :-)


\begin{enumerate}

\item{Sentry via sentry\_sdk}

\item{Nagios}

\item{LibreNMS}

\item{Zabbix}

\end{enumerate}


Il existe √©galement \href{https://munin-monitoring.org}{Munin}, \href{https://www.elastic.co}{Logstash, ElasticSearch et Kibana (ELK-Stack)} ou \href{https://www.fluentd.org}{Fluentd}.


\hypertarget{x-autres-outils}{\chapter{Autres outils}}
Voir aussi devpi, circus, uswgi, statsd.


See \href{https://mattsegal.dev/nginx-django-reverse-proxy-config.html}{https://mattsegal.dev/nginx-django-reverse-proxy-config.html}


\hypertarget{x-ressources}{\chapter{Ressources}}
\begin{itemize}

\item \href{https://zestedesavoir.com/tutoriels/2213/deployer-une-application-django-en-production/}{https://zestedesavoir.com/tutoriels/2213/deployer-une-application-django-en-production/}

\item \href{https://docs.djangoproject.com/fr/3.0/howto/deployment/}{D√©ploiement}.

\item Let‚Äôs Encrypt !

\end{itemize}


\hypertarget{x-django}{\part*{Django}}
Dans ce chapitre, on va parler de plusieurs concepts utiles au d√©veloppement rapide d‚Äôune application. On parlera de mod√©lisation, de migrations, d‚Äôadministration auto-g√©n√©r√©e. C‚Äôest un framework Web proposant une tr√®s bonne int√©gration des composants, et une flexibilit√© bien pens√©e: chacun des composants permet de d√©finir son contenu de mani√®re pouss√©e, en respectant des contraintes logiques et faciles √† retenir.


En restant dans les sentiers battus, votre projet suivra le patron de conception \texttt{MVC} (Mod√®le-Vue-Controleur), avec une petite variante sur les termes utilis√©s: Django les nomme respectivement Mod√®le-Template-Vue:


Dans un \textbf{pattern} MVC classique, la traduction imm√©diate du \textbf{contr√¥leur} est une \textbf{vue}. Et comme on le verra par la suite, la \textbf{vue} est en fait le \textbf{template}.


\begin{itemize}

\item Le mod√®le (\texttt{models.py}) fait le lien avec la base de donn√©es et permet de d√©finir les champs et leur type √† associer √† une table. \emph{Grosso modo}*, une table SQL correspondra √† une classe d‚Äôun mod√®le Django.

\item La vue (\texttt{views.py}), qui joue le r√¥le de contr√¥leur: \emph{a priori}, tous les traitements, la r√©cup√©ration des donn√©es, etc. doit passer par ce composant et ne doit (pratiquement) pas √™tre g√©n√©r√© √† la vol√©e, directement √† l‚Äôaffichage d‚Äôune page. En d‚Äôautres mots, la vue sert de pont entre les donn√©es g√©r√©es par la base et l‚Äôinterface utilisateur.

\item Le template, qui s‚Äôoccupe de la mise en forme: c‚Äôest le composant qui va s‚Äôoccuper de transformer les donn√©es en un affichage compr√©hensible (avec l‚Äôaide du navigateur) pour l‚Äôutilisateur.

\end{itemize}


Pour reprendre une partie du sch√©ma pr√©c√©dent, on a une requ√™te qui est √©mise par un utilisateur. La premi√®re √©tape consiste √† trouver une route qui correspond √† cette requ√™te, c‚Äôest √† dire √† trouver la correspondance entre l‚ÄôURL demand√©e et la fonction qui sera ex√©cut√©e. Cette fonction correspond au \textbf{contr√¥leur} et s‚Äôoccupera de construire le \textbf{mod√®le} correspondant.


En simplifiant, Django suit bien le mod√®le MVC, et toutes ces √©tapes sont li√©es ensemble gr√¢ce aux diff√©rentes routes, d√©finies dans les fichiers \texttt{urls.py}.


\hypertarget{x-mod√©lisation}{\chapter{Mod√©lisation}}
Nous allons aborder la mod√©lisation des objets en elle-m√™me, qui est en lien direct avec la conception de la base de donn√©es et la mani√®re dont celles-ci s‚Äôagencent et communiquent entre elles.


Django utilise un paradigme de type \href{https://fr.wikipedia.org/wiki/Mapping_objet-relationnel}{ORM} - c‚Äôest-√†-dire que chaque type d‚Äôobjet peut s‚Äôapparenter √† une table SQL, mais en ajoutant une couche propre au mod√®le orient√© objet.
Il est ainsi possible de d√©finir facilement des notions d‚Äôh√©ritage (tout en restant dans une forme d‚Äôh√©ritage simple), la possibilit√© d‚Äôutiliser des propri√©t√©s sp√©cifiques, des classes interm√©diaires, ‚Ä¶‚Äã


L‚Äôavantage de tout ceci est que tout reste au niveau du code.
Si l‚Äôon revient sur la m√©thodologie des douze facteurs, ce point concerne principalement la minimisation de la divergence entre les environnements d‚Äôex√©cution.
D√©ployer une nouvelle instance de l‚Äôapplication pourra √™tre r√©alis√© directement √† partir d‚Äôune seule et m√™me commande, dans la mesure o√π \textbf{tout est embarqu√© au niveau du code}.


Assez de blabla, on d√©marre !


\hypertarget{x-mod√©lisation-de-base}{\section{Mod√©lisation de base}}
\hypertarget{x-types-de-champs}{\subsection{Types de champs}}

\hypertarget{x-cl√©s-√©trang√®res-et-relations}{\subsection{Cl√©s √©trang√®res et relations}}
\begin{enumerate}

\item{ForeignKey}

\item{ManyToManyField}

\item{OneToOneField}

\end{enumerate}


Dans les examples ci-dessus, nous avons vu les relations multiples (1-N), repr√©sent√©es par des cl√©s √©trang√®res (\textbf{ForeignKey}) d‚Äôune classe A vers une classe B.
Pour repr√©senter d‚Äôautres types de relations, il existe √©galement les champs de type \textbf{ManyToManyField}, afin de repr√©senter une relation N-N. Les champs de type \textbf{OneToOneField}, pour repr√©senter une relation 1-1.


Dans notre mod√®le ci-dessus, nous n‚Äôavons jusqu‚Äô√† pr√©sent eu besoin que des relations 1-N:


\begin{enumerate}

\item{La premi√®re entre les listes de souhaits et les souhaits;}

\item{La seconde entre les souhaits et les parts.}

\end{enumerate}


\begin{verbatim}
# wish/models.py

class Wishlist(models.Model):
    pass


class Item(models.Model):
    wishlist = models.ForeignKey(Wishlist)
\end{verbatim}

Depuis le code, √† partir de l‚Äôinstance de la classe \texttt{Item}, on peut donc acc√©der √† la liste en appelant la propri√©t√© \texttt{wishlist} de notre instance. \textbf{A contrario}, depuis une instance de type \texttt{Wishlist}, on peut acc√©der √† tous les √©l√©ments li√©s gr√¢ce √† \texttt{<nom de la propri√©t√©>\_set}; ici \texttt{item\_set}.


Lorsque vous d√©clarez une relation 1-1, 1-N ou N-N entre deux classes, vous pouvez ajouter l‚Äôattribut \texttt{related\_name} afin de nommer la relation inverse.


\begin{verbatim}
# wish/models.py

class Wishlist(models.Model):
    pass


class Item(models.Model):
    wishlist = models.ForeignKey(Wishlist, related_name='items')
\end{verbatim}

Si, dans une classe A, plusieurs relations sont li√©es √† une classe B, Django ne saura pas √† quoi correspondra la relation inverse. Pour palier √† ce probl√®me, nous fixons une valeur √† l‚Äôattribut \texttt{related\_name}. Par facilit√© (et pas conventions), prenez l‚Äôhabitude de toujours ajouter cet attribut. Votre mod√®le gagnera en coh√©rence et en lisibilit√©.

A partir de maintenant, nous pouvons acc√©der √† nos propri√©t√©s de la mani√®re suivante:


\begin{verbatim}
# python manage.py shell

>>> from wish.models import Wishlist, Item
>>> wishlist = Wishlist.create('Liste de test', 'description')
>>> item = Item.create('Element de test', 'description', w)
>>>
>>> item.wishlist
<Wishlist: Wishlist object>
>>>
>>> wishlist.items.all()
[<Item: Item object>]
\end{verbatim}

\hypertarget{x-metamod√®le}{\subsection{Metamod√®le}}
Quand on prend une classe (par exemple, \texttt{Wishlist} que l‚Äôon a d√©fini ci-dessus), on voit qu‚Äôelle h√©rite par d√©faut de \texttt{models.Model}. On peut regarder les propri√©t√©s d√©finies dans cette classe en analysant le fichier \texttt{lib\\site-packages\\django\\models\\base.py}. On y voit notamment que \texttt{models.Model} h√©rite de \texttt{ModelBase} au travers de \href{https://pypi.python.org/pypi/six}{six} pour la r√©trocompatibilit√© vers Python 2.7.


Cet h√©ritage apporte notamment les fonctions \texttt{save()}, \texttt{clean()}, \texttt{delete()}, ‚Ä¶‚Äã Bref, toutes les m√©thodes qui font qu‚Äôune instance est sait \textbf{comment} interagir avec la base de donn√©es. La base d‚Äôun \href{https://en.wikipedia.org/wiki/Object-relational_mapping}{ORM}, en fait.


D‚Äôautre part, chaque classe h√©ritant de \texttt{models.Model} poss√®de une propri√©t√© \texttt{objects}. Comme on l‚Äôa vu dans la section \textbf{Jouons un peu avec la console}, cette propri√©t√© permet d‚Äôacc√©der aux objects persistants dans la base de donn√©es, au travers d‚Äôun \texttt{ModelManager}.


En plus de cela, il faut bien tenir compte des propri√©t√©s \texttt{Meta} de la classe: si elle contient d√©j√† un ordre par d√©faut, celui-ci sera pris en compte pour l‚Äôensemble des requ√™tes effectu√©es sur cette classe.


\begin{verbatim}
class Wish(models.Model):
    name = models.CharField(max_length=255)

    class Meta:
        ordering = ('name',) 
\end{verbatim}


Pour s√©lectionner un objet au pif : \texttt{return Category.objects.order\_by("?").first()}


Les propri√©t√©s de la classe Meta les plus utiles sont les suivates:


\begin{itemize}

\item \texttt{ordering} pour sp√©cifier un ordre de r√©cup√©ration sp√©cifique.

\item \texttt{verbose\_name} pour indiquer le nom √† utiliser au singulier pour d√©finir votre classe

\item \texttt{verbose\_name\_plural}, pour le pluriel.

\item \texttt{contraints} (Voir \href{https://girlthatlovestocode.com/django-model}{ici}-), par exemple

\end{itemize}


\begin{verbatim}
    constraints = [ # constraints added
        models.CheckConstraint(check=models.Q(year_born__lte=datetime.date.today().year-18), name='will_be_of_age'),
    ]
\end{verbatim}

\hypertarget{x-choix}{\subsection{Choix}}
Voir \href{https://girlthatlovestocode.com/django-model}{ici}


\begin{verbatim}
class Runner(models.Model):

    # this is new:
    class Zone(models.IntegerChoices):
        ZONE_1 = 1, 'Less than 3.10'
        ZONE_2 = 2, 'Less than 3.25'
        ZONE_3 = 3, 'Less than 3.45'
        ZONE_4 = 4, 'Less than 4 hours'
        ZONE_5 = 5, 'More than 4 hours'

    name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    email = models.EmailField()
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    start_zone = models.PositiveSmallIntegerField(choices=Zone.choices, default=Zone.ZONE_5, help_text="What was your best time on the marathon in last 2 years?") # this is new
\end{verbatim}

\hypertarget{x-shell}{\subsection{Shell}}

\hypertarget{x-constructeurs}{\subsection{Constructeurs}}
Si vous d√©cidez de d√©finir un constructeur sur votre mod√®le, ne surchargez pas la m√©thode \texttt{\emph{init}}: cr√©ez plut√¥t une m√©thode static de type \texttt{create()}, en y associant les param√®tres obligatoires ou souhait√©s:


\begin{verbatim}
class Wishlist(models.Model):

    @staticmethod
    def create(name, description):
        w = Wishlist()
        w.name = name
        w.description = description
        w.save()
        return w

class Item(models.Model):

    @staticmethod
    def create(name, description, wishlist):
        i = Item()
        i.name = name
        i.description = description
        i.wishlist = wishlist
        i.save()
        return i
\end{verbatim}

Mieux encore: on pourrait passer par un \texttt{ModelManager} pour limiter le couplage; l‚Äôacc√®s √† une information stock√©e en base de donn√©es ne se ferait d√®s lors qu‚Äôau travers de cette instance et pas directement au travers du mod√®le. De cette mani√®re, on limite le couplage des classes et on centralise l‚Äôacc√®s.


\begin{verbatim}
class ItemManager(...):
    (de m√©moire, je ne sais plus exactement :-))
\end{verbatim}

\hypertarget{x-migrations}{\chapter{Migrations}}
Dans cette section, nous allons voir comment les migrations fonctionnent.
Dans une premi√®re version, elles peuvent sembler un peu magiques, dans la mesure o√π elles appliquent des modifications au niveau du sch√©ma de donn√©es en se basant uniquement sur des modifications effectu√©es sur le mod√®le.


Pour repartir de notre exemple ci-dessus, nous avions un mod√®le reprenant quelques classes, et saupoudr√©es de propri√©t√©s.
Pour sch√©matiser, chaque classe correspond √† une table dans la base de donn√©es, tandis que que chaque propri√©t√© correspond √† un champ de cette table.


Une migration consiste donc √† appliquer un ensemble de modifications, qui exercent un ensemble de transformations, pour que le sch√©ma de base de donn√©es corresponde au mod√®le de l‚Äôapplication.


Les migrations (comprendre les "\emph{migrations du sch√©ma de base de donn√©es}") sont intimement li√©es √† la repr√©sentation d‚Äôun contexte fonctionnel. L‚Äôajout d‚Äôune nouvelle information, d‚Äôun nouveau champ ou d‚Äôune nouvelle fonction peut s‚Äôaccompagner de tables de donn√©es √† mettre √† jour ou de champs √† √©tendre.


Toujours dans une optique de centralisation, les migrations sont directement embarqu√©es au niveau du code. Le d√©veloppeur s‚Äôoccupe de cr√©er les migrations en fonction des actions √† entreprendre; ces migrations peuvent √™tre retravaill√©es, \emph{squash√©es}, ‚Ä¶‚Äã et feront partie int√©grante du processus de mise √† jour de l‚Äôapplication.


A noter que les migrations n‚Äôappliqueront de modifications que si le sch√©ma est impact√©. Ajouter une propri√©t√© \texttt{related\_name} sur une ForeignKey n‚Äôengendrera aucune nouvelle action de migration, puisque ce type d‚Äôaction ne s‚Äôapplique que sur l‚ÄôORM, et pas directement sur la base de donn√©es: au niveau des tables, rien ne change. Seul le code et le mod√®le sont impact√©s.


\href{https://simpleisbetterthancomplex.com/tutorial/2016/07/26/how-to-reset-migrations.html}{reset migrations}.


\begin{quotation}
\begin{verbatim}
En gros, soit on supprime toutes les migrations (en conservant le fichier __init__.py), soit on r√©initialise proprement les migrations avec un --fake-initial (sous r√©serve que toutes les personnes qui utilisent d√©j√† le projet s'y conforment... Ce qui n'est pas gagn√©.
Pour repartir de notre exemple ci-dessus, nous avions un mod√®le reprenant quelques classes, saupoudr√©es de propri√©t√©s d√©crivant nos diff√©rents champs. Pour √™tre prise en compte par le moteur de base de donn√©es, chaque modification doit √™tre
\end{verbatim}
\end{quotation}

\begin{enumerate}

\item{D√©crite, gr√¢ce √† la commande \texttt{makemigrations}}

\item{Appliqu√©e, avec la commande \texttt{migrate}.}

\end{enumerate}


\hypertarget{x-description-d‚Äôune-migration}{\section{Description d‚Äôune migration}}

\hypertarget{x-application-d‚Äôune-ou-plusieurs-migrations}{\section{Application d‚Äôune ou plusieurs migrations}}

\hypertarget{x-analyse}{\section{Analyse}}
Nous allons ci-dessous analyser exactement les modifications appliqu√©es au sch√©ma de la base de donn√©es, en fonction des diff√©rents cas, et comment ils sont g√©r√©s par les pilotes de Django.
Nous utiliserons \href{https://sqlitebrowser.org/}{Sqlite Browser} et la commande \texttt{sqldump}, qui nous pr√©sentera le sch√©ma tel qu‚Äôil sera compris


\hypertarget{x-cr√©ation-de-nouveaux-champs}{\subsection{Cr√©ation de nouveaux champs}}

\hypertarget{x-modification-d‚Äôun-champ-existant}{\subsection{Modification d‚Äôun champ existant}}

\hypertarget{x-suppression-d‚Äôun-champ-existant}{\subsection{Suppression d‚Äôun champ existant}}

\hypertarget{x-shell}{\chapter{Shell}}

\hypertarget{x-administration}{\chapter{Administration}}
Wok√©. On va commencer par la \textbf{partie √† ne \emph{surtout} (\emph{surtout} !!) pas faire en premier dans un projet Django}.
Mais on va la faire quand m√™me: la raison principale est que cette partie est tellement puissante et performante, qu‚Äôelle pourrait laisser penser qu‚Äôil est possible de r√©aliser une application compl√®te rien qu‚Äôen configurant l‚Äôadministration.
Mais c‚Äôest faux.


L‚Äôadministration est une sorte de tour de contr√¥le √©volu√©e, un \emph{back office} sans transpirer; elle se base sur le mod√®le de donn√©es programm√© et construit dynamiquement les formulaires qui lui est associ√©.
Elle joue avec les cl√©s primaires, √©trang√®res, les champs et types de champs par \href{https://fr.wikipedia.org/wiki/Introspection}{introspection}, et pr√©sente tout ce qu‚Äôil faut pour avoir du \href{https://fr.wikipedia.org/wiki/CRUD}{CRUD}, c‚Äôest-√†-dire tout ce qu‚Äôil faut pour ajouter, lister, modifier ou supprimer des informations.


Son probl√®me est qu‚Äôelle pr√©sente une courbe d‚Äôapprentissage asymptotique.
Il est \textbf{tr√®s} facile d‚Äôarriver rapidement √† un bon r√©sultat, au travers d‚Äôun p√©rim√®tre de configuration relativement restreint.
Mais quoi que vous fassiez, il y a un moment o√π la courbe de param√©trage sera tellement ardue que vous aurez plus facile √† d√©velopper ce que vous souhaitez ajouter en utilisant les autres concepts de Django.


Cette fonctionnalit√© doit rester dans les mains d‚Äôadministrateurs ou de gestionnaires, et dans leurs mains √† eux uniquement: il n‚Äôest pas question de donner des droits aux utilisateurs finaux (m√™me si c‚Äôest extr√™ment tentant durant les premiers tours de roues).
Ind√©pendamment de la mani√®re dont vous allez l‚Äôutiliser et la configurer, vous finirez par devoir d√©velopper une "vraie" application, destin√©e aux utilisateurs classiques, et r√©pondant √† leurs besoins uniquement.


Une bonne id√©e consiste √† d√©velopper l‚Äôadministration dans un premier temps, en \textbf{gardant en t√™te qu‚Äôil sera n√©cessaire de d√©velopper des concepts sp√©cifiques}.
Dans cet objectif, l‚Äôadministration est un outil exceptionel, qui permet de valider un mod√®le, de cr√©er des objets rapidement et de valider les liens qui existent entre eux.


C‚Äôest aussi un excellent outil de prototypage et de preuve de concept.


Elle se base sur plusieurs couches que l‚Äôon a d√©j√† (ou on va bient√¥t) aborder (suivant le sens de lecture que vous pr√©f√©rez):


\begin{enumerate}

\item{Le mod√®le de donn√©es}

\item{Les validateurs}

\item{Les formulaires}

\item{Les widgets}

\end{enumerate}


\hypertarget{x-le-mod√®le-de-donn√©es}{\section{Le mod√®le de donn√©es}}
Comme expliqu√© ci-dessus, le mod√®le de donn√©es est constit√© d‚Äôun ensemble de champs typ√©s et de relations.
L‚Äôadministration permet de d√©crire les donn√©es qui peuvent √™tre modifi√©es, en y associant un ensemble (basique) de permissions.


Si vous vous rappelez de l‚Äôapplication que nous avions cr√©√©e dans la premi√®re partie, les URLs reprenaient d√©j√† la partie suivante:


\begin{verbatim}
from django.contrib import admin
from django.urls import path

from gwift.views import wish_details

urlpatterns = [
    path('admin/', admin.site.urls), 
    [...]
]
\end{verbatim}


C‚Äôest le seul pr√©requis pour cette partie.


Chaque application nouvellement cr√©√©e contient par d√©faut un fichier \texttt{admin.py}, dans lequel il est possible de d√©clarer quel ensemble de donn√©es sera accessible/√©ditable.
Ainsi, si nous partons du mod√®le basique que nous avions d√©taill√© plus t√¥t, avec des souhaits et des listes de souhaits:


\begin{verbatim}
# gwift/wish/models.py

from django.db import models


class WishList(models.Model):
    name = models.CharField(max_length=255)


class Item(models.Model):
    name = models.CharField(max_length=255)
    wishlist = models.ForeignKey(WishList, on_delete=models.CASCADE)
\end{verbatim}

Nous pouvons facilement arriver au r√©sultat suivant, en ajoutant quelques lignes de configuration dans ce fichier \texttt{admin.py}:


\begin{verbatim}
from django.contrib import admin

from .models import Item, WishList 


admin.site.register(Item) 
admin.site.register(WishList)
\end{verbatim}


Il nous reste une seule √©tape √† r√©aliser: cr√©er un nouvel utilisateur.
Pour cet exemple, notre gestion va se limiter √† une gestion manuelle; nous aurons donc besoin d‚Äôun \emph{super-utilisateur}, que nous pouvons cr√©er gr√¢ce √† la commande \texttt{python manage.py createsuperuser}.


\begin{verbatim}
Œª python manage.py createsuperuser
Username (leave blank to use 'fred'): fred
Email address: fred@root.org
Password: ******
Password (again): ******
Superuser created successfully.
\end{verbatim}

\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-site-admin.png}
\caption{}
\centering
\end{figure}

\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-site-admin-after-connection.png}
\caption{}
\centering
\end{figure}

\hypertarget{x-quelques-conseils-de-base}{\section{Quelques conseils de base}}
\begin{enumerate}

\item{Surchargez la m√©thode \texttt{\emph{str}(self)} pour chaque classe que vous aurez d√©finie dans le mod√®le. Cela permettra de construire une repr√©sentation textuelle pour chaque instance de votre classe. Cette information sera utilis√©e un peu partout dans le code, et donnera une meilleure id√©e de ce que l‚Äôon manipule. En plus, cette m√©thode est √©galement appel√©e lorsque l‚Äôadministration historisera une action (et comme cette √©tape sera inalt√©rable, autant qu‚Äôelle soit fix√©e dans le d√©but).}

\item{La m√©thode \texttt{get\_absolute\_url(self)} retourne l‚ÄôURL √† laquelle on peut acc√©der pour obtenir les d√©tails d‚Äôune instance. Par exemple:}

\end{enumerate}


\begin{verbatim}
def get_absolute_url(self):
    return reverse('myapp.views.details', args=[self.id])
\end{verbatim}

\begin{enumerate}

\item{Les attributs \texttt{Meta}:}

\end{enumerate}


\begin{verbatim}
class Meta:
	ordering = ['-field1', 'field2']
	verbose_name = 'my class in singular'
	verbose_name_plural = 'my class when is in a list!'
\end{verbatim}

\begin{enumerate}

\item{Le titre:}

\begin{itemize}

\item Soit en modifiant le template de l‚Äôadministration

\item Soit en ajoutant l‚Äôassignation suivante dans le fichier \texttt{urls.py}: \texttt{admin.site.site\_header \= \"SuperBook Secret Area}.

\end{itemize}

\item{Prefetch}

\end{enumerate}


\href{https://hackernoon.com/all-you-need-to-know-about-prefetching-in-django-f9068ebe1e60?gi=7da7b9d3ad64}{https://hackernoon.com/all-you-need-to-know-about-prefetching-in-django-f9068ebe1e60?gi=7da7b9d3ad64}


\href{https://medium.com/hakibenita/things-you-must-know-about-django-admin-as-your-app-gets-bigger-6be0b0ee9614}{https://medium.com/hakibenita/things-you-must-know-about-django-admin-as-your-app-gets-bigger-6be0b0ee9614}


En gros, le probl√®me de l‚Äôadmin est que si on fait des requ√™tes imbriqu√©es, on va flinguer l‚Äôapplication et le chargement de la page.
La solution consiste √† utiliser la propri√©t√© \texttt{list\_select\_related} de la classe d‚ÄôAdmin, afin d‚Äôappliquer une jointure par d√©faut et
et gagner en performances.


\hypertarget{x-admin.modeladmin}{\section{admin.ModelAdmin}}
La classe \texttt{admin.ModelAdmin} que l‚Äôon retrouvera principalement dans le fichier \texttt{admin.py} de chaque application contiendra la d√©finition de ce que l‚Äôon souhaite faire avec nos donn√©es dans l‚Äôadministration. Cette classe (et sa partie Meta)


\hypertarget{x-l‚Äôaffichage}{\section{L‚Äôaffichage}}
Comme l‚Äôinterface d‚Äôadministration fonctionne (en tr√®√®√®√®s) gros comme un CRUD auto-g√©n√©r√©, on trouve par d√©faut la possibilit√© de :


\begin{enumerate}

\item{Cr√©er de nouveaux √©l√©ments}

\item{Lister les √©l√©ments existants}

\item{Modifier des √©l√©ments existants}

\item{Supprimer un √©l√©ment en particulier.}

\end{enumerate}


Les affichages sont donc de deux types: en liste et par √©l√©ment.


Pour les affichages en liste, le plus simple consiste √† jouer sur la propri√©t√© \texttt{list\_display}.


Par d√©faut, la premi√®re colonne va accueillir le lien vers le formulaire d‚Äô√©dition.
On peut donc modifier ceci, voire cr√©er de nouveaux liens vers d‚Äôautres √©l√©ments en construisant des URLs dynamiquement.


(Ins√©rer ici l‚Äôexemple de Medplan pour les liens vers les postgradu√©s :-))


Voir aussi comment personnaliser le fil d‚ÄôAriane ?


\hypertarget{x-les-filtres}{\section{Les filtres}}
\begin{enumerate}

\item{list\_filter}

\item{filter\_horizontal}

\item{filter\_vertical}

\item{date\_hierarchy}

\end{enumerate}


\hypertarget{x-les-permissions}{\section{Les permissions}}
On l‚Äôa dit plus haut, il vaut mieux √©viter de proposer un acc√®s √† l‚Äôadministration √† vos utilisateurs.
Il est cependant possible de configurer des permissions sp√©cifiques pour certains groupes, en leur autorisant certaines actions de visualisation/ajout/√©dition ou suppression.


Cela se joue au niveau du \texttt{ModelAdmin}, en impl√©mentant les m√©thodes suivantes:


\begin{verbatim}
def has_add_permission(self, request):
	return True

def has_delete_permission(self, request):
	return True

def has_change_permission(self, request):
	return True
\end{verbatim}

On peut acc√©der aux informations de l‚Äôutilisateur actuellement connect√© au travers de l‚Äôobjet \texttt{request.user}.


\begin{enumerate}

\item{NOTE: ajouter un ou deux screenshots :-)}

\end{enumerate}


\hypertarget{x-les-relations}{\section{Les relations}}
\hypertarget{x-les-relations-1-n}{\subsection{Les relations 1-n}}
Les relations 1-n sont impl√©ment√©es au travers de formsets (que l‚Äôon a normalement d√©j√† d√©crits plus haut). L‚Äôadministration permet de les d√©finir d‚Äôune mani√®re extr√™mement simple, gr√¢ce √† quelques propri√©t√©s.


L‚Äôimpl√©mentation consiste tout d‚Äôabord √† d√©finir le comportement du type d‚Äôobjet r√©f√©renc√© (la relation -N), puis √† inclure cette d√©finition au niveau du type d‚Äôobjet r√©f√©ren√ßant (la relation 1-).


\begin{verbatim}
class WishInline(TabularInline):
	model = Wish


class Wishlist(admin.ModelAdmin):
	...
	inlines = [WishInline]
	...
\end{verbatim}

Et voil√† : l‚Äôadministration d‚Äôune liste de souhaits (\emph{Wishlist}) pourra directement g√©rer des relations multiples vers des souhaits.


\hypertarget{x-les-auto-suggestions-et-auto-compl√©tions}{\subsection{Les auto-suggestions et auto-compl√©tions}}
Parler de l‚Äôint√©gration de select2.


\hypertarget{x-la-pr√©sentation}{\section{La pr√©sentation}}
Parler ici des \texttt{fieldsets} et montrer comment on peut regrouper des champs dans des groupes, ajouter un peu de javascript, ‚Ä¶‚Äã


\hypertarget{x-les-actions-sur-des-s√©lections}{\section{Les actions sur des s√©lections}}
Les actions permettent de partir d‚Äôune liste d‚Äô√©l√©ments, et autorisent un utilisateur √† appliquer une action sur une s√©lection d‚Äô√©l√©ments. Par d√©faut, il existe d√©j√† une action de \textbf{suppression}.


Les param√®tres d‚Äôentr√©e sont :


\begin{enumerate}

\item{L‚Äôinstance de classe}

\item{La requ√™te entrante}

\item{Le queryset correspondant √† la s√©lection.}

\end{enumerate}


\begin{verbatim}
def double_quantity(self, request, queryset):
	for obj in queryset.all():
		obj.field += 1
		obj.save()
double_quantity.short_description = "Doubler la quantit√© des souhaits."
\end{verbatim}

Et pour informer l‚Äôutilisateur de ce qui a √©t√© r√©alis√©, on peut aussi lui passer un petit message:


\begin{verbatim}
if rows_updated = 0:
	self.message_user(request, "Aucun √©l√©ment n'a √©t√© impact√©.")
else:
	self.message_user(request, "{} √©l√©ment(s) mis √† jour".format(rows_updated))
\end{verbatim}

\hypertarget{x-forms}{\chapter{Forms}}
Ou comment valider proprement des donn√©es entrantes.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/xkcd-327.png}


\end{figure}

Quand on parle de \texttt{forms}, on ne parle pas uniquement de formulaires Web. On pourrait consid√©rer qu‚Äôil s‚Äôagit de leur objectif principal, mais on peut √©galement voir un peu plus loin: on peut en fait voir les \texttt{forms} comme le point d‚Äôentr√©e pour chaque donn√©e arrivant dans notre application: il s‚Äôagit en quelque sorte d‚Äôun ensemble de r√®gles compl√©mentaires √† celles d√©j√† pr√©sentes au niveau du mod√®le.


L‚Äôexemple le plus simple est un fichier \texttt{.csv}: la lecture de ce fichier pourrait se faire de mani√®re tr√®s simple, en r√©cup√©rant les valeurs de chaque colonne et en l‚Äôintroduisant dans une instance du mod√®le.


Mauvaise id√©e. On peut proposer trois versions d‚Äôun m√™me code, de la version simple (lecture du fichier csv et jonglage avec les indices de colonnes), puis une version plus sophistiqu√©e (et plus lisible, √† base de \href{https://docs.python.org/3/library/csv.html#csv.DictReader}{DictReader}), et la version + √† base de form.


Les donn√©es fournies par un utilisateur \textbf{doivent} \textbf{toujours} √™tre valid√©es avant introduction dans la base de donn√©es. Notre base de donn√©es √©tant accessible ici par l‚ÄôORM, la solution consiste √† introduire une couche suppl√©mentaire de validation.


Le flux √† suivre est le suivant:


\begin{enumerate}

\item{Cr√©ation d‚Äôune instance gr√¢ce √† un dictionnaire}

\item{Validation des donn√©es et des informations re√ßues}

\item{Traitement, si la validation a r√©ussi.}

\end{enumerate}


Ils jouent √©galement deux r√¥les importants:


\begin{enumerate}

\item{Valider des donn√©es, en plus de celles d√©j√† d√©finies au niveau du mod√®le}

\item{Contr√¥ler le rendu √† appliquer aux champs.}

\end{enumerate}


Ils agissent come une glue entre l‚Äôutilisateur et la mod√©lisation de vos structures de donn√©es.


\hypertarget{x-flux-de-validation}{\section{Flux de validation}}
| .Validation
| .is\_valid
| .clean\_fields
‚Üì .clean\_fields\_machin


\admonition{NOTE}{A compl√©ter ;-)}
\hypertarget{x-d√©pendance-avec-le-mod√®le}{\section{D√©pendance avec le mod√®le}}
Un \textbf{form} peut d√©pendre d‚Äôune autre classe Django. Pour cela, il suffit de fixer l‚Äôattribut \texttt{model} au niveau de la \texttt{class Meta} dans la d√©finition.


\begin{verbatim}
from django import forms

from wish.models import Wishlist

class WishlistCreateForm(forms.ModelForm):
    class Meta:
        model = Wishlist
        fields = ('name', 'description')
\end{verbatim}

De cette mani√®re, notre form d√©pendra automatiquement des champs d√©j√† d√©clar√©s dans la classe \texttt{Wishlist}. Cela suit le principe de \texttt{DRY <don‚Äôt repeat yourself>`\_, et √©vite qu‚Äôune modification ne pourrisse le code: en testant les deux champs pr√©sent dans l‚Äôattribut fields}, nous pourrons nous assurer de faire √©voluer le formulaire en fonction du mod√®le sur lequel il se base.


\hypertarget{x-rendu-et-affichage}{\section{Rendu et affichage}}
Le formulaire permet √©galement de contr√¥ler le rendu qui sera appliqu√© lors de la g√©n√©ration de la page. Si les champs d√©pendent du mod√®le sur lequel se base le formulaire, ces widgets doivent √™tre initialis√©s dans l‚Äôattribut \texttt{Meta}. Sinon, ils peuvent l‚Äô√™tre directement au niveau du champ.


\begin{verbatim}
from datetime import date

from django import forms

from .models import Accident


class AccidentForm(forms.ModelForm):
    class Meta:
        model = Accident
        fields = ('gymnast', 'educative', 'date', 'information')
        widgets = {
            'date' : forms.TextInput(
                     attrs={
                        'class' : 'form-control',
                        'data-provide' : 'datepicker',
                        'data-date-format' : 'dd/mm/yyyy',
                        'placeholder' : date.today().strftime("%d/%m/%Y")
                     }),
            'information' : forms.Textarea(
                            attrs={
                                'class' : 'form-control',
                                'placeholder' : 'Context (why, where, ...)'
                            })
        }
\end{verbatim}

\hypertarget{x-squelette-par-d√©faut}{\section{Squelette par d√©faut}}
On a d‚Äôun c√¥t√© le form.as\_p, mais il y a beaucoup mieux que √ßa ;-) Voir les templates de Vitor et en passant par \texttt{widget-tweaks}.


\hypertarget{x-crispy-forms}{\section{Crispy-forms}}
Comme on l‚Äôa vu √† l‚Äôinstant, les forms, en Django, c‚Äôest le bien. Cela permet de valider des donn√©es re√ßues en entr√©e et d‚Äôafficher (tr√®s) facilement des formulaires √† compl√©ter par l‚Äôutilisateur.


Par contre, c‚Äôest lourd. D√®s qu‚Äôon souhaite peaufiner un peu l‚Äôaffichage, contr√¥ler parfaitement ce que l‚Äôutilisateur doit remplir, modifier les types de contr√¥leurs, les placer au pixel pr√®s, ‚Ä¶‚Äã Tout √ßa demande √©norm√©ment de temps. Et c‚Äôest l√† qu‚Äôintervient \href{http://django-crispy-forms.readthedocs.io/en/latest/}{Django-Crispy-Forms}. Cette librairie int√®gre plusieurs frameworks CSS (Bootstrap, Foundation et uni-form) et permet de contr√¥ler enti√®rement le \textbf{layout} et la pr√©sentation.


(c/c depuis le lien ci-dessous)


Pour chaque champ, crispy-forms va :


\begin{itemize}

\item utiliser le \texttt{verbose\_name} comme label.

\item v√©rifier les param√®tres \texttt et \texttt{null} pour savoir si le champ est obligatoire.

\item utiliser le type de champ pour d√©finir le type de la balise \texttt{<input>}.

\item r√©cup√©rer les valeurs du param√®tre \texttt{choices} (si pr√©sent) pour la balise \texttt{<select>}.

\end{itemize}


\href{http://dotmobo.github.io/django-crispy-forms.html}{http://dotmobo.github.io/django-crispy-forms.html}


\hypertarget{x-en-conclusion}{\section{En conclusion}}
\begin{enumerate}

\item{Toute donn√©e entr√©e par l‚Äôutilisateur \textbf{doit} passer par une instance de \texttt{form}.}

\item{euh ?}

\end{enumerate}


\hypertarget{x-vues}{\chapter{Vues}}
Une vue correspond √† un contr√¥leur dans le pattern MVC. Tout ce que vous pourrez d√©finir au niveau du fichier \texttt{views.py} fera le lien entre le mod√®le stock√© dans la base de donn√©es et ce avec quoi l‚Äôutilisateur pourra r√©ellement interagir (le \texttt{template}).


Chaque vue peut etre repr√©sent√©e de deux mani√®res: soit par des fonctions, soit par des classes. Le comportement leur est propre, mais le r√©sultat reste identique. Le lien entre l‚ÄôURL √† laquelle l‚Äôutilisateur acc√®de et son ex√©cution est faite au travers du fichier \texttt{gwift/urls.py}, comme on le verra par la suite.


\hypertarget{x-function-based-views}{\section{Function Based Views}}
Les fonctions (ou \texttt{FBV} pour \textbf{Function Based Views}) permettent une impl√©mentation classique des contr√¥leurs. Au fur et √† mesure de votre impl√©mentation, on se rendra compte qu‚Äôil y a beaucoup de r√©p√©titions dans ce type d‚Äôimpl√©mentation: elles ne sont pas obsol√®tes, mais dans certains cas, il sera pr√©f√©rable de passer par les classes.


Pour d√©finir la liste des \texttt{WishLists}  actuellement disponibles, on pr√©c√©dera de la mani√®re suivante:


\begin{enumerate}

\item{D√©finition d‚Äôune fonction qui va r√©cup√©rer les objets de type \texttt{WishList} dans notre base de donn√©es. La valeur de retour sera la construction d‚Äôun dictionnaire (le \textbf{contexte}) qui sera pass√© √† un template HTML. On d√©mandera √† ce template d‚Äôeffectuer le rendu au travers de la fonction \texttt{render}, qui est import√©e par d√©faut dans le fichier \texttt{views.py}.}

\item{Construction d‚Äôune URL qui permettra de lier l‚Äôadresse √† l‚Äôex√©cution de la fonction.}

\item{D√©finition du squelette.}

\end{enumerate}


\begin{verbatim}
# wish/views.py

from django.shortcuts import render
from .models import Wishlist

def wishlists(request):
	wishlists = Wishlist.objects.all()
	return render(
		request,
		'wish/list.html',
		{
			'wishlists': wishlists
		}
	)
\end{verbatim}

Rien qu‚Äôici, on doit d√©j√† tester deux choses:


\begin{enumerate}

\item{Qu‚Äôon construit bien le mod√®le attendu - la liste de tous les souhaits d√©j√† √©mis.}

\item{Que le template \texttt{wish/list.html} existe bien - sans quoi, on va tomber sur une erreur de type \texttt{TemplateDoesNotExist} dans notre environnement de test, et sur une erreur 500 en production.}

\end{enumerate}


A ce stade, v√©rifiez que la variable \texttt{TEMPLATES} est correctement initialis√©e dans le fichier \texttt{gwift/settings.py} et que le fichier \texttt{templates/wish/list.html} ressemble √† ceci:


\begin{verbatim}
<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<title></title>
	</head>
	<body>
		<p>Mes listes de souhaits</p>
		<ul>
		{% for wishlist in wishlists %}
			<li>glossterm::[ wishlist.name ]: glossterm::[ wishlist.description ]</li>
		{% endfor %}
		</ul>
	</body>
</html>
\end{verbatim}

A pr√©sent, ajoutez quelques listes de souhaits gr√¢ce √† un \textbf{shell}, puis lancez le serveur:


\begin{verbatim}
$ python manage.py shell
>>> from wish.models import Wishlist
>>> Wishlist.create('D√©cembre', "Ma liste pour les f√™tes de fin d'ann√©e")
<Wishlist: Wishlist object>
>>> Wishlist.create('Anniv 30 ans', "Je suis vieux! Faites des dons!")
<Wishlist: Wishlist object>
\end{verbatim}

Lancez le serveur gr√¢ce √† la commande \texttt{python manage.py runserver}, ouvrez un navigateur quelconque et rendez-vous √† l‚Äôadresse `http://localhost:8000 <\href{http://localhost:8000>`}{http://localhost:8000>`}. Vous devriez obtenir le r√©sultat suivant:


\begin{enumerate}

\item{image:: mvc/my-first-wishlists.png
:align: center}

\end{enumerate}


Rien de tr√®s sexy, aucune interaction avec l‚Äôutilisateur, tr√®s peu d‚Äôutilisation des variables contextuelles, mais c‚Äôest un bon d√©but! =)


\hypertarget{x-class-based-views}{\section{Class Based Views}}
Les classes, de leur c√¥t√©, impl√©mente le \textbf{pattern} objet et permettent d‚Äôarriver facilement √† un r√©sultat en tr√®s peu de temps, parfois m√™me en d√©finissant simplement quelques attributs, et rien d‚Äôautre. Pour l‚Äôexemple, on va d√©finir deux classes qui donnent exactement le m√™me r√©sultat que la fonction \texttt{wishlists} ci-dessus. Une premi√®re fois en utilisant une classe g√©n√©rique vierge, et ensuite en utilisant une classe de type \texttt{ListView}.


Voir \href{https://ccbv.co.uk/}{Classy Class Based Views}.


L‚Äôid√©e derri√®re les classes est de d√©finir des fonctions \textbf{par convention plut√¥t que par configuration}.


\admonition{NOTE}{√† compl√©ter ici :-)}
\hypertarget{x-listview}{\subsection{ListView}}
Les classes g√©n√©riques impl√©mentent un aspect bien particulier de la repr√©sentation d‚Äôun mod√®le, en utilisant tr√®s peu d‚Äôattributs. Les principales classes g√©n√©riques sont de type \texttt{ListView}, [‚Ä¶‚Äã]. L‚Äôimpl√©mentation consiste, exactement comme pour les fonctions, √†:


\begin{enumerate}

\item{D√©finir une sous-classe de celle que l‚Äôon souhaite utiliser}

\item{C√¢bler l‚ÄôURL qui lui sera associ√©e}

\item{D√©finir le squelette.}

\end{enumerate}


\begin{verbatim}
# wish/views.py

from django.views.generic import ListView

from .models import Wishlist

class WishListList(ListView):
	context_object_name = 'wishlists'
	model = Wishlist
	template_name = 'wish/list.html'
\end{verbatim}

Il est m√™me possible de r√©duire encore ce morceau de code en d√©finissant juste le snippet suivant :


\begin{verbatim}
# wish/views.py

from django.views.generic import ListView

from .models import Wishlist

class WishListList(ListView):
	context_object_name = 'wishlists'
\end{verbatim}

Par inf√©rence, Django construit beaucoup d‚Äôinformations: si on n‚Äôavait pas sp√©cifi√© les variables \texttt{context\_object\_name} et \texttt{template\_name}, celles-ci auraient pris les valeurs suivantes:


\begin{itemize}

\item \texttt{context\_object\_name}: \texttt{wishlist\_list} (ou plus pr√©cis√©ment, le nom du mod√®le suivi de \texttt{\_list})

\item \texttt{template\_name}: \texttt{wish/wishlist\_list.html} (√† nouveau, le fichier g√©n√©r√© est pr√©fix√© du nom du mod√®le).

\end{itemize}


En l‚Äô√©tat, par rapport √† notre pr√©c√©dente vue bas√©e sur une fonction, on y gagne sur les conventions utilis√©es et le nombre de tests √† r√©aliser. A vous de voir la d√©claration que vous pr√©f√©rez, en fonction de vos affinit√©s et du r√©sultat que vous souhaitez atteindre.


\admonition{NOTE}{un petit tableau de diff√©rence entre les deux ? :-)}
\begin{verbatim}
# gwift/urls.py

from django.conf.urls import include, url
from django.contrib import admin

from wish.views import WishListList

urlpatterns = [
	url(r'^admin/', include(admin.site.urls)),
	url(r'^$', WishListList.as_view(), name='wishlists'),
]
\end{verbatim}

C‚Äôest tout. Lancez le serveur, le r√©sultat sera identique.


\hypertarget{x-templates}{\chapter{Templates}}
Avant de commencer √† interagir avec nos donn√©es au travers de listes, formulaires et d‚Äôinterfaces sophistiqu√©es, quelques mots sur les templates: il s‚Äôagit en fait de \textbf{squelettes} de pr√©sentation, recevant en entr√©e un dictionnaire contenant des cl√©s-valeurs et ayant pour but de les afficher selon le format que vous d√©finirez.


En int√©grant un ensemble de \textbf{tags}, cela vous permettra de greffer les donn√©es re√ßues en entr√©e dans un patron pr√©d√©fini.


\admonition{NOTE}{(je ne sais plus ce que je voulais dire ici)}
Un squelette de page HTML basique ressemble √† ceci:


\begin{verbatim}
<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
    </head>
    <body>
        <p>Hello world!</p>
    </body>
</html>
\end{verbatim}

Notre premi√®re vue permettra de r√©cup√©rer la liste des objets de type \texttt{Wishlist} que nous avons d√©finis dans le fichier \texttt{wish/models.py}. Supposez que cette liste soit accessible \textbf{via} la cl√© \texttt{wishlists} d‚Äôun dictionnaire pass√© au template. Elle devient d√®s lors accessible gr√¢ce aux tags

De m√™me, il sera possible d‚Äôacc√©der aux propri√©t√©s de cette objet de la m√™me mani√®re: \texttt{wishlist.id}, \texttt{wishlist.description}, ... et d‚Äôainsi respecter la mise en page que nous souhaitons.


En reprenant l‚Äôexemple de la page HTML d√©finie ci-dessus, on pourra l‚Äôagr√©menter de la mani√®re suivante:


\begin{verbatim}
<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
    </head>
    <body>
        <p>Mes listes de souhaits</p>
        <ul>
        {% for wishlist in wishlists %}
            <li>glossterm::[ wishlist.name ]: glossterm::[ wishlist.description ]</li>
        {% endfor %}
        </ul>
    </body>
</html>
\end{verbatim}

\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/html/my-first-wishlists.png}


\end{figure}

Mais plut√¥t que de r√©√©crire √† chaque fois le m√™me ent√™te, on peut se simplifier la vie en impl√©mentant un h√©ritage au niveau des templates. Pour cela, il suffit de d√©finir des blocs de contenu, et d'\textbf{√©tendre} une page de base, puis de surcharger ces m√™mes blocs.


Par exemple, si on repart de notre page de base ci-dessus, on va y d√©finir deux blocs r√©utilisables:


\begin{verbatim}
<!-- templates/base.html -->

<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>{% block title %}Gwift{% endblock %}</title> 
    </head>
    <body>
        {% block body %}<p>Hello world!</p>{% endblock %} 
    </body>
</html>
\end{verbatim}


La page HTML pour nos listes de souhaits devient alors:


\begin{verbatim}
<!-- templates/wishlist/wishlist_list.html -->

{% extends "base.html" %} 

{% block title %}glossterm::[ block.super ] - Listes de souhaits{% endblock %} 

{% block body %} 
<p>Mes listes de souhaits</p>
<ul>
{% for wishlist in wishlists %}
    <li>glossterm::[ wishlist.name ]: glossterm::[ wishlist.description ]</li>
{% endfor %}
</ul>
\end{verbatim}


\hypertarget{x-structure-et-configuration}{\section{Structure et configuration}}
Il est conseill√© que les templates respectent la structure de vos diff√©rentes applications, mais dans un r√©pertoire √† part. Par convention, nous les placerons dans un r√©pertoire \texttt{templates}. La hi√©rarchie des fichiers devient alors celle-ci:


\begin{verbatim}
$ tree templates/
templates/
‚îî‚îÄ‚îÄ wish
    ‚îî‚îÄ‚îÄ list.html
\end{verbatim}

Par d√©faut, Django cherchera les templates dans les r√©pertoirer d‚Äôinstallation. Vous devrez vous √©diter le fichier \texttt{gwift/settings.py} et ajouter, dans la variable \texttt{TEMPLATES}, la cl√© \texttt{DIRS} de la mani√®re suivante:


\begin{verbatim}
TEMPLATES = [
    {
        ...
        'DIRS': [ 'templates' ],
        ...
    },
]
\end{verbatim}

\hypertarget{x-builtins}{\section{Builtins}}
Django vient avec un ensemble de \textbf{tags} ou \textbf{template tags}. On a vu la boucle \texttt{for} ci-dessus, mais il existe \href{https://docs.djangoproject.com/fr/1.9/ref/templates/builtins/}{beaucoup d‚Äôautres tags nativement pr√©sents}. Les principaux sont par exemple:


\begin{itemize}

\item if, conditions, etc. permet de v√©rifier une condition et de n‚Äôafficher le contenu du bloc que si la condition est v√©rifi√©e.

\item Op√©rateurs de comparaison (gueules de loups, in, not in, etc.)

\item Regroupements avec le tag regroup by ... as 

\item url pour construire facilement une URL √† partir de son nom

\item urlize qui permet de remplacer des URLs trouv√©es dans un champ CharField ou TextField en lien cliquable

\end{itemize}


Chacune de ces fonctions peut √™tre utilis√©e autant au niveau des templates qu‚Äôau niveau du code. Il suffit d‚Äôaller les chercher dans le package \texttt{django.template.defaultfilters}. Par exemple:


\begin{verbatim}
from django.db import models
from django.template.defaultfilters import urlize


class Suggestion(models.Model):
    """Repr√©sentation des suggestions.
    """
    subject = models.TextField(verbose_name="Sujet")

    def urlized_subject(self):
        """
        Voir https://docs.djangoproject.com/fr/3.0/howto/custom-template-tags/
        """
        return urlize(self.subject, autoescape=True)
\end{verbatim}

\hypertarget{x-non-builtins}{\section{Non-builtins}}
En plus des quelques tags survol√©s ci-dessus, il est √©galement possible de construire ses propres tags. La structure est un peu bizarre, car elle consiste √† ajouter un paquet dans une de vos applications, √† y d√©finir un nouveau module et √† y d√©finir un ensemble de fonctions. Chacune de ces fonctions correspondra √† un tag appelable depuis vos templates.


Il existe trois types de tags \textbf{non-builtins}:


\begin{enumerate}

\item \textbf{Les filtres} - on peut les appeler gr√¢ce au \textbf{pipe} directement apr√®s une valeur dans le template.

\item \textbf{Les tags simples} - ils peuvent prendre une valeur ou plusieurs en param√®tre et retourne une nouvelle valeur. Pour les appeler, c‚Äôest \textbf{via} les tags nom de la fonction param1 param2...

\item \textbf{Les tags d inclusion}: ils retournent un contexte (ie. un dictionnaire), qui est ensuite pass√© √† un nouveau template. Type include.

\end{enumerate}


Pour l‚Äôimpl√©mentation:


\begin{enumerate}

\item On prend l‚Äôapplication \texttt{wish} et on y ajoute un r√©pertoire \texttt{templatetags}, ainsi qu‚Äôun fichier \texttt{init.py}.

\item{Dans ce nouveau paquet, on ajoute un nouveau module que l‚Äôon va appeler \texttt{tools.py}}

\item{Dans ce module, pour avoir un aper√ßu des possibilit√©s, on va d√©finir trois fonctions (une pour chaque type de tags possible).}

\end{enumerate}


\begin{verbatim}
[Inclure un tree du dossier template tags]
\end{verbatim}

\hypertarget{x-filtres}{\subsection{Filtres}}
\begin{verbatim}
# wish/tools.py

from django import template

from wish.models import Wishlist

register = template.Library()

@register.filter(is_safe=True)
def add_xx(value):
    return '%sxx' % value
\end{verbatim}

\hypertarget{x-tags-simples}{\subsection{Tags simples}}
\begin{verbatim}
# wish/tools.py

from django import template

from wish.models import Wishlist


register = template.Library()


@register.simple_tag
def current_time(format_string):
    return datetime.datetime.now().strftime(format_string)
\end{verbatim}

\hypertarget{x-tags-d‚Äôinclusion}{\subsection{Tags d‚Äôinclusion}}
\begin{verbatim}
# wish/tools.py

from django import template

from wish.models import Wishlist


register = template.Library()


@register.inclusion_tag('wish/templatetags/wishlists_list.html')
def wishlists_list():
    return { 'list': Wishlist.objects.all() }
\end{verbatim}

\hypertarget{x-contexts-processors}{\section{Contexts Processors}}
Un \texttt{context processor} permet d‚Äôajouter des informations par d√©faut √† un contexte (le dictionnaire qu‚Äôon passe de la vue au template).
L‚Äôid√©e est d‚Äôajouter une fonction √† un module Python √† notre projet, puis de le r√©f√©rencer parmi
  les CONTEXT\_PROCESSORS de nos param√®tres g√©n√©raux. Cette fonction doit peupler un dictionnaire, et les cl√©s de ce dictionnaire seront
  directement ajout√©es √† tout autre dictionnaire/contexte pass√© √† une vue. Par exemple:


(cf. \href{https://stackoverflow.com/questions/60515797/default-context-for-all-pages-django}{StackOverflow} - √† retravailler)


\begin{verbatim}
from product.models import SubCategory, Category


def add_variable_to_context(request):
    return {
        'subCategories': SubCategory.objects.order_by('id').all(),
        'categories': Category.objects.order_by("id").all(),
    }
\end{verbatim}

\begin{verbatim}
'OPTIONS': {
    'context_processors': [
        ....
        'core.context_processors.add_variable_to_context',
        ....
    ],
},
\end{verbatim}

\hypertarget{x-mise-en-page}{\section{Mise en page}}
Pour que nos pages soient un peu plus \textbf{eye-candy} que ce qu‚Äôon a pr√©sent√© ci-dessus, nous allons modifi√© notre squelette pour qu‚Äôil se base sur \href{http://getbootstrap.com/>`}{http://getbootstrap.com/>`}. Nous placerons une barre de navigation principale, la possibilit√© de se connecter pour l‚Äôutilisateur et d√©finirons quelques emplacements √† utiliser par la suite. Reprenez votre fichier base.html et modifiez le comme ceci:


\begin{verbatim}
{% load staticfiles %}

<!DOCTYPE html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link rel="icon" href="{% static 'img/favicon.ico' %}" />
    <title>Gwift</title>
</head>

<body class="base-body">

    <!-- navigation -->
    <div class="nav-wrapper">
        <div id="nav">
            <nav class="navbar navbar-default navbar-static-top navbar-shadow">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#menuNavbar">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">
                            <img src="{% static 'img/gwift-20x20.png' %}" />
                        </a>
                    </div>
                    <div class="collapse navbar-collapse" id="menuNavbar">
                        {% include "_menu_items.html" %}
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- end navigation -->

    <!-- content -->
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
    <!-- end content -->

    <!-- footer -->
    <footer class="footer">
        {% include "_footer.html" %}
    </footer>
    <!-- end footer -->
</body>
</html>
\end{verbatim}

Quelques remarques:


\begin{itemize}

\item La premi√®re ligne du fichier inclut le \textbf{tag}  load staticfiles On y reviendra par la suite, mais en gros, cela permet de faciliter la gestion des fichiers statiques, notamment en les appelent gr√¢ce √† la commande static 'img/header.png' ou static 'css/app\_style.css' .

\item La balise \texttt{<head />} est bour√©e d‚Äôappel vers des ressources stock√©es sur des CDN.

\item Les balises permettent de faire h√©riter du contenu depuis une autre page. On l‚Äôutilise notamment dans notre page \texttt{templates/wish/list.html}.

\item Pour l‚Äôent√™te et le bas de page n fait appel aux balises include pour charger un nom de fichier - ces fichiers sont des fichiers physiques, plac√©s sur le filesystem, juste √† c√¥t√© du fichier . De fa√ßon b√™te et m√©chante, cela inclut juste du contenu HTML. Le contenu des fichiers  et  est copi√© ci-dessous.

\end{itemize}


\begin{verbatim}
<!-- gwift/templates/wish/list.html -->

{% extends "base.html" %}

{% block content %}
    <p>Mes listes de souhaits</p>
    <ul>
    {% for wishlist in wishlists %}
        <li>glossterm::[ wishlist.name ]: glossterm::[ wishlist.description ]</li>
    {% endfor %}
    </ul>
{% endblock %}
\end{verbatim}

\begin{verbatim}
<!-- gwift/templates/_menu_items.html -->
<ul class="nav navbar-nav">
    <li class="">
        <a href="#">
            <i class="fa fa-calendar"></i> Mes listes
        </a>
    </li>
</ul>
<ul class="nav navbar-nav navbar-right">
    <li class="">
        <a href="#">
            <i class="fa fa-user"></i> Login / Register
        </a>
    </li>
</ul>
\end{verbatim}

\begin{verbatim}
<!-- gwift/templates/_footer.html -->
<div class="container">
    Copylefted '16
</div>
\end{verbatim}

En fonction de vos affinit√©s, vous pourriez passer par PluCSS, KNACSS, Cascade, PureCSS, Semantic-UI, ... 
Pour notre plus grand bonheur, les frameworks de ce type pullulent.
Reste √† choisir le bon.

\textbf{A priori}, si vous relancez le serveur de d√©veloppement maintenant, vous devriez d√©j√† voir les modifications‚Ä¶‚Äã Mais pas les images, ni tout autre fichier statique.


\hypertarget{x-fichiers-statiques}{\subsection{Fichiers statiques}}
Si vous ouvrez la page et que vous lancez la console de d√©veloppement (F12, sur la majorit√© des navigateurs), vous vous rendrez compte que certains fichiers ne sont pas disponibles. Il s‚Äôagit des fichiers suivants:


\begin{itemize}

\item \texttt{/static/css/style.css}

\item \texttt{/static/img/favicon.ico}

\item \texttt{/static/img/gwift-20x20.png}.

\end{itemize}


En fait, par d√©faut, les fichiers statiques sont r√©cup√©r√©s gr√¢ce √† deux handlers:


\begin{enumerate}

\item{\texttt{django.contrib.staticfiles.finders.FileSystemFinder} et . \texttt{django.contrib.staticfiles.finders.AppDirectoriesFinder}.}

\end{enumerate}


En fait, Django va consid√©rer un r√©pertoire \texttt{static} √† l‚Äôint√©rieur de chaque application. Si deux fichiers portent le m√™me nom, le premier trouv√© sera pris. Par facilit√©, et pour notre d√©veloppement, nous placerons les fichiers statiques dans le r√©pertoire \texttt{gwift/static}. On y trouve donc:


\begin{verbatim}
[inclure un tree du r√©pertoire gwift/static]
\end{verbatim}

\begin{verbatim}
# gwift/settings/base.py

STATIC_URL = '/static/'
\end{verbatim}

\begin{verbatim}
# gwift/settings/dev.py

STATICFILES_DIRS = [
    os.path.join(BASE_DIR, "static"),
]
\end{verbatim}

En production par contre, nous ferons en sorte que le contenu statique soit pris en charge par le front-end Web (Nginx), raison pour laquelle cette variable n‚Äôest initialis√©e que dans le fichier des param√®tres li√©s au d√©veloppement.


Au final, cela ressemble √† ceci:


\begin{enumerate}

\item{image:: mvc/my-first-wishlists.png
:align: center}

\end{enumerate}


\hypertarget{x-urls-et-espaces-de-noms}{\chapter{URLs et espaces de noms}}
La gestion des URLs permet \textbf{grosso modo} d‚Äôassigner une adresse param√©tr√©e ou non √† une fonction Python. La mani√®re simple consiste √† modifier le fichier \texttt{gwift/settings.py} pour y ajouter nos correspondances. Par d√©faut, le fichier ressemble √† ceci:


\begin{verbatim}
# gwift/urls.py

from django.conf.urls import include, url
from django.contrib import admin

urlpatterns = [
    url(r'^admin/', include(admin.site.urls)),
]
\end{verbatim}

La variable \texttt{urlpatterns} associe un ensemble d‚Äôadresses √† des fonctions. Dans le fichier \textbf{nu}, seul le \textbf{pattern} \texttt{admin} est d√©fini, et inclut toutes les adresses qui sont d√©finies dans le fichier \texttt{admin.site.urls}.


\admonition{NOTE}{petit mot d‚Äôexplication sur les expressions rationnelles.}
\begin{verbatim}
# admin.site.urls.py
\end{verbatim}

Pour reprendre l‚Äôexemple o√π on en √©tait rest√©:


\begin{verbatim}
# gwift/urls.py

from django.conf.urls import include, url
from django.contrib import admin

from wish import views as wish_views

urlpatterns = [
	url(r'^admin/', include(admin.site.urls)),
	url(r'^$', wish_views.wishlists, name='wishlists'),
]
\end{verbatim}

A pr√©sent, on doit tester que l‚ÄôURL racine de notre application m√®ne bien vers la fonction \texttt{wish\_views.wishlists}.


Prenons par exemple l‚Äôexemple de Twitter : quand on acc√®de √† une URL, elle est de la forme \texttt{https://twitter.com/<user>`}. Sauf que les pages \texttt{about} et \texttt{help} existent √©galement. Pour impl√©menter ce type de pr√©c√©dence, il faudrait impl√©menter les URLs de la mani√®re suivante:


\begin{verbatim}
| about
| help
| <user>
\end{verbatim}

Mais cela signifie aussi que les utilisateurs \texttt{about} et \texttt{help} (s‚Äôils existent‚Ä¶‚Äã) ne pourront jamais acc√©der √† leur profil. Une derni√®re solution serait de maintenir une liste d‚Äôauthorit√© des noms d‚Äôutilisateur qu‚Äôil n‚Äôest pas possible d‚Äôutiliser.


D‚Äôo√π l‚Äôimportance de bien d√©finir la s√©quence de d√©inition de ces routes, ainsi que des espaces de noms.


L‚Äôid√©e des espaces de noms ou \emph{namespaces} est de d√©finir un \emph{sous-r√©pertoire} dans lequel on trouvera nos nouvelles routes. Cette mani√®re de proc√©der permet notamment de r√©pondre au probl√®me ci-dessous, en d√©finissant un sous-dossier type \texttt{https://twitter.com/users/<user>`}.


De l√†, d√©coule une autre bonne pratique: l‚Äôutilisation de \emph{breadcrumbs} (\href{https://stackoverflow.com/questions/826889/how-to-implement-breadcrumbs-in-a-django-template}{https://stackoverflow.com/questions/826889/how-to-implement-breadcrumbs-in-a-django-template}) ou de guidelines de navigation.


\hypertarget{x-reverse}{\section{Reverse}}
En associant un nom ou un libell√© √† chaque URL, il est possible de r√©cup√©rer sa \textbf{traduction}. Cela implique par contre de ne plus toucher √† ce libell√© par la suite‚Ä¶‚Äã


Dans le fichier \texttt{urls.py}, on associe le libell√© \texttt{wishlists} √† l‚ÄôURL \$ (c‚Äôest-√†-dire la racine du site):


\begin{verbatim}
from wish.views import WishListList

urlpatterns = [
    url(r'^admin/', include(admin.site.urls)),
    url(r'^$', WishListList.as_view(), name='wishlists'),
]
\end{verbatim}

De cette mani√®re, dans nos templates, on peut √† pr√©sent construire un lien vers la racine avec le tags suivant:


\begin{verbatim}
<a href="{% url 'wishlists' %}">glossterm::[ yearvar ] Archive</a>
\end{verbatim}

De la m√™me mani√®re, on peut √©galement r√©cup√©rer l‚ÄôURL de destination pour n‚Äôimporte quel libell√©, de la mani√®re suivante:


\begin{verbatim}
from django.core.urlresolvers import reverse_lazy

wishlists_url = reverse_lazy('wishlists')
\end{verbatim}

\hypertarget{x-authentification}{\chapter{Authentification}}
Comme on l‚Äôa vu dans la partie sur le mod√®le, nous souhaitons que le cr√©ateur d‚Äôune liste puisse retrouver facilement les √©l√©ments qu‚Äôil aura cr√©√©. Ce dont nous n‚Äôavons pas parl√© cependant, c‚Äôest la mani√®re dont l‚Äôutilisateur va pouvoir cr√©er son compte et s‚Äôauthentifier. La \href{https://docs.djangoproject.com/en/stable/topics/auth/}{documentation} est tr√®s compl√®te, nous allons essayer de la simplifier au maximum. Accrochez-vous, le sujet peut √™tre complexe.


\hypertarget{x-m√©canisme-d‚Äôauthentification}{\section{M√©canisme d‚Äôauthentification}}
On peut sch√©matiser le flux d‚Äôauthentification de la mani√®re suivante :


En gros:


\begin{enumerate}

\item{La personne acc√®de √† une URL qui est prot√©g√©e (voir les d√©corateurs \@login\_required et le mixin LoginRequiredMixin)}

\item{Le framework d√©tecte qu‚Äôil est n√©cessaire pour la personne de se connecter (gr√¢ce √† un param√®tre type LOGIN\_URL)}

\item{Le framework pr√©sente une page de connexion ou un m√©canisme d‚Äôacc√®s pour la personne (template √† d√©finir)}

\item{Le framework r√©cup√®re les informations du formulaire, et les transmets aux diff√©rents backends d‚Äôauthentification, dans l‚Äôordre}

\item{Chaque backend va appliquer la m√©thode \texttt{authenticate} en cascade, jusqu‚Äô√† ce qu‚Äôun backend r√©ponde True ou qu‚Äôaucun ne r√©ponde}

\item{La r√©ponse de la m√©thode authenticate doit √™tre une instance d‚Äôun utilisateur, tel que d√©finit parmi les param√®tres g√©n√©raux de l‚Äôapplication.}

\end{enumerate}


En r√©sum√© (bis):


\begin{enumerate}

\item{Une personne souhaite se connecter;}

\item{Les backends d‚Äôauthentification s‚Äôencha√Æne jusqu‚Äô√† trouver une bonne correspondance. Si aucune correspondance n‚Äôest trouv√©e, on envoie la personne sur les roses.}

\item{Si OK, on retourne une instance de type current\_user, qui pourra √™tre utilis√©e de mani√®re uniforme dans l‚Äôapplication.}

\end{enumerate}


Ci-dessous, on d√©finit deux backends diff√©rents pour mieux comprendre les diff√©rentes possibilit√©s:


\begin{enumerate}

\item{Une authentification par jeton}

\item{Une authentification LDAP}

\end{enumerate}


\begin{verbatim}
from datetime import datetime

from django.contrib.auth import backends, get_user_model
from django.db.models import Q

from accounts.models import Token  


UserModel = get_user_model()


class TokenBackend(backends.ModelBackend):
    def authenticate(self, request, username=None, password=None, **kwargs):
        """Authentifie l'utilisateur sur base d'un jeton qu'il a re√ßu.

        On regarde la date de validit√© de chaque jeton avant d'autoriser l'acc√®s.
        """
        token = kwargs.get("token", None)

        current_token = Token.objects.filter(token=token, validity_date__gte=datetime.now()).first()

        if current_token:
            user = current_token.user

            current_token.last_used_date = datetime.now()
            current_token.save()

            return user

        return None
\end{verbatim}


\begin{verbatim}
from django.contrib.auth import backends, get_user_model

from ldap3 import Server, Connection, ALL
from ldap3.core.exceptions import LDAPPasswordIsMandatoryError

from config import settings


UserModel = get_user_model()


class LdapBackend(backends.ModelBackend):
    """Impl√©mentation du backend LDAP pour la connexion des utilisateurs √† l'Active Directory.
    """
    def authenticate(self, request, username=None, password=None, **kwargs):
        """Authentifie l'utilisateur au travers du serveur LDAP.
        """

        ldap_server = Server(settings.LDAP_SERVER, get_info=ALL)
        ldap_connection = Connection(ldap_server, user=username, password=password)

        try:
            if not ldap_connection.bind():
                raise ValueError("Login ou mot de passe incorrect")
        except (LDAPPasswordIsMandatoryError, ValueError) as ldap_exception:
            raise ldap_exception

        user, _ = UserModel.objects.get_or_create(username=username)
\end{verbatim}

On peut r√©sumer le m√©canisme d‚Äôauthentification de la mani√®re suivante:


\begin{itemize}

\item Si vous voulez modifier les informations li√©es √† un utilisateur, orientez-vous vers la modification du mod√®le. Comme nous le verrons ci-dessous, il existe trois mani√®res de prendre ces modifications en compte. Voir √©galement \href{https://docs.djangoproject.com/en/stable/topics/auth/customizing/}{ici}.

\item Si vous souhaitez modifier la mani√®re dont l‚Äôutilisateur se connecte, alors vous devrez modifier le.

\end{itemize}


\hypertarget{x-modification-du-mod√®le}{\section{Modification du mod√®le}}
Dans un premier temps, Django a besoin de manipuler \href{https://docs.djangoproject.com/en/1.9/ref/contrib/auth/#user-model}{des instances de type \texttt{django.contrib.auth.User}}. Cette classe impl√©mente les champs suivants:


\begin{itemize}

\item \texttt{username}

\item \texttt{first\_name}

\item \texttt{last\_name}

\item textttjaguarondi27@gmail.com

\item \texttt{password}

\item \texttt{date\_joined}.

\end{itemize}


D‚Äôautres champs, comme les groupes auxquels l‚Äôutilisateur est associ√©, ses permissions, savoir s‚Äôil est un super-utilisateur, ‚Ä¶‚Äã sont moins pertinents pour le moment. Avec les quelques champs d√©j√† d√©finis ci-dessus, nous avons de quoi identifier correctement nos utilisateurs. Inutile d‚Äôimpl√©menter nos propres classes, puisqu‚Äôelles existent d√©j√† :-)


Si vous souhaitez ajouter un champ, il existe trois mani√®res de faire.


\hypertarget{x-extension-du-mod√®le-existant}{\section{Extension du mod√®le existant}}
Le plus simple consiste √† cr√©er une nouvelle classe, et √† faire un lien de type \texttt{OneToOne} vers la classe \texttt{django.contrib.auth.User}. De cette mani√®re, on ne modifie rien √† la mani√®re dont Django authentife ses utlisateurs: tout ce qu‚Äôon fait, c‚Äôest un lien vers une table nouvellement cr√©√©e, comme on l‚Äôa d√©j√† vu au point [‚Ä¶‚Äãvoir l‚Äôh√©ritage de mod√®le]. L‚Äôavantage de cette m√©thode, c‚Äôest qu‚Äôelle est extr√™mement flexible, et qu‚Äôon garde les m√©canismes Django standard. Le d√©savantage, c‚Äôest que pour avoir toutes les informations de notre utilisateur, on sera oblig√© d‚Äôeffectuer une jointure sur le base de donn√©es, ce qui pourrait avoir des cons√©quences sur les performances.


\hypertarget{x-substitution}{\section{Substitution}}
Avant de commencer, sachez que cette √©tape doit √™tre effectu√©e \textbf{avant la premi√®re migration}. Le plus simple sera de d√©finir une nouvelle classe h√©ritant de \texttt{django.contrib.auth.User} et de sp√©cifier la classe √† utiliser dans votre fichier de param√®tres. Si ce param√®tre est modifi√© apr√®s que la premi√®re migration ait √©t√© effectu√©e, il ne sera pas pris en compte. Tenez-en compte au moment de mod√©liser votre application.


\begin{verbatim}
AUTH_USER_MODEL = 'myapp.MyUser'
\end{verbatim}

Notez bien qu‚Äôil ne faut pas sp√©cifier le package \texttt{.models} dans cette injection de d√©pendances: le sch√©ma √† indiquer est bien \texttt{<nom de l‚Äôapplication>.<nom de la classe>}.


\hypertarget{x-backend}{\subsection{Backend}}

\hypertarget{x-templates}{\subsection{Templates}}
Ce qui n‚Äôexiste pas par contre, ce sont les vues. Django propose donc tout le m√©canisme de gestion des utilisateurs, except√© le visuel (hors administration). En premier lieu, ces param√®tres sont fix√©s dans le fichier `settings <\href{https://docs.djangoproject.com/en/1.8/ref/settings/auth}. On y trouve par exemple les param√®tres suivants:


\begin{itemize}

\item \texttt{LOGIN\_REDIRECT\_URL}: si vous ne sp√©cifiez pas le param√®tre \texttt{next}, l‚Äôutilisateur sera automatiquement redirig√© vers cette page.

\item \texttt{LOGIN\_URL}: l‚ÄôURL de connexion √† utiliser. Par d√©faut, l‚Äôutilisateur doit se rendre sur la page \texttt{/accounts/login}.

\end{itemize}


\hypertarget{x-social-authentification}{\subsection{Social-Authentification}}
Voir ici : \href{https://github.com/omab/python-social-auth}{python social auth}


\hypertarget{x-un-petit-mot-sur-oauth}{\subsection{Un petit mot sur OAuth}}
OAuth est un standard libre d√©finissant un ensemble de m√©thodes √† impl√©menter pour l‚Äôacc√®s (l‚Äôautorisation) √† une API. Son fonctionnement se base sur un syst√®me de jetons (Tokens), attribu√©s par le possesseur de la ressource √† laquelle un utilisateur souhaite acc√©der.


Le client initie la connexion en demandant un jeton au serveur. Ce jeton est ensuite utilis√©e tout au long de la connexion, pour acc√©der aux diff√©rentes ressources offertes par ce serveur. wikipedia

Une introduction √† OAuth est \href{http://hueniverse.com/oauth/guide/intro/}{disponible ici}. Elle introduit le protocole comme √©tant une \texttt{valet key}, une cl√© que l‚Äôon donne √† la personne qui va garer votre voiture pendant que vous profitez des mondanit√©s. Cette cl√© donne un acc√®s √† votre voiture, tout en bloquant un ensemble de fonctionnalit√©s. Le principe du protocole est semblable en ce sens: vous vous r√©servez un acc√®s total √† une API, tandis que le syst√®me de jetons permet d‚Äôidentifier une personne, tout en lui donnant un acc√®s restreint √† votre application.


L‚Äôutilisation de jetons permet notamment de d√©finir une dur√©e d‚Äôutilisation et une port√©e d‚Äôutilisation. L‚Äôutilisateur d‚Äôun service A peut par exemple autoriser un service B √† acc√©der √† des ressources qu‚Äôil poss√®de, sans pour autant r√©v√©ler son nom d‚Äôutilisateur ou son mot de passe.


L‚Äôexemple repris au niveau du \href{http://hueniverse.com/oauth/guide/workflow/}{workflow} est le suivant : un utilisateur(trice), Jane, a upload√© des photos sur le site faji.com (A). Elle souhaite les imprimer au travers du site beppa.com (B).
Au moment de la commande, le site beppa.com envoie une demande au site faji.com pour acc√©der aux ressources partag√©es par Jane. Pour cela, une nouvelle page s‚Äôouvre pour l‚Äôutilisateur, et lui demande d‚Äôintroduire sa "pi√®ce d‚Äôidentit√©". Le site A, ayant re√ßu une demande de B, mais certifi√©e par l‚Äôutilisateur, ouvre alors les ressources et lui permet d‚Äôy acc√©der.


\hypertarget{x-logging}{\chapter{Logging}}
La configuration des \emph{loggers} est relativement simple, un peu plus complexe si nous nous penchons dessus, et franchement compl√®te si nous creusons encore.
Il est ainsi possible de d√©finir des formattages, gestionnaires (\emph{handlers}) et loggers distincts, en fonction de nos applications.


Sauf que comme nous l‚Äôavons vu avec les 12 facteurs, nous devons traiter les informations de notre application comme un flux d‚Äô√©v√®nements.
Il n‚Äôest donc pas r√©ellement n√©cessaire de chipoter la configuration, puisque la seule classe qui va r√©ellement nous int√©resser concerne les \texttt{StreamHandler}.
La configuration que nous allons utiliser est celle-ci:


\begin{enumerate}

\item{Formattage: √† d√©finir - mais la variante suivante est compl√®te, lisible et pratique: \texttt{{levelname} {asctime} {module} {process:d} {thread:d} {message}}}

\item{Handler: juste un, qui d√©finit un \texttt{StreamHandler}}

\item{Logger: pour celui-ci, nous avons besoin d‚Äôun niveau (\texttt{level}) et de savoir s‚Äôil faut propager les informations vers les sous-paquets, auquel cas il nous suffira de fixer la valeur de \texttt{propagate} √† \texttt{True}.}

\end{enumerate}


\begin{verbatim}
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
        },
        'simple': {
            'format': '{levelname} {asctime} {module} {message}',
        },
    },
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': "verbose"
        }
    },
    'loggers': {
        'khana': {
            'handlers': ['console'],
            'level': env("LOG_LEVEL", default="DEBUG"),
            'propagate': True,
        },
    }
}
\end{verbatim}

Pour utiliser nos loggers, il suffit de copier le petit bout de code suivant:


\begin{verbatim}
import logging

logger = logging.getLogger(__name__)

logger.debug('helloworld')
\end{verbatim}

\href{https://docs.djangoproject.com/en/stable/topics/logging/#examples}{Par exemples}.


\admonition{NOTE}{Ne pas oublier de parler des sessions. Mais je ne sais pas si c‚Äôest le bon endroit.}
\hypertarget{x-go-live-!}{\part*{Go Live !}}
Pour commencer, nous allons nous concentrer sur la cr√©ation d‚Äôun site ne contenant qu‚Äôune seule application, m√™me si en pratique le site contiendra d√©j√† plusieurs applications fournies pas django, comme nous le verrons plus loin.


Pour prendre un exemple concret, nous allons cr√©er un site permettant de g√©rer des listes de souhaits, que nous appellerons \texttt{gwift} (pour \texttt{GiFTs and WIshlisTs} :)).


La premi√®re chose √† faire est de d√©finir nos besoins du point de vue de l‚Äôutilisateur, c‚Äôest-√†-dire ce que nous souhaitons qu‚Äôun utilisateur puisse faire avec l‚Äôapplication.


Ensuite, nous pourrons traduire ces besoins en fonctionnalit√©s et finalement effectuer le d√©veloppement.


\hypertarget{x-gwift}{\chapter{Gwift}}
\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-project-vs-apps-gwift.png}
\caption{}

\end{figure}

\hypertarget{x-besoins-utilisateurs}{\chapter{Besoins utilisateurs}}
Nous souhaitons d√©velopper un site o√π un utilisateur donn√© peut cr√©er une liste contenant des souhaits et o√π d‚Äôautres utilisateurs, authentifi√©s ou non, peuvent choisir les souhaits √† la r√©alisation desquels ils souhaitent participer.


Il sera n√©cessaire de s‚Äôauthentifier pour :


\begin{itemize}

\item Cr√©er une liste associ√©e √† l‚Äôutilisateur en cours

\item Ajouter un nouvel √©l√©ment √† une liste

\end{itemize}


Il ne sera pas n√©cessaire de s‚Äôauthentifier pour :


\begin{itemize}

\item Faire une promesse d‚Äôoffre pour un √©l√©ment appartenant √† une liste, associ√©e √† un utilisateur.

\end{itemize}


L‚Äôutilisateur ayant cr√©√© une liste pourra envoyer un email directement depuis le site aux personnes avec qui il souhaite partager sa liste, cet email contenant un lien permettant d‚Äôacc√©der √† cette liste.


A chaque souhait, on pourrait de mani√®re facultative ajouter un prix. Dans ce cas, le souhait pourrait aussi √™tre subdivis√© en plusieurs parties, de mani√®re √† ce que plusieurs personnes puissent participer √† sa r√©alisation.


Un souhait pourrait aussi √™tre r√©alis√© plusieurs fois. Ceci revient √† dupliquer le souhait en question.


\hypertarget{x-besoins-fonctionnels}{\chapter{Besoins fonctionnels}}
\hypertarget{x-gestion-des-utilisateurs}{\section{Gestion des utilisateurs}}
Pour g√©rer les utilisateurs, nous allons faire en sorte de surcharger ce que Django propose: par d√©faut, on a une la possibilit√© de g√©rer des utilisateurs (identifi√©s par une adresse email, un nom, un pr√©nom, ‚Ä¶‚Äã) mais sans plus.


Ce qu‚Äôon peut souhaiter, c‚Äôest que l‚Äôutilisateur puisse s‚Äôauthentifier gr√¢ce √† une plateforme connue (Facebook, Twitter, Google, etc.), et qu‚Äôil puisse un minimum g√©rer son profil.


\hypertarget{x-gestion-des-listes}{\section{Gestion des listes}}
\hypertarget{x-mod√®lisation}{\subsection{Mod√®lisation}}
Les donn√©es suivantes doivent √™tre associ√©es √† une liste:


\begin{itemize}

\item un identifiant

\item un identifiant externe (un GUID, par exemple)

\item un nom

\item une description

\item le propri√©taire, associ√© √† l‚Äôutilisateur qui l‚Äôaura cr√©√©e

\item une date de cr√©ation

\item une date de modification

\end{itemize}


\hypertarget{x-fonctionnalit√©s}{\subsection{Fonctionnalit√©s}}
\begin{itemize}

\item Un utilisateur authentifi√© doit pouvoir cr√©er, modifier, d√©sactiver et supprimer une liste dont il est le propri√©taire

\item Un utilisateur doit pouvoir associer ou retirer des souhaits √† une liste dont il est le propri√©taire

\item Il faut pouvoir acc√©der √† une liste, avec un utilisateur authentifier ou non, \textbf{via} son identifiant externe

\item Il faut pouvoir envoyer un email avec le lien vers la liste, contenant son identifiant externe

\item L‚Äôutilisateur doit pouvoir voir toutes les listes qui lui appartiennent

\end{itemize}


\hypertarget{x-gestion-des-souhaits}{\section{Gestion des souhaits}}
\hypertarget{x-mod√©lisation}{\subsection{Mod√©lisation}}
Les donn√©es suivantes peuvent √™tre associ√©es √† un souhait:


\begin{itemize}

\item un identifiant

\item identifiant de la liste

\item un nom

\item une description

\item le propri√©taire

\item une date de cr√©ation

\item une date de modification

\item une image, afin de repr√©senter l‚Äôobjet ou l‚Äôid√©e

\item un nombre (1 par d√©faut)

\item un prix facultatif

\item un nombre de part, facultatif √©galement, si un prix est fourni.

\end{itemize}


\hypertarget{x-fonctionnalit√©s}{\subsection{Fonctionnalit√©s}}
\begin{itemize}

\item Un utilisateur authentifi√© doit pouvoir cr√©er, modifier, d√©sactiver et supprimer un souhait dont il est le propri√©taire.

\item On ne peut cr√©er un souhait sans liste associ√©e

\item Il faut pouvoir fractionner un souhait uniquement si un prix est donn√©.

\item Il faut pouvoir acc√©der √† un souhait, avec un utilisateur authentifi√© ou non.

\item Il faut pouvoir r√©aliser un souhait ou une partie seulement, avec un utilisateur authentifi√© ou non.

\item Un souhait en cours de r√©alisation et compos√© de diff√©rentes parts ne peut plus √™tre modifi√©.

\item Un souhait en cours de r√©alisation ou r√©alis√© ne peut plus √™tre supprim√©.

\item On peut modifier le nombre de fois qu‚Äôun souhait doit √™tre r√©alis√© dans la limite des r√©alisations d√©j√† effectu√©es.

\end{itemize}


\hypertarget{x-gestion-des-r√©alisations-de-souhaits}{\section{Gestion des r√©alisations de souhaits}}
\hypertarget{x-mod√©lisation}{\subsection{Mod√©lisation}}
Les donn√©es suivantes peuvent √™tre associ√©es √† une r√©alisation de souhait:


\begin{itemize}

\item identifiant du souhait

\item identifiant de l‚Äôutilisateur si connu

\item identifiant de la personne si utilisateur non connu

\item un commentaire

\item une date de r√©alisation

\end{itemize}


\hypertarget{x-fonctionnalit√©s}{\subsection{Fonctionnalit√©s}}
\begin{itemize}

\item L‚Äôutilisateur doit pouvoir voir si un souhait est r√©alis√©, en partie ou non. Il doit √©galement avoir un pourcentage de compl√©tion sur la possibilit√© de r√©alisation de son souhait, entre 0% et 100%.

\item L‚Äôutilisateur doit pouvoir voir la ou les personnes ayant r√©alis√© un souhait.

\item Il y a autant de r√©alisation que de parts de souhait r√©alis√©es ou de nombre de fois que le souhait est r√©alis√©.

\end{itemize}


\hypertarget{x-gestion-des-personnes-r√©alisants-les-souhaits-et-qui-ne-sont-pas-connues}{\section{Gestion des personnes r√©alisants les souhaits et qui ne sont pas connues}}
\hypertarget{x-mod√©lisation}{\subsection{Mod√©lisation}}
Les donn√©es suivantes peuvent √™tre associ√©es √† une personne r√©alisant un souhait:


\begin{itemize}

\item un identifiant

\item un nom

\item une adresse email facultative

\end{itemize}


\hypertarget{x-fonctionnalit√©s}{\subsection{Fonctionnalit√©s}}
\begin{sidebar}
Mod√©lisation
\end{sidebar}

L‚ÄôORM de Django permet de travailler uniquement avec une d√©finition de classes, et de faire en sorte que le lien avec la base de donn√©es soit g√©r√© uniquement de mani√®re indirecte, par Django lui-m√™me. On peut sch√©matiser ce comportement par  une classe = une table.


Comme on l‚Äôa vu dans la description des fonctionnalit√©s, on va \textbf{grosso modo} avoir besoin des √©l√©ments suivants:


\begin{itemize}

\item Des listes de souhaits

\item Des √©l√©ments qui composent ces listes

\item Des parts pouvant composer chacun de ces √©l√©ments

\item Des utilisateurs pour g√©rer tout ceci.

\end{itemize}


Nous proposons dans un premier temps d‚Äô√©luder la gestion des utilisateurs, et de simplement se concentrer sur les fonctionnalit√©s principales.
Cela nous donne ceci:


\begin{enumerate}

\item{code-block:: python}

\begin{verbatim}
# wish/models.py
\end{verbatim}

\begin{verbatim}
from django.db import models
\end{verbatim}

\begin{verbatim}
class Wishlist(models.Model):
    pass
\end{verbatim}

\begin{verbatim}
class Item(models.Model):
    pass
\end{verbatim}

\begin{verbatim}
class Part(models.Model):
    pass
\end{verbatim}
\end{enumerate}


Les classes sont cr√©√©es, mais vides. Entrons dans les d√©tails.


\begin{sidebar}
Listes de souhaits
\end{sidebar}

Comme d√©j√† d√©crit pr√©c√©demment, les listes de souhaits peuvent s‚Äôapparenter simplement √† un objet ayant un nom et une description. Pour rappel, voici ce qui avait √©t√© d√©fini dans les sp√©cifications:


\begin{itemize}

\item un identifiant

\item un identifiant externe

\item un nom

\item une description

\item une date de cr√©ation

\item une date de modification

\end{itemize}


Notre classe \texttt{Wishlist} peut √™tre d√©finie de la mani√®re suivante:


\begin{enumerate}

\item{code-block:: python}

\begin{verbatim}
# wish/models.py
\end{verbatim}

\begin{verbatim}
class Wishlist(models.Model):
\end{verbatim}

\begin{verbatim}
name = models.CharField(max_length=255)
description = models.TextField()
created_at = models.DateTimeField(auto_now_add=True)
updated_at = models.DateTimeField(auto_now=True)
external_id = models.UUIDField(unique=True, default=uuid.uuid4, editable=False)
\end{verbatim}
\end{enumerate}


Que peut-on constater?


\begin{itemize}

\item Que s‚Äôil n‚Äôest pas sp√©cifi√©, un identifiant \texttt{id} sera automatiquement g√©n√©r√© et accessible dans le mod√®le. Si vous souhaitez malgr√© tout sp√©cifier que ce soit un champ en particulier qui devienne la cl√© primaire, il suffit de l‚Äôindiquer gr√¢ce √† l‚Äôattribut \texttt{primary\_key=True}.

\item Que chaque type de champs (\texttt{DateTimeField}, \texttt{CharField}, \texttt{UUIDField}, etc.) a ses propres param√®tres d‚Äôinitialisation. Il est int√©ressant de les apprendre ou de se r√©f√©rer √† la documentation en cas de doute.

\end{itemize}


Au niveau de notre mod√©lisation:


\begin{itemize}

\item La propri√©t√© \texttt{created\_at} est g√©r√©e automatiquement par Django gr√¢ce √† l‚Äôattribut \texttt{auto\_now\_add}: de cette mani√®re, lors d‚Äôun \textbf{ajout}, une valeur par d√©faut ("\textbf{maintenant}") sera attribu√©e √† cette propri√©t√©.

\item La propri√©t√© \texttt{updated\_at} est √©galement g√©r√©e automatique, cette fois gr√¢ce √† l‚Äôattribut \texttt{auto\_now} initialis√© √† \texttt{True}: lors d‚Äôune \textbf{mise √† jour}, la propri√©t√© se verra automatiquement assigner la valeur du moment pr√©sent. Cela ne permet √©videmment pas de g√©rer un historique complet et ne nous dira pas \textbf{quels champs} ont √©t√© modifi√©s, mais cela nous conviendra dans un premier temps.

\item La propri√©t√© \texttt{external\_id} est de type \texttt{UUIDField}. Lorsqu‚Äôune nouvelle instance sera instanci√©e, cette propri√©t√© prendra la valeur g√©n√©r√©e par la fonction \texttt{uuid.uuid4()}. \textbf{A priori}, chacun des types de champs poss√®de une propri√©t√© \texttt{default}, qui permet d‚Äôinitialiser une valeur sur une nouvelle instance.

\end{itemize}


\begin{sidebar}
Souhaits
\end{sidebar}

Nos souhaits ont besoin des propri√©t√©s suivantes:


\begin{itemize}

\item un identifiant

\item l‚Äôidentifiant de la liste auquel le souhait est li√©

\item un nom

\item une description

\item le propri√©taire

\item une date de cr√©ation

\item une date de modification

\item une image permettant de le repr√©senter.

\item un nombre (1 par d√©faut)

\item un prix facultatif

\item un nombre de part facultatif, si un prix est fourni.

\end{itemize}


Apr√®s impl√©mentation, cela ressemble √† ceci:


\begin{enumerate}

\item{code-block:: python}

\begin{verbatim}
# wish/models.py
\end{verbatim}

\begin{verbatim}
class Wish(models.Model):
\end{verbatim}

\begin{verbatim}
wishlist = models.ForeignKey(Wishlist)
name = models.CharField(max_length=255)
description = models.TextField()
created_at = models.DateTimeField(auto_now_add=True)
updated_at = models.DateTimeField(auto_now=True)
picture = models.ImageField()
numbers_available = models.IntegerField(default=1)
number_of_parts = models.IntegerField(null=True)
estimated_price = models.DecimalField(max_digits=19, decimal_places=2,
                                        null=True)
\end{verbatim}
\end{enumerate}


A nouveau, que peut-on constater ?


\begin{itemize}

\item Les cl√©s √©trang√®res sont g√©r√©es directement dans la d√©claration du mod√®le. Un champ de type ForeignKey  permet de d√©clarer une relation 1-N entre deux classes. Dans la m√™me veine, une relation 1-1 sera repr√©sent√©e par un champ de type OneToOneField  alors qu‚Äôune relation N-N utilisera un ManyToManyField .

\item L‚Äôattribut \texttt{default} permet de sp√©cifier une valeur initiale, utilis√©e lors de la construction de l‚Äôinstance. Cet attribut peut √©galement √™tre une fonction.

\item Pour rendre un champ optionnel, il suffit de lui ajouter l‚Äôattribut \texttt{null=True}.

\item Comme cit√© ci-dessus, chaque champ poss√®de des attributs sp√©cifiques. Le champ \texttt{DecimalField} poss√®de par exemple les attributs \texttt{max\_digits} et \texttt{decimal\_places}, qui nous permettra de repr√©senter une valeur comprise entre 0 et plus d‚Äôun milliard (avec deux chiffres d√©cimaux).

\item L‚Äôajout d‚Äôun champ de type \texttt{ImageField} n√©cessite l‚Äôinstallation de \texttt{pillow} pour la gestion des images. Nous l‚Äôajoutons donc √† nos pr√©-requis, dans le fichier \texttt{requirements/base.txt}.

\end{itemize}


\begin{sidebar}
Parts
\end{sidebar}

Les parts ont besoins des propri√©t√©s suivantes:


\begin{itemize}

\item un identifiant

\item identifiant du souhait

\item identifiant de l‚Äôutilisateur si connu

\item identifiant de la personne si utilisateur non connu

\item un commentaire

\item une date de r√©alisation

\end{itemize}


Elles constituent la derni√®re √©tape de notre mod√©lisation et repr√©sente la r√©alisation d‚Äôun souhait. Il y aura autant de part d‚Äôun souhait que le nombre de souhait √† r√©aliser fois le nombre de part.


Elles permettent √† un utilisateur de participer au souhait √©mis par un autre utilisateur. Pour les mod√©liser, une part est li√©e d‚Äôun c√¥t√© √† un souhait, et d‚Äôautre part √† un utilisateur. Cela nous donne ceci:


\begin{enumerate}

\item{code-block:: python}

\begin{verbatim}
from django.contrib.auth.models import User
\end{verbatim}

\begin{verbatim}
class WishPart(models.Model):
\end{verbatim}

\begin{verbatim}
wish = models.ForeignKey(Wish)
user = models.ForeignKey(User, null=True)
unknown_user = models.ForeignKey(UnknownUser, null=True)
comment = models.TextField(null=True, blank=True)
done_at = models.DateTimeField(auto_now_add=True)
\end{verbatim}
\end{enumerate}


La classe \texttt{User} r√©f√©renc√©e au d√©but du snippet correspond √† l‚Äôutilisateur qui sera connect√©. Ceci est g√©r√© par Django. Lorsqu‚Äôune requ√™te est effectu√©e et est transmise au serveur, cette information sera disponible gr√¢ce √† l‚Äôobjet \texttt{request.user}, transmis √† chaque fonction ou \textbf{Class-based-view}. C‚Äôest un des avantages d‚Äôun framework tout int√©gr√©: il vient \textbf{batteries-included} et beaucoup de d√©tails ne doivent pas √™tre pris en compte. Pour le moment, nous nous limiterons √† ceci. Par la suite, nous verrons comment am√©liorer la gestion des profils utilisateurs, comment y ajouter des informations et comment g√©rer les cas particuliers.


La classe \texttt{UnknownUser} permet de repr√©senter un utilisateur non enregistr√© sur le site et est d√©finie au point suivant.


\begin{sidebar}
Utilisateurs inconnus
\end{sidebar}

\begin{enumerate}

\item{todo:: je supprimerais pour que tous les utilisateurs soient g√©r√©s au m√™me endroit.}

\end{enumerate}


Pour chaque r√©alisation d‚Äôun souhait par quelqu‚Äôun, il est n√©cessaire de sauver les donn√©es suivantes, m√™me si l‚Äôutilisateur n‚Äôest pas enregistr√© sur le site:


\begin{itemize}

\item un identifiant

\item un nom

\item une adresse email. Cette adresse email sera unique dans notre base de donn√©es, pour ne pas cr√©er une nouvelle occurence si un m√™me utilisateur participe √† la r√©alisation de plusieurs souhaits.

\end{itemize}


Ceci nous donne apr√®s impl√©mentation:


\begin{enumerate}

\item{code-block:: python}

\begin{verbatim}
class UnkownUser(models.Model):
\end{verbatim}

\begin{verbatim}
name = models.CharField(max_length=255)
email = models.CharField(email = models.CharField(max_length=255, unique=True)
\end{verbatim}
\end{enumerate}


\hypertarget{x-tests-unitaires}{\chapter{Tests unitaires}}
\hypertarget{x-pourquoi-s‚Äôennuyer-√†-√©crire-des-tests?}{\section{Pourquoi s‚Äôennuyer √† √©crire des tests?}}
Traduit grossi√®rement depuis un article sur https://medium.com/javascript-scene/what-every-unit-test-needs-f6cd34d9836d

\begin{verbatim}
Vos tests sont la premi√®re et la meilleure ligne de d√©fense contre les d√©fauts de programmation. Ils sont
\end{verbatim}

\begin{verbatim}
Les tests unitaires combinent de nombreuses fonctionnalit√©s, qui en fait une arme secr√®te au service d'un d√©veloppement r√©ussi:
\end{verbatim}

\begin{enumerate}

\item{Aide au design: √©crire des tests avant d‚Äô√©crire le code vous donnera une meilleure perspective sur le design √† appliquer aux API.}

\item{Documentation (pour les d√©veloppeurs): chaque description d‚Äôun test}

\item{Tester votre compr√©hension en tant que d√©veloppeur:}

\item{Assurance qualit√©: des tests,
5.}

\end{enumerate}


\hypertarget{x-why-bother-with-test-discipline?}{\section{Why Bother with Test Discipline?}}
Your tests are your first and best line of defense against software defects. Your tests are more important than linting \& static analysis (which can only find a subclass of errors, not problems with your actual program logic). Tests are as important as the implementation itself (all that matters is that the code meets the requirement‚Ää‚Äî‚Äähow it‚Äôs implemented doesn‚Äôt matter at all unless it‚Äôs implemented poorly).


Unit tests combine many features that make them your secret weapon to application success:


\begin{enumerate}

\item{Design aid: Writing tests first gives you a clearer perspective on the ideal API design.}

\item{Feature documentation (for developers): Test descriptions enshrine in code every implemented feature requirement.}

\item{Test your developer understanding: Does the developer understand the problem enough to articulate in code all critical component requirements?}

\item{Quality Assurance: Manual QA is error prone. In my experience, it‚Äôs impossible for a developer to remember all features that need testing after making a change to refactor, add new features, or remove features.}

\item{Continuous Delivery Aid: Automated QA affords the opportunity to automatically prevent broken builds from being deployed to production.}

\end{enumerate}


Unit tests don‚Äôt need to be twisted or manipulated to serve all of those broad-ranging goals. Rather, it is in the essential nature of a unit test to satisfy all of those needs. These benefits are all side-effects of a well-written test suite with good coverage.


\hypertarget{x-what-are-you-testing?}{\section{What are you testing?}}
\begin{enumerate}

\item{What component aspect are you testing?}

\item{What should the feature do? What specific behavior requirement are you testing?}

\end{enumerate}


\hypertarget{x-couverture-de-code}{\section{Couverture de code}}
On a vu au chapitre 1 qu‚Äôil √©tait possible d‚Äôobtenir une couverture de code, c‚Äôest-√†-dire un pourcentage.


\hypertarget{x-comment-tester-?}{\section{Comment tester ?}}
Il y a deux mani√®res d‚Äô√©crire les tests: soit avant, soit apr√®s l‚Äôimpl√©mentation. Oui, id√©alement, les tests doivent √™tre √©crits √† l‚Äôavance. Entre nous, on ne va pas r√¢ler si vous faites l‚Äôinverse, l‚Äôimportant √©tant que vous le fassiez. Une bonne m√©trique pour v√©rifier l‚Äôavancement des tests est la couverture de code.


Pour l‚Äôexemple, nous allons √©crire la fonction \texttt{percentage\_of\_completion} sur la classe \texttt{Wish}, et nous allons sp√©cifier les r√©sultats attendus avant m√™me d‚Äôimpl√©menter son contenu. Prenons le cas o√π nous √©crivons la m√©thode avant son test:


\begin{verbatim}
class Wish(models.Model):

    [...]

    @property
    def percentage_of_completion(self):
        """
        Calcule le pourcentage de compl√©tion pour un √©l√©ment.
        """
        number_of_linked_parts = WishPart.objects.filter(wish=self).count()
        total = self.number_of_parts * self.numbers_available
        percentage = (number_of_linked_parts / total)
        return percentage * 100
\end{verbatim}

Lancez maintenant la couverture de code. Vous obtiendrez ceci:


\begin{verbatim}
$ coverage run --source "." src/manage.py test wish
$ coverage report

Name                             Stmts   Miss Branch BrPart  Cover
------------------------------------------------------------------
src\gwift\__init__.py                0      0      0      0   100%
src\gwift\settings\__init__.py       4      0      0      0   100%
src\gwift\settings\base.py          14      0      0      0   100%
src\gwift\settings\dev.py            8      0      2      0   100%
src\manage.py                        6      0      2      1    88%
src\wish\__init__.py                 0      0      0      0   100%
src\wish\admin.py                    1      0      0      0   100%
src\wish\models.py                  36      5      0      0    88%
------------------------------------------------------------------
TOTAL                               69      5      4      1    93%
\end{verbatim}

Si vous g√©n√©rez le rapport HTML avec la commande \texttt{coverage html} et que vous ouvrez le fichier \texttt{coverage\_html\_report/src\_wish\_models\_py.html}, vous verrez que les m√©thodes en rouge ne sont pas test√©es.
\textbf{A contrario}, la couverture de code atteignait \textbf{98\%} avant l‚Äôajout de cette nouvelle m√©thode.


Pour cela, on va utiliser un fichier tests.py dans notre application \texttt{wish}. \textbf{A priori}, ce fichier est cr√©√© automatiquement lorsque vous initialisez une nouvelle application.


\begin{verbatim}
from django.test import TestCase

class TestWishModel(TestCase):
    def test_percentage_of_completion(self):
        """
        V√©rifie que le pourcentage de compl√©tion d'un souhait
        est correctement calcul√©.

        Sur base d'un souhait, on cr√©e quatre parts et on v√©rifie
        que les valeurs s'√©talent correctement sur 25%, 50%, 75% et 100%.
        """
        wishlist = Wishlist(name='Fake WishList',
                            description='This is a faked wishlist')
        wishlist.save()

        wish = Wish(wishlist=wishlist,
                    name='Fake Wish',
                    description='This is a faked wish',
                    number_of_parts=4)
        wish.save()

        part1 = WishPart(wish=wish, comment='part1')
        part1.save()
        self.assertEqual(25, wish.percentage_of_completion)

        part2 = WishPart(wish=wish, comment='part2')
        part2.save()
        self.assertEqual(50, wish.percentage_of_completion)

        part3 = WishPart(wish=wish, comment='part3')
        part3.save()
        self.assertEqual(75, wish.percentage_of_completion)

        part4 = WishPart(wish=wish, comment='part4')
        part4.save()
        self.assertEqual(100, wish.percentage_of_completion)
\end{verbatim}

L‚Äôattribut \texttt{property} sur la m√©thode \texttt{percentage\_of\_completion()} va nous permettre d‚Äôappeler directement la m√©thode \texttt{percentage\_of\_completion()} comme s‚Äôil s‚Äôagissait d‚Äôune propri√©t√© de la classe, au m√™me titre que les champs \texttt{number\_of\_parts} ou \texttt{numbers\_available}. Attention que ce type de m√©thode contactera la base de donn√©es √† chaque fois qu‚Äôelle sera appel√©e. Il convient de ne pas surcharger ces m√©thodes de connexions √† la base: sur de petites applications, ce type de comportement a tr√®s peu d‚Äôimpacts, mais ce n‚Äôest plus le cas sur de grosses applications ou sur des m√©thodes fr√©quemment appel√©es. Il convient alors de passer par un m√©canisme de \textbf{cache}, que nous aborderons plus loin.


En relan√ßant la couverture de code, on voit √† pr√©sent que nous arrivons √† 99%:


\begin{verbatim}
$ coverage run --source='.' src/manage.py test wish; coverage report; coverage html;
.
----------------------------------------------------------------------
Ran 1 test in 0.006s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...
Name                             Stmts   Miss Branch BrPart  Cover
------------------------------------------------------------------
src\gwift\__init__.py                0      0      0      0   100%
src\gwift\settings\__init__.py       4      0      0      0   100%
src\gwift\settings\base.py          14      0      0      0   100%
src\gwift\settings\dev.py            8      0      2      0   100%
src\manage.py                        6      0      2      1    88%
src\wish\__init__.py                 0      0      0      0   100%
src\wish\admin.py                    1      0      0      0   100%
src\wish\models.py                  34      0      0      0   100%
src\wish\tests.py                   20      0      0      0   100%
------------------------------------------------------------------
TOTAL                               87      0      4      1    99%
\end{verbatim}

En continuant de cette mani√®re (ie. Ecriture du code et des tests, v√©rification de la couverture de code), on se fixe un objectif id√©al d√®s le d√©but du projet. En prenant un d√©veloppement en cours de route, fixez-vous comme objectif de ne jamais faire baisser la couverture de code.


\hypertarget{x-quelques-liens-utiles}{\section{Quelques liens utiles}}
\begin{itemize}

\item Django factory boy 

\end{itemize}


\hypertarget{x-refactoring}{\chapter{Refactoring}}
On constate que plusieurs classes poss√®dent les m√™mes propri√©t√©s \texttt{created\_at} et \texttt{updated\_at}, initialis√©es aux m√™mes valeurs. Pour gagner en coh√©rence, nous allons cr√©er une classe dans laquelle nous d√©finirons ces deux champs, et nous ferons en sorte que les classes \texttt{Wishlist}, \texttt{Item} et \texttt{Part} en h√©ritent. Django g√®re trois sortes d‚Äôh√©ritage:


\begin{itemize}

\item L‚Äôh√©ritage par classe abstraite

\item L‚Äôh√©ritage classique

\item L‚Äôh√©ritage par classe proxy.

\end{itemize}


\hypertarget{x-classe-abstraite}{\section{Classe abstraite}}
L‚Äôh√©ritage par classe abstraite consiste √† d√©terminer une classe m√®re qui ne sera jamais instanci√©e. C‚Äôest utile pour d√©finir des champs qui se r√©p√®teront dans plusieurs autres classes et surtout pour respecter le principe de DRY. Comme la classe m√®re ne sera jamais instanci√©e, ces champs seront en fait dupliqu√©s physiquement, et traduits en SQL, dans chacune des classes filles.


\begin{verbatim}
# wish/models.py

class AbstractModel(models.Model):
    class Meta:
        abstract = True

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)


class Wishlist(AbstractModel):
    pass


class Item(AbstractModel):
    pass


class Part(AbstractModel):
    pass
\end{verbatim}

En traduisant ceci en SQL, on aura en fait trois tables, chacune reprenant les champs \texttt{created\_at} et \texttt{updated\_at}, ainsi que son propre identifiant:


\begin{verbatim}
--$ python manage.py sql wish
BEGIN;
CREATE TABLE "wish_wishlist" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_item" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_part" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;

COMMIT;
\end{verbatim}

\hypertarget{x-h√©ritage-classique}{\section{H√©ritage classique}}
L‚Äôh√©ritage classique est g√©n√©ralement d√©conseill√©, car il peut introduire tr√®s rapidement un probl√®me de performances: en reprenant l‚Äôexemple introduit avec l‚Äôh√©ritage par classe abstraite, et en omettant l‚Äôattribut \texttt{abstract = True}, on se retrouvera en fait avec quatre tables SQL:


\begin{itemize}

\item Une table \texttt{AbstractModel}, qui reprend les deux champs \texttt{created\_at} et \texttt{updated\_at}

\item Une table \texttt{Wishlist}

\item Une table \texttt{Item}

\item Une table \texttt{Part}.

\end{itemize}


A nouveau, en analysant la sortie SQL de cette mod√©lisation, on obtient ceci:


\begin{verbatim}
--$ python manage.py sql wish

BEGIN;
CREATE TABLE "wish_abstractmodel" (
    "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    "created_at" datetime NOT NULL,
    "updated_at" datetime NOT NULL
)
;
CREATE TABLE "wish_wishlist" (
    "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;
CREATE TABLE "wish_item" (
    "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;
CREATE TABLE "wish_part" (
    "abstractmodel_ptr_id" integer NOT NULL PRIMARY KEY REFERENCES "wish_abstractmodel" ("id")
)
;

COMMIT;
\end{verbatim}

Le probl√®me est que les identifiants seront d√©finis et incr√©ment√©s au niveau de la table m√®re. Pour obtenir les informations h√©rit√©es, nous seront oblig√©s de faire une jointure. En gros, impossible d‚Äôobtenir les donn√©es compl√®tes pour l‚Äôune des classes de notre travail de base sans effectuer un \textbf{join} sur la classe m√®re.


Dans ce sens, cela va encore‚Ä¶‚Äã Mais imaginez que vous d√©finissiez une classe \texttt{Wishlist}, de laquelle h√©ritent les classes \texttt{ChristmasWishlist} et \texttt{EasterWishlist}: pour obtenir la liste compl√®tes des listes de souhaits, il vous faudra faire une jointure \textbf{externe} sur chacune des tables possibles, avant m√™me d‚Äôavoir commenc√© √† remplir vos donn√©es. Il est parfois n√©cessaire de passer par cette mod√©lisation, mais en √©tant conscient des risques inh√©rents.


\hypertarget{x-classe-proxy}{\section{Classe proxy}}
Lorsqu‚Äôon d√©finit une classe de type \textbf{proxy}, on fait en sorte que cette nouvelle classe ne d√©finisse aucun nouveau champ sur la classe m√®re. Cela ne change d√®s lors rien √† la traduction du mod√®le de donn√©es en SQL, puisque la classe m√®re sera traduite par une table, et la classe fille ira r√©cup√©rer les m√™mes informations dans la m√™me table: elle ne fera qu‚Äôajouter ou modifier un comportement dynamiquement, sans ajouter d‚Äôemplacements de stockage suppl√©mentaires.


Nous pourrions ainsi d√©finir les classes suivantes:


\begin{verbatim}
# wish/models.py

class Wishlist(models.Model):
    name = models.CharField(max_length=255)
    description = models.CharField(max_length=2000)
    expiration_date = models.DateField()

    @staticmethod
    def create(self, name, description, expiration_date=None):
        wishlist = Wishlist()
        wishlist.name = name
        wishlist.description = description
        wishlist.expiration_date = expiration_date
        wishlist.save()
        return wishlist

class ChristmasWishlist(Wishlist):
    class Meta:
        proxy = True

    @staticmethod
    def create(self, name, description):
        christmas = datetime(current_year, 12, 31)
        w = Wishlist.create(name, description, christmas)
        w.save()


class EasterWishlist(Wishlist):
    class Meta:
        proxy = True

    @staticmethod
    def create(self, name, description):
        expiration_date = datetime(current_year, 4, 1)
        w = Wishlist.create(name, description, expiration_date)
        w.save()
\end{verbatim}

\begin{sidebar}
Gestion des utilisateurs
\end{sidebar}

Dans les sp√©cifications, nous souhaitions pouvoir associer un utilisateur √† une liste (\textbf{le propri√©taire}) et un utilisateur √† une part (\textbf{le donateur}). Par d√©faut, Django offre une gestion simplifi√©e des utilisateurs (pas de connexion LDAP, pas de double authentification, ‚Ä¶‚Äã): juste un utilisateur et un mot de passe. Pour y acc√©der, un param√®tre par d√©faut est d√©fini dans votre fichier de settings: \texttt{AUTH\_USER\_MODEL}.


\hypertarget{x-khana}{\chapter{Khana}}
Khana est une application de suivi d‚Äôapprentissage pour des √©l√®ves ou √©tudiants.
Nous voulons pouvoir:


\begin{enumerate}

\item{Lister les √©l√®ves}

\item{Faire des listes de pr√©sence pour les √©l√®ves}

\item{Pouvoir planifier ses cours}

\item{Pouvoir suivre l‚Äôapprentissage des √©l√®ves, les liens qu‚Äôils ont entre les √©l√©ments √† apprendre:}

\item{pour √©crire une phrase, il faut pouvoir √©crire des mots, conna√Ætre la grammaire, et conna√Ætre la conjugaison}

\item{pour √©crire des mots, il faut savoir √©crire des lettres}

\item{‚Ä¶‚Äã}

\end{enumerate}


Plusieurs professeurs s‚Äôoccupent d‚Äôune m√™me classe; il faut pouvoir √©crire des notes, envoyer des messages aux autres professeurs, etc.


Il faut √©galement pouvoir d√©finir des dates de contr√¥le, voir combien de semaines il reste pour s‚Äôassurer d‚Äôavoir vu toute la mati√®tre.


Et pouvoir encoder les points des contr√¥les.


\begin{figure}[h]{}
\centering\includegraphics[width=2.5truein]{images/django/django-project-vs-apps-khana.png}
\caption{}

\end{figure}

\hypertarget{x-ressources-et-bibliographie}{\part*{Ressources et bibliographie}}
\begin{itemize}

\item \href{https://simpleisbetterthancomplex.com/series/beginners-guide/1.11/}{Simple Is Better Than Complex}

\item \href{https://www.feldroy.com/collections/two-scoops-press/products/two-scoops-of-django-1-11}{Two Scoops of Django 1.11}

\item \href{https://www.feldroy.com/products/django-crash-course}{Django Crash Course}

\item \href{https://www.amazon.com/dp/B07BDGC57}{Django Design Patterns and Best Practices} (Packt Publishing)

\item \href{https://books.agiliq.com/en/latest/README.html}{Books by Agiliq}

\end{itemize}


\hypertarget{x-snippets-utiles-(et-forc√©ment-dispensables)}{\chapter{Snippets utiles (et forc√©ment dispensables)}}
\hypertarget{x-r√©cup√©ration-du-dernier-tag-git-en-python}{\section{R√©cup√©ration du dernier tag Git en Python}}
L‚Äôid√©e ici est simplement de pouvoir afficher le num√©ro de version ou le hash d‚Äôex√©cution du code, sans avoir √† se connecter au d√©p√¥t. Cela apporte une certaine transparence, \textbf{sous r√©serve que le code soit g√©r√© par Git}. Si vous suivez scrupuleusement les 12 facteurs, la version de l‚Äôapplication d√©ploy√©e n‚Äôest plus sens√©e conserver un lien avec votre d√©p√¥t d‚Äôorigine‚Ä¶‚Äã Si vous d√©ployez votre code en utilisant un \texttt{git fetch} puis un \texttt{git checkout <tag\_name>}, le morceau de code ci-dessous pourra vous int√©resser :-)


\begin{verbatim}

\end{verbatim}

\hypertarget{x-applications-\emph{legacy}}{\chapter{Applications \emph{Legacy}}}
Quand on int√®gre une nouvelle application Django dans un environement existant, la premi√®re √©tape est de se c√¢bler sur la base de donn√©es existantes;


\begin{enumerate}

\item{Soit l‚Äôapplication sur laquelle on se greffe restera telle quelle;}

\item{Soit l‚Äôapplication est \textbf{remplac√©e} par la nouvelle application Django.}

\begin{verbatim}
Dans le premier cas, il convient de cr√©er une application et de sp√©cifier pour chaque classe l'attribute `managed = False` dans le `class Meta:` de la d√©finition.
Dans le second, il va falloir c√¢bler deux-trois √©l√©ments avant d'avoir une int√©gration compl√®te (comprendre: avec une interface d'admin, les migrations, les tests unitaires et tout le brol :))
\end{verbatim}

\begin{verbatim}
`python manage.py inspectdb > models.py`
\end{verbatim}

\begin{enumerate}

\item{\href{https://simpleisbetterthancomplex.com/series/beginners-guide/1.11/}{A Complete Beginner‚Äôs Guide to Django}:}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/09/04/a-complete-beginners-guide-to-django-part-1.html}{Getting Started}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/09/11/a-complete-beginners-guide-to-django-part-2.html}{Fundamentals}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/09/18/a-complete-beginners-guide-to-django-part-3.html}{Advanced Concepts}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/09/25/a-complete-beginners-guide-to-django-part-4.html}{Authentication}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/10/02/a-complete-beginners-guide-to-django-part-5.html}{Django ORM}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/10/09/a-complete-beginners-guide-to-django-part-6.html}{Class Based Views}}

\item{\href{https://simpleisbetterthancomplex.com/series/2017/10/16/a-complete-beginners-guide-to-django-part-7.html}{Deployment}}

\end{enumerate}

\end{enumerate}


\hypertarget{x-livres}{\chapter{Livres}}
\begin{itemize}

\item \href{https://www.packtpub.com/product/expert-python-programming-third-edition/9781789808896}{Expert Python Programming - Third Edition} - pour les chapitres sur Docker, Vagrant.

\end{itemize}


\end{document}

